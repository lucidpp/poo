<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peyza Developer Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Modern Dark/Grey Theme */
        :root {
            --rbx-bg: #191b1d;
            --rbx-panel: #2b2d31;
            --rbx-header: #232527;
            --rbx-text: #ffffff;
            --rbx-text-sec: #adadad;
            --rbx-blue: #00b06f;
            --rbx-divider: #393b3d;
            --rbx-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        body {
            background-color: var(--rbx-bg);
            color: var(--rbx-text);
            font-family: 'Gotham SSm', 'Segoe UI', Helvetica, Arial, sans-serif;
            overflow-x: hidden;
        }
        .rbx-card {
            background-color: var(--rbx-panel);
            border-radius: 12px;
            box-shadow: var(--rbx-shadow);
            border: 1px solid #383a40;
        }
        .rbx-input {
            background-color: #1a1c1e;
            border: 1px solid #393b3d;
            color: white;
            border-radius: 8px;
        }
        .rbx-input:focus {
            border-color: #00b06f;
            outline: none;
        }
        .rbx-btn-primary {
            background-color: white;
            color: black;
            font-weight: 700;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .rbx-btn-green {
            background-color: #00b06f;
            color: white;
            font-weight: 700;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .rbx-btn-green:hover {
            background-color: #009960;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--rbx-bg); 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4d52; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #606368; 
        }

        .verified-badge {
            color: #fff;
            background-color: #00b06f;
            border-radius: 50%;
            padding: 2px;
            font-size: 0.7em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 4px;
        }

        /* 3D View Container */
        #game-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background: #000;
            display: none;
        }
        
        /* Mobile Bottom Nav */
        .mobile-nav {
            display: none;
        }
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
            }
            .sidebar {
                display: none !important;
            }
            main {
                margin-left: 0 !important;
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Top Navigation (Desktop) -->
    <nav class="h-14 bg-[#232527] border-b border-[#393b3d] flex items-center justify-between px-4 fixed w-full z-50 shadow-md">
        <div class="flex items-center gap-6">
            <h1 class="text-2xl font-extrabold cursor-pointer text-white tracking-tight hover:text-gray-300 transition" onclick="app.navigate('home')">Peyza</h1>
            <ul class="hidden md:flex gap-6 text-base font-medium text-gray-400">
                <li class="cursor-pointer hover:text-white transition" onclick="app.navigate('home')">Discover</li>
                <li class="cursor-pointer hover:text-white transition" onclick="app.navigate('marketplace')">Marketplace</li>
                <li class="cursor-pointer hover:text-white transition" onclick="app.navigate('devhub')">Create</li>
                <li class="cursor-pointer hover:text-white transition" onclick="app.navigate('robux')">Robux</li>
            </ul>
        </div>
        <div class="flex-1 max-w-xl mx-4 hidden md:block">
            <div class="relative">
                <input id="nav-search" type="text" placeholder="Search experiences..." class="w-full bg-[#1a1c1e] border border-[#393b3d] rounded-full py-2 px-4 text-sm text-white focus:outline-none focus:border-gray-500">
                <i class="fas fa-search absolute right-4 top-2.5 text-gray-500 text-xs"></i>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-1 bg-[#2b2d31] px-3 py-1 rounded-full cursor-pointer hover:bg-[#393b3d] transition border border-[#393b3d]" onclick="app.navigate('robux')">
                <i class="fas fa-hexagon text-white text-xs"></i>
                <span id="nav-robux" class="font-bold text-sm text-white">0</span>
            </div>
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.navigate('profile')">
                <div class="w-9 h-9 rounded-full bg-gray-600 overflow-hidden border border-[#393b3d]">
                    <img id="nav-avatar-img" src="https://tr.rbxcdn.com/38c6edcb50633730ff4cf39ac8859840/150/150/AvatarHeadshot/Png" alt="Avatar" class="w-full h-full object-cover">
                </div>
                <span id="nav-username" class="text-sm font-semibold text-white hidden sm:block">User</span>
            </div>
        </div>
    </nav>

    <!-- Sidebar (Desktop) -->
    <aside class="sidebar fixed left-0 top-14 w-60 h-full bg-[#191b1d] border-r border-[#393b3d] pt-4 hidden lg:block z-40 overflow-y-auto">
        <div class="flex flex-col gap-1 px-3">
            <a onclick="app.navigate('home')" class="px-4 py-2 hover:bg-[#2b2d31] rounded-lg cursor-pointer flex items-center gap-3 text-gray-300 font-semibold transition hover:text-white"><i class="fas fa-home w-5"></i> Home</a>
            <a onclick="app.navigate('profile')" class="px-4 py-2 hover:bg-[#2b2d31] rounded-lg cursor-pointer flex items-center gap-3 text-gray-300 font-semibold transition hover:text-white"><i class="fas fa-user w-5"></i> Profile</a>
            <a onclick="app.navigate('messages')" class="px-4 py-2 hover:bg-[#2b2d31] rounded-lg cursor-pointer flex items-center gap-3 text-gray-300 font-semibold transition hover:text-white">
                <i class="fas fa-comment-dots w-5"></i> Messages 
                <span id="msg-badge" class="hidden bg-red-500 text-white text-[10px] px-1.5 rounded-full ml-auto">0</span>
            </a>
            <a onclick="app.navigate('groups')" class="px-4 py-2 hover:bg-[#2b2d31] rounded-lg cursor-pointer flex items-center gap-3 text-gray-300 font-semibold transition hover:text-white"><i class="fas fa-user-friends w-5"></i> Groups</a>
            <a onclick="app.navigate('avatar')" class="px-4 py-2 hover:bg-[#2b2d31] rounded-lg cursor-pointer flex items-center gap-3 text-gray-300 font-semibold transition hover:text-white"><i class="fas fa-tshirt w-5"></i> Avatar</a>
            <a onclick="app.navigate('inventory')" class="px-4 py-2 hover:bg-[#2b2d31] rounded-lg cursor-pointer flex items-center gap-3 text-gray-300 font-semibold transition hover:text-white"><i class="fas fa-box w-5"></i> Inventory</a>
            
            <div class="mt-4 border-t border-[#393b3d] pt-4 px-4">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">My Events</h3>
                <a onclick="app.navigate('devhub')" class="py-2 hover:bg-[#2b2d31] rounded-lg px-2 -ml-2 cursor-pointer flex items-center gap-3 text-gray-300 font-semibold hover:text-white"><i class="fas fa-pencil-ruler w-5"></i> Developer Hub</a>
            </div>
        </div>
    </aside>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-nav fixed bottom-0 w-full bg-[#232527] border-t border-[#393b3d] h-16 z-50 flex justify-around items-center px-2">
        <div onclick="app.navigate('home')" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white">
            <i class="fas fa-home text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Home</span>
        </div>
        <div onclick="app.navigate('devhub')" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white">
            <i class="fas fa-gamepad text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Create</span>
        </div>
        <div onclick="app.navigate('profile')" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white">
            <div class="w-8 h-8 rounded-full overflow-hidden border border-gray-500 mb-1">
                 <img src="https://tr.rbxcdn.com/38c6edcb50633730ff4cf39ac8859840/150/150/AvatarHeadshot/Png" class="w-full h-full object-cover">
            </div>
        </div>
        <div onclick="app.navigate('robux')" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white">
             <i class="fas fa-hexagon text-xl mb-1"></i>
             <span class="text-[10px] font-bold">Robux</span>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="lg:ml-60 mt-14 p-4 md:p-8 flex-1 overflow-y-auto pb-24">
        <!-- Dynamic Content Injected Here -->
    </main>

    <!-- 3D Game Overlay -->
    <div id="game-view" class="relative">
        <div class="absolute top-4 left-4 z-50 flex gap-4">
             <button onclick="threeApp.stopGame()" class="bg-red-600 text-white px-4 py-2 rounded font-bold shadow-lg hover:bg-red-700">Leave Game</button>
             <div class="bg-black bg-opacity-50 text-white px-4 py-2 rounded font-bold backdrop-blur-sm">
                Playing: <span id="game-playing-name">Game</span>
             </div>
        </div>
        <div class="absolute bottom-10 left-10 z-50 text-white pointer-events-none select-none">
            <p class="text-2xl font-bold mb-1">Controls</p>
            <p class="text-sm opacity-80">Click/Drag to look around</p>
            <p class="text-sm opacity-80">You earn +1 visit/sec while here</p>
        </div>
        <canvas id="game-canvas" class="w-full h-full block"></canvas>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-20 md:bottom-5 right-5 flex flex-col gap-2 z-[60]"></div>

    <script>
        // --- Persistence Helpers ---
        const storage = {
            save: () => {
                const data = {
                    state: appState,
                    timestamp: Date.now()
                };
                localStorage.setItem('peyza_save_v6', JSON.stringify(data));
            },
            load: () => {
                const data = localStorage.getItem('peyza_save_v6');
                if (data) return JSON.parse(data);
                return null;
            }
        };

        // --- Data Generators ---
        const generateDemoGames = () => {
            const adjectives = ["Super", "Mega", "Ultimate", "Royal", "Dark", "Crazy", "Happy", "Speed", "Ninja", "Pixel", "Blox", "Build", "Escape"];
            const nouns = ["City", "Tycoon", "Simulator", "Obby", "Wars", "Survival", "Life", "World", "Tower", "Legends", "Mystery", "School", "Island"];
            const bots = ["Builderman", "Roblox", "NoobMaster", "ProGamer", "DevKing", "ScriptNinja", "PolyHex", "BlockSmith", "PixelArt"];
            
            const games = [];
            for (let i = 0; i < 40; i++) {
                const seed = Math.floor(Math.random() * 10000);
                games.push({
                    id: `demo_${i}`,
                    name: `${adjectives[Math.floor(Math.random()*adjectives.length)]} ${nouns[Math.floor(Math.random()*nouns.length)]}`,
                    description: "Experience the thrill in this amazing world! Play with friends, unlock items, and explore vast landscapes.",
                    visits: Math.floor(Math.random() * 5000000) + 10000,
                    active: Math.floor(Math.random() * 15000) + 50,
                    favorites: Math.floor(Math.random() * 100000),
                    likes: Math.floor(Math.random() * 50000),
                    dislikes: Math.floor(Math.random() * 5000),
                    created: "1/12/2024",
                    genre: ["Adventure", "Tycoon", "Simulator", "Obby"][Math.floor(Math.random()*4)],
                    icon: `https://picsum.photos/seed/${seed}/300/300`,
                    thumbnail: `https://picsum.photos/seed/${seed}/768/432`,
                    creatorName: bots[Math.floor(Math.random()*bots.length)],
                    isDemo: true,
                    gamepasses: [],
                    events: []
                });
            }
            return games;
        };

        // --- Game State & Data ---
        const initialGame = {
            id: 'game_1',
            name: "Mega Fun Obby!",
            description: "Welcome to the most fun obstacle course on Peyza! Can you beat all 100 stages? Updates every Friday!",
            visits: 15420,
            active: 42,
            favorites: 1200,
            likes: 450,
            dislikes: 12,
            created: new Date().toLocaleDateString(),
            genre: "Adventure",
            icon: "https://picsum.photos/seed/icon1/300/300",
            thumbnail: "https://picsum.photos/seed/thumb1/768/432",
            creatorName: "PeyzaDev_2025",
            ownerId: 'user', // 'user' or groupID
            isDemo: false,
            gamepasses: [
                { id: 'gp_1', name: "Speed Coil", price: 99, sales: 12, image: "https://via.placeholder.com/150" }
            ],
            events: [] 
        };

        const defaultState = {
            view: 'home',
            user: {
                username: "PeyzaDev_2025",
                followers: 95000,
                robux: 450,
                usd: 0.00,
                status: "Developing the next big hit!",
                joinDate: "2/14/2021",
                usedFreeSponsor: false,
                avatarColor: '#1e1e1e'
            },
            groups: [],
            messages: [
                { id: 1, from: "Builderman", subject: "Welcome to Peyza!", body: "Welcome to the future of imagination. Start building today!", read: false },
                { id: 2, from: "System", subject: "Premium Payout", body: "You earned 45 Robux from Premium Payouts yesterday.", read: true }
            ],
            games: [initialGame],
            demoGames: [],
            currentGameId: null,
            currentGroupId: null,
            eventsLog: [],
            searchTerm: "",
            inventory: []
        };

        let appState = defaultState;

        // --- Core Application Logic ---

        const app = {
            init: () => {
                const saved = storage.load();
                if (saved) {
                    appState = saved.state;
                    if (!appState.groups) appState.groups = [];
                    if (!appState.messages) appState.messages = defaultState.messages;
                    appState.games.forEach(g => { if(!g.events) g.events = []; });
                    appState.groups.forEach(g => { if(!g.announcements) g.announcements = []; });

                    if (!appState.demoGames || appState.demoGames.length === 0) appState.demoGames = generateDemoGames();
                    app.calculateOfflineProgress(saved.timestamp);
                } else {
                    appState.demoGames = generateDemoGames();
                }
                
                app.startSimulation();
                app.render();
                app.updateHeader();

                // Listeners
                document.getElementById('nav-search').addEventListener('input', (e) => {
                    appState.searchTerm = e.target.value.toLowerCase();
                    if(appState.view === 'home') app.render(); 
                });
                
                // Auto-save
                setInterval(storage.save, 5000);
                window.addEventListener('beforeunload', storage.save);
            },

            calculateOfflineProgress: (lastTime) => {
                const now = Date.now();
                const diffSeconds = (now - lastTime) / 1000;
                
                if (diffSeconds > 10) {
                    let totalVisits = 0;
                    let totalMembersGained = 0;

                    appState.games.forEach(game => {
                        const oldActive = game.active;
                        const decay = Math.pow(0.999, diffSeconds); 
                        game.active = Math.floor(game.active * decay);
                        
                        // Offline visits from decayed active players
                        const avgActive = (oldActive + game.active) / 2;
                        let offlineVisits = Math.floor(avgActive * 0.5 * diffSeconds);
                        
                        // Passive Group Visits (Members checking out game)
                        if (game.ownerId !== 'user') {
                            const group = appState.groups.find(g => g.id === game.ownerId);
                            if (group) {
                                // e.g. 5% of members visit per hour
                                const memberVisits = Math.floor(group.members * (0.015 * diffSeconds)); 
                                offlineVisits += memberVisits;

                                // Visits -> New Members (Offline)
                                const newMembers = Math.floor(offlineVisits / 800);
                                group.members += newMembers;
                                totalMembersGained += newMembers;
                            }
                        }

                        game.visits += offlineVisits;
                        totalVisits += offlineVisits;

                        if (offlineVisits > 0 && !game.isDemo) {
                            appState.user.followers += Math.floor(offlineVisits / 150);
                        }
                    });
                    
                    if (totalVisits > 0) {
                        setTimeout(() => {
                            let msg = `Welcome back! +${app.formatNumber(totalVisits)} Visits`;
                            if(totalMembersGained > 0) msg += `, +${totalMembersGained} Group Members`;
                            app.showToast(msg);
                        }, 1000);
                    }
                }
            },

            navigate: (page, param = null) => {
                appState.view = page;
                if (page === 'game') appState.currentGameId = param;
                if (page === 'group_details') appState.currentGroupId = param;
                window.scrollTo(0,0);
                app.render();
            },

            startSimulation: () => {
                setInterval(() => {
                    const allGames = [...appState.games, ...appState.demoGames];
                    let unreadMsg = appState.messages.filter(m => !m.read).length;
                    const badge = document.getElementById('msg-badge');
                    if(badge) {
                        badge.innerText = unreadMsg;
                        badge.style.display = unreadMsg > 0 ? 'inline-block' : 'none';
                    }

                    allGames.forEach(game => {
                        // 1. Natural Fluctuation
                        const drift = (Math.random() - 0.49) * 2; 
                        
                        // 2. Determine Active Players
                        let groupBoost = 0;
                        
                        // Group Synergy: Members provide a base floor of active players
                        if (game.ownerId !== 'user') {
                            const group = appState.groups.find(g => g.id === game.ownerId);
                            if (group) {
                                // 1 active player per 500 members guaranteed
                                const baseActive = Math.floor(group.members / 500);
                                if (game.active < baseActive) {
                                    // Recover fast if below base
                                    game.active += Math.ceil((baseActive - game.active) * 0.1);
                                }
                                
                                // Visits -> Members (Realtime conversion)
                                // If people are visiting, some join the group
                                if(game.active > 0 && Math.random() < 0.005) {
                                    group.members++;
                                }
                            }
                        }

                        if (game.active === 0) {
                             if(Math.random() < 0.001) game.active = Math.floor(Math.random() * 20); 
                        } else {
                            const maxChange = Math.max(1, game.active * 0.03); 
                            const actualChange = drift * maxChange;
                            game.active = Math.floor(Math.max(0, game.active + actualChange));
                        }
                        
                        // 3. Visits Accumulation
                        const newVisits = Math.ceil(game.active * 0.5);
                        game.visits += newVisits;

                        // 4. Stats Growth 
                        if (newVisits > 0) {
                            if (Math.random() < 0.02) game.likes++;
                            if (Math.random() < 0.01) game.favorites++;
                            if (Math.random() < 0.001) game.dislikes++;
                        }

                        // 5. Followers from Visits
                        if (!game.isDemo && newVisits > 0 && Math.random() < 0.02) { 
                             appState.user.followers++;
                        }

                        // 6. Events Simulation
                        if (game.events && game.events.length > 0) {
                            game.events.forEach(ev => {
                                if(Math.random() < 0.05) {
                                    ev.interested += Math.floor(Math.random() * 5) + 1;
                                    // Events drive group members heavily
                                    if(game.ownerId !== 'user' && Math.random() < 0.6) {
                                        const grp = appState.groups.find(g => g.id === game.ownerId);
                                        if(grp) grp.members++;
                                    }
                                }
                            });
                        }

                        // 7. Visits -> Robux
                        if (!game.isDemo && game.active > 0 && Math.random() < 0.05) {
                            appState.user.robux++;
                        }

                        // LIVE DOM UPDATE
                        const activeEl = document.getElementById(`live-active-${game.id}`);
                        if (activeEl) activeEl.innerText = app.formatNumber(game.active);
                        const visitEl = document.getElementById(`live-visits-${game.id}`);
                        if (visitEl) visitEl.innerText = `${app.formatNumber(game.visits)} Visits`;
                    });

                    // Simulate Groups (Bot Reactions)
                    appState.groups.forEach(group => {
                        if(group.announcements) {
                            group.announcements.forEach(ann => {
                                const age = Date.now() - ann.timestamp;
                                if(age < 600000) { 
                                    if(Math.random() < 0.1) ann.likes++;
                                    if(Math.random() < 0.05) {
                                        const bots = ["Noob123", "Guest99", "FanBoy", "RbxLover", "CoolGuy", "Sniper", "Gamer"];
                                        ann.comments.push({
                                            user: bots[Math.floor(Math.random()*bots.length)],
                                            text: ["Awesome!", "Hype!", "Can't wait!", "Finally!", "Best group ever!"][Math.floor(Math.random()*5)]
                                        });
                                        if(appState.view === 'group_details' && appState.currentGroupId === group.id) app.render(false);
                                    }
                                }
                            });
                        }
                        // Random organic group growth
                        if(Math.random() < 0.01) group.members++;
                    });

                    app.updateHeader();
                }, 1000);
            },

            // Actions
            createGame: (name, genre, description, ownerId, iconFile, thumbFile) => {
                const isGroup = ownerId !== 'user';
                let creatorName = appState.user.username;
                if(isGroup) {
                    const g = appState.groups.find(gr => gr.id === ownerId);
                    if(g) creatorName = g.name;
                }

                const seed = name.replace(/\s/g, '') + Date.now(); 

                const newGame = {
                    id: `game_${Date.now()}`,
                    name: name || "Untitled Game",
                    description: description || "No description provided.",
                    genre: genre,
                    visits: 0,
                    active: 0,
                    favorites: 0,
                    likes: 0,
                    dislikes: 0,
                    created: new Date().toLocaleDateString(),
                    icon: iconFile ? URL.createObjectURL(iconFile) : `https://picsum.photos/seed/${seed}/300/300`,
                    thumbnail: thumbFile ? URL.createObjectURL(thumbFile) : `https://picsum.photos/seed/${seed}_thumb/768/432`,
                    creatorName: creatorName,
                    ownerId: ownerId,
                    isDemo: false,
                    gamepasses: [],
                    events: []
                };
                appState.games.push(newGame);
                app.showToast("Game Created Successfully!");
                if(isGroup) app.navigate('group_details', ownerId);
                else app.navigate('devhub');
            },

            createEvent: (gameId, title, desc) => {
                const game = appState.games.find(g => g.id === gameId);
                if(game) {
                    if(!game.events) game.events = [];
                    game.events.unshift({
                        id: Date.now(),
                        title,
                        description: desc,
                        interested: 1,
                        date: new Date().toLocaleDateString()
                    });
                    game.active += 50; 
                    app.showToast("Event Published!");
                    app.render();
                }
            },

            createGroup: (name, desc) => {
                if(appState.user.robux < 100) {
                    app.showToast("Need 100 Robux to create a group!", "error");
                    return;
                }
                appState.user.robux -= 100;
                const newGroup = {
                    id: `group_${Date.now()}`,
                    name: name,
                    description: desc,
                    members: 1,
                    icon: `https://picsum.photos/seed/${name}/150/150`,
                    announcements: []
                };
                appState.groups.push(newGroup);
                app.showToast(`Group "${name}" created!`);
                app.navigate('groups');
            },

            postAnnouncement: (groupId, text) => {
                const group = appState.groups.find(g => g.id === groupId);
                if(group && text.trim().length > 0) {
                    group.announcements.unshift({
                        id: Date.now(),
                        text: text,
                        author: appState.user.username,
                        timestamp: Date.now(),
                        likes: 0,
                        comments: []
                    });
                    app.showToast("Announcement Posted!");
                    app.render();
                }
            },

            createGamepass: (gameId, name, price) => {
                const game = appState.games.find(g => g.id === gameId);
                if (game) {
                    game.gamepasses.push({
                        id: `gp_${Date.now()}`,
                        name: name,
                        price: parseInt(price),
                        sales: 0,
                        image: "https://via.placeholder.com/150"
                    });
                    app.showToast("Gamepass Created!");
                    app.render(); 
                }
            },

            buyGamepass: (gameId, gpId) => {
                const allGames = [...appState.games, ...appState.demoGames];
                const game = allGames.find(g => g.id === gameId);
                if(!game) return;
                const gp = game.gamepasses.find(p => p.id === gpId);
                
                if (appState.user.robux >= gp.price) {
                    appState.user.robux -= gp.price;
                    gp.sales++;
                    if (!game.isDemo) {
                        const revenue = Math.floor(gp.price * 0.7);
                        appState.user.robux += revenue; 
                        app.showToast(`Sale! +${revenue} R$ from ${gp.name}`);
                    } else {
                        app.showToast(`Bought ${gp.name}!`);
                    }
                    app.updateHeader();
                    app.render(); 
                } else {
                    app.showToast("Not enough Robux!", "error");
                }
            },
            
            runAd: (gameId, type) => {
                const game = appState.games.find(g => g.id === gameId);
                
                if (type === 'free') {
                    if (appState.user.usedFreeSponsor) {
                        app.showToast("You already used your One-Time Free Sponsor!", "error");
                        return;
                    }
                    appState.user.usedFreeSponsor = true;
                    game.active += 5000; 
                    game.visits += 10000;
                    app.showToast(`MEGA SPONSOR ACTIVE! ${game.name} is blowing up!`);
                    app.updateHeader();
                    return;
                }

                if (appState.user.robux >= 50) {
                    appState.user.robux -= 50;
                    game.active += Math.floor(Math.random() * 100) + 50; 
                    app.showToast(`Ad Campaign Started for ${game.name}!`);
                    app.updateHeader();
                } else {
                    app.showToast("Need 50 R$ to run ad", "error");
                }
            },

            convertRobux: (amount) => {
                const rate = 0.0035; 
                if (appState.user.robux >= amount && amount > 0) {
                    appState.user.robux -= amount;
                    appState.user.usd += (amount * rate);
                    app.showToast(`Cashed out ${amount} R$ for $${(amount*rate).toFixed(2)} USD`);
                    app.render();
                    app.updateHeader();
                }
            },

            launchGame3D: (gameId) => {
                const allGames = [...appState.games, ...appState.demoGames];
                const game = allGames.find(g => g.id === gameId);
                if(!game) return;
                
                document.getElementById('game-view').style.display = 'block';
                document.getElementById('game-playing-name').innerText = game.name;
                threeApp.init(gameId);
            },

            markMessageRead: (id) => {
                const msg = appState.messages.find(m => m.id === id);
                if(msg) {
                    msg.read = true;
                    app.render();
                }
            },

            changeAvatarColor: (color) => {
                appState.user.avatarColor = color;
                app.showToast("Avatar Updated!");
                const navImg = document.getElementById('nav-avatar-img');
                if(navImg) navImg.style.filter = `hue-rotate(${Math.random() * 360}deg)`; 
                app.render();
            },

            formatNumber: (num) => {
                if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B+';
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M+';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K+';
                return Math.floor(num).toString();
            },

            showToast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                let colorClass = 'bg-[#00b06f]';
                if (type === 'error') colorClass = 'bg-red-500';
                
                toast.className = `px-4 py-3 rounded-lg shadow-xl text-white text-sm font-bold animate-bounce ${colorClass} flex items-center gap-2 border border-white/10`;
                toast.innerHTML = msg;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            },

            updateHeader: () => {
                const rbEl = document.getElementById('nav-robux');
                if(rbEl) rbEl.innerText = app.formatNumber(appState.user.robux);
                const userEl = document.getElementById('nav-username');
                if(userEl) userEl.innerText = appState.user.username;
            },

            // --- Renderers ---
            
            render: (fullRender = true) => {
                const container = document.getElementById('main-content');
                if(document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;

                let html = '';

                switch(appState.view) {
                    case 'home': html = app.views.home(); break;
                    case 'profile': html = app.views.profile(); break;
                    case 'devhub': html = app.views.devhub(); break;
                    case 'game': html = app.views.game(appState.currentGameId); break;
                    case 'robux': html = app.views.robux(); break;
                    case 'messages': html = app.views.messages(); break;
                    case 'groups': html = app.views.groups(); break;
                    case 'group_details': html = app.views.group_details(appState.currentGroupId); break;
                    case 'avatar': html = app.views.avatar(); break;
                    case 'marketplace': html = app.views.marketplace(); break;
                    case 'inventory': html = `<div class="text-center text-gray-500 mt-10">Inventory Empty</div>`; break;
                }
                container.innerHTML = html;
            },

            views: {
                home: () => {
                    const allGames = [...appState.games, ...appState.demoGames];
                    const filtered = allGames.filter(g => g.name.toLowerCase().includes(appState.searchTerm));

                    return `
                        <div class="max-w-7xl mx-auto">
                            <h2 class="text-3xl font-bold mb-6 text-white">Home</h2>
                            
                            <h3 class="text-xl font-bold mb-4 text-white">Recommended for You</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                ${filtered.length > 0 ? filtered.map(game => `
                                    <div class="cursor-pointer group" onclick="app.navigate('game', '${game.id}')">
                                        <div class="aspect-square rounded-xl overflow-hidden relative mb-2 shadow-sm bg-[#2b2d31]">
                                            <img src="${game.icon}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 opacity-90 group-hover:opacity-100" loading="lazy">
                                        </div>
                                        <h4 class="font-bold text-white text-base truncate group-hover:underline">${game.name}</h4>
                                        <div class="text-xs text-gray-400 flex items-center gap-1 mt-1">
                                            <i class="fas fa-thumbs-up text-[10px]"></i> ${(game.likes / (game.likes + game.dislikes || 1) * 100).toFixed(0)}%
                                            <span class="ml-2 flex items-center gap-1">
                                                <i class="fas fa-user text-[10px]"></i> 
                                                <span id="live-active-${game.id}">${app.formatNumber(game.active)}</span>
                                            </span>
                                        </div>
                                    </div>
                                `).join('') : '<div class="col-span-full text-center text-gray-500 py-10">No games found.</div>'}
                            </div>
                        </div>
                    `;
                },

                group_details: (groupId) => {
                    const group = appState.groups.find(g => g.id === groupId);
                    if(!group) return "Group Not Found";
                    
                    const groupGames = appState.games.filter(g => g.ownerId === groupId);

                    return `
                        <div class="max-w-5xl mx-auto">
                            <div class="rbx-card p-6 mb-6">
                                <div class="flex gap-6 items-center">
                                    <div class="w-32 h-32 bg-black rounded-lg overflow-hidden border border-[#393b3d]">
                                        <img src="${group.icon}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1">
                                        <h2 class="text-3xl font-bold text-white mb-2">${group.name}</h2>
                                        <div class="text-gray-400 mb-2">${group.description}</div>
                                        <div class="text-sm text-gray-500">${app.formatNumber(group.members)} Members</div>
                                        <div class="mt-4 flex gap-3">
                                            <button onclick="document.getElementById('create-modal').classList.remove('hidden')" class="bg-[#00b06f] hover:bg-[#009960] text-white px-4 py-1.5 rounded font-bold text-sm">Create Experience</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2 space-y-6">
                                    <div class="rbx-card p-4">
                                        <h3 class="font-bold text-lg mb-3">Shout</h3>
                                        <div class="flex gap-2">
                                            <input id="shout-input" type="text" placeholder="Enter shout..." class="flex-1 rbx-input p-2 text-sm">
                                            <button onclick="app.postAnnouncement('${group.id}', document.getElementById('shout-input').value); document.getElementById('shout-input').value=''" class="bg-[#393b3d] hover:bg-[#45484d] text-white px-4 py-1 rounded font-bold text-sm">Post</button>
                                        </div>
                                    </div>

                                    <div class="space-y-4">
                                        ${group.announcements && group.announcements.length > 0 ? group.announcements.map(ann => `
                                            <div class="rbx-card p-4">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <div class="w-8 h-8 bg-gray-600 rounded-full overflow-hidden">
                                                        <img src="https://tr.rbxcdn.com/38c6edcb50633730ff4cf39ac8859840/150/150/AvatarHeadshot/Png" class="w-full h-full">
                                                    </div>
                                                    <div>
                                                        <div class="font-bold text-sm text-blue-400 hover:underline cursor-pointer">${ann.author}</div>
                                                        <div class="text-xs text-gray-500">${new Date(ann.timestamp).toLocaleTimeString()}</div>
                                                    </div>
                                                </div>
                                                <div class="text-gray-300 text-sm mb-3 pl-11">
                                                    ${ann.text}
                                                </div>
                                                <div class="flex gap-4 pl-11 text-xs text-gray-500">
                                                    <span><i class="fas fa-heart mr-1"></i> ${ann.likes} Likes</span>
                                                    <span>${ann.comments.length} Comments</span>
                                                </div>
                                                ${ann.comments.length > 0 ? `
                                                    <div class="mt-3 pl-11 space-y-2 border-t border-[#393b3d] pt-2">
                                                        ${ann.comments.slice(-3).map(c => `
                                                            <div class="text-xs text-gray-400"><span class="font-bold text-white">${c.user}:</span> ${c.text}</div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('') : '<div class="text-center text-gray-500 py-4">No shouts yet.</div>'}
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold text-lg mb-3">Experiences</h3>
                                    <div class="space-y-3">
                                        ${groupGames.length > 0 ? groupGames.map(g => `
                                            <div class="rbx-card p-2 flex gap-3 cursor-pointer hover:bg-[#323438]" onclick="app.navigate('game', '${g.id}')">
                                                <div class="w-16 h-16 bg-gray-800 rounded-lg overflow-hidden flex-shrink-0">
                                                    <img src="${g.icon}" class="w-full h-full object-cover">
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-bold text-sm truncate">${g.name}</div>
                                                    <div class="text-xs text-green-400">${app.formatNumber(g.active)} Active</div>
                                                </div>
                                            </div>
                                        `).join('') : '<div class="text-gray-500 text-sm">No games yet.</div>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Create Game Modal Reused but pre-filled -->
                        <div id="create-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div class="rbx-card p-6 w-full max-w-md relative bg-[#2b2d31] shadow-2xl">
                                <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="document.getElementById('create-modal').classList.add('hidden')"><i class="fas fa-times text-xl"></i></button>
                                <h3 class="text-2xl font-bold mb-6 text-white">Create Group Experience</h3>
                                <div class="space-y-4">
                                    <input id="new-game-name" type="text" placeholder="Experience Name" class="w-full rbx-input p-3">
                                    <textarea id="new-game-desc" placeholder="Description" class="w-full rbx-input p-3 h-24"></textarea>
                                    <input type="hidden" id="new-game-owner" value="${groupId}">
                                    <select id="new-game-genre" class="w-full rbx-input p-3">
                                        <option>Adventure</option>
                                        <option>Fighting</option>
                                        <option>Obby</option>
                                        <option>Tycoon</option>
                                        <option>Simulator</option>
                                    </select>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Icon (Optional)</label>
                                        <input id="new-game-icon" type="file" accept="image/*" class="w-full text-sm text-gray-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Thumbnail (Optional)</label>
                                        <input id="new-game-thumb" type="file" accept="image/*" class="w-full text-sm text-gray-500">
                                    </div>
                                    <button onclick="app.createGame(document.getElementById('new-game-name').value, document.getElementById('new-game-genre').value, document.getElementById('new-game-desc').value, document.getElementById('new-game-owner').value, document.getElementById('new-game-icon').files[0], document.getElementById('new-game-thumb').files[0]); document.getElementById('create-modal').classList.add('hidden')" class="w-full bg-[#00b06f] py-3 rounded-lg font-bold text-white hover:bg-[#009960] transition shadow-md">Create Experience</button>
                                </div>
                            </div>
                        </div>
                    `;
                },

                // ... other views (profile, robux etc same as before)
                profile: () => {
                    const isVerified = appState.user.followers >= 100000;
                    return `
                        <div class="max-w-5xl mx-auto rbx-card p-6 md:p-8 relative bg-[#2b2d31]">
                            <div class="flex flex-col md:flex-row gap-8 items-center md:items-start border-b border-[#393b3d] pb-8">
                                <div class="w-32 h-32 md:w-40 md:h-40 rounded-full overflow-hidden border-4 border-[#393b3d] bg-gray-600">
                                     <img src="https://tr.rbxcdn.com/38c6edcb50633730ff4cf39ac8859840/150/150/AvatarHeadshot/Png" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 text-center md:text-left">
                                    <h2 class="text-3xl font-extrabold flex items-center justify-center md:justify-start gap-2 text-white">
                                        ${appState.user.username} 
                                        ${isVerified ? '<span class="verified-badge w-6 h-6 text-sm" title="Verified Creator"><i class="fas fa-check"></i></span>' : ''}
                                    </h2>
                                    <p class="text-gray-400 mt-1 italic">"${appState.user.status}"</p>
                                    
                                    <div class="flex gap-8 mt-6 justify-center md:justify-start text-sm">
                                        <div class="text-center md:text-left">
                                            <div class="font-bold text-xl text-white">${app.formatNumber(appState.user.followers)}</div>
                                            <div class="text-gray-500 text-xs uppercase tracking-wide font-bold">Followers</div>
                                        </div>
                                        <div class="text-center md:text-left">
                                            <div class="font-bold text-xl text-white">24</div>
                                            <div class="text-gray-500 text-xs uppercase tracking-wide font-bold">Following</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-xl font-bold mb-6 text-white">Creations</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                     ${appState.games.map(game => `
                                    <div class="cursor-pointer group" onclick="app.navigate('game', '${game.id}')">
                                        <div class="aspect-square rounded-xl overflow-hidden mb-3 border border-[#393b3d] shadow-sm relative">
                                            <img src="${game.icon}" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                        </div>
                                        <h4 class="font-bold text-white text-base truncate group-hover:underline">${game.name}</h4>
                                        <div class="text-xs text-gray-500 mt-1" id="live-visits-${game.id}">
                                            ${app.formatNumber(game.visits)} Visits
                                        </div>
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                },
                messages: () => {
                     return `
                        <div class="max-w-4xl mx-auto rbx-card p-0 overflow-hidden">
                            <h2 class="text-2xl font-bold p-6 bg-[#2b2d31] border-b border-[#393b3d]">Messages</h2>
                            <div class="divide-y divide-[#393b3d]">
                                ${appState.messages.length === 0 ? '<div class="p-6 text-center text-gray-500">No messages</div>' : ''}
                                ${appState.messages.map(msg => `
                                    <div class="p-4 hover:bg-[#323438] cursor-pointer transition flex gap-4 ${msg.read ? 'opacity-60' : 'bg-[#2b2d31] border-l-4 border-blue-500'}" onclick="app.markMessageRead(${msg.id})">
                                        <div class="w-12 h-12 bg-gray-600 rounded-full flex-shrink-0 overflow-hidden">
                                            <img src="https://tr.rbxcdn.com/38c6edcb50633730ff4cf39ac8859840/150/150/AvatarHeadshot/Png" class="w-full h-full">
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex justify-between">
                                                <span class="font-bold text-white">${msg.subject}</span>
                                                <span class="text-xs text-gray-500">Yesterday</span>
                                            </div>
                                            <div class="text-sm text-gray-400">From: ${msg.from}</div>
                                            <div class="text-sm text-gray-300 mt-1">${msg.body}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                },
                groups: () => {
                    return `
                        <div class="max-w-4xl mx-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-bold text-white">My Groups</h2>
                                <button onclick="document.getElementById('create-group-modal').classList.remove('hidden')" class="bg-[#00b06f] text-white px-4 py-2 rounded font-bold hover:bg-[#009960]">Create Group (100 R$)</button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${appState.groups.length === 0 ? '<div class="col-span-full text-center py-10 text-gray-500">You are not in any groups.</div>' : ''}
                                ${appState.groups.map(group => `
                                    <div class="rbx-card p-4 flex gap-4 items-center cursor-pointer hover:bg-[#323438]" onclick="app.navigate('group_details', '${group.id}')">
                                        <div class="w-20 h-20 bg-gray-700 rounded-lg overflow-hidden">
                                            <img src="${group.icon}" class="w-full h-full object-cover">
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-bold text-xl text-white">${group.name}</h3>
                                            <div class="text-sm text-gray-400">${app.formatNumber(group.members)} Members</div>
                                            <div class="text-xs text-gray-500 mt-1">${group.description}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Create Group Modal -->
                        <div id="create-group-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[60] flex items-center justify-center p-4">
                            <div class="rbx-card p-6 w-full max-w-md relative bg-[#2b2d31]">
                                <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="document.getElementById('create-group-modal').classList.add('hidden')"><i class="fas fa-times"></i></button>
                                <h3 class="text-xl font-bold mb-4 text-white">Create New Group</h3>
                                <input id="new-group-name" type="text" placeholder="Group Name" class="w-full rbx-input p-3 mb-3">
                                <textarea id="new-group-desc" placeholder="Description" class="w-full rbx-input p-3 mb-3 h-24"></textarea>
                                <button onclick="app.createGroup(document.getElementById('new-group-name').value, document.getElementById('new-group-desc').value); document.getElementById('create-group-modal').classList.add('hidden')" class="w-full bg-[#00b06f] py-3 rounded font-bold text-white hover:bg-[#009960]">Purchase (100 R$)</button>
                            </div>
                        </div>
                    `;
                },
                marketplace: () => {
                     return `
                         <div class="max-w-6xl mx-auto">
                            <h2 class="text-3xl font-bold mb-6 text-white">Marketplace</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                ${[...Array(12)].map((_, i) => `
                                    <div class="rbx-card p-2 cursor-pointer hover:bg-[#323438] transition">
                                        <div class="aspect-square bg-gray-700 rounded-lg mb-2 overflow-hidden">
                                             <img src="https://picsum.photos/seed/item${i}/200/200" class="w-full h-full object-cover">
                                        </div>
                                        <div class="font-bold text-sm text-white truncate">Cool Item ${i+1}</div>
                                        <div class="text-xs text-gray-400">By Peyza</div>
                                        <div class="font-bold text-sm text-white mt-1"><i class="fas fa-hexagon text-xs"></i> ${50 + i * 10}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                },
                avatar: () => {
                    return `
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-3xl font-bold mb-6 text-white">Avatar Editor</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="flex justify-center">
                                    <div class="w-64 h-80 bg-[#1a1c1e] rounded-lg border border-[#393b3d] flex items-center justify-center relative overflow-hidden">
                                        <div class="w-32 h-32 bg-gray-300 rounded-full mb-10 relative z-10" style="background-color: ${appState.user.avatarColor}"></div>
                                        <div class="w-40 h-48 bg-gray-700 absolute bottom-0 rounded-t-3xl"></div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-bold text-xl mb-4">Body Colors</h3>
                                    <div class="flex gap-2 flex-wrap mb-8">
                                        ${['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#ecf0f1', '#34495e'].map(c => `
                                            <div class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border-2 border-transparent hover:border-white" style="background-color: ${c}" onclick="app.changeAvatarColor('${c}')"></div>
                                        `).join('')}
                                    </div>
                                    <h3 class="font-bold text-xl mb-4">Recent Items</h3>
                                    <div class="text-gray-500 italic">No items available. Visit Marketplace.</div>
                                </div>
                            </div>
                        </div>
                    `;
                },
                game: (gameId) => {
                    const allGames = [...appState.games, ...appState.demoGames];
                    const game = allGames.find(g => g.id === gameId);
                    if (!game) return "Game not found";
                    const isOwner = game.ownerId === 'user' || appState.groups.find(gr => gr.id === game.ownerId);

                    const likeRatio = Math.round((game.likes / (game.likes + game.dislikes || 1)) * 100);

                    return `
                        <div class="max-w-6xl mx-auto">
                            <div class="flex flex-col lg:flex-row gap-8 mb-8">
                                <div class="w-full lg:w-[700px] aspect-video bg-[#000] rounded-xl overflow-hidden shadow-lg relative group border border-[#393b3d]">
                                    <img src="${game.thumbnail}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition">
                                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition bg-black bg-opacity-40 pointer-events-none">
                                        <i class="fas fa-play text-white text-6xl shadow-xl drop-shadow-lg"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-3xl md:text-4xl font-extrabold mb-2 text-white leading-tight">${game.name}</h2>
                                    <div class="text-sm text-gray-400 mb-6 font-medium">By <a href="#" class="text-blue-400 hover:underline">@${game.creatorName}</a></div>
                                    
                                    <div class="flex gap-8 mb-8 border-t border-b border-[#393b3d] py-4">
                                        <div class="flex flex-col items-center">
                                            <div class="text-2xl font-bold text-white" id="live-active-${game.id}">${app.formatNumber(game.active)}</div>
                                            <div class="text-xs text-gray-500 uppercase tracking-wide font-bold">Active</div>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="text-2xl font-bold text-white" id="live-visits-${game.id}">${app.formatNumber(game.visits)}</div>
                                            <div class="text-xs text-gray-500 uppercase tracking-wide font-bold">Visits</div>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="text-2xl font-bold text-white flex items-center gap-1">
                                                <i class="fas fa-thumbs-up text-lg text-[#00b06f]"></i> ${likeRatio}%
                                            </div>
                                            <div class="text-xs text-gray-500 uppercase tracking-wide font-bold">Rating</div>
                                        </div>
                                    </div>

                                    <button class="w-full bg-[#00b06f] hover:bg-[#009960] text-white py-4 rounded-xl font-bold text-xl shadow-lg mb-6 flex items-center justify-center gap-3 transform transition hover:-translate-y-1 active:scale-95 active:translate-y-0" onclick="app.launchGame3D('${game.id}')">
                                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><i class="fas fa-play text-sm"></i></div>
                                        Play
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2">
                                    ${isOwner ? `
                                        <div class="rbx-card p-4 mb-6 border-blue-500/30 bg-blue-900/10">
                                            <h3 class="font-bold text-lg mb-2 text-blue-300">Developer Controls</h3>
                                            <div class="flex gap-2">
                                                <input id="event-title" type="text" placeholder="Event Title (e.g. Double XP)" class="flex-1 rbx-input p-2 text-sm">
                                                <button onclick="app.createEvent('${game.id}', document.getElementById('event-title').value, 'Limited time event!'); document.getElementById('event-title').value=''" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded font-bold text-sm">Publish Event</button>
                                            </div>
                                        </div>
                                    ` : ''}

                                    <div class="rbx-card p-6 mb-6">
                                        <h3 class="font-bold text-xl mb-4 text-white">About</h3>
                                        <p class="text-gray-300 whitespace-pre-line leading-relaxed">${game.description}</p>
                                    </div>

                                    ${game.events && game.events.length > 0 ? `
                                        <div class="rbx-card p-6 mb-6">
                                            <h3 class="font-bold text-xl mb-4 text-white">Events</h3>
                                            <div class="space-y-4">
                                                ${game.events.map(ev => `
                                                    <div class="bg-[#1a1c1e] p-3 rounded-lg border border-[#393b3d]">
                                                        <div class="flex justify-between">
                                                            <div class="font-bold text-blue-400">${ev.title}</div>
                                                            <div class="text-xs text-gray-500">${ev.date}</div>
                                                        </div>
                                                        <div class="text-sm text-gray-300 mt-1">${ev.description}</div>
                                                        <div class="text-xs text-gray-500 mt-2"><i class="fas fa-star text-yellow-500"></i> ${ev.interested} Interested</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `: ''}
                                    
                                    <h3 class="font-bold text-xl mb-4 text-white">Store</h3>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        ${game.gamepasses.length > 0 ? game.gamepasses.map(gp => `
                                            <div class="rbx-card p-4 flex gap-4 items-center shadow-sm hover:bg-[#323438] transition border border-[#393b3d]">
                                                <div class="w-16 h-16 bg-gray-700 rounded-lg overflow-hidden">
                                                    <img src="${gp.image}" class="w-full h-full object-cover">
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-bold text-white truncate">${gp.name}</div>
                                                    <button class="mt-2 bg-white text-black text-xs font-bold px-4 py-1.5 rounded-lg w-full hover:bg-gray-200 transition" onclick="app.buyGamepass('${game.id}', '${gp.id}')">
                                                        <i class="fas fa-hexagon text-[10px] mr-1"></i> ${gp.price}
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('') : '<div class="col-span-full text-gray-500 italic">No items for sale.</div>'}
                                        
                                        ${!game.isDemo ? `
                                        <div class="rbx-card p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-[#323438] border-2 border-dashed border-[#393b3d] text-gray-500 hover:text-gray-300 transition" onclick="app.navigate('devhub')">
                                            <i class="fas fa-plus text-2xl mb-1"></i>
                                            <span class="text-sm font-bold">Add Pass</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="hidden lg:block">
                                    <div class="rbx-card p-6 sticky top-20">
                                        <h4 class="font-bold text-white mb-4">Game Stats</h4>
                                        <ul class="text-sm text-gray-400 space-y-3 font-medium">
                                            <li class="flex justify-between border-b border-[#393b3d] pb-2"><span>Favorites</span> <span class="text-white">${app.formatNumber(game.favorites)}</span></li>
                                            <li class="flex justify-between border-b border-[#393b3d] pb-2"><span>Likes</span> <span class="text-white">${app.formatNumber(game.likes)}</span></li>
                                            <li class="flex justify-between"><span>Dislikes</span> <span class="text-white">${app.formatNumber(game.dislikes)}</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                },
                devhub: () => {
                    return `
                        <div class="max-w-6xl mx-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-extrabold text-white">Developer Hub</h2>
                                <button onclick="document.getElementById('create-modal').classList.remove('hidden')" class="bg-[#00b06f] text-white px-5 py-2.5 rounded-lg font-bold hover:bg-[#009960] shadow-md transition transform active:scale-95">
                                    <i class="fas fa-plus mr-2"></i> Create Experience
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div class="col-span-1 space-y-4">
                                    <div class="rbx-card p-5 border-l-4 border-blue-500 shadow-sm">
                                        <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Total Visits</div>
                                        <div class="text-3xl font-bold text-white mt-1">
                                            ${app.formatNumber(appState.games.reduce((acc, g) => acc + g.visits, 0))}
                                        </div>
                                    </div>
                                </div>

                                <div class="col-span-1 md:col-span-3">
                                    <h3 class="text-xl font-bold mb-4 text-white">My Experiences</h3>
                                    <div class="space-y-4">
                                        ${appState.games.map(game => `
                                            <div class="rbx-card p-5 flex gap-5 items-start hover:shadow-md transition bg-[#2b2d31]">
                                                <div class="w-24 h-24 bg-black rounded-lg overflow-hidden flex-shrink-0 border border-[#393b3d]">
                                                    <img src="${game.icon}" class="w-full h-full object-cover">
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex justify-between items-start">
                                                        <h4 class="font-bold text-lg text-white hover:text-blue-400 cursor-pointer truncate" onclick="app.navigate('game', '${game.id}')">${game.name}</h4>
                                                        <span class="text-xs bg-green-900 text-green-200 px-2 py-1 rounded font-bold">Public</span>
                                                    </div>
                                                    <div class="text-sm text-gray-400 mt-1 mb-4 line-clamp-2">${game.description}</div>
                                                    
                                                    <div class="flex flex-wrap gap-2">
                                                        <button class="px-4 py-1.5 bg-[#393b3d] text-gray-300 text-xs font-bold rounded-lg hover:bg-gray-600 transition" onclick="app.navigate('game', '${game.id}')">View Page</button>
                                                        <button class="px-4 py-1.5 bg-[#393b3d] text-gray-300 text-xs font-bold rounded-lg hover:bg-gray-600 transition" onclick="app.runAd('${game.id}', 'paid')">Run Ad (50 R$)</button>
                                                        <button class="px-4 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition" 
                                                            onclick="document.getElementById('gp-modal-gameid').value='${game.id}'; document.getElementById('gp-modal').classList.remove('hidden')">
                                                            + Add Pass
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Create Game Modal (Main Hub Version) -->
                        <div id="create-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div class="rbx-card p-6 w-full max-w-md relative bg-[#2b2d31] shadow-2xl">
                                <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="document.getElementById('create-modal').classList.add('hidden')"><i class="fas fa-times text-xl"></i></button>
                                <h3 class="text-2xl font-bold mb-6 text-white">Create New Experience</h3>
                                <div class="space-y-4">
                                    <input id="new-game-name" type="text" placeholder="Experience Name" class="w-full rbx-input p-3">
                                    <textarea id="new-game-desc" placeholder="Description" class="w-full rbx-input p-3 h-24"></textarea>
                                    <select id="new-game-owner" class="w-full rbx-input p-3">
                                        <option value="user">Me (User)</option>
                                        ${appState.groups.map(g => `<option value="${g.id}">Group: ${g.name}</option>`).join('')}
                                    </select>
                                    <select id="new-game-genre" class="w-full rbx-input p-3">
                                        <option>Adventure</option>
                                        <option>Fighting</option>
                                        <option>Obby</option>
                                        <option>Tycoon</option>
                                        <option>Simulator</option>
                                    </select>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Icon (Optional)</label>
                                        <input id="new-game-icon" type="file" accept="image/*" class="w-full text-sm text-gray-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Thumbnail (Optional)</label>
                                        <input id="new-game-thumb" type="file" accept="image/*" class="w-full text-sm text-gray-500">
                                    </div>
                                    <button onclick="app.createGame(document.getElementById('new-game-name').value, document.getElementById('new-game-genre').value, document.getElementById('new-game-desc').value, document.getElementById('new-game-owner').value, document.getElementById('new-game-icon').files[0], document.getElementById('new-game-thumb').files[0]); document.getElementById('create-modal').classList.add('hidden')" class="w-full bg-[#00b06f] py-3 rounded-lg font-bold text-white hover:bg-[#009960] transition shadow-md">Create Experience</button>
                                </div>
                            </div>
                        </div>

                         <!-- Create Gamepass Modal -->
                        <div id="gp-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[60] flex items-center justify-center p-4">
                            <div class="rbx-card p-6 w-full max-w-md relative bg-[#2b2d31]">
                                <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="document.getElementById('gp-modal').classList.add('hidden')"><i class="fas fa-times text-xl"></i></button>
                                <h3 class="text-2xl font-bold mb-6 text-white">Create Gamepass</h3>
                                <input type="hidden" id="gp-modal-gameid">
                                <div class="space-y-4">
                                    <input id="gp-name" type="text" placeholder="Pass Name" class="w-full rbx-input p-3">
                                    <input id="gp-price" type="number" placeholder="Price (Robux)" class="w-full rbx-input p-3">
                                    <button onclick="app.createGamepass(document.getElementById('gp-modal-gameid').value, document.getElementById('gp-name').value, document.getElementById('gp-price').value); document.getElementById('gp-modal').classList.add('hidden')" class="w-full bg-[#00b06f] py-3 rounded-lg font-bold text-white hover:bg-[#009960]">Put On Sale</button>
                                </div>
                            </div>
                        </div>
                    `;
                },
                robux: () => {
                    const canCashOut = appState.user.robux >= 50000;
                    return `
                        <div class="max-w-4xl mx-auto text-center pt-10">
                            <div class="mb-12">
                                <i class="fas fa-hexagon text-7xl text-white mb-6"></i>
                                <h2 class="text-4xl font-extrabold mb-2 text-white">My Balance</h2>
                                <div class="text-6xl font-bold text-[#00b06f] flex items-center justify-center gap-3">
                                    ${app.formatNumber(appState.user.robux)} <span class="text-3xl text-gray-500 font-medium self-end mb-2">Robux</span>
                                </div>
                                <div class="text-xl text-gray-500 mt-2 font-medium">$${appState.user.usd.toFixed(2)} USD Earned</div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                                <div class="rbx-card p-8 bg-[#2b2d31]">
                                    <h3 class="text-xl font-bold mb-6 text-white">Buy Robux</h3>
                                    <div class="space-y-4">
                                        <button class="w-full flex justify-between items-center p-4 border border-[#393b3d] rounded-xl hover:bg-[#323438] transition group" onclick="appState.user.robux+=400; app.render(); app.updateHeader();">
                                            <span class="font-bold text-gray-300 group-hover:text-white">400 Robux</span>
                                            <span class="bg-white text-black px-4 py-1.5 rounded-lg font-bold text-sm shadow-sm">$4.99</span>
                                        </button>
                                        <button class="w-full flex justify-between items-center p-4 border border-[#393b3d] rounded-xl hover:bg-[#323438] transition group" onclick="appState.user.robux+=800; app.render(); app.updateHeader();">
                                            <span class="font-bold text-gray-300 group-hover:text-white">800 Robux</span>
                                            <span class="bg-white text-black px-4 py-1.5 rounded-lg font-bold text-sm shadow-sm">$9.99</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="rbx-card p-8 bg-gradient-to-br from-[#1a1c1e] to-[#2b2d31] relative overflow-hidden">
                                    <h3 class="text-xl font-bold mb-2 text-white">Developer Exchange</h3>
                                    <p class="text-sm text-gray-400 mb-6 leading-relaxed">Convert your earned Robux into real cash. Minimum 50,000 Robux required.</p>
                                    <div class="mb-6 relative z-10">
                                        <div class="flex gap-2">
                                            <input id="devex-amount" type="number" value="50000" class="flex-1 rbx-input p-3 font-bold">
                                            <button class="bg-[#00b06f] text-white font-bold px-6 rounded-lg shadow-md transition ${!canCashOut ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[#009960]'}" 
                                                onclick="${canCashOut ? "app.convertRobux(parseInt(document.getElementById('devex-amount').value))" : "app.showToast('Minimum 50K Robux required', 'error')" }">
                                                Cash Out
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-center text-gray-500 font-medium">Current Rate: 1,000 R$ = $3.50 USD</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        };

        const threeApp = {
            scene: null, camera: null, renderer: null, animationId: null, cubes: [], activeGameId: null,
            init: (gameId) => {
                threeApp.activeGameId = gameId;
                const container = document.getElementById('game-canvas');
                threeApp.scene = new THREE.Scene();
                threeApp.scene.background = new THREE.Color(0x87CEEB);
                threeApp.scene.fog = new THREE.Fog(0x87CEEB, 10, 50);
                threeApp.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                threeApp.camera.position.set(0, 5, 10);
                threeApp.renderer = new THREE.WebGLRenderer({ canvas: container, antialias: true });
                threeApp.renderer.setSize(window.innerWidth, window.innerHeight);
                threeApp.scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(10, 20, 10);
                threeApp.scene.add(dirLight);
                const plane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({ color: 0x2F4F4F }));
                plane.rotation.x = -Math.PI / 2;
                threeApp.scene.add(plane);
                threeApp.scene.add(new THREE.GridHelper(100, 20));
                threeApp.cubes = [];
                for(let i=0; i<15; i++) {
                    const cube = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff }));
                    cube.position.set((Math.random() - 0.5) * 40, 1, (Math.random() - 0.5) * 40);
                    cube.userData = { speed: 0.05 + Math.random() * 0.1, direction: Math.random() * Math.PI * 2, jumpOffset: Math.random() * 10 };
                    threeApp.scene.add(cube);
                    threeApp.cubes.push(cube);
                }
                threeApp.setupControls(container);
                threeApp.animate();
            },
            setupControls: (container) => {
                let isDragging = false, prev = { x: 0, y: 0 };
                const handleStart = (x, y) => { isDragging = true; prev = { x, y }; };
                const handleMove = (x, y) => {
                    if(isDragging) {
                        const deltaX = x - prev.x;
                        const angle = deltaX * 0.01;
                        const cx = threeApp.camera.position.x, cz = threeApp.camera.position.z;
                        threeApp.camera.position.x = cx * Math.cos(angle) - cz * Math.sin(angle);
                        threeApp.camera.position.z = cx * Math.sin(angle) + cz * Math.cos(angle);
                        threeApp.camera.lookAt(0, 0, 0);
                        prev = { x, y };
                    }
                };
                container.onmousedown = (e) => handleStart(e.offsetX, e.offsetY);
                container.onmousemove = (e) => handleMove(e.offsetX, e.offsetY);
                window.onmouseup = () => isDragging = false;
                container.ontouchstart = (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY);
                container.ontouchmove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY);
                container.ontouchend = () => isDragging = false;
            },
            animate: () => {
                threeApp.animationId = requestAnimationFrame(threeApp.animate);
                const time = Date.now() * 0.001;
                threeApp.cubes.forEach(c => {
                    c.position.x += Math.cos(c.userData.direction) * c.userData.speed;
                    c.position.z += Math.sin(c.userData.direction) * c.userData.speed;
                    c.position.y = 1 + Math.abs(Math.sin(time * 3 + c.userData.jumpOffset));
                    if(Math.abs(c.position.x)>20 || Math.abs(c.position.z)>20) c.userData.direction += Math.PI;
                });
                if (Math.random() < 0.05) {
                     const game = [...appState.games, ...appState.demoGames].find(g => g.id === threeApp.activeGameId);
                     if(game) { game.visits++; if(!game.isDemo && Math.random() < 0.2) appState.user.followers++; }
                }
                threeApp.renderer.render(threeApp.scene, threeApp.camera);
            },
            stopGame: () => {
                cancelAnimationFrame(threeApp.animationId);
                document.getElementById('game-view').style.display = 'none';
                threeApp.scene = null;
                app.render();
                app.showToast("Thanks for playing!");
            }
        };

        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
