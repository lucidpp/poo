<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peyza</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        :root {
            /* Default (X Dark) */
            --bg-color: #000000;
            --text-main: #e7e9ea;
            --text-secondary: #71767b;
            --accent: #1d9bf0;
            --accent-hover: #1a8cd8;
            --border: #2f3336;
            --hover-bg: rgba(239, 243, 244, 0.1);
            --danger: #f4212e;
            --like-color: #f91880;
            --retweet-color: #00ba7c;
            --bookmark-color: #1d9bf0;
            --gold: #ffd700;
            --platinum: #e5e4e2;
            --font-stack: "TwitterChirp", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* Halloween Theme */
        body.theme-halloween {
            --bg-color: #120500;
            --text-main: #ffe0b2;
            --text-secondary: #d97706;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --border: #431407;
            --hover-bg: rgba(249, 115, 22, 0.15);
            --like-color: #ef4444;
        }

        /* Christmas Theme */
        body.theme-christmas {
            --bg-color: #020617; /* Very dark blue */
            --text-main: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #ef4444; /* Red */
            --accent-hover: #dc2626;
            --border: #1e293b;
            --hover-bg: rgba(255, 255, 255, 0.1);
            --like-color: #22c55e; /* Green likes */
        }

        /* Thanksgiving Theme */
        body.theme-thanksgiving {
            --bg-color: #1c1917; /* Warm dark grey */
            --text-main: #fef3c7;
            --text-secondary: #a8a29e;
            --accent: #d97706; /* Amber */
            --accent-hover: #b45309;
            --border: #44403c;
            --hover-bg: rgba(217, 119, 6, 0.15);
        }

        @font-face {
            font-family: 'TwitterChirp';
            src: local('Segoe UI'), local('Roboto');
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-stack);
            overflow-y: scroll;
            height: 100vh;
            overscroll-behavior-y: contain;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Falling Particles Container */
        #particles {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            top: -50px;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(360deg); }
        }

        /* Scrollbar aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            color: inherit;
        }

        /* Modern Inputs */
        input, textarea, select {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
            font-family: inherit;
            font-size: 16px;
            transition: 0.2s;
        }
        
        textarea:focus, input:focus {
            outline: 2px solid var(--accent);
            border-color: transparent;
            background: rgba(0,0,0,0.5);
        }

        /* Animations */
        @keyframes like-bounce {
            0% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pop-number {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-5px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .animate-like { animation: like-bounce 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .number-pop { animation: pop-number 0.3s ease-out; }
        .msg-slide { animation: slide-up 0.3s ease-out forwards; }
        
        /* Pull to Refresh */
        #refresh-spinner {
            height: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: height 0.2s;
        }
        .spinner-icon {
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .p-4 { padding: 16px; }
        .border-b { border-bottom: 1px solid var(--border); }
        .text-gray { color: var(--text-secondary); }
        .text-bold { font-weight: 700; }
        .text-sm { font-size: 14px; }
        .text-xl { font-size: 20px; }
        .w-full { width: 100%; }
        .rounded-full { border-radius: 9999px; }

        /* Auth Screen */
        #auth-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .auth-box {
            width: 100%;
            max-width: 400px;
            padding: 30px;
            border-radius: 16px;
        }
        
        .logo-large {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 12px;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 15px;
            margin-top: 10px;
            background: white;
            color: black;
            transition: 0.2s;
        }

        .auth-btn:hover { background: #dcdcdc; }
        
        .auth-btn.outline {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--border);
        }
        
        .auth-btn.outline:hover { background: rgba(29, 155, 240, 0.1); }

        /* Main Layout */
        #app-layout {
            display: flex;
            max-width: 1265px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* Sidebar (Desktop) */
        header {
            width: 275px;
            padding: 0 12px;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            border-right: 1px solid var(--border);
            align-items: flex-start;
        }

        .logo-container {
            padding: 12px;
            width: fit-content;
            margin-bottom: 4px;
        }
        .logo-container img {
            width: 45px;
            height: 45px;
            border-radius: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px 12px 12px;
            border-radius: 30px;
            font-size: 20px;
            margin-bottom: 4px;
            width: fit-content;
            transition: 0.2s;
            color: var(--text-main);
            text-decoration: none;
        }

        .nav-item:hover { background-color: var(--hover-bg); }
        .nav-item svg { width: 26px; height: 26px; margin-right: 16px; fill: currentColor; }
        .nav-item.active { font-weight: 700; }
        .nav-item.active svg { fill: var(--text-main); stroke-width: 0.5px; }

        .tweet-btn-large {
            background-color: var(--accent);
            color: white;
            border-radius: 30px;
            padding: 15px 0;
            font-size: 17px;
            font-weight: bold;
            width: 90%;
            margin-top: 16px;
            box-shadow: 0 4px 10px rgba(29, 155, 240, 0.3);
            transition: background-color 0.2s;
        }
        .tweet-btn-large:hover { background-color: var(--accent-hover); }

        .mini-profile {
            margin-top: auto;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
        }
        .mini-profile:hover { background-color: var(--hover-bg); }
        .mini-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; border: 1px solid #333; }

        /* Account Switcher Dropdown */
        .account-switcher-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000;
            display: none;
            background: rgba(0,0,0,0.5);
        }
        .account-menu {
            position: absolute;
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
            z-index: 1001;
            display: none;
            overflow: hidden;
            width: 300px;
        }
        /* Mobile specific positioning */
        @media (max-width: 500px) {
            .account-menu {
                bottom: 0;
                left: 0;
                width: 100%;
                border-radius: 16px 16px 0 0;
                border-bottom: none;
            }
        }
        /* Desktop specific positioning */
        @media (min-width: 501px) {
            .account-menu {
                bottom: 80px;
                left: 20px;
            }
        }

        .account-menu-item {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .account-menu-item:hover { background: var(--hover-bg); }
        .account-menu-item:last-child { border-bottom: none; }

        /* Verified Badge */
        .verified-badge {
            width: 18px;
            height: 18px;
            fill: var(--accent);
            margin-left: 4px;
            vertical-align: text-bottom;
        }
        .verified-badge.gold { fill: var(--gold); }

        /* Main Feed Area */
        main {
            width: 600px;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            padding-bottom: 60px; /* Space for mobile nav */
        }

        .header-sticky {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(12px);
            padding: 0 16px;
            height: 53px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 10;
            font-weight: 700;
            font-size: 20px;
            cursor: pointer;
        }

        /* Theme Card */
        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px;
        }
        .theme-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background: rgba(255,255,255,0.05);
        }
        .theme-card:hover { border-color: var(--accent); }
        .theme-card.active { border-color: var(--accent); background: rgba(29, 155, 240, 0.1); }
        .theme-icon { font-size: 32px; margin-bottom: 10px; display: block; }

        /* Post Styles */
        .post {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            animation: fade-in 0.4s ease-out;
        }
        .post:hover { background-color: var(--hover-bg); }
        .post-content { width: 100%; }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 2px; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 4px; color: var(--text-secondary); font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-name { color: var(--text-main); font-weight: 700; display: flex; align-items: center;}
        .user-handle { color: var(--text-secondary); }
        .post-text { font-size: 15px; line-height: 20px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-main); }
        .post-image {
            width: 100%;
            margin-top: 12px;
            border-radius: 16px;
            border: 1px solid var(--border);
            max-height: 500px;
            object-fit: cover;
        }
        .post-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            max-width: 425px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            transition: 0.2s;
            group: true;
            padding: 6px;
            border-radius: 50px;
            margin-left: -8px; 
            cursor: pointer;
        }
        .stat-item span { padding: 0 4px; font-variant-numeric: tabular-nums; }
        .stat-item:hover { color: var(--accent); background-color: var(--hover-bg); }
        
        /* Interactive States */
        .stat-item.like-btn:hover { color: var(--like-color); background-color: rgba(249, 24, 128, 0.1); }
        .stat-item.like-btn.liked { color: var(--like-color); }
        .stat-item.like-btn.liked svg { fill: var(--like-color); }
        
        .stat-item.retweet-btn:hover { color: var(--retweet-color); background-color: rgba(0, 186, 124, 0.1); }
        .stat-item.retweet-btn.retweeted { color: var(--retweet-color); }
        .stat-item.retweet-btn.retweeted svg { fill: var(--retweet-color); }

        .stat-item.bookmark-btn:hover { color: var(--bookmark-color); background-color: rgba(29, 155, 240, 0.1); }
        .stat-item.bookmark-btn.bookmarked { color: var(--bookmark-color); }
        .stat-item.bookmark-btn.bookmarked svg { fill: var(--bookmark-color); }

        .stat-icon { width: 18px; height: 18px; fill: currentColor; }

        /* Detailed Post View */
        .detail-container { padding: 0 16px; border-bottom: 1px solid var(--border); }
        .detail-header { display: flex; gap: 12px; align-items: center; padding-top: 12px; }
        .detail-user { display: flex; flex-direction: column; }
        .detail-text { font-size: 23px; line-height: 28px; margin: 16px 0; white-space: pre-wrap; }
        .detail-meta { padding: 16px 0; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-size: 15px; }
        .detail-meta span { color: var(--text-main); font-weight: 700; margin-left: 4px; }
        .detail-stats { padding: 16px 0; border-bottom: 1px solid var(--border); display: flex; gap: 20px; }
        .detail-actions { padding: 6px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-around; }
        .detail-actions .stat-item { padding: 10px; }
        .detail-actions .stat-icon { width: 22.5px; height: 22.5px; }

        /* Messaging */
        .message-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .message-row:hover { background: var(--hover-bg); }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 53px); /* Fallback */
            height: calc(100dvh - 53px); /* Modern mobile viewport */
            position: relative;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 80px; /* Space for input */
        }
        .chat-bubble {
            max-width: 75%;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 20px;
            position: relative;
            word-wrap: break-word;
            cursor: pointer;
        }
        .chat-bubble.sent {
            align-self: flex-end;
            background-color: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.received {
            align-self: flex-start;
            background-color: #2f3336;
            color: white;
            border-bottom-left-radius: 4px;
        }
        .chat-status {
            align-self: flex-end;
            font-size: 11px;
            color: var(--text-secondary);
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .chat-reaction {
            position: absolute;
            bottom: -10px;
            right: 0;
            background: #202327;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
        }
        .chat-input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-color);
            border-top: 1px solid var(--border);
            padding: 10px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 20;
        }
        
        .reaction-menu {
            position: absolute;
            background: #16181c;
            border-radius: 20px;
            padding: 8px;
            display: flex;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 50;
        }
        .reaction-emoji { font-size: 20px; cursor: pointer; transition: 0.2s; }
        .reaction-emoji:hover { transform: scale(1.3); }

        /* Right Sidebar */
        aside {
            width: 350px;
            padding: 12px 0 0 30px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 100vh;
        }
        .search-bar {
            background-color: #202327;
            border-radius: 25px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            position: sticky;
            top: 5px;
            z-index: 5;
            border: 1px solid transparent;
        }
        .search-bar:focus-within {
            background-color: var(--bg-color);
            border: 1px solid var(--accent);
        }
        .search-bar input {
            background: transparent;
            border: none;
            color: var(--text-main);
            width: 100%;
            outline: none;
            padding: 0;
            font-size: 15px;
        }
        .widget {
            background-color: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .widget h2 { font-size: 20px; font-weight: 800; margin-bottom: 12px; padding: 0 0 4px 0; }
        .trend-item { padding: 12px 0; cursor: pointer; transition: 0.2s; }
        .trend-item:hover { background-color: var(--hover-bg); }
        .trend-meta { font-size: 13px; color: var(--text-secondary); }
        .trend-title { font-weight: bold; margin: 2px 0; font-size: 15px; }
        .trend-count { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        
        .follow-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
        }
        .follow-btn-small {
            background: var(--text-main);
            color: var(--bg-color);
            font-weight: bold;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
        }
        .follow-btn-small:hover { opacity: 0.9; }

        /* Profile Page */
        .profile-banner {
            height: 200px;
            background-color: #333;
            background-size: cover;
            background-position: center;
        }
        .profile-header {
            padding: 12px 16px;
            position: relative;
        }
        .profile-avatar-large {
            width: 134px;
            height: 134px;
            border-radius: 50%;
            border: 4px solid var(--bg-color);
            margin-top: -84px;
            background: #444;
            object-fit: cover;
        }
        .profile-actions {
            position: absolute;
            top: 12px;
            right: 16px;
            display: flex;
            gap: 10px;
        }
        .edit-profile-btn {
            border: 1px solid #536471;
            color: var(--text-main);
            border-radius: 20px;
            padding: 6px 16px;
            font-weight: bold;
            font-size: 15px;
            transition: 0.2s;
        }
        .edit-profile-btn:hover { background-color: var(--hover-bg); }
        .profile-stats { display: flex; gap: 20px; margin-top: 12px; color: var(--text-secondary); font-size: 15px; }
        .stat-value { color: var(--text-main); font-weight: 700; }
        .profile-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-top: 8px;
        }
        .profile-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }
        .profile-tab:hover { background-color: var(--hover-bg); }
        .profile-tab.active { color: var(--text-main); font-weight: 700; }
        .profile-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 4px;
            background-color: var(--accent);
            border-radius: 2px;
        }

        /* Achievements / Badges */
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .badge {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .badge.platinum { border-color: var(--platinum); color: var(--platinum); }
        .badge.gold { border-color: var(--gold); color: var(--gold); }
        .badge.accent { border-color: var(--accent); color: var(--accent); }

        /* Modern Edit Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: var(--bg-color);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        .modal-header {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .modal-body {
            padding-bottom: 30px;
        }
        .cover-preview {
            height: 190px;
            background: #333;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }
        .avatar-preview-container {
            padding: 0 16px;
            margin-top: -45px;
            margin-bottom: 16px;
            position: relative;
        }
        .avatar-preview {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid var(--bg-color);
            background: #444;
            object-fit: cover;
            cursor: pointer;
        }
        .form-section { padding: 0 16px; display: flex; flex-direction: column; gap: 20px; }
        .input-wrap { position: relative; border: 1px solid #333; border-radius: 4px; padding: 4px 8px; transition: 0.2s; }
        .input-wrap:focus-within { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
        .input-label { color: var(--text-secondary); font-size: 13px; }
        .input-field { background: transparent; border: none; padding: 4px 0; width: 100%; color: white; font-size: 17px; outline: none; }

        /* Mobile Bottom Nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-color);
            border-top: 1px solid var(--border);
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        .mobile-nav-item {
            padding: 8px;
            border-radius: 50%;
        }
        .mobile-nav-item svg { width: 24px; height: 24px; fill: var(--text-main); }

        /* Floating Post Button (Mobile) */
        .fab {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--accent);
            border-radius: 50%;
            display: none; /* Shown via media query */
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
            z-index: 90;
        }
        .fab svg { width: 24px; height: 24px; fill: white; }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #333;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 16px; height: 16px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }
        .toggle-switch.on { background: var(--accent); }
        .toggle-switch.on::after { transform: translateX(20px); }

        /* Responsive */
        @media (max-width: 1280px) {
            header { width: 88px; align-items: center; }
            .nav-item span { display: none; }
            .nav-item { width: auto; padding: 12px; }
            .tweet-btn-large span { display: none; }
            .tweet-btn-large { width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
            .tweet-btn-large::after { content: '+'; font-size: 24px; }
            aside { width: 290px; }
        }

        @media (max-width: 1000px) {
            aside { display: none; }
            main { width: 100%; border-right: none; }
            header { width: 88px; }
        }

        @media (max-width: 500px) {
            header { display: none; }
            .mobile-nav { display: flex; }
            .fab { display: flex; }
            main { padding-bottom: 80px; }
            #app-layout { flex-direction: column; }
            .modal { width: 100%; height: 100%; border-radius: 0; }
        }
    </style>
</head>
<body>

    <div id="particles"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <img src="favicon.png" class="logo-large">
        <h1 style="font-size: 32px; margin-bottom: 10px;">Happening now</h1>
        <div class="auth-box">
            <h2 style="margin-bottom: 20px;">Join Peyza today.</h2>
            <div id="auth-forms">
                <input type="text" id="username-in" placeholder="Username" style="width: 100%; margin-bottom: 10px; padding: 15px;">
                <input type="password" id="password-in" placeholder="Password" style="width: 100%; margin-bottom: 20px; padding: 15px;">
                <button class="auth-btn" onclick="app.handleAuth('signup')">Sign up</button>
                <button class="auth-btn outline" onclick="app.handleAuth('login')">Log in</button>
            </div>
            <p id="auth-error" style="color: var(--danger); margin-top: 10px; font-size: 14px; display: none;"></p>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="app-layout" class="hidden">
        <header>
            <div class="logo-container" onclick="app.navTo('home')">
                <img src="favicon.png">
            </div>
            <nav>
                <a href="#" class="nav-item active" id="nav-home" onclick="app.navTo('home')">
                    <svg viewBox="0 0 24 24"><path d="M22.46 7.57L12.357 2.115c-.223-.12-.49-.12-.713 0L1.543 7.57c-.364.197-.507.65-.31 1.014.196.364.65.507 1.013.31L12 3.69l9.753 5.204c.364.197.818.054 1.014-.31.197-.364.054-.818-.31-1.014zM12 4.196l-8.494 4.53L12 13.262l8.494-4.536L12 4.196zM2.26 10.706c.068-.387.433-.64.82-.572.387.067.64.432.572.82v5.772l8.025 4.093c.12.062.25.093.38.093.13 0 .262-.03.38-.092l8.026-4.103V10.95c-.068-.386.186-.75.572-.82.388-.06.753.19.82.573v6.07c0 .26-.14.498-.364.618l-9.062 4.63c-.15.077-.314.114-.476.114-.16 0-.325-.037-.475-.113l-9.063-4.62c-.223-.114-.363-.35-.363-.61v-5.786z"></path></svg>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-item" id="nav-explore" onclick="app.navTo('explore')">
                    <svg viewBox="0 0 24 24"><path d="M9.8 12c0 1.216.984 2.2 2.2 2.2s2.2-.984 2.2-2.2-.984-2.2-2.2-2.2-2.2.984-2.2 2.2zm9.63-7.91l-15.02 5.5c-.85.313-1.127 1.43-.513 2.11l4.13 4.58 4.63-4.5c.343-.333.886-.102.94.364l.5 4.5 3.96 4.98c.64.805 1.88.59 2.24-.38l6.13-16.5c.29-.78-.45-1.52-1.23-1.23l-5.757 2.576z"></path></svg>
                    <span>Trending</span>
                </a>
                <a href="#" class="nav-item" id="nav-notifs" onclick="app.navTo('notifications')">
                    <svg viewBox="0 0 24 24"><path d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.01 5.295L18.866 16H5.134z"></path></svg>
                    <span>Notifications</span>
                </a>
                <a href="#" class="nav-item" id="nav-messages" onclick="app.navTo('messages')">
                    <svg viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15.004c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5H4.498c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5H4.498zm15.5 5.487l-7.588 3.452c-.266.121-.558.121-.824 0l-7.588-3.452V18.5c0 .276.224.5.5.5h15.004c.276 0 .5-.224.5-.5v-8.013z"></path></svg>
                    <span>Messages</span>
                </a>
                <a href="#" class="nav-item" id="nav-themes" onclick="app.navTo('themes')">
                    <svg viewBox="0 0 24 24"><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm-5-3a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm1-5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm3-3a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm4 2a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm2 4a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"></path></svg>
                    <span>Themes</span>
                </a>
                <a href="#" class="nav-item" id="nav-profile" onclick="app.navTo('profile')">
                    <svg viewBox="0 0 24 24"><path d="M12 1.75c-5.108 0-9.25 4.142-9.25 9.25 0 2.27.83 4.347 2.217 5.96.128.148.146.36.046.53-2.227 3.785-2.26 3.868-2.28 4.288-.02.392.293.712.686.722h17.16c.394-.01.708-.33.687-.722-.02-.42-.054-.503-2.28-4.288-.1-.17-.082-.382.046-.53 1.387-1.613 2.217-3.69 2.217-5.96 0-5.108-4.142-9.25-9.25-9.25zM4.25 11c0-4.274 3.476-7.75 7.75-7.75s7.75 3.476 7.75 7.75c0 1.957-.72 3.75-1.91 5.13-1.614-2.128-4.04-3.52-6.79-3.52s-5.176 1.392-6.79 3.52c-1.19-1.38-1.91-3.173-1.91-5.13z"></path></svg>
                    <span>Profile</span>
                </a>
                <button class="tweet-btn-large" onclick="app.focusComposer()">
                    <span>Post</span>
                </button>
            </nav>
            
            <div class="mini-profile" onclick="document.querySelector('.account-switcher-overlay').style.display='block'">
                <img src="" class="mini-avatar" id="current-user-avatar-mini">
                <div style="display: flex; flex-direction: column;">
                    <span class="text-bold" id="current-user-name-mini" style="font-size: 15px;">Name</span>
                    <span class="text-gray" id="current-user-handle-mini" style="font-size: 15px;">@handle</span>
                </div>
                <div style="margin-left:auto; font-weight:bold;">
                    <svg viewBox="0 0 24 24" style="width:18px;height:18px;"><path d="M3.543 8.96l1.414-1.42L12 14.59l7.043-7.05 1.414 1.42L12 17.41 3.543 8.96z"></path></svg>
                </div>
            </div>
        </header>

        <main id="main-content">
            <!-- Dynamic Content -->
        </main>

        <aside>
            <div class="search-bar">
                <svg viewBox="0 0 24 24" style="width: 18px; fill: currentColor;"><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.73 3.815-1.945 5.232l4.947 4.947-1.414 1.414-4.947-4.947C14.065 16.27 12.236 17 10.25 17c-4.694 0-8.5-3.806-8.5-8.5z"></path></svg>
                <input type="text" placeholder="Search">
            </div>

            <div class="widget">
                <h2>Who to follow</h2>
                <div id="who-to-follow-list"></div>
                <div class="p-4 text-accent" style="color: var(--accent); cursor:pointer;">Show more</div>
            </div>
        </aside>
    </div>

    <!-- Account Switcher -->
    <div class="account-switcher-overlay" onclick="this.style.display='none'">
        <div class="account-menu" id="account-menu-list"></div>
    </div>

    <!-- Create Post Modal -->
    <div id="post-modal" class="hidden modal-overlay">
        <div class="modal" style="height: auto; min-height: 200px;">
            <div class="modal-header">
                 <button onclick="document.getElementById('post-modal').classList.add('hidden')" style="font-size: 20px;">âœ•</button>
                 <div style="font-weight: bold; color: var(--accent);">Drafts</div>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <div class="flex gap-4">
                     <img id="post-modal-avatar" src="" class="mini-avatar">
                     <div class="w-full">
                         <textarea id="composer-text" class="composer-input" placeholder="What is happening?!"></textarea>
                         <img id="composer-image-preview" src="" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none;">
                     </div>
                </div>
                 <div class="flex justify-between items-center mt-4" style="margin-top: 20px;">
                     <div style="color: var(--accent); display:flex; gap:12px;">
                         <label style="cursor: pointer;">
                             <input type="file" class="hidden" accept="image/*" onchange="app.handleImageUpload(this, 'post')">
                             <svg viewBox="0 0 24 24" width="20" fill="currentColor"><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 4c-.828 0-1.5.672-1.5 1.5v13c0 .828.672 1.5 1.5 1.5h13c.828 0 1.5-.672 1.5-1.5v-13c0-.828-.672-1.5-1.5-1.5h-13zM12 5.5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"></path></svg>
                         </label>
                         <svg viewBox="0 0 24 24" width="20" fill="currentColor"><path d="M19 10.5V8.8h-4.4v6.4h1.7v-2h2v-1.7h-2v-1h2.7zm-6-2.2v8h1.7v-3h1.8v3h1.7v-3h1.8v3h1.7v-8H13z"></path></svg>
                     </div>
                     <button class="tweet-btn-large" style="width: auto; padding: 8px 20px; margin: 0;" onclick="app.createPost()">Post</button>
                 </div>
            </div>
        </div>
    </div>

    <div class="fab" onclick="app.focusComposerMobile()">
        <svg viewBox="0 0 24 24"><path d="M23 3c-6.62-.1-10.38 2.421-13.05 6.03C7.29 12.61 6 17.331 6 22h2c0-1.007.07-2.012.19-3H12c4.1 0 7.48-3.082 7.94-7.054C22.79 10.147 23.17 6.359 23 3zm-7 8h-1.5v2H16c.63-.016 1.2-.08 1.72-.188C16.95 15.24 14.68 17 12 17H8.55c.57-2.512 1.57-4.851 3-6.78 2.16-2.912 5.29-4.911 9.45-5.187C20.95 8.079 19.9 11 16 11zM4 9V6H1V4h3V1h2v3h3v2H6v3H4z"></path></svg>
    </div>

    <nav class="mobile-nav">
        <div class="mobile-nav-item" onclick="app.navTo('home')">
            <svg viewBox="0 0 24 24"><path d="M22.46 7.57L12.357 2.115c-.223-.12-.49-.12-.713 0L1.543 7.57c-.364.197-.507.65-.31 1.014.196.364.65.507 1.013.31L12 3.69l9.753 5.204c.364.197.818.054 1.014-.31.197-.364.054-.818-.31-1.014zM12 4.196l-8.494 4.53L12 13.262l8.494-4.536L12 4.196zM2.26 10.706c.068-.387.433-.64.82-.572.387.067.64.432.572.82v5.772l8.025 4.093c.12.062.25.093.38.093.13 0 .262-.03.38-.092l8.026-4.103V10.95c-.068-.386.186-.75.572-.82.388-.06.753.19.82.573v6.07c0 .26-.14.498-.364.618l-9.062 4.63c-.15.077-.314.114-.476.114-.16 0-.325-.037-.475-.113l-9.063-4.62c-.223-.114-.363-.35-.363-.61v-5.786z"></path></svg>
        </div>
         <div class="mobile-nav-item" onclick="app.navTo('explore')">
            <svg viewBox="0 0 24 24"><path d="M9.8 12c0 1.216.984 2.2 2.2 2.2s2.2-.984 2.2-2.2-.984-2.2-2.2-2.2-2.2.984-2.2 2.2zm9.63-7.91l-15.02 5.5c-.85.313-1.127 1.43-.513 2.11l4.13 4.58 4.63-4.5c.343-.333.886-.102.94.364l.5 4.5 3.96 4.98c.64.805 1.88.59 2.24-.38l6.13-16.5c.29-.78-.45-1.52-1.23-1.23l-5.757 2.576z"></path></svg>
        </div>
        <div class="mobile-nav-item" onclick="app.navTo('themes')">
            <svg viewBox="0 0 24 24"><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm-5-3a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm1-5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm3-3a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm4 2a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm2 4a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"></path></svg>
        </div>
        <div class="mobile-nav-item" onclick="app.navTo('messages')">
            <svg viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15.004c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5H4.498c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5H4.498zm15.5 5.487l-7.588 3.452c-.266.121-.558.121-.824 0l-7.588-3.452V18.5c0 .276.224.5.5.5h15.004c.276 0 .5-.224.5-.5v-8.013z"></path></svg>
        </div>
        <div class="mobile-nav-item" onclick="app.navTo('profile')">
             <svg viewBox="0 0 24 24"><path d="M12 1.75c-5.108 0-9.25 4.142-9.25 9.25 0 2.27.83 4.347 2.217 5.96.128.148.146.36.046.53-2.227 3.785-2.26 3.868-2.28 4.288-.02.392.293.712.686.722h17.16c.394-.01.708-.33.687-.722-.02-.42-.054-.503-2.28-4.288-.1-.17-.082-.382.046-.53 1.387-1.613 2.217-3.69 2.217-5.96 0-5.108-4.142-9.25-9.25-9.25zM4.25 11c0-4.274 3.476-7.75 7.75-7.75s7.75 3.476 7.75 7.75c0 1.957-.72 3.75-1.91 5.13-1.614-2.128-4.04-3.52-6.79-3.52s-5.176 1.392-6.79 3.52c-1.19-1.38-1.91-3.173-1.91-5.13z"></path></svg>
        </div>
    </nav>

    <!-- Edit Profile Modal -->
    <div id="edit-modal" class="hidden modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('edit-modal').classList.add('hidden')" style="font-size: 20px;">âœ•</button>
                    <h2 style="margin:0; font-size: 20px;">Edit Profile</h2>
                </div>
                <button class="tweet-btn-large" style="width: auto; padding: 6px 20px; margin: 0; background: white; color: black;" onclick="app.saveProfile()">Save</button>
            </div>
            
            <div class="modal-body">
                <div class="cover-preview" id="preview-cover">
                     <label style="cursor:pointer; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%;">
                         <input type="file" class="hidden" accept="image/*" onchange="app.handleImageUpload(this, 'banner')">
                         ðŸ“·
                     </label>
                </div>
                <div class="avatar-preview-container">
                    <label style="cursor:pointer;">
                        <img id="preview-avatar" class="avatar-preview" src="">
                        <input type="file" class="hidden" accept="image/*" onchange="app.handleImageUpload(this, 'avatar')">
                    </label>
                </div>

                <div class="form-section">
                    <div class="input-wrap">
                        <div class="input-label">Name</div>
                        <input type="text" id="edit-name" class="input-field">
                    </div>
                    <div class="input-wrap">
                        <div class="input-label">Bio</div>
                        <textarea id="edit-bio" class="input-field" style="resize:none; height: 60px;"></textarea>
                    </div>
                    <div class="input-wrap">
                         <div class="input-label">Website (Hack Followers)</div>
                         <input type="number" id="edit-followers" class="input-field">
                    </div>
                    
                    <div id="verification-section" style="border-top: 1px solid var(--border); padding-top: 16px;">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">Verification</h3>
                        <div id="verification-status"></div>
                    </div>
                    
                    <!-- Hidden inputs to store current values if not changed -->
                    <input type="hidden" id="edit-avatar">
                    <input type="hidden" id="edit-banner">
                    <input type="checkbox" id="edit-verified" class="hidden">
                </div>
            </div>
        </div>
    </div>

    <script>
        const Utils = {
            generateId: () => Math.random().toString(36).substr(2, 9),
            timeAgo: (timestamp) => {
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                if(seconds < 60) return seconds + "s";
                let interval = seconds / 60;
                if (interval < 60) return Math.floor(interval) + "m";
                interval = interval / 60;
                if (interval < 24) return Math.floor(interval) + "h";
                return new Date(timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            },
            formatNumber: (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num;
            },
            createBot: (forceName) => {
                const names = ["CryptoKing", "DevSarah", "NewsBot3000", "ElonFan", "ArtDaily", "TechGuru", "MemeLord", "AlphaWolf", "DesignQueen", "ReactEnjoyer", "BasedGod", "PoliticsEnjoyer", "CinemaLover", "SportsCenterFan"];
                const name = forceName || names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random()*100);
                const handle = "@" + name.replace(/\s/g, '').toLowerCase();
                
                if(app.data.users[handle]) return app.data.users[handle];

                const bot = {
                    username: handle,
                    name: name,
                    handle: handle,
                    bio: "Automated account. I like tech and memes.",
                    joined: Date.now() - Math.floor(Math.random() * 10000000000),
                    followers: Math.floor(Math.random() * 50000),
                    following: Math.floor(Math.random() * 500),
                    avatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${handle}`,
                    banner: `https://picsum.photos/seed/${handle}/600/200`,
                    isVerified: Math.random() > 0.8,
                    achievements: []
                };
                app.data.users[handle] = bot;
                return bot;
            },
            generateBotPost: () => {
                const topics = ["HTML is actually turing complete if you squint hard enough.", "Just deployed to production on a Friday. Wish me luck.", "Why is centering a div still so hard?", "Crypto is going to the moon! ðŸš€", "Web3 is the future.", "Anyone else tired of frameworks?", "Just watched the new Marvel movie.", "Pizza with pineapple is a crime.", "Coding at 3AM hits different.", "I need more coffee.", "AI is taking over.", "Check out my new project!", "React 19 looks slick.", "CSS Grid > Flexbox. Fight me."];
                const bot = Utils.createBot();
                return {
                    id: Utils.generateId(),
                    authorHandle: bot.handle,
                    text: topics[Math.floor(Math.random() * topics.length)],
                    timestamp: Date.now(),
                    stats: { views: Math.floor(Math.random()*100), likes: Math.floor(Math.random()*20), retweets: Math.floor(Math.random()*5), replies: 0, bookmarks: 0 },
                    likedBy: [],
                    retweetedBy: [],
                    bookmarkedBy: [],
                    replies: []
                }
            },
            getBadgeIcon: (type) => {
                return 'ðŸ†';
            }
        };

        const DB = {
            load: () => {
                const data = localStorage.getItem('peyza_db');
                let parsed = { users: {}, posts: [], currentUser: null, lastActive: Date.now(), messages: {}, chats: {}, myAccounts: [], settings: { autoReply: true, theme: 'default' } };
                if (data) {
                    parsed = JSON.parse(data);
                    if(!parsed.messages) parsed.messages = {};
                    if(!parsed.chats) parsed.chats = {};
                    if(!parsed.myAccounts) parsed.myAccounts = parsed.currentUser ? [parsed.currentUser] : [];
                    if(!parsed.settings) parsed.settings = { autoReply: true, theme: 'default' };
                    if(!parsed.settings.theme) parsed.settings.theme = 'default';
                }
                return parsed;
            },
            save: (data) => {
                data.lastActive = Date.now();
                localStorage.setItem('peyza_db', JSON.stringify(data));
            }
        };

        const app = {
            data: null,
            tempImage: null,
            activeProfileTab: 'Posts', 
            
            init: () => {
                app.data = DB.load();
                app.cleanup();
                app.applyTheme(app.data.settings.theme);
                
                if (app.data.currentUser) {
                    app.showApp();
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
                
                app.renderWhoToFollow();
                app.initPullToRefresh();
                setInterval(app.simulateLive, 1000); 
            },

            cleanup: () => {
                const cutoff = Date.now() - (48 * 60 * 60 * 1000);
                app.data.posts = app.data.posts.filter(p => {
                    return p.timestamp > cutoff || p.authorHandle === app.data.currentUser;
                });
                DB.save(app.data);
            },
            
            applyTheme: (themeName) => {
                app.data.settings.theme = themeName;
                document.body.className = ''; // reset
                if (themeName !== 'default') {
                    document.body.classList.add(`theme-${themeName}`);
                }
                
                // Falling Particles
                const container = document.getElementById('particles');
                container.innerHTML = '';
                
                if (themeName === 'halloween' || themeName === 'christmas' || themeName === 'thanksgiving') {
                    const emojis = {
                        'halloween': ['ðŸŽƒ', 'ðŸ¦‡', 'ðŸ‘»'],
                        'christmas': ['â„ï¸', 'â›„'],
                        'thanksgiving': ['ðŸ‚', 'ðŸ¦ƒ', 'ðŸ']
                    };
                    const set = emojis[themeName];
                    
                    for(let i=0; i<20; i++) {
                        const p = document.createElement('div');
                        p.className = 'particle';
                        p.innerText = set[Math.floor(Math.random() * set.length)];
                        p.style.left = Math.random() * 100 + 'vw';
                        p.style.animationDuration = (Math.random() * 5 + 5) + 's';
                        p.style.fontSize = (Math.random() * 20 + 10) + 'px';
                        p.style.opacity = Math.random() * 0.7 + 0.3;
                        container.appendChild(p);
                    }
                }
                DB.save(app.data);
            },

            simulateLive: () => {
                app.simulateStep(false);
                DB.save(app.data);
                app.checkAchievements();
                
                if(app.currentView === 'home' && !document.querySelector('.is-animating')) {
                    app.data.posts.forEach(post => {
                        const viewEl = document.getElementById(`views-${post.id}`);
                        if(viewEl && viewEl.innerText !== Utils.formatNumber(post.stats.views)) {
                             viewEl.innerText = Utils.formatNumber(post.stats.views);
                        }
                    });
                }
            },

            checkAchievements: () => {
                const user = app.data.users[app.data.currentUser];
                if(!user.achievements) user.achievements = [];
                const badges = user.achievements;
                
                const addBadge = (name, type='normal') => {
                    if(!badges.find(b => b.name === name)) badges.push({name, type});
                };

                if(user.followers >= 100) addBadge("100 Followers", 'normal');
                if(user.followers >= 1000) addBadge("1K Club", 'normal');
                if(user.followers >= 10000) addBadge("10K Influencer", 'gold');
                
                const myPosts = app.data.posts.filter(p => p.authorHandle === user.handle);
                if(myPosts.length >= 1) addBadge("First Post", 'normal');
            },

            simulateStep: (quietMode) => {
                if (Math.random() > 0.985) {
                    const newBotPost = Utils.generateBotPost();
                    app.data.posts.unshift(newBotPost);
                    if(app.data.posts.length > 300) app.data.posts.pop(); 
                }

                const user = app.data.users[app.data.currentUser];
                const boost = Math.max(1, Math.log10(user.followers + 1)); 

                app.data.posts.forEach(post => {
                    const isMine = post.authorHandle === app.data.currentUser;
                    const velocity = isMine ? boost : 1;
                    const isViral = post.stats.likes > 50;
                    const chance = isViral ? 0.8 : 0.4;

                    if (Math.random() > (1 - chance)) post.stats.views += Math.floor((Math.random() * (isViral?50:5)) * velocity) + 1;
                    if (Math.random() > 0.90) post.stats.likes += Math.ceil(velocity * 0.1);
                    if (Math.random() > 0.97) post.stats.bookmarks += 1;
                    if (Math.random() > 0.95) post.stats.retweets += 1;
                });
            },

            handleImageUpload: (input, type) => {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64 = reader.result;
                    if (type === 'post') {
                        app.tempImage = base64;
                        document.getElementById('composer-image-preview').src = base64;
                        document.getElementById('composer-image-preview').style.display = 'block';
                    } else if (type === 'avatar') {
                        document.getElementById('preview-avatar').src = base64;
                        document.getElementById('edit-avatar').value = base64;
                    } else if (type === 'banner') {
                        document.getElementById('preview-cover').style.backgroundImage = `url(${base64})`;
                        document.getElementById('edit-banner').value = base64;
                    }
                }
                reader.readAsDataURL(file);
            },

            initPullToRefresh: () => {
                let startY = 0;
                let currentY = 0;
                const spinner = document.getElementById('refresh-spinner');

                window.addEventListener('touchstart', e => {
                    if (window.scrollY === 0) startY = e.touches[0].clientY;
                }, {passive: true});

                window.addEventListener('touchmove', e => {
                    if (window.scrollY === 0 && startY > 0) {
                        currentY = e.touches[0].clientY - startY;
                        if (currentY > 0 && currentY < 200) {
                            spinner.style.height = `${currentY/2}px`;
                        }
                    }
                }, {passive: true});

                window.addEventListener('touchend', e => {
                    if (currentY > 80) {
                        spinner.style.height = '60px';
                        setTimeout(() => {
                            app.simulateStep(true); 
                            app.renderCurrentView();
                            spinner.style.height = '0px';
                        }, 1000);
                    } else {
                        spinner.style.height = '0px';
                    }
                    startY = 0;
                    currentY = 0;
                });
            },

            handleAuth: (type) => {
                const userIn = document.getElementById('username-in').value;
                const passIn = document.getElementById('password-in').value;
                const errorEl = document.getElementById('auth-error');

                if (!userIn || !passIn) {
                    errorEl.textContent = "Please fill in all fields.";
                    errorEl.style.display = 'block';
                    return;
                }

                if (type === 'signup') {
                    if (app.data.users['@'+userIn]) {
                        errorEl.textContent = "Username taken.";
                        errorEl.style.display = 'block';
                        return;
                    }
                    const handle = '@' + userIn;
                    const newUser = {
                        username: handle,
                        password: passIn,
                        name: userIn,
                        handle: handle,
                        bio: "Just joined Peyza!",
                        joined: Date.now(),
                        followers: 0,
                        following: 0,
                        avatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${handle}`,
                        banner: '#333',
                        isVerified: false,
                        achievements: []
                    };
                    app.data.users[handle] = newUser;
                    app.data.currentUser = handle;
                    if(!app.data.myAccounts.includes(handle)) app.data.myAccounts.push(handle);
                    DB.save(app.data);
                    app.showApp();
                } else {
                    const handle = '@' + userIn;
                    const user = app.data.users[handle];
                    if (user && user.password === passIn) {
                        app.data.currentUser = handle;
                        if(!app.data.myAccounts.includes(handle)) app.data.myAccounts.push(handle);
                        DB.save(app.data);
                        app.showApp();
                    } else {
                        errorEl.textContent = "Invalid credentials.";
                        errorEl.style.display = 'block';
                    }
                }
            },

            showApp: () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-layout').classList.remove('hidden');
                app.updateUserDisplay();
                app.renderAccountMenu();
                app.navTo('home');
            },

            updateUserDisplay: () => {
                const user = app.data.users[app.data.currentUser];
                document.getElementById('current-user-name-mini').textContent = user.name;
                document.getElementById('current-user-handle-mini').textContent = user.handle;
                document.getElementById('current-user-avatar-mini').src = user.avatar;
                document.getElementById('post-modal-avatar').src = user.avatar;
            },
            
            renderAccountMenu: () => {
                const container = document.getElementById('account-menu-list');
                container.innerHTML = '';
                
                app.data.myAccounts.forEach(handle => {
                    const user = app.data.users[handle];
                    const div = document.createElement('div');
                    div.className = 'account-menu-item';
                    div.onclick = () => app.switchAccount(handle);
                    div.innerHTML = `
                        <img src="${user.avatar}" class="mini-avatar" style="width:30px;height:30px;margin:0;">
                        <div style="flex:1">
                            <div class="text-bold text-sm">${user.name}</div>
                            <div class="text-gray text-sm">${user.handle}</div>
                        </div>
                        ${handle === app.data.currentUser ? '<div style="color:var(--accent)">âœ“</div>' : ''}
                    `;
                    container.appendChild(div);
                });
                
                // Add Create Account
                const addDiv = document.createElement('div');
                addDiv.className = 'account-menu-item';
                addDiv.onclick = () => {
                    document.getElementById('app-layout').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.querySelector('.account-switcher-overlay').style.display='none';
                };
                addDiv.innerHTML = `<div class="text-bold text-sm" style="padding:4px 0;">+ Create a new account</div>`;
                container.appendChild(addDiv);
            },
            
            switchAccount: (handle) => {
                app.data.currentUser = handle;
                DB.save(app.data);
                app.updateUserDisplay();
                app.renderAccountMenu();
                document.querySelector('.account-switcher-overlay').style.display='none';
                app.navTo('home');
            },

            createPost: () => {
                const text = document.getElementById('composer-text').value;
                if (!text.trim() && !app.tempImage) return;

                const user = app.data.users[app.data.currentUser];
                const newPost = {
                    id: Utils.generateId(),
                    authorHandle: user.handle,
                    text: text,
                    image: app.tempImage,
                    timestamp: Date.now(),
                    stats: { views: 0, likes: 0, retweets: 0, replies: 0, bookmarks: 0 },
                    likedBy: [], 
                    retweetedBy: [],
                    bookmarkedBy: [],
                    replies: []
                };

                app.data.posts.unshift(newPost);
                DB.save(app.data);
                
                document.getElementById('composer-text').value = '';
                document.getElementById('composer-image-preview').src = '';
                document.getElementById('composer-image-preview').style.display = 'none';
                app.tempImage = null;
                document.getElementById('post-modal').classList.add('hidden');
                
                app.navTo('home');
            },

            navTo: (view, params = null) => {
                app.currentView = view;
                app.viewParams = params;
                
                if (view === 'profile') app.activeProfileTab = 'Posts';
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if(view === 'home') document.getElementById('nav-home').classList.add('active');
                if(view === 'explore') document.getElementById('nav-explore').classList.add('active');
                if(view === 'notifications') document.getElementById('nav-notifs').classList.add('active');
                if(view === 'messages') document.getElementById('nav-messages').classList.add('active');
                if(view === 'themes') document.getElementById('nav-themes').classList.add('active');
                if(view === 'profile' && (!params || params.handle === app.data.currentUser)) document.getElementById('nav-profile').classList.add('active');

                app.renderCurrentView();
                window.scrollTo(0,0);
            },
            
            switchProfileTab: (tab) => {
                app.activeProfileTab = tab;
                app.renderCurrentView(true);
            },
            
            focusComposer: () => {
                 document.getElementById('post-modal').classList.remove('hidden');
                 document.getElementById('composer-text').focus();
            },
            
            focusComposerMobile: () => {
                document.getElementById('post-modal').classList.remove('hidden');
                document.getElementById('composer-text').focus();
            },

            renderCurrentView: (preserveState = false) => {
                const main = document.getElementById('main-content');
                if(document.activeElement && document.activeElement.id === 'composer-text' && preserveState) return;
                
                main.innerHTML = '';

                if (app.currentView === 'home') {
                    app.renderHeader(main, 'Home');
                    app.renderFeed(main);
                } else if (app.currentView === 'profile') {
                    const handle = app.viewParams ? app.viewParams.handle : app.data.currentUser;
                    app.renderProfile(main, handle);
                } else if (app.currentView === 'post') {
                    app.renderPostDetail(main, app.viewParams.id);
                } else if (app.currentView === 'explore') {
                    app.renderHeader(main, 'Trending');
                    app.renderTrending(main);
                } else if (app.currentView === 'notifications') {
                    app.renderHeader(main, 'Notifications');
                    app.renderNotifications(main);
                } else if (app.currentView === 'messages') {
                    app.renderHeader(main, 'Messages');
                    app.renderMessages(main);
                } else if (app.currentView === 'chat') {
                    app.renderChat(main, app.viewParams.handle);
                } else if (app.currentView === 'themes') {
                    app.renderHeader(main, 'Themes');
                    app.renderThemeSelector(main);
                }
            },

            renderHeader: (container, title, backBtn = false) => {
                const div = document.createElement('div');
                div.className = 'header-sticky';
                let html = '';
                if (backBtn || (title === 'Chat')) {
                    html += `<div onclick="app.navTo(title === 'Chat' ? 'messages' : 'home')" style="cursor:pointer; margin-right: 20px;">â†</div>`;
                }
                html += `<div style="flex:1;">${title}</div>`;
                
                // Add Auto Reply Toggle in Chat
                if (title === 'Chat') {
                    const isOn = app.data.settings.autoReply;
                    const toggle = document.createElement('div');
                    toggle.className = 'flex items-center gap-2';
                    toggle.style.fontSize = '12px';
                    toggle.innerHTML = `
                        <span>Auto-reply</span>
                        <div class="toggle-switch ${isOn ? 'on' : ''}" onclick="app.toggleAutoReply(this)"></div>
                    `;
                    div.appendChild(toggle);
                }
                container.appendChild(div);
            },
            
            toggleAutoReply: (el) => {
                app.data.settings.autoReply = !app.data.settings.autoReply;
                el.classList.toggle('on');
                DB.save(app.data);
            },
            
            renderThemeSelector: (container) => {
                const themes = [
                    { id: 'default', name: 'Default', icon: 'ðŸŒ‘' },
                    { id: 'halloween', name: 'Halloween', icon: 'ðŸŽƒ' },
                    { id: 'christmas', name: 'Christmas', icon: 'ðŸŽ„' },
                    { id: 'thanksgiving', name: 'Thanksgiving', icon: 'ðŸ¦ƒ' }
                ];
                
                const grid = document.createElement('div');
                grid.className = 'theme-grid';
                
                themes.forEach(t => {
                    const card = document.createElement('div');
                    card.className = `theme-card ${app.data.settings.theme === t.id ? 'active' : ''}`;
                    card.innerHTML = `<span class="theme-icon">${t.icon}</span><strong>${t.name}</strong>`;
                    card.onclick = () => {
                        app.applyTheme(t.id);
                        app.renderThemeSelector(container); // Re-render to update active state
                    };
                    grid.appendChild(card);
                });
                
                container.innerHTML = '';
                app.renderHeader(container, 'Themes');
                container.appendChild(grid);
            },

            renderFeed: (container) => {
                const feedDiv = document.createElement('div');
                if(!container) container = document.getElementById('main-content');
                
                let posts = app.data.posts;
                
                if (app.currentView === 'profile') {
                     const handle = app.viewParams ? app.viewParams.handle : app.data.currentUser;
                     if (app.activeProfileTab === 'Posts') posts = posts.filter(p => p.authorHandle === handle);
                     else if (app.activeProfileTab === 'Media') posts = posts.filter(p => p.authorHandle === handle && p.image);
                     else if (app.activeProfileTab === 'Likes') posts = posts.filter(p => p.likedBy && p.likedBy.includes(handle));
                }

                posts.sort((a,b) => b.timestamp - a.timestamp);
                
                if (posts.length === 0) {
                    const empty = document.createElement('div');
                    empty.style.padding = '30px';
                    empty.style.textAlign = 'center';
                    empty.style.color = 'var(--text-secondary)';
                    empty.innerText = "Nothing to see here yet.";
                    feedDiv.appendChild(empty);
                }

                posts.forEach(post => {
                    let author = app.data.users[post.authorHandle];
                    if (!author) author = { name: "Unknown", handle: "@unknown", avatar: "" };
                    
                    const likedByMe = post.likedBy && post.likedBy.includes(app.data.currentUser);
                    const retweetedByMe = post.retweetedBy && post.retweetedBy.includes(app.data.currentUser);
                    const bookmarkedByMe = post.bookmarkedBy && post.bookmarkedBy.includes(app.data.currentUser);
                    
                    const el = document.createElement('div');
                    el.className = 'post';
                    el.onclick = (e) => {
                         if(e.target.closest('.stat-item') || e.target.closest('.mini-avatar') || e.target.tagName === 'A') return;
                         app.navTo('post', {id: post.id});
                    };
                    
                    const verifiedHtml = author.isVerified ? `<svg viewBox="0 0 24 24" class="verified-badge"><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .495.083.965.238 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></svg>` : '';

                    el.innerHTML = `
                        <img src="${author.avatar}" class="mini-avatar" onclick="app.navTo('profile', {handle: '${author.handle}'})">
                        <div class="post-content">
                            <div class="post-header">
                                <div class="user-info">
                                    <span class="user-name">${author.name} ${verifiedHtml}</span>
                                    <span class="user-handle">${author.handle}</span>
                                    <span>Â·</span>
                                    <span>${Utils.timeAgo(post.timestamp)}</span>
                                </div>
                                <div class="text-gray" style="font-size:16px;">Â·Â·Â·</div>
                            </div>
                            <div class="post-text">${post.text}</div>
                            ${post.image ? `<img src="${post.image}" class="post-image">` : ''}
                            <div class="post-stats">
                                <div class="stat-item" onclick="app.interact('${post.id}', 'replies', this)">
                                    <svg class="stat-icon" viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg>
                                    <span>${Utils.formatNumber(post.stats.replies)}</span>
                                </div>
                                <div class="stat-item retweet-btn ${retweetedByMe ? 'retweeted' : ''}" onclick="app.interact('${post.id}', 'retweets', this)">
                                    <svg class="stat-icon" viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                                    <span>${Utils.formatNumber(post.stats.retweets)}</span>
                                </div>
                                <div class="stat-item like-btn ${likedByMe ? 'liked' : ''}" onclick="app.interact('${post.id}', 'likes', this)">
                                    <svg class="stat-icon" viewBox="0 0 24 24"><path d="${likedByMe ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.894 1.81.844 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.894 1.81.844 4.17-.514 6.67z'}"></path></svg>
                                    <span id="likes-${post.id}" class="number-anim">${Utils.formatNumber(post.stats.likes)}</span>
                                </div>
                                <div class="stat-item bookmark-btn ${bookmarkedByMe ? 'bookmarked' : ''}" onclick="app.interact('${post.id}', 'bookmarks', this)">
                                    <svg class="stat-icon" viewBox="0 0 24 24"><path d="${bookmarkedByMe ? 'M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5z' : 'M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z'}"></path></svg>
                                    <span class="number-anim">${Utils.formatNumber(post.stats.bookmarks)}</span>
                                </div>
                                <div class="stat-item">
                                    <svg class="stat-icon text-gray" viewBox="0 0 24 24"><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></svg>
                                    <span id="views-${post.id}">${Utils.formatNumber(post.stats.views)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    feedDiv.appendChild(el);
                });

                container.appendChild(feedDiv);
            },
            
            renderMessages: (container) => {
                const myHandle = app.data.currentUser;
                const conversations = app.data.messages[myHandle] || [];
                
                conversations.sort((a,b) => b.lastTimestamp - a.lastTimestamp);
                
                if(conversations.length === 0) {
                    container.innerHTML = `<div class="p-4 text-center text-gray">No messages yet. Visit a profile to message someone.</div>`;
                    return;
                }
                
                conversations.forEach(convo => {
                    const otherHandle = convo.with;
                    const user = app.data.users[otherHandle];
                    const div = document.createElement('div');
                    div.className = 'message-row';
                    div.onclick = () => app.navTo('chat', {handle: otherHandle});
                    div.innerHTML = `
                        <img src="${user.avatar}" class="mini-avatar" style="width:50px;height:50px;">
                        <div style="flex:1">
                            <div class="flex justify-between">
                                <span class="text-bold">${user.name}</span>
                                <span class="text-gray text-sm">${Utils.timeAgo(convo.lastTimestamp)}</span>
                            </div>
                            <div class="text-gray text-sm" style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">
                                ${convo.lastMessage}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },
            
            renderChat: (container, otherHandle) => {
                const user = app.data.users[otherHandle];
                const myHandle = app.data.currentUser;
                const convoId = [myHandle, otherHandle].sort().join('_');
                
                if(!app.data.chats) app.data.chats = {};
                if(!app.data.chats[convoId]) app.data.chats[convoId] = [];
                
                const messages = app.data.chats[convoId];
                
                app.renderHeader(container, 'Chat', true);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex items-center gap-2 p-4 border-b';
                infoDiv.innerHTML = `<span class="text-bold">${user.name}</span> <span class="text-gray">${user.handle}</span>`;
                container.appendChild(infoDiv);
                
                const chatContainer = document.createElement('div');
                chatContainer.className = 'chat-container';
                
                const msgsDiv = document.createElement('div');
                msgsDiv.className = 'chat-messages';
                
                const renderMsgs = () => {
                    msgsDiv.innerHTML = '';
                    messages.forEach((msg, idx) => {
                        const div = document.createElement('div');
                        div.className = `chat-bubble ${msg.sender === myHandle ? 'sent' : 'received'} msg-slide`;
                        div.innerText = msg.text;
                        div.ondblclick = () => app.toggleReaction(div, convoId, idx);
                        // Add ID to wrapper to find it later easily? No, bubble structure is complex.
                        // We will add ID to the status element below.
                        
                        if(msg.reaction) {
                            const r = document.createElement('div');
                            r.className = 'chat-reaction';
                            r.innerText = msg.reaction;
                            div.appendChild(r);
                        }
                        
                        msgsDiv.appendChild(div);
                        
                        if(msg.sender === myHandle && idx === messages.length - 1) {
                            const status = document.createElement('div');
                            status.className = 'chat-status';
                            status.id = `chat-status-${idx}`; // UNIQUE ID FOR DIRECT UPDATE
                            status.innerText = msg.status;
                            msgsDiv.appendChild(status);
                        }
                    });
                    
                    // Only scroll on init
                    setTimeout(() => msgsDiv.scrollTop = msgsDiv.scrollHeight, 50);
                };
                renderMsgs();
                
                chatContainer.appendChild(msgsDiv);
                
                const inputArea = document.createElement('div');
                inputArea.className = 'chat-input-area';
                inputArea.innerHTML = `
                    <input type="text" id="chat-input" placeholder="Start a new message" style="flex:1;">
                    <div style="color:var(--accent); cursor:pointer;" onclick="app.sendChatMessage('${otherHandle}')">
                        <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:currentColor;"><path d="M2.504 21.866l.526-2.108C3.04 19.756 3.022 19.724 3.023 19.722L4.256 12.001 2.504 2.133c-.22-.88.69-1.595 1.458-1.146l20.002 11.011c.67.369.67 1.335 0 1.704L3.962 23.011c-.768.45-1.678-.266-1.458-1.145z"></path></svg>
                    </div>
                `;
                
                inputArea.querySelector('input').onkeypress = (e) => {
                    if(e.key === 'Enter') app.sendChatMessage(otherHandle);
                };
                
                chatContainer.appendChild(inputArea);
                container.appendChild(chatContainer);
            },
            
            toggleReaction: (el, convoId, msgIdx) => {
                // Simple reaction picker overlay
                if(el.querySelector('.reaction-menu')) {
                    el.querySelector('.reaction-menu').remove();
                    return;
                }
                const menu = document.createElement('div');
                menu.className = 'reaction-menu';
                ['â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥','ðŸ‘'].forEach(emoji => {
                    const span = document.createElement('span');
                    span.className = 'reaction-emoji';
                    span.innerText = emoji;
                    span.onclick = (e) => {
                        e.stopPropagation();
                        app.data.chats[convoId][msgIdx].reaction = emoji;
                        DB.save(app.data);
                        // Re-render specifically this user chat to show reaction
                        app.renderChat(document.getElementById('main-content'), convoId.split('_').find(h=>h!==app.data.currentUser));
                    };
                    menu.appendChild(span);
                });
                el.appendChild(menu);
            },
            
            sendChatMessage: (toHandle) => {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if(!text) return;
                
                const myHandle = app.data.currentUser;
                const convoId = [myHandle, toHandle].sort().join('_');
                
                if(!app.data.chats) app.data.chats = {};
                if(!app.data.chats[convoId]) app.data.chats[convoId] = [];
                
                const newMsg = {
                    sender: myHandle,
                    text: text,
                    timestamp: Date.now(),
                    status: 'Sent'
                };
                app.data.chats[convoId].push(newMsg);
                
                const msgIndex = app.data.chats[convoId].length - 1;
                
                const updateMeta = (owner, partner, txt) => {
                    if(!app.data.messages[owner]) app.data.messages[owner] = [];
                    let c = app.data.messages[owner].find(x => x.with === partner);
                    if(!c) {
                        c = { with: partner, lastMessage: '', lastTimestamp: 0 };
                        app.data.messages[owner].push(c);
                    }
                    c.lastMessage = txt;
                    c.lastTimestamp = Date.now();
                };
                
                updateMeta(myHandle, toHandle, text);
                
                // Simulate updating the other user's inbox
                updateMeta(toHandle, myHandle, text);
                
                input.value = '';
                DB.save(app.data);
                app.renderChat(document.getElementById('main-content'), toHandle);
                
                // Helper to update DOM without re-render
                const updateStatusDOM = (status) => {
                    if (app.currentView === 'chat') {
                        const statusEl = document.getElementById(`chat-status-${msgIndex}`);
                        if (statusEl) statusEl.innerText = status;
                    }
                };
                
                // Simulation Logic using direct DOM update
                setTimeout(() => { 
                    newMsg.status = 'Delivered'; 
                    DB.save(app.data); 
                    updateStatusDOM('Delivered');
                }, 1500);
                
                setTimeout(() => { 
                    newMsg.status = 'Read'; 
                    DB.save(app.data); 
                    updateStatusDOM('Read');
                }, 3000);
                
                // Bot Reply
                if (app.data.settings.autoReply) {
                    setTimeout(() => {
                        const botReplies = ["Haha true", "Yeah totally!", "Nice one", "ðŸ‘", "What?", "Send me the link", "Lol", "Ok", "For real?", "ðŸ‘€"];
                        const replyText = botReplies[Math.floor(Math.random() * botReplies.length)];
                        app.data.chats[convoId].push({
                            sender: toHandle,
                            text: replyText,
                            timestamp: Date.now()
                        });
                        updateMeta(myHandle, toHandle, replyText); 
                        updateMeta(toHandle, myHandle, replyText);
                        DB.save(app.data);
                        
                        // Only full re-render for NEW message to append it
                        if(app.currentView==='chat') app.renderChat(document.getElementById('main-content'), toHandle);
                    }, 5000 + Math.random() * 3000);
                }
            },
            
            renderProfile: (container, handle) => {
                const user = app.data.users[handle] || app.data.users[Object.keys(app.data.users).find(u => app.data.users[u].handle === handle)];
                
                if (!user) {
                    container.innerHTML = "<div class='p-4'>User not found</div>";
                    return;
                }

                const verifiedHtml = user.isVerified ? `<svg viewBox="0 0 24 24" class="verified-badge"><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .495.083.965.238 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></svg>` : '';

                let badgesHtml = '';
                if(user.achievements) {
                    badgesHtml = '<div class="badges-container">';
                    user.achievements.forEach(badge => {
                        badgesHtml += `<div class="badge ${badge.type}">ðŸ† ${badge.name}</div>`;
                    });
                    badgesHtml += '</div>';
                }

                // Action Buttons
                let actionBtn = '';
                if(user.handle === app.data.currentUser) {
                    actionBtn = `<button class="edit-profile-btn" onclick="app.openEditProfile()">Edit profile</button>`;
                } else {
                    actionBtn = `
                        <button class="edit-profile-btn" onclick="app.navTo('chat', {handle: '${user.handle}'})" style="padding:6px; border-radius:50%; margin-right:8px;"><svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15.004c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5H4.498c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5H4.498zm15.5 5.487l-7.588 3.452c-.266.121-.558.121-.824 0l-7.588-3.452V18.5c0 .276.224.5.5.5h15.004c.276 0 .5-.224.5-.5v-8.013z"></path></svg></button>
                        <button class="edit-profile-btn" onclick="alert('Followed!')">Follow</button>
                    `;
                }
                
                // Account Switcher Arrow
                const switcherArrow = user.handle === app.data.currentUser ? 
                    `<div onclick="document.querySelector('.account-switcher-overlay').style.display='block'" style="display:inline-block; cursor:pointer; margin-left:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:white;"><path d="M3.543 8.96l1.414-1.42L12 14.59l7.043-7.05 1.414 1.42L12 17.41 3.543 8.96z"></path></svg></div>` 
                    : '';

                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="header-sticky">
                         <div onclick="app.navTo('home')" style="cursor:pointer; margin-right: 15px;">â†</div>
                         <div style="display:flex; flex-direction:column;">
                             <span class="text-bold" style="font-size:17px; line-height:20px;">${user.name}</span>
                             <span class="text-gray text-sm" style="line-height:14px;">${Utils.formatNumber(app.data.posts.filter(p=>p.authorHandle === user.handle).length)} posts</span>
                         </div>
                    </div>
                    <div class="profile-banner" style="background-image: url('${user.banner}'); background-color: ${user.banner.startsWith('http')?'transparent':user.banner}"></div>
                    <div class="profile-header">
                        <img src="${user.avatar}" class="profile-avatar-large">
                        <div class="profile-actions">
                            ${actionBtn}
                        </div>
                        <div style="margin-top: 12px;">
                            <div class="text-xl text-bold" style="display:flex; align-items:center;">
                                ${user.name} ${verifiedHtml} ${switcherArrow}
                            </div>
                            <div class="text-gray">${user.handle}</div>
                        </div>
                        <div style="margin-top: 12px; margin-bottom: 12px; white-space: pre-wrap;">${user.bio}</div>
                        ${badgesHtml}
                        <div class="profile-stats">
                            <span><span class="stat-value">${Utils.formatNumber(user.following)}</span> Following</span>
                            <span><span class="stat-value">${Utils.formatNumber(user.followers)}</span> Followers</span>
                        </div>
                    </div>
                    <div class="profile-nav">
                        <div class="profile-tab ${app.activeProfileTab === 'Posts' ? 'active' : ''}" onclick="app.switchProfileTab('Posts')">Posts</div>
                        <div class="profile-tab ${app.activeProfileTab === 'Media' ? 'active' : ''}" onclick="app.switchProfileTab('Media')">Media</div>
                        <div class="profile-tab ${app.activeProfileTab === 'Likes' ? 'active' : ''}" onclick="app.switchProfileTab('Likes')">Likes</div>
                    </div>
                `;
                container.appendChild(div);
                app.renderFeed(container);
            },

            renderPostDetail: (container, postId) => {
                const post = app.data.posts.find(p => p.id === postId);
                if (!post) return;
                const author = app.data.users[post.authorHandle] || { name: "Unknown", handle: "@unknown", avatar: "" };
                const likedByMe = post.likedBy && post.likedBy.includes(app.data.currentUser);
                const retweetedByMe = post.retweetedBy && post.retweetedBy.includes(app.data.currentUser);
                const bookmarkedByMe = post.bookmarkedBy && post.bookmarkedBy.includes(app.data.currentUser);
                
                app.renderHeader(container, 'Post', true);
                
                const div = document.createElement('div');
                div.className = 'detail-container';
                const verifiedHtml = author.isVerified ? `<svg viewBox="0 0 24 24" class="verified-badge"><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .495.083.965.238 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></svg>` : '';

                div.innerHTML = `
                    <div class="detail-header">
                        <img src="${author.avatar}" class="mini-avatar" onclick="app.navTo('profile', {handle: '${author.handle}'})" style="margin:0;">
                        <div class="detail-user">
                            <span class="text-bold" style="display:flex; align-items:center;">${author.name} ${verifiedHtml}</span>
                            <span class="text-gray">${author.handle}</span>
                        </div>
                        <div style="margin-left:auto; color:gray;">Â·Â·Â·</div>
                    </div>
                    <div class="detail-text">${post.text}</div>
                    ${post.image ? `<img src="${post.image}" class="post-image">` : ''}
                    
                    <div class="detail-meta">
                        ${new Date(post.timestamp).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})} Â· ${new Date(post.timestamp).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric'})}
                        Â· <span style="color:white" id="detail-views-${post.id}">${Utils.formatNumber(post.stats.views)}</span> <span style="font-weight:400">Views</span>
                    </div>

                    <div class="detail-stats">
                         <div class="flex gap-2"><span class="text-bold" id="detail-retweets-${post.id}">${Utils.formatNumber(post.stats.retweets)}</span> <span class="text-gray">Retweets</span></div>
                         <div class="flex gap-2"><span class="text-bold" id="detail-replies-${post.id}">${Utils.formatNumber(post.stats.replies)}</span> <span class="text-gray">Quotes</span></div>
                         <div class="flex gap-2"><span class="text-bold" id="detail-likes-${post.id}">${Utils.formatNumber(post.stats.likes)}</span> <span class="text-gray">Likes</span></div>
                         <div class="flex gap-2"><span class="text-bold" id="detail-bookmarks-${post.id}">${Utils.formatNumber(post.stats.bookmarks)}</span> <span class="text-gray">Bookmarks</span></div>
                    </div>

                    <div class="detail-actions">
                         <div class="stat-item" onclick="app.interact('${post.id}', 'replies', this)"><svg class="stat-icon text-gray" viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg></div>
                         <div class="stat-item retweet-btn ${retweetedByMe ? 'retweeted' : ''}" onclick="app.interact('${post.id}', 'retweets', this)"><svg class="stat-icon" viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg></div>
                         <div class="stat-item like-btn ${likedByMe ? 'liked' : ''}" onclick="app.interact('${post.id}', 'likes', this)"><svg class="stat-icon" viewBox="0 0 24 24"><path d="${likedByMe ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.894 1.81.844 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.894 1.81.844 4.17-.514 6.67z'}"></path></svg></div>
                         <div class="stat-item bookmark-btn ${bookmarkedByMe ? 'bookmarked' : ''}" onclick="app.interact('${post.id}', 'bookmarks', this)"><svg class="stat-icon" viewBox="0 0 24 24"><path d="${bookmarkedByMe ? 'M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5z' : 'M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z'}"></path></svg></div>
                    </div>
                `;
                container.appendChild(div);

                post.replies.forEach(reply => {
                     const rEl = document.createElement('div');
                     rEl.className = 'post';
                     rEl.onclick = () => app.navTo('profile', {handle: reply.author.handle});
                     rEl.innerHTML = `
                         <img src="${reply.author.avatar}" class="mini-avatar">
                         <div class="post-content">
                             <div class="post-header">
                                <div class="user-info">
                                    <span class="user-name">${reply.author.name}</span>
                                    <span class="user-handle">${reply.author.handle}</span>
                                    <span>Â·</span>
                                    <span>${Utils.timeAgo(reply.timestamp)}</span>
                                </div>
                             </div>
                             <div class="post-text">${reply.text}</div>
                         </div>
                     `;
                     container.appendChild(rEl);
                });
            },
            
            renderTrending: (container) => {
                 // Top 10 by impact, unique authors
                 let sorted = [...app.data.posts].sort((a,b) => (b.stats.views + b.stats.likes*5) - (a.stats.views + a.stats.likes*5));
                 const uniqueAuthors = new Set();
                 const uniquePosts = [];
                 
                 for(let post of sorted) {
                     if(!uniqueAuthors.has(post.authorHandle)) {
                         uniqueAuthors.add(post.authorHandle);
                         uniquePosts.push(post);
                     }
                     if(uniquePosts.length >= 10) break;
                 }
                 
                 const h2 = document.createElement('h2');
                 h2.innerText = "Trending";
                 h2.style.padding = "16px";
                 h2.style.borderBottom = "1px solid var(--border)";
                 container.appendChild(h2);
                 
                 uniquePosts.forEach((post, index) => {
                     const author = app.data.users[post.authorHandle];
                     const el = document.createElement('div');
                     el.className = 'post';
                     el.onclick = () => app.navTo('post', {id: post.id});
                     el.innerHTML = `
                         <div style="font-size: 16px; font-weight: bold; color: var(--text-secondary); width: 30px;">${index+1}</div>
                         <div style="flex:1;">
                              <div class="text-gray text-sm" style="margin-bottom:4px;">Trending in Peyza</div>
                              <div class="text-bold">${author.name}</div>
                              <div class="text-gray" style="font-size: 14px; margin-top:2px;">${Utils.formatNumber(post.stats.views)} views</div>
                         </div>
                         <img src="${author.avatar}" style="width: 60px; height: 60px; border-radius: 8px; object-fit:cover;">
                     `;
                     container.appendChild(el);
                 });
            },
            
            renderNotifications: (container) => {
                // Find replies to current user posts
                const myHandle = app.data.currentUser;
                const notifications = [];
                
                app.data.posts.forEach(post => {
                    if(post.authorHandle === myHandle) {
                        post.replies.forEach(reply => {
                            notifications.push({
                                type: 'reply',
                                timestamp: reply.timestamp,
                                author: reply.author,
                                text: reply.text,
                                parentId: post.id
                            });
                        });
                    }
                });
                
                notifications.sort((a,b) => b.timestamp - a.timestamp);
                
                if(notifications.length === 0) {
                    container.innerHTML = `<div class="p-4 text-center text-gray">No notifications yet</div>`;
                    return;
                }
                
                notifications.forEach(notif => {
                     const el = document.createElement('div');
                     el.className = 'post'; // reuse style
                     el.onclick = () => app.navTo('post', {id: notif.parentId});
                     el.innerHTML = `
                        <img src="${notif.author.avatar}" class="mini-avatar">
                        <div class="post-content">
                            <div class="text-bold" style="margin-bottom: 4px;">${notif.author.name} replied</div>
                            <div class="text-gray" style="margin-bottom: 8px;">${notif.text}</div>
                        </div>
                     `;
                     container.appendChild(el);
                });
            },

            renderWhoToFollow: () => {
                const container = document.getElementById('who-to-follow-list');
                container.innerHTML = '';
                // Generate 3 random bots to follow
                for(let i=0; i<3; i++) {
                    const bot = Utils.createBot();
                    const div = document.createElement('div');
                    div.className = 'follow-item';
                    div.innerHTML = `
                         <div class="flex items-center gap-2" onclick="app.navTo('profile', {handle: '${bot.handle}'})">
                             <img src="${bot.avatar}" class="mini-avatar">
                             <div class="flex flex-col">
                                 <span class="text-bold text-sm">${bot.name}</span>
                                 <span class="text-gray text-sm">${bot.handle}</span>
                             </div>
                        </div>
                        <button class="follow-btn-small" onclick="this.innerText = 'Following'">Follow</button>
                    `;
                    container.appendChild(div);
                }
            },

            interact: (id, type, el) => {
                const post = app.data.posts.find(p => p.id === id);
                if (!post) return;

                if (type === 'replies') {
                    if (app.currentView !== 'post') {
                        app.navTo('post', {id: id});
                    } else {
                        app.focusComposer();
                    }
                    return; // CRITICAL: Stop execution here
                }

                let isActive = false;
                let countChange = 1;

                if (type === 'likes') {
                    if (!post.likedBy) post.likedBy = [];
                    isActive = post.likedBy.includes(app.data.currentUser);
                    if (isActive) {
                        post.likedBy = post.likedBy.filter(u => u !== app.data.currentUser);
                        countChange = -1;
                    } else {
                        post.likedBy.push(app.data.currentUser);
                    }
                } else if (type === 'retweets') {
                    if (!post.retweetedBy) post.retweetedBy = [];
                    isActive = post.retweetedBy.includes(app.data.currentUser);
                     if (isActive) {
                        post.retweetedBy = post.retweetedBy.filter(u => u !== app.data.currentUser);
                        countChange = -1;
                    } else {
                        post.retweetedBy.push(app.data.currentUser);
                    }
                } else if (type === 'bookmarks') {
                    if (!post.bookmarkedBy) post.bookmarkedBy = [];
                     isActive = post.bookmarkedBy.includes(app.data.currentUser);
                     if (isActive) {
                        post.bookmarkedBy = post.bookmarkedBy.filter(u => u !== app.data.currentUser);
                        countChange = -1;
                    } else {
                        post.bookmarkedBy.push(app.data.currentUser);
                    }
                }

                post.stats[type] += countChange;
                
                // Update UI
                // 1. Text Update
                let countEl = el.querySelector('span'); // Feed default
                if (!countEl && app.currentView === 'post') {
                    // In detail view, the counter is separate, find by ID
                    countEl = document.getElementById(`detail-${type}-${id}`);
                }

                if (countEl) {
                    countEl.innerText = Utils.formatNumber(post.stats[type]);
                    countEl.classList.remove('number-pop');
                    void countEl.offsetWidth; // trigger reflow
                    countEl.classList.add('number-pop');
                }

                // 2. Icon/Class Update
                const svgPath = el.querySelector('svg path');
                const svg = el.querySelector('svg');
                
                if (isActive && countChange === -1) {
                    el.classList.remove('liked', 'retweeted', 'bookmarked');
                    // Set outline path
                    if(type === 'likes') {
                        if(svgPath) svgPath.setAttribute('d', 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.894 1.81.844 4.17-.514 6.67z');
                    } else if(type === 'bookmarks') {
                        if(svgPath) svgPath.setAttribute('d', 'M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z');
                    }
                    if(svg) svg.classList.remove('animate-like');
                } else {
                    el.classList.add(type === 'likes' ? 'liked' : (type === 'retweets' ? 'retweeted' : 'bookmarked'));
                    // Set filled path
                    if(type === 'likes') {
                        if(svgPath) svgPath.setAttribute('d', 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.894 1.81.844 4.17-.514 6.67z');
                    } else if(type === 'bookmarks') {
                        if(svgPath) svgPath.setAttribute('d', 'M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5z');
                    }
                    if(svg && (type === 'likes' || type === 'bookmarks')) {
                        svg.classList.remove('animate-like');
                        void svg.offsetWidth;
                        svg.classList.add('animate-like');
                    }
                }
                
                DB.save(app.data);
            },

            openEditProfile: () => {
                const user = app.data.users[app.data.currentUser];
                if (!user) return; 

                // Safe defaults
                const avatar = user.avatar || `https://api.dicebear.com/7.x/identicon/svg?seed=${user.handle}`;
                const banner = user.banner || '#333';

                document.getElementById('edit-name').value = user.name || '';
                document.getElementById('edit-bio').value = user.bio || '';
                document.getElementById('edit-followers').value = user.followers || 0;
                document.getElementById('edit-verified').checked = user.isVerified || false;
                
                // Populate hidden fields
                document.getElementById('edit-avatar').value = avatar;
                document.getElementById('edit-banner').value = banner;
                
                // Previews
                document.getElementById('preview-avatar').src = avatar;
                document.getElementById('preview-cover').style.backgroundImage = `url(${banner})`;
                if(!banner.startsWith('http') && !banner.startsWith('data:')) document.getElementById('preview-cover').style.backgroundColor = banner;

                // Verification Logic
                const verifyDiv = document.getElementById('verification-status');
                if(user.isVerified) {
                    verifyDiv.innerHTML = '<span style="color:var(--accent); font-weight:bold;">âœ“ Account Verified</span>';
                } else {
                    verifyDiv.innerHTML = `<button class="auth-btn outline" onclick="app.requestVerification()">Request Verification</button> <p style="font-size:12px; color:gray; margin-top:4px;">Requires 100k followers</p>`;
                }

                const modal = document.getElementById('edit-modal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex'; // Force display just in case
            },
            
            requestVerification: () => {
                const user = app.data.users[app.data.currentUser];
                if(user.followers >= 100000) {
                    user.isVerified = true;
                    document.getElementById('edit-verified').checked = true;
                    document.getElementById('verification-status').innerHTML = '<span style="color:var(--accent); font-weight:bold;">âœ“ Account Verified! (Save to apply)</span>';
                } else {
                    alert(`You need ${Utils.formatNumber(100000)} followers. You have ${Utils.formatNumber(user.followers)}.`);
                }
            },

            saveProfile: () => {
                const user = app.data.users[app.data.currentUser];
                user.name = document.getElementById('edit-name').value;
                user.bio = document.getElementById('edit-bio').value;
                user.followers = parseInt(document.getElementById('edit-followers').value);
                user.isVerified = document.getElementById('edit-verified').checked;
                
                const av = document.getElementById('edit-avatar').value;
                if(av) user.avatar = av;
                
                const ban = document.getElementById('edit-banner').value;
                if(ban) user.banner = ban;

                DB.save(app.data);
                document.getElementById('edit-modal').classList.add('hidden');
                app.updateUserDisplay();
                app.renderCurrentView();
            }
        };

        // Initialize
        window.onload = app.init;
    </script>
</body>
</html>
