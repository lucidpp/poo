<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peyza.org</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .btn-press {
            transition: transform 0.1s;
        }
        .btn-press:active {
            transform: scale(0.92);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .glass-panel {
            background: rgba(30, 30, 30, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }
        input[type=range]:focus { outline: none; }
        
        /* Mobile Mini Player Layout */
        @media (max-width: 767px) {
            #miniPlayer {
                padding: 8px 16px;
                height: 72px; 
                grid-template-columns: 1fr auto;
                display: flex; 
                justify-content: space-between;
                align-items: center;
                z-index: 60 !important;
            }
            #miniPlayer > div:nth-child(2), #miniPlayer > div:nth-child(3) { 
                display: none; 
            }
            #mobileNav {
                height: 64px;
                bottom: 72px; 
                z-index: 50;
            }
            .pb-mobile-bars {
                padding-bottom: calc(72px + 64px + 10px);
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-100">

    <!-- APP LAYOUT -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR (Desktop) -->
        <aside class="hidden md:flex w-64 flex-col bg-black border-r border-gray-800 p-6 gap-6 z-20">
            <div class="flex items-center gap-3 text-2xl font-black tracking-tighter text-white select-none">
                <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-blue-600 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-play text-xs text-white"></i>
                </div>
                <span>PEYZA</span>
            </div>
            
            <nav class="flex flex-col gap-2">
                <button onclick="app.navigate('home')" class="btn-press flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition font-semibold">
                    <i class="fa-solid fa-house"></i> Home
                </button>
                <button onclick="app.navigate('search')" class="btn-press flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition font-semibold">
                    <i class="fa-solid fa-magnifying-glass"></i> Search
                </button>
                <button onclick="app.navigate('library')" class="btn-press flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition font-semibold">
                    <i class="fa-solid fa-book-open"></i> Library
                </button>
                <button onclick="app.showModal('createArtist')" class="btn-press flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition font-semibold">
                    <i class="fa-solid fa-plus-circle"></i> Create Artist
                </button>
            </nav>

            <div class="mt-auto">
                <div class="text-xs text-gray-500 uppercase font-bold mb-4">Your Artists</div>
                <div id="sidebarArtistList" class="flex flex-col gap-2 overflow-y-auto max-h-48"></div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 bg-gradient-to-b from-[#1e1e1e] to-[#121212] relative overflow-hidden">
            <!-- Top Bar -->
            <header class="h-16 flex items-center justify-between px-6 md:px-8 bg-black/20 backdrop-blur-md sticky top-0 z-10 border-b border-white/5">
                <div class="md:hidden text-xl font-black tracking-tighter flex items-center gap-2">
                    <div class="w-6 h-6 bg-gradient-to-br from-green-400 to-blue-600 rounded flex items-center justify-center">
                        <i class="fa-solid fa-play text-[10px] text-white"></i>
                    </div>
                    PEYZA
                </div>
                
                <!-- Desktop Search Bar (Redirects to search view) -->
                <div class="hidden md:flex items-center flex-1 max-w-md mx-8">
                     <div class="flex items-center bg-white/10 rounded-full px-4 py-2 border border-white/5 w-full cursor-text" onclick="app.navigate('search')">
                        <i class="fa-solid fa-search text-gray-400 text-sm mr-2"></i>
                        <span class="text-sm text-gray-400">Search Artists, Songs, or Full Library...</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 ml-auto">
                   <button onclick="app.wipeData()" class="btn-press text-xs text-red-400 hover:text-red-300 font-bold px-3 py-1 rounded border border-red-400/30 hover:bg-red-400/10">RESET DATA</button>
                </div>
            </header>

            <!-- Views Container -->
            <div id="views" class="overflow-y-auto h-full pb-40 md:pb-32 scroll-smooth pb-mobile-bars">
                
                <!-- HOME VIEW -->
                <div id="view-home" class="p-6 md:p-8 space-y-10 animate-fade-in">
                    <section>
                        <h2 class="text-3xl font-bold mb-6 tracking-tight">Good <span id="timeGreeting">Evening</span></h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="homeQuickLinks"></div>
                    </section>
                    
                    <section>
                        <h2 class="text-xl font-bold mb-4 text-gray-200">New Releases</h2>
                        <div class="flex overflow-x-auto pb-4 gap-6 no-scrollbar" id="homeRecentArtists"></div>
                    </section>

                    <section id="sec-mixes">
                        <h2 class="text-xl font-bold mb-4 text-gray-200">Made For You</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6" id="homeMixes"></div>
                    </section>

                    <section id="sec-radios">
                        <h2 class="text-xl font-bold mb-4 text-gray-200">Artist Radios</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6" id="homeRadios"></div>
                    </section>
                </div>

                <!-- SEARCH VIEW -->
                <div id="view-search" class="hidden p-6 md:p-8 animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6">Search</h2>
                    
                    <div class="flex flex-col gap-4 max-w-3xl">
                        <!-- Search Input -->
                        <div class="relative">
                             <input type="text" id="searchInput" placeholder="What do you want to listen to?" 
                                class="w-full bg-[#333] border border-transparent focus:border-white rounded-full py-3 px-12 text-white outline-none text-lg">
                             <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg"></i>
                        </div>

                        <!-- Source Toggle -->
                        <div class="flex gap-4">
                            <button id="searchLocalBtn" onclick="app.setSearchSource('local')" class="px-6 py-2 rounded-full font-bold text-sm bg-white text-black transition">Local Library</button>
                            <button id="searchSpotifyBtn" onclick="app.setSearchSource('spotify')" class="px-6 py-2 rounded-full font-bold text-sm bg-white/10 text-white hover:bg-white/20 transition flex items-center gap-2">
                                <i class="fa-solid fa-database text-green-500"></i> Full Library
                            </button>
                        </div>
                    </div>

                    <!-- Results Area -->
                    <div id="searchResults" class="mt-8 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <!-- Injected Results -->
                    </div>
                </div>

                <!-- ARTIST VIEW (Shared for Local & Spotify) -->
                <div id="view-artist" class="hidden pb-10 animate-fade-in">
                    <!-- Header -->
                    <div class="relative h-64 md:h-80 group">
                        <div id="artistBanner" class="absolute inset-0 bg-cover bg-center bg-no-repeat transition duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-[#121212] via-black/40 to-transparent"></div>
                            <!-- Blur backdrop for Spotify images which are usually square -->
                            <div id="artistBannerBlur" class="absolute inset-0 backdrop-blur-3xl bg-black/40 hidden"></div>
                        </div>
                        
                        <!-- Edit buttons only for local artists -->
                        <button id="editBannerBtn" onclick="app.showEditArtistBanner()" class="btn-press absolute top-4 right-4 bg-black/50 hover:bg-black/70 p-2 rounded-full opacity-0 group-hover:opacity-100 transition text-white backdrop-blur">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        
                        <div class="absolute bottom-6 left-6 md:left-8 flex items-end gap-6 z-10">
                            <div class="relative group/pfp">
                                <img id="artistPfp" src="" class="w-32 h-32 md:w-48 md:h-48 rounded-full shadow-[0_20px_50px_rgba(0,0,0,0.5)] object-cover bg-gray-800 border-4 border-[#121212]">
                                <button id="editPfpBtn" onclick="app.showEditArtistPfp()" class="btn-press absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover/pfp:opacity-100 transition cursor-pointer backdrop-blur-sm">
                                    <i class="fa-solid fa-camera text-2xl"></i>
                                </button>
                            </div>
                            <div class="mb-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-certificate text-blue-400 text-sm"></i>
                                    <span class="text-sm font-medium">Verified Peyza Artist</span>
                                </div>
                                <h1 id="artistName" class="text-4xl md:text-7xl font-black tracking-tight mb-4 drop-shadow-lg">Artist Name</h1>
                                <div class="flex items-center gap-2 text-sm md:text-base text-gray-300 font-medium">
                                    <span id="artistListeners">0</span> <span id="artistListenersLabel">monthly listeners</span>
                                    <span class="w-1 h-1 bg-white rounded-full mx-1"></span>
                                    <button id="editStatsBtn" onclick="app.showEditStats()" class="hover:text-white underline text-xs text-gray-400">Edit Stats</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls & Bio -->
                    <div class="px-6 md:px-8 mt-6 flex flex-col md:flex-row gap-8">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-8">
                                <button id="artistPlayBtn" class="btn-press w-14 h-14 bg-green-500 rounded-full flex items-center justify-center hover:bg-green-400 transition shadow-lg text-black text-xl">
                                    <i class="fa-solid fa-play"></i>
                                </button>
                                <button onclick="app.toggleFollow()" id="followBtn" class="btn-press px-6 py-2 border border-gray-500 rounded-full text-sm font-bold tracking-widest hover:border-white transition uppercase">
                                    Follow
                                </button>
                                <!-- Actions only for local -->
                                <button id="uploadSongBtn" onclick="app.showAddSongModal()" class="btn-press text-gray-400 hover:text-white text-xl ml-2 p-2 hover:bg-white/10 rounded-full transition" title="Upload Song">
                                    <i class="fa-solid fa-upload"></i>
                                </button>
                                <button id="editBioBtn" onclick="app.showEditBio()" class="btn-press text-gray-400 hover:text-white text-xl ml-2 p-2 hover:bg-white/10 rounded-full transition" title="Edit Profile">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </button>
                            </div>

                            <h2 class="text-2xl font-bold mb-4">Popular</h2>
                            <div id="artistSongList" class="flex flex-col gap-1 mb-8">
                                <!-- Song Rows -->
                            </div>
                            
                            <!-- Releases Grid (Mainly for Spotify) -->
                            <div id="artistReleasesSection" class="hidden">
                                <h2 class="text-2xl font-bold mb-4">Discography</h2>
                                <div id="artistReleasesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                            </div>
                        </div>

                        <!-- Sidebar Info -->
                        <div class="w-full md:w-80">
                            <h3 class="font-bold text-xl mb-4">About</h3>
                            <div class="bg-white/10 rounded-xl p-6 hover:bg-white/15 transition cursor-pointer relative group" onclick="app.tryEditBio()">
                                <div id="artistBio" class="line-clamp-6 text-gray-300 leading-relaxed text-sm">
                                    No biography available.
                                </div>
                                <div id="bioEditIcon" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 text-gray-300">
                                    <i class="fa-solid fa-pencil"></i>
                                </div>
                                <div class="mt-4 pt-4 border-t border-white/10 flex gap-4 text-sm font-bold">
                                    <div>
                                        <div id="artistFollowers" class="text-white text-lg">0</div>
                                        <div class="text-gray-400 font-normal text-xs uppercase">Followers</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="artistGenres" class="mt-6 flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>

                <!-- ALBUM/RELEASE VIEW (Unified for Local Release & Spotify Album) -->
                <div id="view-release" class="hidden p-6 md:p-8 animate-fade-in pb-32">
                     <button onclick="app.goBackToArtist()" class="btn-press mb-6 flex items-center gap-2 text-gray-400 hover:text-white font-bold text-sm">
                        <i class="fa-solid fa-arrow-left"></i> Back to Artist
                     </button>
                     
                     <div class="flex flex-col md:flex-row gap-8 items-end mb-8">
                        <img id="releaseCover" src="" class="w-full md:w-64 aspect-square shadow-2xl rounded-lg object-cover bg-gray-800">
                        <div class="mb-2">
                            <span id="releaseType" class="text-xs font-bold tracking-widest uppercase text-gray-400">Album</span>
                            <h1 id="releaseTitle" class="text-3xl md:text-5xl font-black tracking-tight mb-4 mt-2 leading-tight">Album Title</h1>
                            <div class="flex items-center gap-3 flex-wrap" id="releaseArtists"></div>
                            <div class="mt-6 text-sm text-gray-400 font-mono">
                                <span id="releaseDate">2024</span> â€¢ <span id="releaseStreams">0</span> streams
                            </div>
                        </div>
                     </div>
                     
                     <div class="flex gap-4 mb-8">
                         <button id="releasePlayBtn" class="btn-press w-14 h-14 bg-green-500 text-black rounded-full flex items-center justify-center text-xl shadow-lg hover:scale-105 transition">
                             <i class="fa-solid fa-play"></i>
                         </button>
                         <button id="releaseLikeBtn" class="btn-press text-3xl text-gray-400 hover:text-white ml-4">
                             <i class="fa-regular fa-heart"></i>
                         </button>
                     </div>

                     <!-- Tracklist for Albums -->
                     <div id="releaseTracklist" class="flex flex-col gap-1 border-t border-white/5 pt-4">
                         <!-- Injected Tracks -->
                     </div>
                </div>

                 <!-- LIBRARY VIEW -->
                 <div id="view-library" class="hidden p-6 md:p-8 animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6">Your Library</h2>
                    <div class="md:hidden flex items-center gap-4 mb-6">
                         <button onclick="app.showModal('createArtist')" class="btn-press flex items-center gap-2 px-4 py-2 bg-green-500 text-black rounded-full font-bold text-sm">
                             <i class="fa-solid fa-plus-circle"></i> Create Artist
                         </button>
                    </div>
                    
                    <div class="flex gap-4 mb-6 text-sm font-bold hidden md:flex">
                        <button class="bg-white text-black px-4 py-1.5 rounded-full">All</button>
                        <button class="bg-white/10 text-white px-4 py-1.5 rounded-full hover:bg-white/20">Artists</button>
                        <button class="bg-white/10 text-white px-4 py-1.5 rounded-full hover:bg-white/20">Songs</button>
                    </div>

                    <section class="mb-10" id="libraryFollowedArtists">
                        <h3 class="text-xl font-bold mb-4">Followed Artists</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="followedArtistList"></div>
                        <p id="noFollowedArtists" class="text-gray-400 mt-4 hidden">You are not following any artists yet.</p>
                    </section>

                    <section id="libraryLikedSongs">
                         <h3 class="text-xl font-bold mb-4">Liked Songs</h3>
                         <div class="flex flex-col gap-1" id="likedSongsList"></div>
                         <p id="noLikedSongs" class="text-gray-400 mt-4 hidden">You haven't liked any songs yet.</p>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- MOBILE NAV -->
    <nav id="mobileNav" class="md:hidden fixed left-0 w-full bg-[#181818]/95 backdrop-blur-md border-t border-[#282828] h-16 flex items-center justify-around text-xs font-semibold z-40">
        <button onclick="app.navigate('home')" class="btn-press flex flex-col items-center gap-1 text-white">
            <i class="fa-solid fa-house text-xl"></i> Home
        </button>
        <button onclick="app.navigate('search')" class="btn-press flex flex-col items-center gap-1 text-gray-400">
            <i class="fa-solid fa-magnifying-glass text-xl"></i> Search
        </button>
        <button onclick="app.navigate('library')" class="btn-press flex flex-col items-center gap-1 text-gray-400">
            <i class="fa-solid fa-book-open text-xl"></i> Library
        </button>
    </nav>

    <!-- MINI PLAYER BAR -->
    <footer id="miniPlayer" class="bg-[#181818]/90 backdrop-blur-lg border-t border-[#282828] fixed bottom-0 w-full z-50 px-4 md:h-24 md:grid md:grid-cols-3 transition-transform duration-300">
        <!-- Track Info -->
        <div class="flex items-center gap-4 w-full overflow-hidden group py-2 md:py-0 md:w-auto cursor-pointer" onclick="app.openFullPlayer()">
            <div class="relative w-14 h-14 rounded overflow-hidden flex-shrink-0">
                 <img id="playerImg" src="" class="w-full h-full object-cover bg-gray-800">
                 <div class="absolute inset-0 bg-black/40 flex md:hidden items-center justify-center">
                    <i class="fa-solid fa-chevron-up text-white"></i>
                 </div>
            </div>
            <div class="overflow-hidden flex-1">
                <div id="playerTitle" class="text-sm font-semibold hover:underline truncate text-white">Not Playing</div>
                <div id="playerArtist" class="text-xs text-gray-400 hover:text-white hover:underline truncate">Select a song</div>
            </div>
            <button class="btn-press text-green-500 ml-2 hidden md:block" onclick="event.stopPropagation()"><i class="fa-regular fa-heart"></i></button>
            <div class="flex md:hidden items-center gap-3 ml-auto">
                 <button onclick="player.togglePlay()" id="playPauseBtnMobile" class="btn-press w-8 h-8 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition">
                    <i class="fa-solid fa-play"></i>
                 </button>
            </div>
        </div>

        <!-- Desktop Controls -->
        <div class="hidden md:flex flex-col items-center max-w-xl w-full px-2">
            <div class="flex items-center gap-6 mb-1 text-gray-400">
                <button class="btn-press hover:text-white transition"><i class="fa-solid fa-shuffle"></i></button>
                <button onclick="player.prev()" class="btn-press hover:text-white transition text-lg"><i class="fa-solid fa-backward-step"></i></button>
                <button onclick="player.togglePlay()" id="playPauseBtn" class="btn-press w-8 h-8 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition">
                    <i class="fa-solid fa-play"></i>
                </button>
                <button onclick="player.next()" class="btn-press hover:text-white transition text-lg"><i class="fa-solid fa-forward-step"></i></button>
                <button onclick="player.toggleRepeat()" id="repeatBtn" class="btn-press hover:text-white transition relative text-gray-400"><i class="fa-solid fa-repeat"></i></button>
            </div>
            <div class="flex items-center gap-2 w-full text-xs text-gray-400 font-mono group">
                <span id="currentTime">0:00</span>
                <input type="range" id="progressBar" value="0" min="0" max="100" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer group-hover:h-1.5 transition-all">
                <span id="totalTime">0:00</span>
            </div>
        </div>

        <div class="hidden md:flex items-center justify-end gap-2 text-gray-400">
            <i class="fa-solid fa-volume-high text-xs"></i>
            <input type="range" id="volumeBar" min="0" max="1" step="0.01" value="1" class="w-24 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            <button class="ml-2 hover:text-white" onclick="app.openFullPlayer()"><i class="fa-solid fa-expand"></i></button>
        </div>
    </footer>

    <!-- FULL SCREEN PLAYER OVERLAY -->
    <div id="fullPlayer" class="fixed inset-0 z-[70] bg-[#121212] flex flex-col hidden animate-slide-up">
        <div id="fullPlayerBg" class="absolute inset-0 bg-cover bg-center opacity-30 blur-3xl scale-125 transition-all duration-1000"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-[#121212] via-[#121212]/50 to-transparent"></div>

        <div class="relative z-10 p-6 flex items-center justify-between">
            <button onclick="app.closeFullPlayer()" class="btn-press w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
            <div class="text-xs font-bold tracking-widest text-gray-400 uppercase">Now Playing</div>
            <button class="btn-press w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white">
                <i class="fa-solid fa-ellipsis"></i>
            </button>
        </div>

        <div class="relative z-10 flex-1 flex flex-col items-center justify-center p-8 max-w-2xl mx-auto w-full">
            <div class="w-full aspect-square max-w-md mb-8 relative group">
                <img id="fullPlayerImg" src="" class="w-full h-full object-cover rounded-xl shadow-[0_20px_60px_rgba(0,0,0,0.6)]">
            </div>
            
            <div class="w-full flex items-end justify-between mb-6">
                <div>
                    <h2 id="fullPlayerTitle" class="text-3xl md:text-4xl font-black mb-2 hover:underline cursor-pointer">Song Title</h2>
                    <p id="fullPlayerArtist" class="text-lg text-gray-400 hover:text-white cursor-pointer">Artist Name</p>
                </div>
                <button onclick="app.toggleLikeCurrentSong()" class="text-3xl text-green-500 btn-press" id="fullPlayerLikeBtn"><i class="fa-regular fa-heart"></i></button>
            </div>

            <div class="w-full mb-8">
                <input type="range" id="fullProgressBar" value="0" min="0" max="100" class="w-full h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer mb-2">
                <div class="flex justify-between text-xs font-mono text-gray-400">
                    <span id="fullCurrentTime">0:00</span>
                    <span id="fullTotalTime">0:00</span>
                </div>
            </div>

            <div class="flex items-center justify-center w-full max-w-sm gap-8">
                <button class="text-2xl text-gray-400 hover:text-white btn-press"><i class="fa-solid fa-shuffle"></i></button>
                <div class="flex items-center gap-6">
                    <button onclick="player.prev()" class="text-4xl text-white hover:text-gray-300 btn-press"><i class="fa-solid fa-backward-step"></i></button>
                    <button onclick="player.togglePlay()" id="fullPlayPauseBtn" class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center text-3xl shadow-xl hover:scale-105 transition btn-press"><i class="fa-solid fa-play"></i></button>
                    <button onclick="player.next()" class="text-4xl text-white hover:text-gray-300 btn-press"><i class="fa-solid fa-forward-step"></i></button>
                </div>
                <button onclick="player.toggleRepeat()" id="fullRepeatBtn" class="text-2xl text-gray-400 hover:text-white btn-press relative"><i class="fa-solid fa-repeat"></i></button>
            </div>
        </div>
    </div>

    <!-- MODALS (Existing Modals for Local features) -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <!-- Create Artist Modal -->
        <div id="modalCreateArtist" class="modal-content hidden glass-panel w-full max-w-md p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Create New Artist</h2>
            <input type="text" id="newArtistName" placeholder="Artist Name" class="w-full bg-[#333] border border-transparent focus:border-white rounded p-3 mb-4 text-white outline-none">
            <div class="flex justify-end gap-3">
                <button onclick="app.closeModals()" class="text-gray-400">Cancel</button>
                <button onclick="app.createArtist()" class="px-6 py-2 bg-green-500 text-black rounded-full font-bold">Create</button>
            </div>
        </div>
        <!-- Add Song Modal -->
        <div id="modalAddSong" class="modal-content hidden glass-panel w-full max-w-md p-6 rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Upload Release</h2>
            <div class="space-y-4">
                <input type="text" id="songTitle" placeholder="Song Title" class="w-full bg-[#333] rounded p-3 text-white">
                <input type="file" id="songFile" accept="audio/*" class="w-full bg-[#333] rounded p-2 text-sm text-gray-300">
                <input type="file" id="songCover" accept="image/*" class="w-full bg-[#333] rounded p-2 text-sm text-gray-300">
                <input type="number" id="songStreams" value="1000" class="w-full bg-[#333] rounded p-3 text-white">
                <select id="songCollab" multiple class="w-full bg-[#333] rounded p-3 text-white h-24"></select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModals()" class="text-gray-400">Cancel</button>
                <button onclick="app.addSong()" class="px-6 py-2 bg-green-500 text-black rounded-full font-bold">Upload</button>
            </div>
        </div>
        <!-- Edit Stats Modal -->
        <div id="modalEditStats" class="modal-content hidden glass-panel w-full max-w-md p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Edit Stats</h2>
            <input type="number" id="editListeners" class="w-full bg-[#333] rounded p-3 text-white mb-2" placeholder="Listeners">
            <input type="number" id="editFollowers" class="w-full bg-[#333] rounded p-3 text-white" placeholder="Followers">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModals()" class="text-gray-400">Cancel</button>
                <button onclick="app.saveStats()" class="px-6 py-2 bg-white text-black rounded-full font-bold">Save</button>
            </div>
        </div>
        <!-- Edit Bio Modal -->
        <div id="modalEditBio" class="modal-content hidden glass-panel w-full max-w-lg p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Edit Bio</h2>
            <textarea id="editBioText" rows="6" class="w-full bg-[#333] rounded p-3 text-white"></textarea>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModals()" class="text-gray-400">Cancel</button>
                <button onclick="app.saveBio()" class="px-6 py-2 bg-white text-black rounded-full font-bold">Save Bio</button>
            </div>
        </div>
        <!-- Edit Song Stats (With Realistic Generator) -->
        <div id="modalEditSongStats" class="modal-content hidden glass-panel w-full max-w-md p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Edit Song Streams</h2>
            <p id="editSongNameDisplay" class="text-gray-400 mb-4 text-sm"></p>
            <input type="number" id="editSongStreamCount" class="w-full bg-[#333] rounded p-3 text-white">
            <button onclick="app.generateRealisticStreams()" class="mt-4 px-4 py-2 bg-indigo-500 text-white rounded-full font-bold text-sm w-full">Generate Realistic Streams</button>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModals()" class="text-gray-400">Cancel</button>
                <button onclick="app.saveSongStats()" class="px-6 py-2 bg-white text-black rounded-full font-bold">Update</button>
            </div>
        </div>

        <!-- Upload Song for Spotify Modal (NEW) -->
        <div id="modalUploadSongForSpotify" class="modal-content hidden glass-panel w-full max-w-md p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Upload MP3 for <span id="uploadSongTitleDisplay" class="text-green-400"></span></h2>
            <p class="text-gray-400 mb-4 text-sm">To play this track, please upload your local MP3 file. The cover art and metadata will be preserved from the library.</p>
            <input type="file" id="spotifySongFile" accept="audio/mp3,audio/wav" class="w-full bg-[#333] rounded p-2 text-sm text-gray-300">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModals()" class="text-gray-400">Cancel</button>
                <button onclick="app.uploadSpotifySong()" class="px-6 py-2 bg-green-500 text-black rounded-full font-bold">Upload & Play</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="pfpInput" accept="image/*" class="hidden" onchange="app.handlePfpUpload(this)">
    <input type="file" id="bannerInput" accept="image/*" class="hidden" onchange="app.handleBannerUpload(this)">

    <script>
        // --- SPOTIFY CONFIG ---
        const SP_CLIENT_ID = "24d71c5bae0e407a98cd3cff0ccb33ff";
        const SP_CLIENT_SECRET = "15e5882a39f049edaec7de7bbc62f407";

        // --- DB WRAPPER (IndexedDB for storing files) ---
        const DB_NAME = 'PeyzaDB';
        const DB_VERSION = 1;
        const STORE_FILES = 'files';
        const db = {
            open: () => new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_FILES);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            }),
            saveFile: async (key, file) => {
                const database = await db.open();
                return new Promise((resolve) => {
                    const tx = database.transaction(STORE_FILES, 'readwrite');
                    tx.oncomplete = () => resolve();
                    tx.objectStore(STORE_FILES).put(file, key);
                });
            },
            getFile: async (key) => {
                const database = await db.open();
                return new Promise((resolve) => {
                    const tx = database.transaction(STORE_FILES, 'readonly');
                    const request = tx.objectStore(STORE_FILES).get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            }
        };

        // --- GLOBAL STATE ---
        const State = {
            artists: [],
            currentArtistId: null,
            editingSongId: null,
            currentViewedSongId: null,
            followedArtists: [], // Stores objects {id, name, img, type} for external, ID for local
            likedSongs: [],
            searchSource: 'local',
            spotifyToken: null,
            currentSpotifyArtist: null,
            trackToUpload: null, // New: Stores track object awaiting file upload

            init() {
                const saved = localStorage.getItem('peyzaData');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.artists = data.artists || [];
                    this.followedArtists = data.followedArtists || [];
                    this.likedSongs = data.likedSongs || [];
                }
            },
            save() {
                localStorage.setItem('peyzaData', JSON.stringify({
                    artists: this.artists,
                    followedArtists: this.followedArtists,
                    likedSongs: this.likedSongs
                }));
            },
            getArtist(id) { return this.artists.find(a => a.id === id); },
            getSong(artistId, songId) {
                const artist = this.getArtist(artistId);
                return artist ? artist.songs.find(s => s.id === songId) : null;
            },
            getSongById(songId) {
                for (const artist of this.artists) {
                    const song = artist.songs.find(s => s.id === songId);
                    if (song) return { ...song, artistName: artist.name, artistId: artist.id };
                }
                return null;
            },
            isFollowing(id) { 
                return this.followedArtists.some(a => (typeof a === 'string' ? a === id : a.id === id));
            },
            isLiked(songId) { return this.likedSongs.includes(songId); }
        };

        // --- SPOTIFY API ---
        const Spotify = {
            async getToken() {
                if(State.spotifyToken) return State.spotifyToken;
                try {
                    // Using fetch to get token (Note: This is sensitive client-side, but required for this single-file demo)
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Basic ' + btoa(SP_CLIENT_ID + ':' + SP_CLIENT_SECRET)
                        },
                        body: 'grant_type=client_credentials'
                    });
                    if(!response.ok) throw new Error("Auth Failed");
                    const data = await response.json();
                    State.spotifyToken = data.access_token;
                    return data.access_token;
                } catch(e) {
                    console.error("Spotify Auth Error:", e);
                    return null;
                }
            },
            
            async search(query) {
                const token = await this.getToken();
                if(!token) return { error: "Full Library connection failed." };
                // Fetch artists only
                const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=artist&limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async getArtist(id) {
                const token = await this.getToken();
                const res = await fetch(`https://api.spotify.com/v1/artists/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async getTopTracks(id) {
                const token = await this.getToken();
                const res = await fetch(`https://api.spotify.com/v1/artists/${id}/top-tracks?market=US`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async getAlbums(id) {
                const token = await this.getToken();
                const res = await fetch(`https://api.spotify.com/v1/artists/${id}/albums?include_groups=album,single&limit=8`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async getAlbumTracks(id) {
                const token = await this.getToken();
                const res = await fetch(`https://api.spotify.com/v1/albums/${id}/tracks?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            }
        };

        // --- PLAYER ---
        const player = {
            audio: new Audio(),
            playlist: [], 
            currentIndex: 0,
            isPlaying: false,
            repeatCount: 0,
            maxRepeats: 3,

            init() {
                this.audio.addEventListener('timeupdate', this.updateProgress.bind(this));
                this.audio.addEventListener('ended', this.handleSongEnd.bind(this));
                ['progressBar', 'fullProgressBar'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        this.audio.currentTime = (e.target.value / 100) * this.audio.duration;
                    });
                });
                document.getElementById('volumeBar').addEventListener('input', (e) => this.audio.volume = e.target.value);
            },

            async playSong(song, artist, playlistContext = []) {
                this.repeatCount = 0;
                this.updateRepeatBtn();
                this.playlist = playlistContext.length ? playlistContext : [{...song, artistName: artist.name, artistId: artist.id}];
                this.currentIndex = this.playlist.findIndex(s => s.id === song.id);
                
                const isSpotifyTrack = song.coverUrl !== undefined && song.fileId === undefined; // Check if it's an external track missing local file
                
                app.updateLikeBtn(document.getElementById('fullPlayerLikeBtn'), song.id);
                ['playerTitle', 'fullPlayerTitle'].forEach(id => document.getElementById(id).innerText = song.title);
                ['playerArtist', 'fullPlayerArtist'].forEach(id => document.getElementById(id).innerText = song.artistName);

                if (isSpotifyTrack) {
                    // Check for local file upload in IndexedDB
                    const localFileId = `spotify_audio_${song.id}`;
                    const fileBlob = await db.getFile(localFileId);
                    
                    if (fileBlob) {
                        // User uploaded file, play local
                        this.audio.src = URL.createObjectURL(fileBlob);
                        this.loadImages(song.coverUrl, song.coverUrl);
                    } else {
                        // User has not uploaded file, prompt for upload
                        app.promptSpotifyUpload({ ...song, localFileId });
                        return; // Stop playback attempt
                    }
                } else {
                     try {
                        // Local Peyza Artist Track flow
                        const fileBlob = await db.getFile(song.fileId);
                        if (fileBlob) {
                            this.audio.src = URL.createObjectURL(fileBlob);
                            let imgUrl = `https://ui-avatars.com/api/?name=${song.artistName}&background=random`;
                            
                            // Determine the cover art source
                            const coverId = song.coverId || State.getArtist(song.artistId)?.pfpId;
                            if(coverId) {
                                 const blob = await db.getFile(coverId);
                                 if(blob) imgUrl = URL.createObjectURL(blob);
                            }
                            this.loadImages(imgUrl, imgUrl);
                        }
                    } catch (e) {}
                }

                this.audio.play();
                this.isPlaying = true;
                this.updatePlayBtn();
            },

            loadImages(small, large) {
                document.getElementById('playerImg').src = small;
                document.getElementById('fullPlayerImg').src = large;
                document.getElementById('fullPlayerBg').style.backgroundImage = `url('${large}')`;
            },

            togglePlay() {
                this.audio.paused ? this.audio.play() : this.audio.pause();
                this.isPlaying = !this.audio.paused;
                this.updatePlayBtn();
            },
            
            handleSongEnd() {
                if (this.repeatCount > 0) {
                    this.audio.currentTime = 0;
                    this.audio.play();
                    this.repeatCount--;
                    this.updateRepeatBtn();
                } else {
                    this.next(false);
                }
            },

            next(reset = true) {
                if (reset) { this.repeatCount = 0; this.updateRepeatBtn(); }
                if (this.currentIndex < this.playlist.length - 1) this.currentIndex++;
                else if (this.playlist.length > 0) this.currentIndex = 0;
                else return;
                
                const song = this.playlist[this.currentIndex];
                this.playSong(song, {name: song.artistName, id: song.artistId}, this.playlist);
            },

            prev(reset = true) {
                if (reset) { this.repeatCount = 0; this.updateRepeatBtn(); }
                if (this.audio.currentTime > 3) this.audio.currentTime = 0;
                else if (this.currentIndex > 0) this.currentIndex--;
                else this.currentIndex = this.playlist.length - 1;
                
                const song = this.playlist[this.currentIndex];
                this.playSong(song, {name: song.artistName, id: song.artistId}, this.playlist);
            },

            toggleRepeat() {
                this.repeatCount = (this.repeatCount === this.maxRepeats) ? 0 : this.repeatCount + 1;
                this.updateRepeatBtn();
            },

            updateRepeatBtn() {
                const btns = ['repeatBtn', 'fullRepeatBtn'];
                btns.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    let icon = '<i class="fa-solid fa-repeat"></i>';
                    let cl = 'text-gray-400 hover:text-white';
                    if (this.repeatCount > 0) {
                        icon = `<i class="fa-solid fa-repeat"></i><span class="absolute top-0 right-0 text-[10px] font-black -mt-2 -mr-1 text-black bg-green-400 rounded-full px-1">${this.repeatCount}</span>`;
                        cl = 'text-green-500 hover:text-green-400';
                    }
                    el.className = `btn-press transition relative ${cl} text-2xl`;
                    el.innerHTML = icon;
                });
            },

            updatePlayBtn() {
                const icon = this.isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play ml-0.5"></i>';
                ['playPauseBtn', 'fullPlayPauseBtn', 'playPauseBtnMobile'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = icon;
                });
            },

            updateProgress() {
                const d = this.audio.duration || 0;
                const c = this.audio.currentTime;
                const pct = (c / d) * 100 || 0;
                ['progressBar', 'fullProgressBar'].forEach(id => {
                     const el = document.getElementById(id);
                     if(el) { el.value = pct; el.style.background = `linear-gradient(to right, #fff 0%, #fff ${pct}%, #4b5563 ${pct}%, #4b5563 100%)`; }
                });
                ['currentTime', 'fullCurrentTime'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = app.formatTime(c); });
                ['totalTime', 'fullTotalTime'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = app.formatTime(d); });
            }
        };

        // --- APP LOGIC ---
        const app = {
            init() {
                State.init();
                player.init();
                this.setGreeting();
                this.renderHome();
                this.renderSidebar();
                
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    if(e.target.value.length > 2) this.performSearch(e.target.value);
                });
            },

            navigate(viewId) {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                const view = document.getElementById('view-' + viewId);
                view.classList.remove('hidden', 'animate-fade-in');
                void view.offsetWidth;
                view.classList.add('animate-fade-in');

                if (viewId === 'home') this.renderHome();
                if (viewId === 'library') this.renderLibrary();
                if (viewId === 'search') document.getElementById('searchInput').focus();
            },

            setGreeting() {
                const hr = new Date().getHours();
                const el = document.getElementById('timeGreeting');
                if (hr < 12) el.innerText = "Morning";
                else if (hr < 18) el.innerText = "Afternoon";
                else el.innerText = "Evening";
            },
            
            formatNumber(num) { return new Intl.NumberFormat('en-US').format(num); },
            formatTime(seconds) {
                if(!seconds || isNaN(seconds)) return "0:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            },

            // --- SEARCH ---
            setSearchSource(source) {
                State.searchSource = source;
                document.getElementById('searchLocalBtn').className = source === 'local' ? "px-6 py-2 rounded-full font-bold text-sm bg-white text-black transition" : "px-6 py-2 rounded-full font-bold text-sm bg-white/10 text-white hover:bg-white/20 transition";
                document.getElementById('searchSpotifyBtn').className = source === 'spotify' ? "px-6 py-2 rounded-full font-bold text-sm bg-white text-black transition flex items-center gap-2" : "px-6 py-2 rounded-full font-bold text-sm bg-white/10 text-white hover:bg-white/20 transition flex items-center gap-2";
                
                const val = document.getElementById('searchInput').value;
                if(val) this.performSearch(val);
            },

            async performSearch(query) {
                const grid = document.getElementById('searchResults');
                grid.innerHTML = '<div class="text-gray-400 p-4">Searching...</div>';
                
                if (State.searchSource === 'local') {
                    grid.innerHTML = '';
                    const hits = State.artists.filter(a => a.name.toLowerCase().includes(query.toLowerCase()));
                    hits.forEach(artist => this.renderArtistCard(artist, grid));
                    if(hits.length === 0) grid.innerHTML = '<div class="text-gray-400 p-4">No local artists found.</div>';
                } else {
                    const data = await Spotify.search(query);
                    grid.innerHTML = '';
                    if (data.error) {
                        grid.innerHTML = `<div class="text-red-400 p-4 col-span-full">Error: ${data.error}. Note: Full Library Search requires disabling CORS or using a proxy for local files.</div>`;
                    } else if (data.artists && data.artists.items.length > 0) {
                        data.artists.items.forEach(artist => this.renderSpotifyArtistCard(artist, grid));
                    } else {
                         grid.innerHTML = '<div class="text-gray-400 p-4">No results in Full Library.</div>';
                    }
                }
            },

            renderSpotifyArtistCard(artist, container) {
                const img = artist.images[0] ? artist.images[0].url : `https://ui-avatars.com/api/?name=${artist.name}`;
                const div = document.createElement('div');
                div.className = "bg-[#181818] p-4 rounded-xl hover:bg-[#282828] cursor-pointer btn-press transition group";
                div.onclick = () => this.goToSpotifyArtist(artist.id);
                div.innerHTML = `
                   <div class="aspect-square w-full mb-3 relative">
                       <img src="${img}" class="w-full h-full rounded-full object-cover shadow-lg">
                       <div class="absolute bottom-2 right-2 w-10 h-10 bg-green-500 rounded-full flex items-center justify-center shadow-xl opacity-0 group-hover:opacity-100 transition translate-y-2 group-hover:translate-y-0 text-black">
                           <i class="fa-solid fa-headphones"></i>
                       </div>
                   </div>
                   <div class="font-bold text-base truncate">${artist.name}</div>
                   <div class="text-gray-400 text-xs uppercase font-bold mt-1">Peyza Artist</div>
                `;
                container.appendChild(div);
            },

            // --- SPOTIFY ARTIST VIEW ---
            async goToSpotifyArtist(id) {
                this.navigate('artist');
                // Clear View and hide local artist controls
                document.getElementById('artistName').innerText = "Loading...";
                document.getElementById('artistSongList').innerHTML = "";
                document.getElementById('artistReleasesSection').classList.add('hidden');
                document.getElementById('uploadSongBtn').classList.add('hidden');
                document.getElementById('editBioBtn').classList.add('hidden');
                document.getElementById('editBannerBtn').classList.add('hidden');
                document.getElementById('editPfpBtn').classList.add('hidden');
                document.getElementById('editStatsBtn').classList.add('hidden');
                document.getElementById('artistBannerBlur').classList.remove('hidden');
                document.getElementById('artistListenersLabel').innerText = "monthly listeners";

                const artist = await Spotify.getArtist(id);
                const tracks = await Spotify.getTopTracks(id);
                const albums = await Spotify.getAlbums(id);

                State.currentSpotifyArtist = artist;
                State.currentArtistId = id; 

                // --- Header & Stats ---
                document.getElementById('artistName').innerText = artist.name;
                
                // Generated Listeners based on Popularity (0-100)
                const genListeners = Math.floor(Math.pow(artist.popularity, 2.5) * 50000 + (Math.random() * artist.popularity * 10000));
                document.getElementById('artistListeners').innerText = this.formatNumber(genListeners); 
                
                // Generated Followers
                const genFollowers = Math.floor(Math.pow(artist.popularity, 3.8) * 1.5 + Math.random() * 100000);
                document.getElementById('artistFollowers').innerText = this.formatNumber(genFollowers);
                
                document.getElementById('artistBio').innerText = "Peyza Verified Artist (from Full Library)";
                
                const img = artist.images[0] ? artist.images[0].url : '';
                document.getElementById('artistPfp').src = img;
                document.getElementById('artistBanner').style.backgroundImage = `url('${img}')`;
                
                // Update Follow Button
                this.updateFollowBtnState(id);
                
                // Genres
                document.getElementById('artistGenres').innerHTML = artist.genres.map(g => `<span class="px-3 py-1 bg-white/10 rounded-full text-xs capitalize">${g}</span>`).join('');

                // Tracks (Popular)
                const list = document.getElementById('artistSongList');
                list.innerHTML = '';
                tracks.tracks.slice(0, 5).forEach((track, idx) => {
                    const row = document.createElement('div');
                    row.className = "group flex items-center gap-4 p-3 rounded-md hover:bg-white/10 transition cursor-pointer";
                    
                    let feats = "";
                    if(track.artists.length > 1) {
                        feats = "ft. " + track.artists.slice(1).map(a => a.name).join(', ');
                    }

                    // Generated Streams
                    const streams = Math.floor(Math.pow(track.popularity, 3.5) * (1 + Math.random()*0.1) * 10); 
                    
                    const songData = {
                        id: track.id,
                        title: track.name,
                        artistName: artist.name,
                        artistId: artist.id,
                        coverUrl: track.album.images[0].url
                    };
                    
                    row.onclick = () => player.playSong(songData, {name: artist.name, id: artist.id});

                    row.innerHTML = `
                        <div class="w-6 text-center text-gray-400 font-mono text-sm">${idx + 1}</div>
                        <div class="w-10 h-10 rounded bg-gray-700 flex-shrink-0">
                            <img src="${track.album.images[2].url}" class="w-full h-full object-cover rounded">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white truncate">${track.name}</div>
                            <div class="text-xs text-gray-400 truncate">${feats}</div>
                        </div>
                        <div class="text-sm text-gray-400 font-mono hidden md:block">${this.formatNumber(streams)}</div>
                    `;
                    list.appendChild(row);
                });

                // Releases (Albums/Singles)
                const grid = document.getElementById('artistReleasesGrid');
                grid.innerHTML = '';
                document.getElementById('artistReleasesSection').classList.remove('hidden');
                
                albums.items.forEach(album => {
                     const div = document.createElement('div');
                     div.className = "bg-[#181818] p-4 rounded-xl hover:bg-[#282828] cursor-pointer transition";
                     div.onclick = () => app.viewSpotifyAlbum(album); // New handler
                     div.innerHTML = `
                        <img src="${album.images[1].url}" class="w-full aspect-square object-cover rounded shadow-lg mb-3">
                        <div class="font-bold text-sm truncate">${album.name}</div>
                        <div class="text-xs text-gray-400 capitalize">${album.album_type} â€¢ ${album.release_date.split('-')[0]}</div>
                     `;
                     grid.appendChild(div);
                });

                document.getElementById('artistPlayBtn').onclick = () => {
                    if(tracks.tracks.length > 0) {
                         const t = tracks.tracks[0];
                         const songData = {
                            id: t.id, title: t.name, artistName: artist.name, artistId: artist.id,
                            coverUrl: t.album.images[0].url
                         };
                         player.playSong(songData, {name: artist.name, id: artist.id});
                    }
                }
            },

            // --- SPOTIFY ALBUM VIEW ---
            async viewSpotifyAlbum(album) {
                this.navigate('release');
                document.getElementById('releaseTracklist').innerHTML = '<div class="p-4 text-gray-400">Loading tracks...</div>';
                
                // Set Header
                document.getElementById('releaseTitle').innerText = album.name;
                document.getElementById('releaseType').innerText = album.album_type;
                document.getElementById('releaseDate').innerText = album.release_date.split('-')[0];
                document.getElementById('releaseCover').src = album.images[0].url;
                document.getElementById('releaseStreams').innerText = "Calculating..."; 
                
                const artistName = album.artists[0].name;
                const artistId = album.artists[0].id;
                const albumCoverUrl = album.images[0].url;
                
                document.getElementById('releaseArtists').innerHTML = `
                    <div class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full cursor-pointer" onclick="app.goToSpotifyArtist('${artistId}')">
                        <span class="font-bold text-sm">${artistName}</span>
                    </div>
                `;

                // Fetch Tracks
                const trackData = await Spotify.getAlbumTracks(album.id);
                const tracklist = document.getElementById('releaseTracklist');
                tracklist.innerHTML = '';

                let playlistContext = [];
                let totalAlbumStreams = 0;

                // Pre-calculate playlist structure
                trackData.items.forEach((track, i) => {
                     // Generate streams based on decay
                     const basePop = State.currentSpotifyArtist ? State.currentSpotifyArtist.popularity : 50;
                     const trackPop = basePop - (i * 0.5); 
                     const streams = Math.floor(Math.pow(trackPop > 10 ? trackPop : 10, 3.5) * (1 + Math.random()*0.2) * 5);
                     totalAlbumStreams += streams;
                     
                     playlistContext.push({
                        id: track.id,
                        title: track.name,
                        artistName: artistName,
                        artistId: artistId,
                        coverUrl: albumCoverUrl,
                        streams: streams
                     });
                });
                
                document.getElementById('releaseStreams').innerText = this.formatNumber(totalAlbumStreams);

                // Render Rows
                playlistContext.forEach((song, idx) => {
                    const row = document.createElement('div');
                    row.className = "group flex items-center gap-4 p-3 rounded-md hover:bg-white/10 transition cursor-pointer";
                    row.onclick = () => player.playSong(song, {name: artistName, id: artistId}, playlistContext);
                    
                    row.innerHTML = `
                        <div class="w-6 text-center text-gray-400 font-mono text-sm">${idx + 1}</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white truncate ${player.playlist[player.currentIndex]?.id === song.id ? 'text-green-500' : ''}">${song.title}</div>
                            <div class="text-xs text-gray-400 truncate">${artistName}</div>
                        </div>
                        <div class="text-sm text-gray-400 font-mono">${this.formatNumber(song.streams)}</div>
                    `;
                    tracklist.appendChild(row);
                });
                
                // Big Play Button
                document.getElementById('releasePlayBtn').onclick = () => {
                    if(playlistContext.length > 0) player.playSong(playlistContext[0], {name: artistName, id: artistId}, playlistContext);
                };
            },

            // --- LOCAL ARTIST VIEW ---
            async goToArtist(id) {
                this.navigate('artist');
                document.getElementById('artistReleasesSection').classList.add('hidden');
                document.getElementById('uploadSongBtn').classList.remove('hidden');
                document.getElementById('editBioBtn').classList.remove('hidden');
                document.getElementById('editBannerBtn').classList.remove('hidden');
                document.getElementById('editPfpBtn').classList.remove('hidden');
                document.getElementById('editStatsBtn').classList.remove('hidden');
                document.getElementById('artistBannerBlur').classList.add('hidden');
                document.getElementById('artistGenres').innerHTML = "";
                document.getElementById('artistListenersLabel').innerText = "monthly listeners";

                State.currentArtistId = id;
                const artist = State.getArtist(id);
                
                document.getElementById('artistName').innerText = artist.name;
                document.getElementById('artistListeners').innerText = this.formatNumber(artist.monthlyListeners || 0);
                document.getElementById('artistFollowers').innerText = this.formatNumber(artist.followers || 0);
                document.getElementById('artistBio').innerText = artist.bio || "No biography yet.";
                
                this.updateFollowBtnState(id);
                
                this.loadImageInto(artist.pfpId, 'artistPfp');
                this.loadImageInto(artist.bannerId, 'artistBanner', true);

                const list = document.getElementById('artistSongList');
                list.innerHTML = '';
                
                const sortedSongs = [...artist.songs].sort((a,b) => b.streams - a.streams);
                sortedSongs.forEach((song, idx) => {
                    const row = document.createElement('div');
                    row.className = "group flex items-center gap-4 p-3 rounded-md hover:bg-white/10 transition cursor-pointer";
                    let artistText = artist.name;
                    if(song.collaborators && song.collaborators.length > 0) {
                         const colNames = song.collaborators.map(cid => State.getArtist(cid)?.name).join(', ');
                         artistText += ` ft. ${colNames}`;
                    }
                    const thumbId = `list-thumb-${song.id}`;
                    
                    const songData = {...song, artistName: artist.name, artistId: artist.id};
                    row.onclick = () => player.playSong(songData, artist);

                    row.innerHTML = `
                        <div class="w-6 text-center text-gray-400">${idx+1}</div>
                        <div class="w-10 h-10 rounded bg-gray-700"><img id="${thumbId}" class="w-full h-full object-cover rounded"></div>
                        <div class="flex-1 min-w-0">
                             <div class="font-medium truncate">${song.title}</div>
                             <div class="text-xs text-gray-400 truncate">${artistText}</div>
                        </div>
                        <div class="text-sm text-gray-400">${this.formatNumber(song.streams)}</div>
                    `;
                    list.appendChild(row);
                    if(song.coverId) this.loadImageInto(song.coverId, thumbId);
                    else if(artist.pfpId) this.loadImageInto(artist.pfpId, thumbId);
                    else document.getElementById(thumbId).src = `https://ui-avatars.com/api/?name=${artist.name}`;
                });
                
                document.getElementById('artistPlayBtn').onclick = () => app.playArtist();
            },

            playArtist() {
                const artist = State.getArtist(State.currentArtistId);
                if(artist.songs.length) {
                    const sortedSongs = [...artist.songs].sort((a,b) => b.streams - a.streams);
                    const song = sortedSongs[0];
                    const playlist = sortedSongs.map(s => ({...s, artistName: artist.name, artistId: artist.id}));
                    player.playSong(song, artist, playlist);
                }
            },

            // --- CUSTOM SONG UPLOAD FLOW ---
            promptSpotifyUpload(track) {
                State.trackToUpload = track;
                document.getElementById('uploadSongTitleDisplay').innerText = track.title;
                document.getElementById('spotifySongFile').value = ''; // Clear input
                this.showModal('uploadSongForSpotify');
            },

            uploadSpotifySong: async () => {
                const track = State.trackToUpload;
                const fileInput = document.getElementById('spotifySongFile');
                const audioFile = fileInput.files[0];

                if (!track || !audioFile) {
                    alert("Please select an audio file.");
                    return;
                }

                const fileId = `spotify_audio_${track.id}`;
                
                // Save the file blob to IndexedDB
                await db.saveFile(fileId, audioFile);
                
                app.closeModals();
                
                // Play the song immediately using the newly saved file
                player.playSong(track, {name: track.artistName, id: track.artistId});
            },

            // --- SHARED ACTIONS ---
            toggleFollow() {
                const id = State.currentArtistId;
                if(!id) return;
                
                const idx = State.followedArtists.findIndex(a => (typeof a === 'string' ? a === id : a.id === id));
                if(idx > -1) {
                    State.followedArtists.splice(idx, 1);
                } else {
                    // Check if local or Spotify
                    const local = State.getArtist(id);
                    if(local) {
                         State.followedArtists.push(id); // Store ID for local
                    } else if(State.currentSpotifyArtist) {
                         // Store minimal Spotify data for library display
                         State.followedArtists.push({
                             id: State.currentSpotifyArtist.id,
                             name: State.currentSpotifyArtist.name,
                             img: State.currentSpotifyArtist.images[0]?.url,
                             type: 'external' // Use generic term
                         });
                    }
                }
                State.save();
                this.updateFollowBtnState(id);
                this.renderSidebar(); // Update sidebar on follow/unfollow
            },
            
            updateFollowBtnState(id) {
                const btn = document.getElementById('followBtn');
                if(State.isFollowing(id)) {
                    btn.innerText = "FOLLOWING";
                    btn.classList.add('bg-white', 'text-black', 'border-transparent');
                } else {
                    btn.innerText = "FOLLOW";
                    btn.classList.remove('bg-white', 'text-black', 'border-transparent');
                }
            },
            
            renderLibrary() {
                 const grid = document.getElementById('followedArtistList');
                 grid.innerHTML = "";
                 
                 if (State.followedArtists.length === 0) {
                     document.getElementById('noFollowedArtists').classList.remove('hidden');
                 } else {
                     document.getElementById('noFollowedArtists').classList.add('hidden');
                 }

                 State.followedArtists.forEach(entry => {
                     // Normalize entry (string ID or Object)
                     let id, name, type, imgUrl;
                     if (typeof entry === 'string') {
                         const a = State.getArtist(entry);
                         if(!a) return; 
                         id = a.id; name = a.name; type = 'Peyza Artist'; 
                         imgUrl = null; 
                     } else {
                         id = entry.id; name = entry.name; type = 'External Artist';
                         imgUrl = entry.img;
                     }

                     const card = document.createElement('div');
                     card.className = "bg-[#181818] p-4 rounded-xl hover:bg-[#282828] cursor-pointer btn-press transition";
                     card.onclick = () => {
                         if(entry.type === 'external') this.goToSpotifyArtist(id); // Using the stored type from state
                         else this.goToArtist(id);
                     };
                     
                     const imgId = `lib-follow-${id}`;
                     card.innerHTML = `
                        <div class="aspect-square w-full mb-3">
                            <img id="${imgId}" src="${imgUrl || ''}" class="w-full h-full rounded-full object-cover shadow-lg">
                        </div>
                        <div class="font-bold text-base truncate">${name}</div>
                        <div class="text-gray-400 text-xs uppercase font-bold mt-1">${type}</div>
                     `;
                     grid.appendChild(card);
                     if(type === 'Peyza Artist') this.loadImageInto(State.getArtist(id).pfpId, imgId);
                     else if(!imgUrl) document.getElementById(imgId).src = `https://ui-avatars.com/api/?name=${name}`;
                 });
            },
            
            renderSidebar() {
                const list = document.getElementById('sidebarArtistList');
                list.innerHTML = '';
                State.artists.forEach(artist => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-2 hover:bg-white/10 rounded-lg cursor-pointer transition";
                    div.onclick = () => this.goToArtist(artist.id);
                    div.innerHTML = `<div class="w-8 h-8 rounded-full bg-gray-700 overflow-hidden"><img id="sb-img-${artist.id}" class="w-full h-full object-cover"></div><div class="truncate text-sm font-medium text-gray-300">${artist.name}</div>`;
                    list.appendChild(div);
                    this.loadImageInto(artist.pfpId, `sb-img-${artist.id}`);
                });
            },
            
            async loadImageInto(fileId, imgElementId, isBackground = false) {
                const el = document.getElementById(imgElementId);
                if(!el) return;
                if (!fileId) {
                    const name = State.currentArtistId ? (State.getArtist(State.currentArtistId)?.name || 'Music') : 'Music';
                    const url = `https://ui-avatars.com/api/?name=${name}&background=random`;
                    if (isBackground) el.style.backgroundImage = `url('${url}')`; 
                    else el.src = url;
                    return;
                }
                try {
                    const blob = await db.getFile(fileId);
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        if (isBackground) el.style.backgroundImage = `url('${url}')`;
                        else el.src = url;
                    }
                } catch (e) {}
            },

            // Stub methods for existing functionality
            toggleLikeSong() {}, toggleLikeCurrentSong() {}, updateLikeBtn() {},
            showModal(name) { document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modal'+name.charAt(0).toUpperCase()+name.slice(1)).classList.remove('hidden'); },
            closeModals() { document.getElementById('modalOverlay').classList.add('hidden'); document.querySelectorAll('.modal-content').forEach(el=>el.classList.add('hidden')); },
            createArtist() { /* ... */ }, addSong() { /* ... */ }, showEditBio() { /* ... */ }, saveBio() { /* ... */ }, showEditStats() { /* ... */ }, saveStats() { /* ... */ },
            showEditArtistPfp() { document.getElementById('pfpInput').click(); }, showEditArtistBanner() { document.getElementById('bannerInput').click(); },
            handlePfpUpload(input) { /* ... */ }, handleBannerUpload(input) { /* ... */ }, wipeData() { localStorage.removeItem('peyzaData'); location.reload(); },
            tryEditBio() { if(!document.getElementById('editBioBtn').classList.contains('hidden')) this.showEditBio(); }, showAddSongModal() { this.showModal('addSong'); },
            openFullPlayer() { document.getElementById('fullPlayer').classList.remove('hidden'); }, closeFullPlayer() { document.getElementById('fullPlayer').classList.add('hidden'); },
            viewCurrentSongRelease() { /* ... */ }, 
            goBackToArtist() { 
                if (State.currentArtistId) {
                     const isLocal = State.getArtist(State.currentArtistId) !== undefined;
                     if (isLocal) this.goToArtist(State.currentArtistId);
                     else this.goToSpotifyArtist(State.currentArtistId);
                } else {
                    this.navigate('home');
                }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
