<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peyza - Music Player</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#121212',
                        'secondary-dark': '#181818',
                        'card-dark': '#282828',
                        'accent-green': '#1DB954',
                        'light-gray': '#b3b3b3',
                        'text-white': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #535353;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6a6a6a;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        /* General Body and Main Content Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            /* Gradient for the top edge like Spotify */
            background-image: linear-gradient(to bottom, rgba(40, 40, 40, 0.5) 0%, rgba(18, 18, 18, 1) 20%);
        }

        /* Mobile Specific Styles */
        @media (max-width: 767px) {
            .desktop-sidebar {
                display: none;
            }
            .mobile-nav-bar {
                display: flex;
            }
            .main-content-area {
                padding-bottom: 72px; /* Space for the mobile nav */
            }
        }

        /* Desktop/Tablet Specific Styles */
        @media (min-width: 768px) {
            .mobile-nav-bar {
                display: none;
            }
            .desktop-sidebar {
                display: flex;
            }
            .app-container {
                display: grid;
                grid-template-columns: 20rem 1fr; /* Sidebar width and main content */
                grid-template-rows: 1fr;
                min-height: 100vh;
            }
        }

        /* Animation for loading spinner */
        .spinner {
            border-top-color: #1DB954;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-primary-dark">

    <!-- Main Application Container (Desktop Grid Layout) -->
    <div id="app-container" class="app-container md:p-2 space-x-2 w-full">

        <!-- Desktop Sidebar (Hidden on Mobile) -->
        <aside class="desktop-sidebar p-2 space-y-2 bg-primary-dark rounded-lg flex-col">
            <!-- Navigation Links -->
            <div class="bg-secondary-dark p-6 rounded-xl space-y-5">
                <a href="#" class="flex items-center space-x-4 text-white hover:text-light-gray transition duration-150" onclick="navigateTo('home')">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="font-bold">Home</span>
                </a>
                <a href="#" class="flex items-center space-x-4 text-light-gray hover:text-white transition duration-150" onclick="navigateTo('search')">
                    <i data-lucide="search" class="w-6 h-6"></i>
                    <span class="font-bold">Search</span>
                </a>
            </div>

            <!-- Your Library Section -->
            <div class="bg-secondary-dark rounded-xl flex-grow overflow-y-auto p-4">
                <div class="flex items-center justify-between text-light-gray mb-4">
                    <a href="#" class="flex items-center space-x-2 hover:text-white transition duration-150" onclick="navigateTo('library')">
                        <i data-lucide="library" class="w-6 h-6"></i>
                        <span class="font-bold">Your Library</span>
                    </a>
                </div>
                <!-- Library Content (Followed Artists) -->
                <div id="library-content" class="space-y-4">
                    <!-- Artists will be rendered here -->
                </div>
            </div>
        </aside>

        <!-- Main Content & Search Area -->
        <main class="flex flex-col rounded-lg md:overflow-y-hidden">

            <!-- Search Bar & Header (Always visible) -->
            <header id="main-header" class="sticky top-0 z-10 bg-secondary-dark p-4 rounded-t-xl flex items-center shadow-lg">
                <div class="flex items-center space-x-4 w-full">
                    <!-- Desktop Back/Forward buttons (optional for this simple app) -->
                    <div class="hidden md:flex space-x-2">
                        <button class="bg-black/50 p-1 rounded-full text-light-gray opacity-50"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                        <button class="bg-black/50 p-1 rounded-full text-light-gray opacity-50"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                    </div>

                    <!-- Search Input (Visible only on 'search' or 'home' screen on mobile) -->
                    <div id="search-container" class="w-full max-w-lg hidden md:block">
                        <div class="relative">
                            <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-light-gray"></i>
                            <input type="text" id="search-input" placeholder="What do you want to listen to?" class="w-full py-2 pl-10 pr-4 rounded-full bg-card-dark text-white placeholder-light-gray focus:ring-2 focus:ring-accent-green focus:outline-none transition" onkeyup="if(event.key === 'Enter') performSearch(this.value)">
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area (Scrollable) -->
            <div id="content-area" class="main-content-area bg-primary-dark rounded-b-xl md:rounded-b-none md:rounded-r-xl">
                <!-- Dynamic content (Home, Search Results, Artist, Album) will be injected here -->
                <div id="loading-indicator" class="hidden flex justify-center items-center py-10">
                    <div class="spinner w-10 h-10 border-4 border-gray-700 border-solid rounded-full"></div>
                </div>
                <div id="dynamic-content">
                    <!-- Default to Home View -->
                </div>
            </div>

        </main>

    </div>

    <!-- Mobile Navigation Bar (Fixed at Bottom) -->
    <nav class="mobile-nav-bar fixed bottom-0 left-0 right-0 h-16 bg-card-dark border-t border-primary-dark z-20 flex justify-around items-center">
        <button class="flex flex-col items-center justify-center p-1 text-light-gray hover:text-white transition duration-150" onclick="navigateTo('home')">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-xs">Home</span>
        </button>
        <button class="flex flex-col items-center justify-center p-1 text-light-gray hover:text-white transition duration-150" onclick="navigateTo('search')">
            <i data-lucide="search" class="w-6 h-6"></i>
            <span class="text-xs">Search</span>
        </button>
        <button class="flex flex-col items-center justify-center p-1 text-light-gray hover:text-white transition duration-150" onclick="navigateTo('library')">
            <i data-lucide="library" class="w-6 h-6"></i>
            <span class="text-xs">Library</span>
        </button>
    </nav>

    <!-- JavaScript for Logic -->
    <script>
        // --- CONSTANTS ---
        // NOTE: Exposing client secrets in client-side code is INSECURE for production applications.
        const CLIENT_ID = '24d71c5bae0e407a98cd3cff0ccb33ff';
        const CLIENT_SECRET = '15e5882a39f049edaec7de7bbc62f407';
        const API_URL = 'https://api.spotify.com/v1';
        const TOKEN_URL = 'https://accounts.spotify.com/api/token';

        let accessToken = localStorage.getItem('spotify_token') || null;

        // --- UI UTILITY FUNCTIONS ---

        /**
         * Shows the loading spinner and hides the dynamic content.
         */
        function showLoading() {
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-indicator').classList.add('flex');
            document.getElementById('dynamic-content').innerHTML = '';
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoading() {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('flex');
        }

        /**
         * Renders Lucide icons after dynamic content has been inserted.
         */
        function renderIcons() {
            lucide.createIcons();
        }

        /**
         * Handles navigation logic, updates the UI, and manages mobile search bar visibility.
         * @param {string} view - The view to navigate to ('home', 'search', 'library').
         */
        function navigateTo(view, data = null) {
            const contentArea = document.getElementById('dynamic-content');
            const searchContainer = document.getElementById('search-container');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Toggle search bar visibility based on view and screen size
            if (view === 'search') {
                searchContainer.classList.remove('hidden');
                searchContainer.classList.add('block');
            } else if (window.innerWidth < 768 && view === 'home') {
                searchContainer.classList.remove('block');
                searchContainer.classList.add('hidden');
            } else if (window.innerWidth >= 768) {
                // Always show search on desktop
                searchContainer.classList.remove('hidden');
                searchContainer.classList.add('block');
            } else {
                searchContainer.classList.remove('block');
                searchContainer.classList.add('hidden');
            }


            showLoading();

            // Render the specific view
            setTimeout(() => {
                hideLoading();
                switch (view) {
                    case 'home':
                        renderHome();
                        break;
                    case 'search':
                        contentArea.innerHTML = renderSearchPlaceholder();
                        break;
                    case 'results':
                        renderSearchResults(data);
                        break;
                    case 'artist':
                        getArtistDetails(data); // data is artist ID
                        break;
                    case 'album':
                        getAlbumDetails(data); // data is album ID
                        break;
                    case 'library':
                        renderLibrary();
                        break;
                    default:
                        renderHome();
                }
                renderIcons();
            }, 300); // Small delay to show "loading" feel
        }

        // --- SPOTIFY API FUNCTIONS ---

        /**
         * Gets the Spotify Access Token using Client Credentials flow.
         * Stores the token and expiry in localStorage.
         * @returns {Promise<string|null>} Access Token or null on failure.
         */
        async function getToken() {
            const expiry = localStorage.getItem('token_expiry');
            // Check if token exists and is not expired
            if (accessToken && expiry && Date.now() < parseInt(expiry)) {
                return accessToken;
            }

            const authString = btoa(CLIENT_ID + ':' + CLIENT_SECRET);
            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + authString
                    },
                    body: 'grant_type=client_credentials'
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('spotify_token', accessToken);
                    // Set expiry time 1 minute before actual expiry for safety
                    localStorage.setItem('token_expiry', Date.now() + ((data.expires_in - 60) * 1000));
                    console.log('New Spotify Token obtained.');
                    return accessToken;
                } else {
                    console.error('Failed to get Spotify token:', response.status, await response.text());
                    return null;
                }
            } catch (error) {
                console.error('Network error during token fetch:', error);
                return null;
            }
        }

        /**
         * Performs a search across artists, tracks, and albums.
         * @param {string} query - The search term.
         */
        async function performSearch(query) {
            if (!query.trim()) return;

            showLoading();
            const token = await getToken();
            if (!token) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Error: Could not authenticate with Full Library.</p>`;
                hideLoading();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/search?q=${encodeURIComponent(query)}&type=artist,album,track&limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    navigateTo('results', data);
                } else {
                    console.error('Search API error:', response.status, await response.text());
                    document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Full Library API Error: ${response.status}. Please try again later.</p>`;
                }
            } catch (error) {
                console.error('Network error during search:', error);
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Network connection failed. Check your internet.</p>`;
            }
            hideLoading();
        }

        /**
         * Fetches full details for an artist and their top tracks.
         * @param {string} artistId - The Spotify ID of the artist.
         */
        async function getArtistDetails(artistId) {
            showLoading();
            const token = await getToken();
            if (!token) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Error: Could not authenticate with Full Library.</p>`;
                hideLoading();
                return;
            }

            try {
                const [artistRes, topTracksRes, albumsRes] = await Promise.all([
                    fetch(`${API_URL}/artists/${artistId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/artists/${artistId}/top-tracks?market=US`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/artists/${artistId}/albums?market=US&limit=6&include_groups=album,single`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                if (artistRes.ok && topTracksRes.ok && albumsRes.ok) {
                    const artistData = await artistRes.json();
                    const topTracksData = await topTracksRes.json();
                    const albumsData = await albumsRes.json();
                    renderArtistPage(artistData, topTracksData.tracks, albumsData.items);
                } else {
                    document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Failed to load artist details.</p>`;
                }
            } catch (error) {
                console.error('Error fetching artist details:', error);
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Network error loading artist details.</p>`;
            }
            hideLoading();
            renderIcons();
        }

        /**
         * Fetches full details for an album and its tracks.
         * @param {string} albumId - The Spotify ID of the album.
         */
        async function getAlbumDetails(albumId) {
            showLoading();
            const token = await getToken();
            if (!token) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Error: Could not authenticate with Full Library.</p>`;
                hideLoading();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/albums/${albumId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const albumData = await response.json();
                    renderAlbumPage(albumData);
                } else {
                    document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Failed to load album details.</p>`;
                }
            } catch (error) {
                console.error('Error fetching album details:', error);
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500 p-4">Network error loading album details.</p>`;
            }
            hideLoading();
            renderIcons();
        }

        // --- DATA GENERATION / SIMULATION FUNCTIONS ---

        /**
         * Formats a number with commas.
         * @param {number} num - The number to format.
         * @returns {string} Formatted number string.
         */
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        /**
         * Generates monthly listeners based on Spotify popularity (0-100).
         * @param {number} popularity - The popularity score (0-100).
         * @returns {string} Formatted listener count.
         */
        function generateMonthlyListeners(popularity) {
            let base = 500;
            if (popularity > 70) base = 1000000; // Big artists
            else if (popularity > 50) base = 10000; // Mid artists
            else if (popularity > 30) base = 1000; // Small artists

            // Scale factor: 0.5 for low pop, up to 50 for high pop
            const factor = Math.pow(popularity / 100, 3) * 50 + 0.5;
            const listeners = Math.floor(base * factor) + (Math.floor(Math.random() * 1000));
            return formatNumber(listeners);
        }

        /**
         * Generates followers based on Spotify popularity (0-100).
         * @param {number} popularity - The popularity score (0-100).
         * @returns {string} Formatted follower count.
         */
        function generateFollowers(popularity) {
            let base = 100;
            if (popularity > 80) base = 5000000;
            else if (popularity > 60) base = 500000;
            else if (popularity > 40) base = 10000;
            const factor = Math.pow(popularity / 100, 2) * 20 + 0.5;
            const followers = Math.floor(base * factor) + (Math.floor(Math.random() * 5000));
            return formatNumber(followers);
        }

        /**
         * Generates stream count based on track popularity (0-100).
         * @param {number} popularity - The popularity score (0-100).
         * @returns {string} Formatted stream count.
         */
        function generateStreams(popularity) {
            let base = 1000;
            if (popularity > 80) base = 50000000;
            else if (popularity > 60) base = 5000000;
            else if (popularity > 40) base = 500000;
            const factor = Math.pow(popularity / 100, 2) * 5 + 0.1;
            const streams = Math.floor(base * factor) + (Math.floor(Math.random() * 10000));
            return formatNumber(streams);
        }

        /**
         * Checks if an artist is currently "followed" (simulated via localStorage).
         * @param {string} artistId - The artist's Spotify ID.
         * @returns {boolean} True if followed, false otherwise.
         */
        function isArtistFollowed(artistId) {
            const followedArtists = JSON.parse(localStorage.getItem('followedPeyzaArtists') || '[]');
            return followedArtists.some(a => a.id === artistId);
        }

        /**
         * Toggles the "follow" state for an artist (simulated via localStorage).
         * @param {string} artistId - The artist's Spotify ID.
         * @param {string} artistName - The artist's name.
         * @param {string} imageUrl - The artist's image URL.
         */
        function toggleFollowArtist(artistId, artistName, imageUrl) {
            const followedArtists = JSON.parse(localStorage.getItem('followedPeyzaArtists') || '[]');
            const index = followedArtists.findIndex(a => a.id === artistId);

            if (index > -1) {
                // Unfollow
                followedArtists.splice(index, 1);
            } else {
                // Follow
                followedArtists.push({ id: artistId, name: artistName, image: imageUrl });
            }

            localStorage.setItem('followedPeyzaArtists', JSON.stringify(followedArtists));

            // Re-render relevant parts of the UI
            renderLibrary();
            // Optional: Re-render the follow button on the current page if it's an artist page
            const followButton = document.getElementById('follow-button');
            if (followButton) {
                followButton.outerHTML = renderFollowButton(artistId, artistName, imageUrl);
                renderIcons();
            }
        }

        // --- UI RENDERING FUNCTIONS ---

        /**
         * Renders the Home View with some suggested content.
         */
        function renderHome() {
            const contentArea = document.getElementById('dynamic-content');
            contentArea.innerHTML = `
                <h1 class="text-4xl font-extrabold mb-8">Good evening</h1>
                
                <!-- Quick Access Grid (Tablet/Desktop) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-10">
                    ${renderCardLink('Artist', 'Verified Peyza Artists', 'artist', '3TVXtAsR1Inumwj472Syg4', 'https://placehold.co/100x100/1DB954/ffffff?text=ARTIST')}
                    ${renderCardLink('Album', 'Latest Hits', 'album', '6KspK9Qf90QfE45V2w5B5M', 'https://placehold.co/100x100/1DB954/ffffff?text=ALBUM')}
                    ${renderCardLink('Playlist', 'Morning Drive', 'search', 'drive', 'https://placehold.co/100x100/1DB954/ffffff?text=PLAYLIST')}
                    ${renderCardLink('Podcast', 'Tech Weekly', 'search', 'tech', 'https://placehold.co/100x100/1DB954/ffffff?text=PODCAST')}
                </div>

                <!-- Suggested Sections -->
                <h2 class="text-2xl font-bold mt-8 mb-4">Made for you</h2>
                ${renderHorizontalSection([
                    { title: 'Chill Vibes', description: 'Relax and unwind with smooth tunes.', image: 'https://placehold.co/150x150/4B77BE/ffffff?text=CHILL' },
                    { title: 'Workout Mix', description: 'High energy for your training.', image: 'https://placehold.co/150x150/FF3860/ffffff?text=WORKOUT' },
                    { title: 'Focus Flow', description: 'Instrumental music for deep work.', image: 'https://placehold.co/150x150/34495E/ffffff?text=FOCUS' }
                ])}

                <h2 class="text-2xl font-bold mt-8 mb-4">Recently Played</h2>
                ${renderHorizontalSection([
                    { title: 'The Road Less Traveled', description: 'By Verified Peyza Artist 1', image: 'https://placehold.co/150x150/F39C12/ffffff?text=ROAD' },
                    { title: 'Midnight City', description: 'Album by Synthwave Co.', image: 'https://placehold.co/150x150/8E44AD/ffffff?text=MIDNIGHT' },
                ])}
            `;
        }

        /**
         * Renders a quick access card link.
         */
        function renderCardLink(type, title, action, data, imageUrl) {
            return `
                <a href="#" class="bg-card-dark/50 hover:bg-card-dark transition duration-200 rounded-lg overflow-hidden flex items-center shadow-lg"
                   onclick="event.preventDefault(); navigateTo('${action}', '${data}');">
                    <img src="${imageUrl}" class="w-20 h-20 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/80x80/282828/b3b3b3?text=${type[0]}'">
                    <span class="text-white font-semibold p-4 truncate">${title}</span>
                </a>
            `;
        }

        /**
         * Renders a horizontal scrolling section of content cards.
         */
        function renderHorizontalSection(items) {
            return `
                <div class="overflow-x-auto whitespace-nowrap pb-4">
                    <div class="flex space-x-4">
                        ${items.map(item => `
                            <div class="inline-block w-40 p-4 bg-card-dark rounded-xl shadow-xl hover:bg-[#333] transition duration-200 cursor-pointer">
                                <img src="${item.image}" alt="${item.title}" class="w-full h-40 object-cover rounded-lg mb-3 shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/160x160/282828/b3b3b3?text=IMG'">
                                <p class="text-white font-bold truncate">${item.title}</p>
                                <p class="text-light-gray text-sm whitespace-normal mt-1">${item.description}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        /**
         * Renders the content when no search query has been made.
         */
        function renderSearchPlaceholder() {
            return `
                <h1 class="text-2xl md:text-3xl font-bold mb-6">Search Full Library</h1>
                <div class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    ${renderSearchCategoryCard('Podcasts', 'bg-red-500', 'podcast')}
                    ${renderSearchCategoryCard('Made For You', 'bg-green-500', 'playlist')}
                    ${renderSearchCategoryCard('Charts', 'bg-blue-500', 'chart')}
                    ${renderSearchCategoryCard('New Releases', 'bg-yellow-500', 'new')}
                    ${renderSearchCategoryCard('Hip Hop', 'bg-purple-500', 'hip hop')}
                    ${renderSearchCategoryCard('Pop', 'bg-pink-500', 'pop')}
                </div>
            `;
        }

        function renderSearchCategoryCard(title, bgColor, search) {
            return `
                <div class="h-32 rounded-xl p-4 cursor-pointer relative overflow-hidden shadow-lg ${bgColor} hover:opacity-90 transition"
                     onclick="document.getElementById('search-input').value='${search}'; performSearch('${search}');">
                    <p class="text-xl font-extrabold">${title}</p>
                    <img src="https://placehold.co/70x70/${bgColor.replace('bg-', '')}/ffffff?text=ðŸŽ§" class="absolute -bottom-2 -right-2 transform rotate-12" alt="icon">
                </div>
            `;
        }

        /**
         * Renders the search results page.
         * @param {object} data - The Spotify search response object.
         */
        function renderSearchResults(data) {
            const contentArea = document.getElementById('dynamic-content');
            const tracks = data.tracks.items;
            const artists = data.artists.items.filter(a => a.images.length > 0);
            const albums = data.albums.items.filter(a => a.images.length > 0);

            contentArea.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Full Library Search Results</h1>

                <!-- Top Result (If available) -->
                ${artists.length > 0 ? `
                <h2 class="text-xl font-bold mb-4">Top Verified Peyza Artist</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-card-dark p-6 rounded-xl shadow-xl hover:bg-[#333] transition duration-200 cursor-pointer col-span-1 md:col-span-1"
                         onclick="navigateTo('artist', '${artists[0].id}')">
                        <img src="${artists[0].images[0].url}" alt="${artists[0].name}" class="w-32 h-32 rounded-full object-cover mb-4 mx-auto md:mx-0 shadow-2xl">
                        <p class="text-xl font-bold text-center md:text-left">${artists[0].name}</p>
                        <p class="text-light-gray text-sm text-center md:text-left">Verified Peyza Artist</p>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-lg font-bold mb-2">Top Tracks</h3>
                        ${tracks.slice(0, 3).map((track, index) => renderTrackRow(track, index + 1)).join('')}
                    </div>
                </div>` : ''}

                <!-- Artists Section -->
                ${artists.length > 0 ? `
                <h2 class="text-2xl font-bold mt-8 mb-4">Verified Peyza Artists</h2>
                <div class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    ${artists.slice(0, 6).map(artist => renderArtistCard(artist)).join('')}
                </div>` : ''}

                <!-- Tracks Section -->
                ${tracks.length > 0 ? `
                <h2 class="text-2xl font-bold mt-8 mb-4">Tracks</h2>
                <div class="space-y-2">
                    ${tracks.slice(0, 5).map((track, index) => renderTrackRow(track, index + 1)).join('')}
                </div>` : ''}

                <!-- Albums Section -->
                ${albums.length > 0 ? `
                <h2 class="text-2xl font-bold mt-8 mb-4">Albums</h2>
                <div class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    ${albums.slice(0, 6).map(album => renderAlbumCard(album)).join('')}
                </div>` : ''}

                ${(tracks.length + artists.length + albums.length) === 0 ? '<p class="text-light-gray p-8 text-center">No results found in Full Library.</p>' : ''}
            `;
            renderIcons();
        }

        /**
         * Renders a card for an Artist.
         * @param {object} artist - Spotify artist object.
         */
        function renderArtistCard(artist) {
            const imageUrl = artist.images?.[0]?.url || 'https://placehold.co/160x160/282828/b3b3b3?text=ARTIST';
            return `
                <div class="p-3 bg-card-dark rounded-xl shadow-xl hover:bg-[#333] transition duration-200 cursor-pointer"
                     onclick="navigateTo('artist', '${artist.id}')">
                    <img src="${imageUrl}" alt="${artist.name}" class="w-full h-auto rounded-full aspect-square object-cover mb-3 shadow-md">
                    <p class="text-white font-bold truncate">${artist.name}</p>
                    <p class="text-light-gray text-sm">Verified Peyza Artist</p>
                </div>
            `;
        }

        /**
         * Renders a card for an Album.
         * @param {object} album - Spotify album object.
         */
        function renderAlbumCard(album) {
            const imageUrl = album.images?.[0]?.url || 'https://placehold.co/160x160/282828/b3b3b3?text=ALBUM';
            return `
                <div class="p-3 bg-card-dark rounded-xl shadow-xl hover:bg-[#333] transition duration-200 cursor-pointer"
                     onclick="navigateTo('album', '${album.id}')">
                    <img src="${imageUrl}" alt="${album.name}" class="w-full h-auto rounded-lg aspect-square object-cover mb-3 shadow-md">
                    <p class="text-white font-bold truncate">${album.name}</p>
                    <p class="text-light-gray text-sm truncate">${album.artists[0].name}</p>
                </div>
            `;
        }

        /**
         * Renders a single row for a track.
         * @param {object} track - Spotify track object.
         * @param {number} index - Track number in a list.
         */
        function renderTrackRow(track, index) {
            const streams = generateStreams(track.popularity);
            const albumImage = track.album?.images?.[2]?.url || 'https://placehold.co/60x60/282828/b3b3b3?text=ðŸŽ¶';
            const duration = new Date(track.duration_ms).toISOString().slice(14, 19).replace('00:', ''); // MM:SS or S:SS

            return `
                <div class="flex items-center p-2 rounded-lg hover:bg-card-dark transition duration-150 cursor-pointer">
                    <span class="text-light-gray w-6 text-center text-sm mr-2">${index}</span>
                    <img src="${albumImage}" class="w-12 h-12 object-cover rounded mr-3" alt="Album Cover">
                    <div class="flex-grow min-w-0">
                        <p class="text-white font-medium truncate">${track.name}</p>
                        <p class="text-light-gray text-xs truncate">
                            ${track.artists.map(a => `<span onclick="event.stopPropagation(); navigateTo('artist', '${a.id}')" class="hover:underline">${a.name}</span>`).join(', ')}
                        </p>
                    </div>
                    <div class="text-light-gray text-sm hidden sm:block w-32 text-right">
                        ${streams} Streams
                    </div>
                    <div class="text-light-gray text-sm w-12 text-right ml-4">
                        ${duration}
                    </div>
                </div>
            `;
        }

        /**
         * Renders the dedicated Artist Page.
         */
        function renderArtistPage(artist, topTracks, albums) {
            const contentArea = document.getElementById('dynamic-content');
            const imageUrl = artist.images?.[0]?.url || 'https://placehold.co/500x300/282828/b3b3b3?text=ARTIST';
            const monthlyListeners = generateMonthlyListeners(artist.popularity);
            const followers = generateFollowers(artist.popularity);
            const isFollowed = isArtistFollowed(artist.id);

            contentArea.innerHTML = `
                <!-- Artist Header -->
                <div class="relative pt-20 pb-8 px-4 md:px-6 rounded-t-xl" style="background-image: linear-gradient(to bottom, rgba(50, 50, 50, 0.5), rgba(18, 18, 18, 1));">
                    <div class="absolute inset-0 bg-cover bg-center opacity-30" style="background-image: url('${imageUrl}');"></div>
                    <div class="relative z-10">
                        <p class="text-white font-bold text-sm flex items-center mb-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-accent-green mr-1"></i>
                            Verified Peyza Artist
                        </p>
                        <h1 class="text-4xl md:text-7xl font-extrabold mb-4">${artist.name}</h1>
                        <p class="text-light-gray text-lg">${monthlyListeners} Monthly Listeners</p>
                        <p class="text-light-gray text-md">${followers} Followers</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="p-4 md:p-6 flex items-center space-x-4">
                    <button class="bg-accent-green text-black font-bold py-3 px-6 rounded-full shadow-lg hover:scale-[1.02] transition duration-200">
                        <i data-lucide="play" class="inline-block w-6 h-6 mr-1"></i> PLAY
                    </button>
                    ${renderFollowButton(artist.id, artist.name, imageUrl)}
                </div>

                <!-- Top Tracks -->
                <div class="p-4 md:p-6">
                    <h2 class="text-2xl font-bold mb-4">Popular Tracks</h2>
                    <div class="space-y-2">
                        ${topTracks.slice(0, 5).map((track, index) => renderTrackRow(track, index + 1)).join('')}
                    </div>
                </div>

                <!-- Albums/Singles -->
                <div class="p-4 md:p-6">
                    <h2 class="text-2xl font-bold mb-4">Albums & Singles</h2>
                    <div class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        ${albums.map(album => renderAlbumCard(album)).join('')}
                    </div>
                </div>
            `;
        }

        /**
         * Renders the follow button state.
         */
        function renderFollowButton(artistId, artistName, imageUrl) {
            const isFollowed = isArtistFollowed(artistId);
            return `
                <button id="follow-button"
                    class="border border-light-gray text-white font-bold py-2 px-4 rounded-full text-sm hover:border-white transition duration-200 ${isFollowed ? 'bg-white text-black hover:bg-light-gray' : ''}"
                    onclick="toggleFollowArtist('${artistId}', '${artistName.replace(/'/g, "\\'")}', '${imageUrl.replace(/'/g, "\\'")}')">
                    ${isFollowed ? 'FOLLOWING' : 'FOLLOW'}
                </button>
            `;
        }

        /**
         * Renders the dedicated Album Release Page.
         */
        function renderAlbumPage(album) {
            const contentArea = document.getElementById('dynamic-content');
            const imageUrl = album.images?.[0]?.url || 'https://placehold.co/300x300/282828/b3b3b3?text=ALBUM';
            const releaseDate = album.release_date.substring(0, 4);

            // Collect all unique artists in the album
            const allArtists = new Map();
            album.tracks.items.forEach(track => {
                track.artists.forEach(artist => {
                    if (artist.id) {
                        allArtists.set(artist.id, { name: artist.name, id: artist.id });
                    }
                });
            });

            // The main artist is always the first one listed
            const mainArtist = album.artists[0];
            allArtists.delete(mainArtist.id); // Remove main artist from featured list

            const featuredArtists = Array.from(allArtists.values());

            contentArea.innerHTML = `
                <!-- Album Header -->
                <div class="flex flex-col md:flex-row items-center md:items-end p-6 md:p-8 bg-card-dark rounded-xl shadow-2xl mb-6" style="background-image: linear-gradient(to bottom, rgba(70, 70, 70, 0.4), rgba(40, 40, 40, 1));">
                    <img src="${imageUrl}" alt="${album.name}" class="w-48 h-48 md:w-64 md:h-64 object-cover rounded-lg shadow-2xl mb-4 md:mb-0 md:mr-6">
                    <div>
                        <p class="text-sm font-semibold uppercase text-light-gray mt-4 md:mt-0">${album.album_type}</p>
                        <h1 class="text-4xl md:text-6xl font-extrabold mb-2">${album.name}</h1>
                        <p class="text-light-gray font-semibold mb-2">${releaseDate} &middot; ${album.total_tracks} songs</p>
                        <div class="flex items-center space-x-2 text-white font-bold">
                            <i data-lucide="verified" class="w-4 h-4 text-accent-green"></i>
                            <a href="#" onclick="event.preventDefault(); navigateTo('artist', '${mainArtist.id}')" class="hover:underline">${mainArtist.name}</a>
                        </div>
                    </div>
                </div>

                <!-- Play Button & Actions -->
                <div class="p-4 flex items-center space-x-4">
                    <button class="bg-accent-green text-black p-3 rounded-full shadow-lg hover:scale-[1.05] transition duration-200">
                        <i data-lucide="play" class="w-8 h-8"></i>
                    </button>
                    <button class="text-light-gray hover:text-white transition duration-200">
                        <i data-lucide="heart" class="w-7 h-7"></i>
                    </button>
                </div>

                <!-- Featured Artists Section -->
                ${featuredArtists.length > 0 ? `
                <div class="p-4">
                    <h2 class="text-xl font-bold mb-3">Featured Verified Peyza Artists</h2>
                    <div class="flex flex-wrap gap-3">
                        ${featuredArtists.map(artist => `
                            <button class="bg-card-dark/70 text-white py-2 px-4 rounded-full text-sm hover:bg-[#333] transition duration-200"
                                    onclick="navigateTo('artist', '${artist.id}')">
                                ${artist.name}
                            </button>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Track List -->
                <div class="p-4 md:p-6">
                    <div class="space-y-1">
                        ${album.tracks.items.map((track, index) => renderTrackRow(track, index + 1)).join('')}
                    </div>
                </div>
            `;
        }


        /**
         * Renders the "Your Library" view (simulated).
         */
        function renderLibrary() {
            const contentArea = document.getElementById('dynamic-content');
            const followedArtists = JSON.parse(localStorage.getItem('followedPeyzaArtists') || '[]');
            const librarySidebar = document.getElementById('library-content');

            contentArea.innerHTML = `
                <h1 class="text-3xl md:text-4xl font-extrabold mb-8">Your Library</h1>
                
                ${followedArtists.length > 0 ? `
                    <h2 class="text-2xl font-bold mb-4">Verified Peyza Artists You Follow</h2>
                    <div class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        ${followedArtists.map(artist => renderArtistCard(artist)).join('')}
                    </div>
                ` : `
                    <div class="p-10 bg-card-dark rounded-xl text-center">
                        <i data-lucide="mic" class="w-12 h-12 mx-auto text-light-gray mb-3"></i>
                        <h2 class="text-xl font-bold mb-2">Find something to follow</h2>
                        <p class="text-light-gray mb-4">Search for your favorite Verified Peyza Artists and follow them to add them here.</p>
                        <button class="bg-white text-black font-bold py-2 px-4 rounded-full hover:bg-light-gray transition" onclick="navigateTo('search')">
                            Search Full Library
                        </button>
                    </div>
                `}
            `;

            // Update the sidebar library content
            librarySidebar.innerHTML = followedArtists.map(artist => `
                <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-card-dark/50 transition duration-150 cursor-pointer"
                     onclick="navigateTo('artist', '${artist.id}')">
                    <img src="${artist.image || 'https://placehold.co/40x40/282828/b3b3b3?text=A'}" class="w-10 h-10 rounded-full object-cover" alt="${artist.name}">
                    <div class="min-w-0">
                        <p class="text-white font-semibold truncate">${artist.name}</p>
                        <p class="text-light-gray text-xs truncate">Verified Peyza Artist</p>
                    </div>
                </div>
            `).join('');

            renderIcons();
        }

        // --- INITIALIZATION ---

        window.onload = () => {
            // Initialize main view
            navigateTo('home');
            // Re-render library on load (just in case)
            renderLibrary();
        };

        // Make search functional from the input field
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(e.target.value);
            }
        });
    </script>
</body>
</html>
