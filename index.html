<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peyza Chronicles - RPG Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Lato', sans-serif;
            color: white;
            user-select: none;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
        }

        /* Top HUD */
        #hud {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .stat-box {
            display: flex;
            gap: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main Dialogue Area */
        #dialogue-container {
            pointer-events: auto;
            margin: 0 auto 40px auto;
            width: 90%;
            max-width: 800px;
            background: rgba(20, 20, 30, 0.95);
            border: 2px solid #4a5568;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.5);
            transition: opacity 0.5s;
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        #speaker-name {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: #fbbf24;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #dialogue-text {
            font-size: 1.1rem;
            line-height: 1.6;
            min-height: 80px;
        }

        #choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        button.choice-btn {
            background: linear-gradient(45deg, #2d3748, #1a202c);
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 15px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-align: left;
        }

        button.choice-btn:hover {
            background: linear-gradient(45deg, #4a5568, #2d3748);
            border-color: #fbbf24;
            transform: translateX(5px);
            box-shadow: -2px 2px 10px rgba(0,0,0,0.5);
        }

        /* Title Screen */
        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            text-align: center;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 5rem;
            color: #fff;
            text-shadow: 0 0 20px #fbbf24, 0 0 40px #d97706;
            margin-bottom: 10px;
            animation: pulse 3s infinite;
        }

        h2 {
            font-family: 'Lato', sans-serif;
            font-weight: 300;
            color: #cbd5e0;
            margin-bottom: 40px;
        }

        .version-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .v-btn {
            padding: 20px 30px;
            background: rgba(20, 20, 30, 0.8);
            border: 2px solid #fbbf24;
            color: #fbbf24;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            text-align: center;
            transition: all 0.3s ease;
            min-width: 220px;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }

        .v-btn:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        /* Christmas Lights Animation for V2 */
        @keyframes lights {
            0% { box-shadow: 0 0 10px red; border-color: red; }
            25% { box-shadow: 0 0 15px gold; border-color: gold; }
            50% { box-shadow: 0 0 10px green; border-color: green; }
            75% { box-shadow: 0 0 15px blue; border-color: blue; }
            100% { box-shadow: 0 0 10px red; border-color: red; }
        }

        #v2-btn {
            animation: lights 2s infinite linear;
            background: rgba(10, 30, 40, 0.9);
            color: #fff;
        }
        
        #v2-btn h3 {
            text-shadow: 0 0 5px white;
        }

        .v-btn h3 { margin: 0; font-size: 1.5rem; }
        .v-btn p { margin: 8px 0 0 0; font-family: 'Lato', sans-serif; font-size: 0.9rem; letter-spacing: 1px;}

        /* Footer Info */
        #footer-info {
            margin-top: 50px;
            color: #a0aec0;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        #play-count { color: #fbbf24; font-weight: bold; }

        /* Animations */
        @keyframes pulse {
            0% { text-shadow: 0 0 20px #fbbf24; }
            50% { text-shadow: 0 0 40px #fbbf24, 0 0 80px #d97706; }
            100% { text-shadow: 0 0 20px #fbbf24; }
        }

        /* Ending Screen */
        #ending-screen {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 20;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            pointer-events: auto;
            text-align: center;
            padding: 20px;
        }
        
        #ending-title { font-family: 'Cinzel', serif; font-size: 3rem; color: #fbbf24; margin-bottom: 20px;}
        #ending-desc { max-width: 600px; font-size: 1.2rem; line-height: 1.6; margin-bottom: 30px;}

    </style>
    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <!-- Audio Elements (Placeholders) -->
    <!-- Replace src with your actual audio files -->
    <audio id="bgm-v1" loop>
        <source src="https://upload.wikimedia.org/wikipedia/commons/e/ec/Folk_Irish_Music.ogg" type="audio/ogg"> 
    </audio>
    <audio id="bgm-v2" loop>
        <source src="https://upload.wikimedia.org/wikipedia/commons/5/5b/Winter_Wind.ogg" type="audio/ogg">
    </audio>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="hud">
            <div class="stat-box">
                <div class="stat"><span>‚ù§</span> <span id="hp-val">100</span></div>
                <div class="stat"><span>ü™ô</span> <span id="gold-val">0</span></div>
                <div class="stat"><span>‚ú®</span> <span id="karma-val">0</span></div>
            </div>
            <div class="stat-box">
                <div id="location-name">Unknown Lands</div>
            </div>
        </div>

        <div id="title-screen">
            <h1>PEYZA CHRONICLES</h1>
            <h2>Choose Your Adventure</h2>
            
            <div class="version-container">
                <button id="v1-btn" class="v-btn">
                    <h3>PEYZA V1</h3>
                    <p>The Original Journey</p>
                </button>
                <button id="v2-btn" class="v-btn">
                    <h3>PEYZA V2</h3>
                    <p>Winter's Legacy</p>
                </button>
            </div>
            
            <div id="footer-info">
                <span id="play-count">Total Plays: 3.2K</span>
                <span>&copy; Peyza.org</span>
            </div>
        </div>

        <div id="dialogue-container">
            <div id="speaker-name">Narrator</div>
            <div id="dialogue-text">...</div>
            <div id="choices"></div>
        </div>

        <div id="ending-screen">
            <div id="ending-title">ENDING UNLOCKED</div>
            <div id="ending-desc"></div>
            <button id="restart-btn" class="choice-btn" style="width: auto; padding: 10px 40px;">Return to Menu</button>
        </div>
    </div>

<script>
/**
 * PEYZA ENGINE 2.0
 */

// --- 1. GAME STATE ---
const state = {
    version: 1, // 1 or 2
    hp: 100,
    gold: 0,
    karma: 0,
    inventory: [],
    location: 'start',
    riddlesSolved: 0,
    hasMetWizard: false,
    hasMetMayor: false
};

// --- 2. THREE.JS SETUP ---
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x111111, 0.02);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.getElementById('canvas-container').appendChild(renderer.domElement);

// Lights
const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
scene.add(ambientLight);

const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(10, 20, 10);
dirLight.castShadow = true;
scene.add(dirLight);

const charLight = new THREE.PointLight(0xfbbf24, 2, 20);
charLight.position.set(0, 5, 2);
scene.add(charLight);

// --- 3. 3D ASSETS ---

// Floor
const floorGeo = new THREE.PlaneGeometry(200, 200, 64, 64);
const positionAttribute = floorGeo.attributes.position;
for ( let i = 0; i < positionAttribute.count; i ++ ) {
    const z = positionAttribute.getZ( i );
    positionAttribute.setZ( i, z + (Math.random() * 2) );
}
floorGeo.computeVertexNormals();

const floorMat = new THREE.MeshStandardMaterial({ 
    color: 0x1a472a, 
    roughness: 0.8,
    metalness: 0.1
});
const floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI / 2;
floor.position.y = -2;
floor.receiveShadow = true;
scene.add(floor);

// Environment Groups
const villageGroup = new THREE.Group();
const forestGroup = new THREE.Group();
const caveGroup = new THREE.Group();
const snowGroup = new THREE.Group(); // New for V2
scene.add(villageGroup);
scene.add(forestGroup);
scene.add(caveGroup);
scene.add(snowGroup);

// Snow Particles (V2 Only)
const snowGeo = new THREE.BufferGeometry();
const snowCount = 1000;
const snowPos = new Float32Array(snowCount * 3);
for(let i=0; i<snowCount*3; i++) {
    snowPos[i] = (Math.random() - 0.5) * 100;
}
snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
const snowMat = new THREE.PointsMaterial({
    color: 0xffffff,
    size: 0.5,
    transparent: true,
    opacity: 0.8
});
const snowSystem = new THREE.Points(snowGeo, snowMat);
snowGroup.add(snowSystem);
snowGroup.visible = false;

// Helper: Tree
function createTree(x, z, frozen = false) {
    const trunkGeo = new THREE.CylinderGeometry(0.5, 0.8, 4, 6);
    const trunkMat = new THREE.MeshStandardMaterial({ color: 0x4a3728 });
    const trunk = new THREE.Mesh(trunkGeo, trunkMat);
    trunk.position.y = 0;
    
    const leavesGeo = new THREE.ConeGeometry(3, 6, 8);
    // Frozen trees are white/blue
    const leavesMat = new THREE.MeshStandardMaterial({ color: frozen ? 0xaaddff : 0x2d5a27 });
    const leaves = new THREE.Mesh(leavesGeo, leavesMat);
    leaves.position.y = 4;
    
    const tree = new THREE.Group();
    tree.add(trunk);
    tree.add(leaves);
    tree.position.set(x, -0.5, z);
    tree.castShadow = true;
    return tree;
}

// Helper: House
function createHouse(x, z, snowCovered = false) {
    const baseGeo = new THREE.BoxGeometry(6, 4, 6);
    const baseMat = new THREE.MeshStandardMaterial({ color: 0x8d7b68 });
    const base = new THREE.Mesh(baseGeo, baseMat);
    
    const roofGeo = new THREE.ConeGeometry(5, 4, 4);
    const roofMat = new THREE.MeshStandardMaterial({ color: snowCovered ? 0xffffff : 0x4a2c2a });
    const roof = new THREE.Mesh(roofGeo, roofMat);
    roof.position.y = 4;
    roof.rotation.y = Math.PI / 4;

    const house = new THREE.Group();
    house.add(base);
    house.add(roof);
    house.position.set(x, 0, z);
    return house;
}

// Helper: Character
let currentCharacter = null;
function createCharacter(type, color) {
    if (currentCharacter) {
        scene.remove(currentCharacter);
    }
    const group = new THREE.Group();
    
    // Head
    const headGeo = new THREE.SphereGeometry(1, 16, 16);
    const headMat = new THREE.MeshStandardMaterial({ color: 0xffdbac });
    const head = new THREE.Mesh(headGeo, headMat);
    head.position.y = 4;
    
    // Body
    const bodyGeo = new THREE.CylinderGeometry(0.8, 1, 3, 12);
    const bodyMat = new THREE.MeshStandardMaterial({ color: color });
    const body = new THREE.Mesh(bodyGeo, bodyMat);
    body.position.y = 1.5;

    // Hat logic
    if(type === 'wizard' || type === 'frozen_king') {
        const hatGeo = new THREE.ConeGeometry(1.2, 3, 16);
        const hatMat = new THREE.MeshStandardMaterial({ color: type === 'frozen_king' ? 0x00ffff : 0x4b0082 });
        const hat = new THREE.Mesh(hatGeo, hatMat);
        hat.position.y = 5.2;
        group.add(hat);
    }

    group.add(head);
    group.add(body);
    group.userData = { offset: Math.random() * 100 };
    group.position.set(0, -2, -5);
    scene.add(group);
    currentCharacter = group;
}

// Populate V1 (Green)
for(let i=0; i<30; i++) {
    const x = (Math.random() - 0.5) * 80;
    const z = (Math.random() - 0.5) * 60 - 20;
    if (Math.abs(x) < 5 && Math.abs(z) < 5) continue;
    forestGroup.add(createTree(x, z, false));
}
villageGroup.add(createHouse(-10, -10));
villageGroup.add(createHouse(10, -15));
villageGroup.add(createHouse(-8, -25));
villageGroup.add(createTree(15, -5));

// --- 4. GAME LOOP ---
let time = 0;
function animate() {
    requestAnimationFrame(animate);
    time += 0.01;

    // Character Bobbing
    if (currentCharacter) {
        currentCharacter.position.y = -2 + Math.sin(time * 2 + currentCharacter.userData.offset) * 0.2;
        currentCharacter.rotation.y = Math.sin(time * 0.5) * 0.1;
    }

    // Camera Drift
    camera.position.x = Math.sin(time * 0.2) * 0.5;
    camera.position.y = 2 + Math.cos(time * 0.3) * 0.2;
    
    // Snow Animation
    if (snowGroup.visible) {
        const positions = snowSystem.geometry.attributes.position.array;
        for(let i = 1; i < positions.length; i += 3) {
            positions[i] -= 0.1;
            if (positions[i] < -5) positions[i] = 20;
        }
        snowSystem.geometry.attributes.position.needsUpdate = true;
    }

    renderer.render(scene, camera);
}
animate();

// --- 5. STORY ENGINE ---

// Combined Story Nodes for V1 and V2
const storyNodes = {
    // === V1 NODES ===
    v1_start: {
        text: "You awaken in a clearing. The air smells of pine. A path leads North to Peyza Village.",
        speaker: "Narrator",
        bg: "forest",
        options: [
            { text: "Go to Village", next: "v1_village_gate" },
            { text: "Check pockets", next: "v1_pockets" }
        ]
    },
    v1_pockets: {
        text: "You find a rusty coin and a note: 'Beware the Red Wizard'.",
        speaker: "Inventory",
        bg: "forest",
        action: () => state.inventory.push("Rusty Coin"),
        options: [{ text: "Back", next: "v1_start" }]
    },
    v1_village_gate: {
        text: "Peyza Village. Mayor Oryn looks worried.",
        speaker: "Narrator",
        bg: "village",
        char: { type: 'villager', color: 0x3b82f6 },
        options: [
            { text: "Talk to Mayor", next: "v1_meet_mayor" }
        ]
    },
    v1_meet_mayor: {
        text: "Traveler! The Red Wizard has cursed us. Please, save our village.",
        speaker: "Mayor Oryn",
        bg: "village",
        char: { type: 'villager', color: 0x3b82f6 },
        options: [
            { text: "I will help.", next: "v1_forest_entry" },
            { text: "No thanks.", next: "v1_leave" }
        ]
    },
    v1_forest_entry: {
        text: "The forest is dark. A fairy appears.",
        speaker: "Narrator",
        bg: "forest",
        options: [
            { text: "Follow Fairy", next: "v1_tower" }
        ]
    },
    v1_tower: {
        text: "You reach the Obsidian Tower. Zog the Red awaits.",
        speaker: "Narrator",
        bg: "cave",
        char: { type: 'wizard', color: 0x4b0082 },
        options: [
            { text: "Fight Him", next: "v1_fight" },
            { text: "Talk", next: "v1_talk" }
        ]
    },
    v1_talk: {
        text: "The Mayor is corrupt! Help me stop the demons.",
        speaker: "Zog",
        bg: "cave",
        options: [
            { text: "Join Zog", next: "end_hero" }
        ]
    },
    v1_fight: {
        text: "Zog blasts you with fire. You perish.",
        speaker: "Narrator",
        bg: "cave",
        action: () => state.hp = 0,
        options: [{ text: "End", next: "end_death" }]
    },
    v1_leave: {
        text: "You walk away, leaving the village to its doom.",
        speaker: "Narrator",
        bg: "forest",
        options: [{ text: "End", next: "end_coward" }]
    },

    // === V2 NODES (Winter's Legacy) ===
    v2_start: {
        text: "Twenty years have passed since your father saved Peyza. But now, an unnatural blizzard buries the land. You, Eldrin, must rise.",
        speaker: "Narrator",
        bg: "snow_forest",
        options: [
            { text: "Leave your warm cabin", next: "v2_snow_village" },
            { text: "Take Father's Old Sword", next: "v2_take_sword" }
        ]
    },
    v2_take_sword: {
        text: "The blade is cold but sharp. It hums with old magic.",
        speaker: "Inventory",
        bg: "snow_forest",
        action: () => state.inventory.push("Hero Sword"),
        options: [{ text: "Head out", next: "v2_snow_village" }]
    },
    v2_snow_village: {
        text: "Peyza Village is frozen. The fountain is solid ice. A shivering guard blocks the path.",
        speaker: "Narrator",
        bg: "snow_village",
        char: { type: 'villager', color: 0xaaddff }, // Frozen villager
        options: [
            { text: "Ask about the cold", next: "v2_guard_talk" },
            { text: "Give him a warm potion", next: "v2_give_potion" } // Hidden option if you had one
        ]
    },
    v2_guard_talk: {
        text: "It's the Frozen King... he returned from the Northern Spire. He demands the Ever-Flame.",
        speaker: "Guard",
        bg: "snow_village",
        options: [
            { text: "I will defeat him.", next: "v2_spire_journey" },
            { text: "Where is the Ever-Flame?", next: "v2_lore_flame" }
        ]
    },
    v2_lore_flame: {
        text: "The Ever-Flame was hidden by your father. Only his blood can find it.",
        speaker: "Guard",
        bg: "snow_village",
        options: [
            { text: "Check the Old Shrine", next: "v2_shrine" }
        ]
    },
    v2_shrine: {
        text: "You find the shrine. A blue flame flickers. It warms your soul.",
        speaker: "Narrator",
        bg: "snow_forest",
        action: () => { state.inventory.push("Ever-Flame"); state.karma += 20; },
        options: [
            { text: "Take it to the Spire", next: "v2_spire_journey" }
        ]
    },
    v2_spire_journey: {
        text: "The wind howls. You climb the frozen steps of the Spire. The cold bites for 10 damage.",
        speaker: "Narrator",
        bg: "snow_cave",
        action: () => { state.hp -= 10; updateHUD(); },
        options: [
            { text: "Enter the Throne Room", next: "v2_throne" }
        ]
    },
    v2_throne: {
        text: "The Frozen King sits on a throne of ice. 'Son of the Hero... have you come to die?'",
        speaker: "Frozen King",
        bg: "snow_cave",
        char: { type: 'frozen_king', color: 0x00ffff },
        options: [
            { text: "Attack with Sword", next: "v2_fight_sword" },
            { text: "Use the Ever-Flame", next: "v2_use_flame" },
            { text: "Try to reason", next: "v2_reason" }
        ]
    },
    v2_fight_sword: {
        text: "Your sword shatters against his ice armor! He freezes you instantly.",
        speaker: "Narrator",
        bg: "snow_cave",
        action: () => state.hp = 0,
        options: [{ text: "End", next: "end_frozen" }]
    },
    v2_use_flame: {
        text: "You unleash the Ever-Flame! The ice melts, and the King shrieks as spring returns to Peyza.",
        speaker: "Narrator",
        bg: "snow_cave",
        options: [{ text: "Victory", next: "end_spring" }]
    },
    v2_reason: {
        text: "He has no heart to reason with. The cold consumes you.",
        speaker: "Narrator",
        bg: "snow_cave",
        action: () => state.hp = 0,
        options: [{ text: "End", next: "end_frozen" }]
    },

    // === ENDINGS ===
    end_hero: { title: "Ending: Hero of V1", desc: "You saved the village.", type: "end" },
    end_coward: { title: "Ending: Coward", desc: "You ran away.", type: "end" },
    end_death: { title: "Ending: Ashes", desc: "You died.", type: "end" },
    end_frozen: { title: "Ending: Ice Statue", desc: "You are frozen forever.", type: "end" },
    end_spring: { title: "Ending: Spring Bringer", desc: "You melted the eternal winter and surpassed your father.", type: "end" }
};

// --- 6. UI LOGIC ---

function updateHUD() {
    document.getElementById('hp-val').innerText = state.hp;
    document.getElementById('gold-val').innerText = state.gold;
    document.getElementById('karma-val').innerText = state.karma;
    
    if(state.hp <= 0 && !state.location.startsWith('end')) {
        // Simple death check
        if(state.version === 1) loadNode('end_death');
        else loadNode('end_frozen');
    }
}

function loadNode(nodeId) {
    state.location = nodeId;
    const node = storyNodes[nodeId];

    // Check for Ending
    if (node.type === 'end') {
        document.getElementById('dialogue-container').style.display = 'none';
        const endScreen = document.getElementById('ending-screen');
        endScreen.style.display = 'flex';
        document.getElementById('ending-title').innerText = node.title;
        document.getElementById('ending-desc').innerText = node.desc;
        return;
    }

    // Execute Action
    if (node.action) node.action();

    // Update Text
    document.getElementById('speaker-name').innerText = node.speaker;
    document.getElementById('dialogue-text').innerText = node.text;

    // Update Visuals
    updateSceneVisuals(node.bg, node.char);

    // Generate Choices
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = '';
    
    node.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.innerText = opt.text;
        btn.onclick = () => loadNode(opt.next);
        choicesDiv.appendChild(btn);
    });
}

function updateSceneVisuals(bgType, charData) {
    // Reset Visibility
    villageGroup.visible = false;
    forestGroup.visible = false;
    caveGroup.visible = false;
    snowGroup.visible = false;
    
    // Default Floor
    floorMat.color.setHex(0x1a472a); // Green

    // Background Colors
    let skyColor = 0x87CEEB;
    let fogColor = 0x87CEEB;

    if (bgType === 'forest') {
        forestGroup.visible = true;
        skyColor = 0x1a472a; fogColor = 0x051a05;
        document.getElementById('location-name').innerText = "Dark Forest";
    } else if (bgType === 'village') {
        villageGroup.visible = true;
        document.getElementById('location-name').innerText = "Peyza Village";
    } else if (bgType === 'cave') {
        caveGroup.visible = true;
        skyColor = 0x111111; fogColor = 0x000000;
        document.getElementById('location-name').innerText = "Obsidian Tower";
    } 
    // V2 Backgrounds
    else if (bgType === 'snow_forest') {
        forestGroup.visible = true;
        snowGroup.visible = true;
        floorMat.color.setHex(0xffffff); // Snow floor
        skyColor = 0xddeeff; fogColor = 0xaaccff;
        document.getElementById('location-name').innerText = "Frozen Wilds";
    } else if (bgType === 'snow_village') {
        villageGroup.visible = true;
        snowGroup.visible = true;
        floorMat.color.setHex(0xffffff);
        skyColor = 0xddeeff; fogColor = 0xaaccff;
        document.getElementById('location-name').innerText = "Frozen Village";
    } else if (bgType === 'snow_cave') {
        caveGroup.visible = true;
        snowGroup.visible = true;
        floorMat.color.setHex(0xaaaaaa);
        skyColor = 0x223344; fogColor = 0x112233;
        document.getElementById('location-name').innerText = "Ice Spire";
    }

    scene.background = new THREE.Color(skyColor);
    scene.fog.color.setHex(fogColor);

    // Character
    if (charData) {
        createCharacter(charData.type, charData.color);
    } else {
        if (currentCharacter) {
            scene.remove(currentCharacter);
            currentCharacter = null;
        }
    }
}

// Music Control
function playMusic(version) {
    const v1Audio = document.getElementById('bgm-v1');
    const v2Audio = document.getElementById('bgm-v2');
    
    v1Audio.pause(); v1Audio.currentTime = 0;
    v2Audio.pause(); v2Audio.currentTime = 0;

    if(version === 1) {
        v1Audio.play().catch(e => console.log("Audio requires interaction"));
    } else {
        v2Audio.play().catch(e => console.log("Audio requires interaction"));
    }
}

// Start Listeners
document.getElementById('v1-btn').addEventListener('click', () => {
    state.version = 1;
    state.hp = 100; state.gold = 0; state.inventory = [];
    document.getElementById('title-screen').style.display = 'none';
    document.getElementById('dialogue-container').style.display = 'flex';
    playMusic(1);
    loadNode('v1_start');
});

document.getElementById('v2-btn').addEventListener('click', () => {
    state.version = 2;
    state.hp = 100; state.gold = 50; state.inventory = [];
    document.getElementById('title-screen').style.display = 'none';
    document.getElementById('dialogue-container').style.display = 'flex';
    playMusic(2);
    loadNode('v2_start');
});

document.getElementById('restart-btn').addEventListener('click', () => {
    location.reload();
});

// Resize
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>
