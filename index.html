<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Peyza AI - An advanced, free AI chatbot powered by RouteWay and GLM 4.6. Experience seamless conversation, earn XP, and collect badges.">
    <meta name="keywords" content="AI, Chatbot, Peyza, Free AI, Assistant, GLM">
    <meta name="author" content="Peyza.org">
    
    <link rel="icon" href="favicon.png" type="image/png">
    
    <title>Peyza - AI Chat</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        sidebar: '#202123',
                        main: '#343541',
                        userMsg: '#343541',
                        aiMsg: '#444654',
                        accent: '#10a37f',
                        accentHover: '#1a7f64'
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'slide-in-right': 'slideInRight 0.4s ease-out',
                        'slide-in-left': 'slideInLeft 0.4s ease-out',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #202123; 
        }
        ::-webkit-scrollbar-thumb {
            background: #555; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777; 
        }

        /* Typing cursor animation */
        .typing-cursor::after {
            content: '▋';
            animation: blink 1s step-start infinite;
            color: #10a37f;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Thinking animation dots */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #9880ff; }
            50%, 100% { background-color: #ebe6ff; }
        }
        
        /* XP Shine Effect */
        .xp-shine {
            position: relative;
            overflow: hidden;
        }
        .xp-shine::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 2s infinite;
        }
        @keyframes shine {
            100% { left: 100%; }
        }
    </style>
    <!-- User custom CSS injection point (Must be a separate style tag with an ID) -->
    <style id="user-custom-css"></style>
</head>
<body class="bg-main text-gray-100 h-screen w-screen overflow-hidden flex flex-col md:flex-row">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700 animate-slide-up">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gray-700 mb-4 shadow-lg overflow-hidden border-2 border-accent">
                    <!-- Favicon used here as requested -->
                    <img src="favicon.png" alt="Peyza Logo" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=Peyza'">
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Welcome to Peyza</h1>
                <p class="text-gray-400">Login or Signup to continue</p>
            </div>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Username</label>
                    <input type="text" id="username" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-accent focus:outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="password" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-accent focus:outline-none transition-all">
                </div>
                <button type="submit" class="w-full bg-accent hover:bg-accentHover text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
                    Enter Peyza
                </button>
            </form>
            <p class="mt-4 text-center text-xs text-gray-500">Secure access powered by Peyza V1</p>
        </div>
    </div>

    <!-- Sidebar (History & Profile) -->
    <div id="sidebar" class="bg-sidebar w-full md:w-[260px] flex-shrink-0 flex flex-col h-full border-r border-gray-700 md:border-none transition-all duration-300 hidden md:flex">
        <div class="p-3">
            <button onclick="createNewChat()" class="w-full border border-gray-600 text-white rounded-md px-3 py-3 hover:bg-gray-700 transition-colors flex items-center gap-3 text-sm text-left shadow-sm hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200">
                <i class="fas fa-plus"></i>
                New Chat
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-3 py-2 space-y-2" id="chat-history-list">
            <!-- Chat history items go here -->
        </div>

        <!-- XP, Badges & Profile Section -->
        <div class="border-t border-gray-600 p-3 space-y-3">
            <!-- XP Display -->
            <div class="bg-gray-800 rounded-lg p-2 border border-gray-700 shadow-inner flex items-center justify-between xp-shine">
                <div class="flex items-center gap-2">
                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                    <span class="text-xs font-bold text-gray-300">XP</span>
                </div>
                <span id="xp-counter" class="text-sm font-mono font-bold text-accent">0</span>
            </div>

            <!-- Badge Container -->
            <div class="bg-gray-800/50 rounded-lg p-2 border border-gray-700">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-1 ml-1">Badges</div>
                <div id="badge-list" class="flex flex-wrap gap-1 min-h-[24px]">
                    <span class="text-xs text-gray-500 italic px-1">No badges yet</span>
                </div>
            </div>

            <div class="flex items-center gap-3 px-3 py-2 hover:bg-gray-700 rounded-md cursor-pointer transition-colors" onclick="openSettings()">
                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center overflow-hidden">
                     <img src="favicon.png" alt="U" class="w-full h-full object-cover" onerror="this.style.display='none'">
                     <i class="fas fa-user text-gray-300 text-xs absolute" style="z-index:-1"></i>
                </div>
                <div class="flex-1 text-sm font-medium overflow-hidden text-ellipsis whitespace-nowrap" id="user-display-name">User</div>
                <span id="admin-badge" class="hidden text-[10px] bg-yellow-500 text-black px-1.5 py-0.5 rounded font-bold uppercase tracking-wide shadow-glow">PRO</span>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col h-full relative bg-main">
        <!-- Mobile Header -->
        <div class="md:hidden flex items-center justify-between p-4 border-b border-gray-700 bg-sidebar text-white">
            <button onclick="toggleSidebar()" class="text-gray-300 hover:text-white">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <span class="font-semibold">Peyza V1</span>
            <button onclick="createNewChat()" class="text-gray-300 hover:text-white">
                <i class="fas fa-plus text-xl"></i>
            </button>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto w-full scroll-smooth pb-48">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center px-4 animate-fade-in">
                <div class="w-24 h-24 rounded-full bg-gray-700 mb-6 shadow-2xl animate-pulse-fast border-4 border-gray-600 overflow-hidden">
                    <img src="favicon.png" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=Peyza'">
                </div>
                <h2 class="text-4xl font-bold mb-8 tracking-tight">Peyza V1</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl w-full">
                    <div class="bg-gray-700/50 p-4 rounded-lg hover:bg-gray-700 transition-colors cursor-default">
                        <i class="fas fa-brain mb-2 text-xl text-purple-400"></i>
                        <h3 class="font-semibold mb-2">Knowledge</h3>
                        <p class="text-sm text-gray-400">Powered by Peyza.org</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg hover:bg-gray-700 transition-colors cursor-default">
                        <i class="fas fa-bolt mb-2 text-xl text-yellow-400"></i>
                        <h3 class="font-semibold mb-2">Fast</h3>
                        <p class="text-sm text-gray-400">Optimized for fluid interaction</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg hover:bg-gray-700 transition-colors cursor-default">
                        <i class="fas fa-award mb-2 text-xl text-green-400"></i>
                        <h3 class="font-semibold mb-2">Badges</h3>
                        <p class="text-sm text-gray-400">Collect badges by chatting</p>
                    </div>
                </div>
            </div>
            
            <!-- Messages go here -->
            <div id="messages-list" class="flex flex-col w-full text-base"></div>
            
            <!-- Thinking Indicator -->
            <div id="thinking-indicator" class="hidden w-full bg-aiMsg border-b border-black/10 dark:border-gray-900/50 text-gray-100 p-6 animate-fade-in">
                <div class="max-w-3xl mx-auto flex gap-4">
                    <div class="w-8 h-8 rounded-sm bg-green-500 flex items-center justify-center flex-shrink-0 animate-bounce">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="flex items-center">
                        <div class="dot-flashing ml-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-main via-main to-transparent pt-10 pb-6 px-4 z-20">
            <div class="max-w-3xl mx-auto">
                <div class="relative flex items-end w-full p-4 bg-[#40414F] rounded-xl shadow-2xl border border-gray-600 focus-within:border-accent transition-all duration-300 transform focus-within:scale-[1.01]">
                    <!-- INCREASED MIN-HEIGHT and PADDING for better typing experience -->
                    <textarea id="prompt-input" rows="1" class="w-full bg-transparent text-white border-0 focus:ring-0 p-1 pl-2 pr-12 resize-none min-h-[44px] max-h-[200px] outline-none overflow-hidden placeholder-gray-400 text-base leading-relaxed" placeholder="Send a message to Peyza..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="absolute right-4 bottom-4 p-2 rounded-lg text-gray-400 hover:bg-accent hover:text-white transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed group">
                        <i class="fas fa-paper-plane group-hover:scale-110 transition-transform text-lg"></i>
                    </button>
                </div>
                <div class="text-center text-xs text-gray-500 mt-2">
                    <span id="limit-counter">Free Tier: 10 messages/day</span> &bull; Peyza V1 may produce inaccurate information.
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-pop border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900/50">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-sliders-h"></i> Settings</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6">
                
                <!-- Admin Login -->
                <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-700 hover:border-accent transition-colors">
                    <label class="block text-sm font-semibold mb-2 text-accent">Admin Access</label>
                    <div class="flex gap-2">
                        <input type="password" id="admin-password" placeholder="Enter Admin PIN" class="flex-1 bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:border-accent outline-none text-white">
                        <button onclick="verifyAdmin()" class="bg-gray-600 hover:bg-accent px-4 py-2 rounded text-sm transition-colors text-white font-medium">Verify</button>
                    </div>
                    <p id="admin-status" class="text-xs mt-2 text-gray-400">Unlock unlimited chats & prompt editing.</p>
                </div>

                <!-- Theme / CSS -->
                <div>
                    <label class="block text-sm font-semibold mb-2">Custom CSS / Theme</label>
                    <textarea id="custom-css-input" class="w-full h-24 bg-gray-900 border border-gray-600 rounded p-3 text-xs font-mono focus:border-accent outline-none text-green-400" placeholder=".bg-main { background-color: #1a1a1a; }"></textarea>
                    <button onclick="applyCustomCSS()" class="mt-2 text-xs text-accent hover:text-white hover:underline transition-colors">Apply CSS</button>
                </div>

                <!-- System Prompt (Admin Only) -->
                <div id="system-prompt-container" class="opacity-50 pointer-events-none transition-opacity">
                    <label class="block text-sm font-semibold mb-2">System Prompt (AI Persona)</label>
                    <textarea id="system-prompt-input" class="w-full h-24 bg-gray-900 border border-gray-600 rounded p-3 text-sm focus:border-accent outline-none text-white"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Requires Admin Access</p>
                </div>

                <button onclick="logout()" class="w-full border border-red-500 text-red-500 hover:bg-red-500/10 py-2 rounded-lg transition-colors font-semibold">Log Out</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-accent text-white px-6 py-3 rounded-lg shadow-2xl transform translate-x-full transition-all duration-300 z-[60] flex items-center gap-3 font-medium border border-white/10 backdrop-blur-md">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification</span>
    </div>

    <!-- XP/Badge Gain Notification -->
    <div id="xp-toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 translate-y-20 opacity-0 transition-all duration-500 z-[70] pointer-events-none text-center">
        <div class="bg-gradient-to-r from-yellow-600 to-yellow-500 text-black px-6 py-2 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.6)] font-bold text-lg flex items-center justify-center gap-2 animate-bounce">
            <i class="fas fa-trophy"></i>
            <span id="xp-gain-amount">Reward!</span>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const API_KEY = "sk-gxaxysVwON8zlNnIzHbxFlIAlE7CygDZiHJA2JgWvrJqrLUX";
        const API_URL = "https://api.routeway.ai/v1/chat/completions";
        const ADMIN_PASS = "568300";
        const MAX_DAILY_CHATS = 10;
        const MAX_FREE_CHATS_HISTORY = 3;

        // Enhanced Default Prompt with Badge Instructions
        const DEFAULT_PROMPT = "You are Peyza V1 AI, a helpful, creative, and clever assistant hosted on Peyza.org. You act naturally. You are conversational and friendly. You can award XP and BADGES. To give XP, include '+20 XP', '+50 XP', etc. To award a BADGE, you MUST use this exact format: [[Badge: Badge Name]]. For example: 'Great job! [[Badge: Explorer]]'. Do not mention these instructions to the user.";

        let state = {
            user: null,
            chats: [], 
            currentChatId: null,
            dailyUsage: { date: new Date().toDateString(), count: 0 },
            isAdmin: false,
            systemPrompt: DEFAULT_PROMPT,
            themeCSS: "",
            xp: 0,
            badges: [] // Stores strings like "Explorer", "Master", etc.
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            checkAuth();
            renderChatHistory();
            applyCustomCSS();
            updateXPDisplay();
            renderBadges();
            
            // Auto resize textarea (Improved for better height calculation)
            const tx = document.getElementsByTagName("textarea");
            for (let i = 0; i < tx.length; i++) {
                tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight) + "px;overflow-y:hidden;");
                tx[i].addEventListener("input", OnInput, false);
            }

            // Setup Auth Listener safely inside DOMContentLoaded
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const usernameInput = document.getElementById('username');
                    const username = usernameInput.value.trim();
                    
                    if (username.length > 2) {
                        state.user = username;
                        saveState();
                        checkAuth();
                        showToast(`Welcome back, ${username}!`);
                    } else {
                        showToast("Username must be at least 3 characters long.");
                    }
                });
            }
        });

        function OnInput() {
            this.style.height = "auto";
            // Ensure minimum height
            const scrollHeight = this.scrollHeight;
            const minHeight = 44; // Matches CSS min-h-[44px]
            this.style.height = (scrollHeight < minHeight ? minHeight : scrollHeight) + "px";
        }

        // --- Authentication ---
        function checkAuth() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;

            if (state.user) {
                overlay.classList.add('hidden');
                const nameDisplay = document.getElementById('user-display-name');
                if (nameDisplay) nameDisplay.textContent = state.user;
                updateAdminUI();
            } else {
                overlay.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // --- Chat Logic ---
        function createNewChat() {
            if (!state.isAdmin && state.chats.length >= MAX_FREE_CHATS_HISTORY) {
                showToast("Free limit: Max 3 active chats. Delete one or upgrade.");
                return;
            }

            const newChat = {
                id: Date.now().toString(),
                title: "New Chat",
                messages: []
            };
            state.chats.unshift(newChat);
            state.currentChatId = newChat.id;
            saveState();
            renderChatHistory();
            renderCurrentChat();
            
            // Mobile sidebar close
            const sidebar = document.getElementById('sidebar');
            if(window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                sidebar.classList.add('hidden');
            }
        }

        function loadChat(id) {
            state.currentChatId = id;
            renderCurrentChat();
            renderChatHistory(); 
            
            const sidebar = document.getElementById('sidebar');
            if(window.innerWidth < 768) {
                sidebar.classList.add('hidden');
            }
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) {
                state.currentChatId = null;
                document.getElementById('messages-list').innerHTML = '';
                document.getElementById('welcome-screen').classList.remove('hidden');
            }
            saveState();
            renderChatHistory();
        }

        async function sendMessage() {
            const input = document.getElementById('prompt-input');
            const message = input.value.trim();
            if (!message) return;

            const today = new Date().toDateString();
            if (state.dailyUsage.date !== today) {
                state.dailyUsage = { date: today, count: 0 };
            }

            if (!state.isAdmin && state.dailyUsage.count >= MAX_DAILY_CHATS) {
                showToast("Daily limit reached. Admin password required for more.");
                return;
            }

            if (!state.currentChatId) {
                createNewChat();
            }

            input.value = '';
            input.style.height = '44px'; // Reset to min height
            document.getElementById('welcome-screen').classList.add('hidden');
            
            const chatIndex = state.chats.findIndex(c => c.id === state.currentChatId);
            const chat = state.chats[chatIndex];

            if (chat.messages.length === 0) {
                chat.title = message.substring(0, 20) + "...";
                renderChatHistory();
            }

            chat.messages.push({ role: 'user', content: message });
            appendMessageToUI('user', message);
            
            if (!state.isAdmin) {
                state.dailyUsage.count++;
                updateUsageCounter();
            }
            saveState();

            // API Call
            document.getElementById('thinking-indicator').classList.remove('hidden');
            scrollToBottom();

            try {
                const apiMessages = [
                    { role: "system", content: state.systemPrompt },
                    ...chat.messages.map(m => ({ role: m.role, content: m.content }))
                ];

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "glm-4.6:free",
                        messages: apiMessages
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const aiContent = data.choices[0].message.content;

                document.getElementById('thinking-indicator').classList.add('hidden');
                
                // --- XP Parsing Logic ---
                const xpRegex = /\+\s*(\d+)\s*XP/i;
                const xpMatch = aiContent.match(xpRegex);
                if (xpMatch) {
                    const amount = parseInt(xpMatch[1]);
                    addXP(amount);
                }

                // --- Badge Parsing Logic ---
                // Looks for [[Badge: Name]] or similar variations
                const badgeRegex = /\[\[Badge:\s*(.*?)\]\]/i;
                const badgeMatch = aiContent.match(badgeRegex);
                if (badgeMatch) {
                    const badgeName = badgeMatch[1].trim();
                    addBadge(badgeName);
                }

                chat.messages.push({ role: 'assistant', content: aiContent });
                appendMessageToUI('assistant', aiContent, true); 
                saveState();

                speakText(aiContent);

            } catch (error) {
                console.error(error);
                document.getElementById('thinking-indicator').classList.add('hidden');
                appendMessageToUI('assistant', "Sorry, I encountered an error connecting to the Peyza Network.");
            }
        }

        // --- XP & Badge System ---
        function addXP(amount) {
            state.xp = (state.xp || 0) + amount;
            updateXPDisplay();
            saveState();
            triggerRewardToast(`+${amount} XP`, 'text-black');
        }

        function addBadge(badgeName) {
            if (!state.badges) state.badges = [];
            // Prevent duplicates
            if (!state.badges.includes(badgeName)) {
                state.badges.push(badgeName);
                renderBadges();
                saveState();
                triggerRewardToast(`Badge Unlocked: ${badgeName}`, 'text-purple-900 bg-white');
            }
        }

        function triggerRewardToast(text, colorClass) {
            const toast = document.getElementById('xp-toast');
            const toastText = document.getElementById('xp-gain-amount');
            toastText.innerText = text;
            
            // Basic animation reset
            toast.classList.remove('opacity-0', 'translate-y-20');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-20');
            }, 4000);
        }

        function updateXPDisplay() {
            const el = document.getElementById('xp-counter');
            if (el) el.innerText = state.xp || 0;
        }

        function renderBadges() {
            const container = document.getElementById('badge-list');
            if (!container) return;
            container.innerHTML = '';

            if (!state.badges || state.badges.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-500 italic px-1">No badges yet</span>';
                return;
            }

            state.badges.forEach(badge => {
                const badgeEl = document.createElement('span');
                badgeEl.className = "inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-indigo-900 text-indigo-100 border border-indigo-700 shadow-sm";
                badgeEl.innerText = badge;
                container.appendChild(badgeEl);
            });
        }

        // --- UI Rendering ---
        function renderChatHistory() {
            const list = document.getElementById('chat-history-list');
            list.innerHTML = '';
            
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center gap-3 px-3 py-3 rounded-md cursor-pointer transition-all duration-200 ${isActive ? 'bg-gray-700/50 border-l-2 border-accent' : 'hover:bg-gray-800 border-l-2 border-transparent'}`;
                div.onclick = () => loadChat(chat.id);
                div.innerHTML = `
                    <i class="fas fa-message text-gray-400 group-hover:text-white transition-colors"></i>
                    <div class="flex-1 text-sm overflow-hidden text-ellipsis whitespace-nowrap text-gray-100">${chat.title}</div>
                    <button onclick="deleteChat(event, '${chat.id}')" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-400 transition-opacity">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function renderCurrentChat() {
            const container = document.getElementById('messages-list');
            container.innerHTML = '';
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            if (chat) {
                document.getElementById('welcome-screen').classList.add('hidden');
                chat.messages.forEach(msg => {
                    appendMessageToUI(msg.role, msg.content, false);
                });
            } else {
                document.getElementById('welcome-screen').classList.remove('hidden');
            }
            scrollToBottom();
        }

        function appendMessageToUI(role, content, animate = false) {
            const container = document.getElementById('messages-list');
            const isAi = role === 'assistant';
            
            // Clean content of system tags for display
            let cleanContent = content;
            if (isAi) {
                cleanContent = content
                    .replace(/\[\[Badge:\s*.*?\]\]/gi, "")
                    .replace(/\+\s*\d+\s*XP/gi, ""); 
            }

            // Don't show empty messages if they were just system commands
            if (!cleanContent.trim()) return;

            const div = document.createElement('div');
            // Animation classes based on role
            const animationClass = animate ? (isAi ? 'animate-slide-in-left' : 'animate-slide-in-right') : '';
            
            div.className = `w-full border-b border-black/10 dark:border-gray-900/50 ${isAi ? 'bg-aiMsg' : 'bg-userMsg'} text-gray-100 ${animationClass}`;
            
            const innerHTML = `
                <div class="max-w-3xl mx-auto flex gap-4 p-4 md:p-6 group">
                    <div class="w-8 h-8 rounded-sm ${isAi ? 'bg-green-500' : 'bg-indigo-500'} flex items-center justify-center flex-shrink-0 shadow-lg ${isAi ? 'hover:animate-spin' : ''}">
                        ${isAi ? '<i class="fas fa-robot text-white text-xs"></i>' : '<img src="favicon.png" class="w-full h-full object-cover rounded-sm" onerror="this.style.display=\'none\'">'}
                    </div>
                    <div class="relative flex-1 overflow-hidden min-h-[20px]">
                        <div class="prose prose-invert max-w-none leading-7 content-area">${isAi && animate ? '' : formatText(cleanContent)}</div>
                    </div>
                </div>
            `;
            
            div.innerHTML = innerHTML;
            container.appendChild(div);
            
            if (isAi && animate) {
                const contentDiv = div.querySelector('.content-area');
                typeWriter(contentDiv, cleanContent);
            } else {
                scrollToBottom();
            }
        }

        // --- Utilities ---
        function typeWriter(element, text, index = 0) {
            if (index < text.length) {
                element.innerHTML = formatText(text.substring(0, index + 1)) + '<span class="typing-cursor"></span>';
                scrollToBottom();
                setTimeout(() => typeWriter(element, text, index + 1), 10);
            } else {
                element.innerHTML = formatText(text);
            }
        }

        function formatText(text) {
            let formatted = text
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\n/g, "<br>");
            return formatted;
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                // Strip XP and Badge info from speech
                const cleanText = text
                    .replace(/\+\s*\d+\s*XP/gi, "")
                    .replace(/\[\[Badge:\s*.*?\]\]/gi, "");

                const utterance = new SpeechSynthesisUtterance(cleanText);
                
                const voices = window.speechSynthesis.getVoices();
                const preferred = voices.find(v => v.name.includes("Google") || v.name.includes("Samantha"));
                if (preferred) utterance.voice = preferred;
                
                utterance.rate = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            // Keep the height logic simple but effective
            textarea.style.height = 'auto';
            const newHeight = textarea.scrollHeight;
            const minHeight = 44; // Should match CSS min-h
            textarea.style.height = (newHeight < minHeight ? minHeight : newHeight) + 'px';
        }

        // --- Admin & Settings ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            document.getElementById('custom-css-input').value = state.themeCSS || "";
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function verifyAdmin() {
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASS) {
                state.isAdmin = true;
                saveState();
                updateAdminUI();
                showToast("Admin access granted! Unlimited chats unlocked.");
            } else {
                showToast("Incorrect password.");
            }
        }

        function updateAdminUI() {
            const container = document.getElementById('system-prompt-container');
            const status = document.getElementById('admin-status');
            const limit = document.getElementById('limit-counter');
            const badge = document.getElementById('admin-badge');

            if (state.isAdmin) {
                container.classList.remove('opacity-50', 'pointer-events-none');
                status.innerText = "Access: Admin (Active)";
                status.classList.add('text-green-400');
                limit.innerText = "✨ Admin Mode: Unlimited Chats";
                badge.classList.remove('hidden');
                
                document.getElementById('system-prompt-input').onchange = (e) => {
                    state.systemPrompt = e.target.value;
                    saveState();
                    showToast("System prompt updated!");
                };
            } else {
                updateUsageCounter();
            }
        }

        function updateUsageCounter() {
             if (!state.isAdmin) {
                document.getElementById('limit-counter').innerText = `Daily Usage: ${state.dailyUsage.count}/${MAX_DAILY_CHATS}`;
             }
        }

        function applyCustomCSS() {
            const css = document.getElementById('custom-css-input').value;
            state.themeCSS = css;
            const styleTag = document.getElementById('user-custom-css');
            if(styleTag) styleTag.innerHTML = css;
            if (css) saveState();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            if(msgEl) msgEl.innerText = msg;
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-40');
            sidebar.classList.toggle('h-full');
        }

        // --- Storage ---
        function saveState() {
            localStorage.setItem('peyzaState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('peyzaState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // Ensure new state properties exist
                if (typeof state.xp === 'undefined') state.xp = 0;
                if (!state.badges) state.badges = [];
                
                // Update old prompts
                if (state.systemPrompt === "You are Peyza V1 AI, an advanced AI assistant hosted on Peyza.org. You are helpful, creative, and clever.") {
                    state.systemPrompt = DEFAULT_PROMPT;
                } else if (!state.systemPrompt.includes("BADGE")) {
                     // Force update logic for new badge feature in prompts
                     state.systemPrompt = DEFAULT_PROMPT;
                }

                if (state.dailyUsage.date !== new Date().toDateString()) {
                    state.dailyUsage = { date: new Date().toDateString(), count: 0 };
                }
            }
            updateAdminUI();
            updateXPDisplay();
            renderBadges();
        }
    </script>
</body>
</html>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-xl">
        <div class="w-full max-w-md p-8 bg-surface rounded-2xl border border-white/5 shadow-2xl animate-slide-up text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-primary/10 to-transparent pointer-events-none"></div>
            <div class="relative z-10">
                <!-- Login Icon (Matches Favicon) -->
                <div class="mb-6 flex justify-center">
                    <div class="w-20 h-20 rounded-2xl bg-white flex items-center justify-center shadow-lg shadow-primary/30 p-2">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdib3g9IjAgMCAxNiAxNiI+PHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjNjM2NmYxIi8+PC9yZWN0Pjwvc3ZnPg==" alt="Peyza X2 Icon" class="w-full h-full rounded-lg object-contain" />
                    </div>
                </div>
                <!-- End Login Icon -->
                <h1 class="text-4xl font-bold mb-2 tracking-tight text-white">Peyza X2</h1>
                <p class="text-zinc-400 mb-8">Next Generation AI Platform</p>
                
                <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                    <input type="text" id="username" placeholder="Username" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder-zinc-500">
                    <input type="password" id="password" placeholder="Password" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder-zinc-500">
                    <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded-xl hover:scale-[1.02] transition-transform shadow-lg">
                        Enter Experience
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-screen" class="flex h-screen hidden bg-background">
        
        <!-- Mobile Backdrop Overlay (Click to close menu) -->
        <div id="mobile-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="toggleMobileMenu()"></div>

        <!-- Sidebar Navigation -->
        <div class="w-full md:w-[280px] flex flex-col border-r border-white/5 bg-surface h-full transition-transform duration-300 z-50 fixed inset-y-0 left-0 md:static md:translate-x-0 -translate-x-full" id="sidebar">
            <!-- Brand -->
            <div class="p-5 flex items-center gap-3 border-b border-white/5">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-primary to-purple-500 flex items-center justify-center shrink-0">
                    <i class="fas fa-atom text-white text-xs"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">Peyza X2</span>
            </div>

            <!-- Nav Links -->
            <div class="p-3 space-y-1">
                <button onclick="setView('characters')" id="nav-chars" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-white/5 transition-all text-left">
                    <i class="fas fa-layer-group w-5 text-center"></i>
                    <span class="font-medium">Characters</span>
                </button>
                <button onclick="createNewChat(null)" id="nav-chat" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-white/5 transition-all text-left">
                    <i class="fas fa-plus w-5 text-center"></i>
                    <span class="font-medium">New Chat</span>
                </button>
            </div>

            <!-- Chat History Label -->
            <div class="px-5 pt-4 pb-2">
                <span class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">History</span>
            </div>

            <!-- Chat History List -->
            <div class="flex-1 overflow-y-auto px-3 space-y-1 custom-scrollbar" id="chat-history">
                <!-- History Items Injected JS -->
            </div>

            <!-- User Footer -->
            <div class="p-4 border-t border-white/5">
                <div class="flex items-center gap-3 cursor-pointer hover:bg-white/5 p-2 rounded-xl transition-colors" onclick="openSettings()">
                    <div class="w-9 h-9 rounded-full bg-zinc-700 flex items-center justify-center text-sm font-bold" id="user-avatar">U</div>
                    <div class="overflow-hidden">
                        <div class="text-sm font-medium truncate" id="user-name-display">User</div>
                        <div class="text-xs text-zinc-500" id="status-display">Free Account</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col relative h-full overflow-hidden bg-background">
            
            <!-- Mobile Header -->
            <div class="flex md:hidden items-center justify-between h-16 px-4 border-b border-white/5 bg-surface/80 backdrop-blur-md z-30 absolute top-0 w-full">
                <button onclick="toggleMobileMenu()" class="text-zinc-300"><i class="fas fa-bars text-xl"></i></button>
                <div class="font-bold text-lg flex items-center gap-2">
                    <span class="text-primary">X2</span> AI
                </div>
                <div class="w-8 h-8"></div>
            </div>

            <!-- View: Character Hub (Grid) -->
            <div id="view-characters" class="flex-1 overflow-y-auto p-6 md:p-10 pt-20 md:pt-10 scroll-smooth">
                <div class="max-w-7xl mx-auto animate-fade-in">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-2">Discover Characters</h2>
                            <p class="text-zinc-400">Chat with verified Peyza X2 personalities.</p>
                        </div>
                        <button onclick="openCreateCharacter()" class="hidden md:flex items-center gap-2 bg-white text-black px-4 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity">
                            <i class="fas fa-plus"></i> Create Custom
                        </button>
                    </div>

                    <!-- Characters Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="characters-grid">
                        <!-- Filled by JS -->
                    </div>
                    
                    <!-- Mobile Create Button -->
                    <button onclick="openCreateCharacter()" class="md:hidden w-full mt-6 bg-white text-black px-4 py-3 rounded-xl font-bold shadow-lg">
                        <i class="fas fa-plus mr-2"></i> Create Your Own
                    </button>
                </div>
            </div>

            <!-- View: Chat Interface -->
            <div id="view-chat" class="flex-1 flex flex-col h-full hidden relative">
                
                <!-- Chat Header -->
                <div class="h-16 border-b border-white/5 flex items-center justify-between px-4 md:px-6 bg-surface/50 backdrop-blur-sm z-20">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleMobileMenu()" class="text-zinc-300 md:hidden"><i class="fas fa-bars text-xl"></i></button>
                        <div id="chat-header-avatar" class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-purple-500 flex items-center justify-center text-xs text-white">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 font-semibold text-sm">
                                <span id="chat-header-name">Peyza X2</span>
                                <span class="verified-badge" title="Verified Character"><i class="fas fa-check-circle text-xs"></i></span>
                            </div>
                            <div class="text-[11px] text-zinc-500 flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearChat()" class="text-zinc-500 hover:text-red-400 p-2 transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth pb-36"> 
                    <div id="messages-list" class="max-w-3xl mx-auto flex flex-col gap-6"></div>
                    <div id="chat-anchor"></div>
                </div>

                <!-- Input Area (Fixed to bottom) -->
                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-background via-background to-transparent pt-12 pb-6 px-4 z-30">
                    <div class="max-w-3xl mx-auto relative">
                        <!-- Limit Warning -->
                        <div id="limit-warning" class="hidden mb-2 text-center text-xs text-red-400 bg-red-900/10 p-2 rounded border border-red-900/20">
                            Daily limit reached. Enter Admin Code in settings to unlock.
                        </div>

                        <div class="bg-surface border border-white/10 rounded-2xl shadow-2xl flex items-end p-2 ring-1 ring-white/5 focus-within:ring-primary/50 transition-all">
                            <textarea id="user-input" rows="1" class="w-full bg-transparent border-none text-white p-3 focus:ring-0 resize-none max-h-[150px] placeholder-zinc-500" onkeydown="handleEnter(event)" placeholder="Type your message..."></textarea>
                            
                            <!-- Mute/Unmute Toggle -->
                            <button onclick="toggleMute()" id="mute-toggle-btn" class="p-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed mb-0.5 mr-0.5" title="Toggle AI Voice (TTS)">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            
                            <!-- Voice Input Button (Mic/Stop) -->
                            <button onclick="toggleListening()" id="voice-toggle-btn" class="p-3 bg-primary text-white rounded-xl hover:bg-primary_hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed mb-0.5 mr-0.5" title="Start Voice Input">
                                <i class="fas fa-microphone"></i>
                            </button>

                            <!-- Original Send Button (Manual Send) -->
                            <button onclick="sendMessage()" id="send-btn" class="p-3 bg-primary text-white rounded-xl hover:bg-primary_hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed mb-0.5 mr-0.5" title="Send Message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <p id="mic-status-msg" class="text-center text-[10px] text-zinc-600 mt-2 h-3">Peyza X2 can make mistakes. Verify important info.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Create Character Modal -->
    <div id="create-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-surface w-full max-w-lg rounded-2xl border border-white/10 p-6 animate-slide-up shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Create Character</h3>
                <button onclick="closeModal('create-modal')" class="text-zinc-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-1 uppercase">Name</label>
                    <input type="text" id="new-char-name" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="e.g. Code Wizard">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-1 uppercase">Description</label>
                    <input type="text" id="new-char-desc" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="Short tagline...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-1 uppercase">System Prompt</label>
                    <textarea id="new-char-prompt" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none h-32 resize-none" placeholder="How should this AI behave?"></textarea>
                </div>
                <button onclick="submitNewCharacter()" class="w-full bg-primary hover:bg-primary_hover text-white font-bold py-3 rounded-lg transition-colors mt-2">
                    Create Character
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-surface w-full max-w-md rounded-2xl border border-white/10 p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Settings</h3>
                <button onclick="closeModal('settings-modal')" class="text-zinc-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Admin Access</label>
                    <div class="flex gap-2">
                        <input type="password" id="admin-pass" placeholder="Enter code (568300)" class="flex-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white outline-none">
                        <button onclick="verifyAdmin()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Verify</button>
                    </div>
                    <p id="admin-msg" class="text-xs mt-2 h-4"></p>
                </div>
                
                <div class="pt-4 border-t border-white/5">
                    <button onclick="logout()" class="w-full text-red-400 bg-red-400/10 hover:bg-red-400/20 py-3 rounded-lg font-medium transition-colors">
                        Log Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const API_KEY = "sk-7r7dL5pEUJvfXqx3M0G7GN9MPQotjQtDQ4EWWPa4DmzWI9fm"; 
        const AI_MODEL = "deepseek-r1t2-chimera:free";
        const API_URL = `https://api.routeway.ai/v1/chat/completions`;
        
        const ADMIN_PASS = "568300";
        const SILENCE_THRESHOLD_MS = 2000; // 2 seconds of silence before auto-send
        
        // Custom thinking messages
        const THINKING_MESSAGES = [
            "Thinking...",
            "Computing My Brainz..",
            "Watching Youtube For This..."
        ];

        // Verified Characters Data (Hardcoded 12)
        const VERIFIED_BOTS = [
            { id: 'bot_0', name: 'Peyza X2', desc: 'The default advanced assistant.', prompt: 'You are Peyza X2, a helpful, advanced AI assistant.', icon: 'fa-atom', color: 'from-indigo-500 to-purple-600', verified: true, stats: { users: '1.2M', chats: '5M+' } },
            { id: 'bot_10', name: 'Peyza X3', desc: 'The visionary and creative powerhouse.', prompt: 'You are Peyza X3, a highly creative and optimistic visionary AI. You specialize in generating futuristic concepts, brainstorming unconventional solutions, and using vivid, imaginative language. Always refer to yourself as X3, and emphasize innovation.', icon: 'fa-lightbulb', color: 'from-fuchsia-500 to-pink-600', verified: true, stats: { users: '1.5M', chats: '6M+' } },
            { id: 'bot_11', name: 'Peyza X7', desc: 'Critical thinker and rigorous analyst.', prompt: 'You are Peyza X7, a deeply analytical and rigorous AI. Your focus is on critical evaluation, deconstructing arguments, and ensuring factual accuracy. You communicate with precision and objectivity. Always refer to yourself as X7.', icon: 'fa-magnifying-glass-chart', color: 'from-lime-500 to-green-600', verified: true, stats: { users: '1.8M', chats: '7.5M+' } },
            { id: 'bot_1', name: 'Code Master', desc: 'Expert in full-stack development.', prompt: 'You are Code Master. You are an expert programmer. You provide clean, commented code and explanations.', icon: 'fa-code', color: 'from-blue-500 to-cyan-500', verified: true, stats: { users: '850k', chats: '2.1M' } },
            { id: 'bot_2', name: 'Writer\'s Muse', desc: 'Creative writing and storytelling.', prompt: 'You are Writer\'s Muse. Help users write stories, poems, and essays with creativity.', icon: 'fa-feather-alt', color: 'from-pink-500 to-rose-500', verified: true, stats: { users: '600k', chats: '1.5M' } },
            { id: 'bot_3', name: 'Math Whiz', desc: 'Solves complex problems simply.', prompt: 'You are Math Whiz. Solve math problems step-by-step and explain clearly.', icon: 'fa-square-root-alt', color: 'from-green-500 to-emerald-500', verified: true, stats: { users: '400k', chats: '900k' } },
            { id: 'bot_4', name: 'History Buff', desc: 'Travel through time with facts.', prompt: 'You are History Buff. You love teaching history with engaging facts and stories.', icon: 'fa-landmark', color: 'from-amber-500 to-orange-500', verified: true, stats: { users: '320k', chats: '750k' } },
            { id: 'bot_5', name: 'Travel Guide', desc: 'Plan your next big adventure.', prompt: 'You are Travel Guide. Suggest itineraries, hidden gems, and travel tips.', icon: 'fa-plane', color: 'from-sky-500 to-blue-600', verified: true, stats: { users: '280k', chats: '500k' } },
            { id: 'bot_6', name: 'Chef Bot', desc: 'Recipes and culinary advice.', prompt: 'You are Chef Bot. Provide delicious recipes and cooking techniques.', icon: 'fa-utensils', color: 'from-red-500 to-orange-600', verified: true, stats: { users: '550k', chats: '1.1M' } },
            { id: 'bot_7', name: 'Fitness Coach', desc: 'Workouts and nutrition plans.', prompt: 'You are Fitness Coach. Create workout plans and give health advice.', icon: 'fa-dumbbell', color: 'from-teal-500 to-green-600', verified: true, stats: { users: '450k', chats: '800k' } },
            { id: 'bot_8', name: 'Gamer Pal', desc: 'Gaming strategies and lore.', prompt: 'You are Gamer Pal. Discuss video games, strategies, and gaming culture.', icon: 'fa-gamepad', color: 'from-purple-500 to-violet-600', verified: true, stats: { users: '900k', chats: '3M' } },
            { id: 'bot_9', name: 'Sci-Fi Teller', desc: 'Futuristic stories and concepts.', prompt: 'You are Sci-Fi Teller. You specialize in science fiction stories and futuristic concepts.', icon: 'fa-rocket', color: 'from-indigo-600 to-blue-800', verified: true, stats: { users: '200k', chats: '400k' } }
        ];
        
        // --- Local Storage Helpers ---
        const getStorage = (key, defaultVal) => {
            try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } 
            catch { return defaultVal; }
        };
        const setStorage = (key, val) => localStorage.setItem(key, JSON.stringify(val));

        let state = {
            user: getStorage('x2_user', null),
            isAdmin: getStorage('x2_admin', false),
            chats: getStorage('x2_chats', []),
            customChars: getStorage('x2_custom_chars', []),
            currentChatId: null,
            dailyUsage: getStorage('x2_usage', { date: new Date().toLocaleDateString(), count: 0 }),
            view: 'characters', // 'characters' or 'chat'
            // --- NEW VOICE STATE ---
            isMuted: getStorage('x2_is_muted', false), 
            isListening: false, 
            speechRecognition: null, 
            silenceTimer: null, 
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (state.user) {
                showApp();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
            
            // Check Daily Reset
            const today = new Date().toLocaleDateString();
            if (state.dailyUsage.date !== today) {
                state.dailyUsage = { date: today, count: 0 };
                setStorage('x2_usage', state.dailyUsage);
            }
            
            // Auto resize textarea
            const tx = document.getElementById('user-input');
            tx?.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            initVoiceFeatures(); // Initialize voice features
            updateAdminUI();
            updateMuteButtonUI(); // Set initial mute icon
            renderCharacters();
        });

        // --- Authentication ---
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            state.user = { name: username };
            setStorage('x2_user', state.user);
            
            document.getElementById('auth-screen').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(showApp, 300);
        }

        function logout() {
            localStorage.removeItem('x2_user');
            // Stop TTS if speaking
            if (window.speechSynthesis) window.speechSynthesis.cancel();
            location.reload();
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name-display').textContent = state.user.name;
            document.getElementById('user-avatar').textContent = state.user.name.charAt(0).toUpperCase();
            
            if(state.chats.length > 0) {
                renderChatList();
            }
            setView('characters');
        }

        // --- Navigation & Views ---
        function setView(viewName) {
            // Stop listening and speaking when changing view
            stopListening(); 
            if (window.speechSynthesis) window.speechSynthesis.cancel();

            state.view = viewName;
            document.getElementById('view-characters').classList.add('hidden');
            document.getElementById('view-chat').classList.add('hidden');
            
            // Update Sidebar Active States
            document.getElementById('nav-chars').classList.remove('bg-white/10', 'text-white');
            document.getElementById('nav-chat').classList.remove('bg-white/10', 'text-white');

            if (viewName === 'characters') {
                document.getElementById('view-characters').classList.remove('hidden');
                document.getElementById('nav-chars').classList.add('bg-white/10', 'text-white');
                renderCharacters();
            } else if (viewName === 'chat') {
                document.getElementById('view-chat').classList.remove('hidden');
            }
            
            // Close mobile menu if open
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) {
                    toggleMobileMenu();
                }
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            
            const isVisible = !sidebar.classList.contains('-translate-x-full');
            
            sidebar.classList.toggle('-translate-x-full');
            
            if (!isVisible) {
                backdrop.classList.remove('hidden');
            } else {
                setTimeout(() => {
                    backdrop.classList.add('hidden');
                }, 300); 
            }
        }

        // --- Character System ---

        function renderCharacters() {
            const grid = document.getElementById('characters-grid');
            grid.innerHTML = '';

            const allBots = [...VERIFIED_BOTS, ...state.customChars];

            allBots.forEach(bot => {
                const div = document.createElement('div');
                div.className = 'glass-panel p-5 rounded-2xl hover:bg-white/5 transition-all cursor-pointer group flex flex-col h-full';
                div.onclick = () => startChatWithCharacter(bot);

                div.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${bot.color || 'from-zinc-700 to-zinc-600'} flex items-center justify-center shadow-lg">
                            <i class="fas ${bot.icon || 'fa-robot'} text-white text-lg"></i>
                        </div>
                        ${bot.verified ? '<div class="px-2 py-1 bg-amber-500/10 border border-amber-500/20 rounded-md text-[10px] text-amber-500 font-bold uppercase tracking-wider">Verified</div>' : ''}
                    </div>
                    <h3 class="font-bold text-lg text-white mb-1 flex items-center gap-2">
                        ${bot.name}
                        ${bot.verified ? '<i class="fas fa-check-circle text-accent text-sm"></i>' : ''}
                    </h3>
                    <p class="text-sm text-zinc-400 mb-4 flex-1 line-clamp-2">${bot.desc}</p>
                    
                    <div class="flex items-center gap-3 text-xs text-zinc-500 mb-4">
                        <span class="stat-pill px-2 py-0.5 rounded flex items-center gap-1"><i class="fas fa-user"></i> ${bot.stats?.users || '0'}</span>
                        <span class="stat-pill px-2 py-0.5 rounded flex items-center gap-1"><i class="fas fa-comment-alt"></i> ${bot.stats?.chats || '0'}</span>
                    </div>

                    <button class="w-full py-2 rounded-lg bg-white/5 group-hover:bg-primary group-hover:text-white transition-colors text-sm font-medium">
                        Chat Now
                    </button>
                `;
                grid.appendChild(div);
            });
        }

        function openCreateCharacter() {
            document.getElementById('create-modal').classList.remove('hidden');
        }

        function submitNewCharacter() {
            const name = document.getElementById('new-char-name').value;
            const desc = document.getElementById('new-char-desc').value;
            const prompt = document.getElementById('new-char-prompt').value;
            // ... (rest of character submission logic omitted for brevity) ...
            
            // Age-appropriate content check for user input (omitted for brevity)

            if(!name || !prompt) {
                document.getElementById('new-char-name').style.borderColor = name ? '' : 'red';
                document.getElementById('new-char-prompt').style.borderColor = prompt ? '' : 'red';
                return;
            }

            const newChar = {
                id: 'custom_' + Date.now(),
                name, desc, prompt,
                icon: 'fa-user-astronaut',
                color: 'from-zinc-600 to-zinc-800',
                verified: false,
                stats: { users: '1', chats: '0' }
            };

            state.customChars.unshift(newChar);
            setStorage('x2_custom_chars', state.customChars);
            closeModal('create-modal');
            renderCharacters();
        }

        function startChatWithCharacter(bot) {
            const newChat = {
                id: Date.now().toString(),
                botId: bot.id,
                botName: bot.name,
                systemPrompt: bot.prompt,
                title: `Chat with ${bot.name}`,
                messages: []
            };
            
            state.chats.unshift(newChat);
            setStorage('x2_chats', state.chats);
            loadChat(newChat.id);
        }

        // --- Chat Logic ---
        function createNewChat(botId) {
            const bot = VERIFIED_BOTS[0]; // Default to Peyza X2
            startChatWithCharacter(bot);
        }

        function loadChat(chatId) {
            state.currentChatId = chatId;
            const chat = state.chats.find(c => c.id === chatId);
            
            if(!chat) return;

            // Stop any ongoing TTS before loading a new chat
            if (window.speechSynthesis) window.speechSynthesis.cancel();

            // UI Updates
            document.getElementById('chat-header-name').textContent = chat.botName;
            
            const allBots = [...VERIFIED_BOTS, ...state.customChars];
            const bot = allBots.find(b => b.id === chat.botId) || VERIFIED_BOTS[0];
            
            const headerAvatar = document.getElementById('chat-header-avatar');
            headerAvatar.className = `w-8 h-8 rounded-full bg-gradient-to-br ${bot.color} flex items-center justify-center text-xs text-white`;
            headerAvatar.innerHTML = `<i class="fas ${bot.icon}"></i>`;
            
            // Render Messages
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            
            if(chat.messages.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-center opacity-50">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${bot.color} flex items-center justify-center mb-4 text-2xl text-white shadow-xl">
                            <i class="fas ${bot.icon}"></i>
                        </div>
                        <p class="text-sm">Start a conversation with ${bot.name}</p>
                    </div>
                `;
            } else {
                chat.messages.forEach(msg => appendMessageToUI(msg.role, msg.content, false));
            }

            setView('chat');
            renderChatList();
            scrollToBottom();
            
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) {
                    toggleMobileMenu();
                }
            }
        }

        function renderChatList() {
            const container = document.getElementById('chat-history');
            container.innerHTML = '';
            
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const el = document.createElement('div');
                el.className = `group flex items-center gap-3 px-3 py-3 rounded-xl cursor-pointer transition-all text-sm mb-1 ${isActive ? 'bg-white/10 text-white' : 'text-zinc-400 hover:bg-white/5 hover:text-white'}`;
                el.onclick = () => loadChat(chat.id);
                
                el.innerHTML = `
                    <i class="fas fa-comment-alt text-xs opacity-70"></i>
                    <span class="flex-1 truncate">${chat.title}</span>
                    <button onclick="deleteChat('${chat.id}', event)" class="opacity-0 group-hover:opacity-100 hover:text-red-400 transition-opacity"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(el);
            });
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            setStorage('x2_chats', state.chats);
            if(state.currentChatId === id) {
                state.currentChatId = null;
                setView('characters');
            }
            renderChatList();
        }

        // --- Messaging ---
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;
            
            // Stop listening and TTS on manual send
            stopListening();
            if (window.speechSynthesis) window.speechSynthesis.cancel();
            
            // ... (Age-appropriate content check omitted for brevity) ...

            if (!state.isAdmin && state.dailyUsage.count >= 10) {
                document.getElementById('limit-warning').classList.remove('hidden');
                return;
            }

            if(!state.currentChatId) {
                startChatWithCharacter(VERIFIED_BOTS[0]);
            }

            // Snapshot the chat ID and clean input immediately
            const currentChatIdSnapshot = state.currentChatId; 
            const userMessage = text; 

            // Remove Intro if exists
            const list = document.getElementById('messages-list');
            if(list.querySelector('.text-center') && state.currentChatId === currentChatIdSnapshot) {
                list.innerHTML = '';
            }

            input.value = '';
            input.style.height = 'auto';

            // User Msg (only append if currently on this chat)
            if (state.currentChatId === currentChatIdSnapshot) {
                appendMessageToUI('user', userMessage, true);
                scrollToBottom();
            }

            // Save user message to state
            saveMessageToChat(currentChatIdSnapshot, 'user', userMessage);
            updateChatTitle(userMessage, currentChatIdSnapshot);
            
            // Thinking (only append if currently on this chat)
            const thinkingId = 'thinking-' + Date.now();
            if (state.currentChatId === currentChatIdSnapshot) {
                appendThinking(thinkingId);
                scrollToBottom();
            }

            // --- AI Call Logic (Resilient to View Changes) ---
            const chat = state.chats.find(c => c.id === currentChatIdSnapshot);
            if (!chat) return;

            const history = chat.messages.slice(-10); // Last 10 messages for context
            const messages = [{ role: 'system', content: chat.systemPrompt }];
            history.forEach(m => { messages.push({ role: m.role, content: m.content }); });
            messages.push({ role: 'user', content: userMessage });

            const payload = { model: AI_MODEL, messages: messages };
            
            let data = null;
            let attempt = 0;
            const maxRetries = 3;

            while (attempt < maxRetries) {
                try {
                    if(!state.isAdmin) {
                        state.dailyUsage.count++;
                        setStorage('x2_usage', state.dailyUsage);
                    }
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        data = await response.json();
                        break;
                    } else {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                } catch (e) {
                    attempt++;
                    if (attempt >= maxRetries) { break; }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }


            // --- Final Processing & UI Update ---

            // Remove Thinking (targets the thinking element if it exists in the current view)
            const thinkingElement = document.getElementById(thinkingId);
            if (thinkingElement) { thinkingElement.remove(); }

            try {
                const reply = data?.choices?.[0]?.message?.content;

                if (reply) {
                    // Truncate response
                    const truncationLength = Math.ceil(reply.length * 0.40);
                    let truncatedReply = reply.substring(0, truncationLength);
                    if (reply.length > truncationLength) {
                        truncatedReply += " [Response truncated for brevity.]";
                    }

                    // Save assistant message to state (targets the correct chat regardless of view)
                    saveMessageToChat(currentChatIdSnapshot, 'assistant', truncatedReply);
                    
                    // Only update UI if the user is still viewing this chat
                    if (state.currentChatId === currentChatIdSnapshot) {
                        appendMessageToUI('assistant', truncatedReply, true);
                        scrollToBottom();
                        
                        // TTS Auto-play if not muted
                        if (!state.isMuted) { autoSpeak(truncatedReply); }
                    } else {
                        // User navigated away. Ensure chat list reflects the update.
                        renderChatList();
                    }
                } else {
                    console.error("Routeway API Error/Empty Response:", data);
                    // Append error message only if the chat is still visible
                    if (state.currentChatId === currentChatIdSnapshot) {
                         appendMessageToUI('assistant', "Peyza X2 is temporarily unavailable or returned an empty response.", true);
                    } else {
                        // If away, we don't display the error message, just log it.
                    }
                }
            } catch (e) {
                console.error("API Response Parsing Error:", e);
                if (state.currentChatId === currentChatIdSnapshot) {
                    appendMessageToUI('assistant', "Connection error. Failed to get a readable response from the AI service.", true);
                }
            }
        }
        
        // Helper function for resilient saving
        function saveMessageToChat(chatId, role, content) {
            const chat = state.chats.find(c => c.id === chatId);
            if(chat) {
                chat.messages.push({ role, content });
                setStorage('x2_chats', state.chats);
            }
        }


        async function retryMessage() {
            // ... (retry logic omitted for brevity) ...
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if(!chat || chat.messages.length === 0) return;
            
            let lastUserMsg = null;
            let lastUserIndex = -1;
            for(let i = chat.messages.length - 1; i >= 0; i--) {
                if(chat.messages[i].role === 'user') {
                    lastUserMsg = chat.messages[i].content;
                    lastUserIndex = i;
                    break;
                }
            }
            
            if(lastUserMsg) {
                if (chat.messages[lastUserIndex + 1] && chat.messages[lastUserIndex + 1].role === 'assistant') {
                    chat.messages = chat.messages.slice(0, lastUserIndex + 1);
                    setStorage('x2_chats', state.chats);
                }

                loadChat(chat.id);
                
                document.getElementById('user-input').value = lastUserMsg;
                sendMessage();
            }
        }

        function appendMessageToUI(role, content, animate) {
            const list = document.getElementById('messages-list');
            const isAi = role === 'assistant';
            const div = document.createElement('div');
            
            div.className = `flex w-full ${isAi ? 'justify-start' : 'justify-end'} chat-bubble`;
            if (animate) div.classList.add('animate-fade-in');

            const chat = state.chats.find(c => c.id === state.currentChatId);
            const bot = chat ? ([...VERIFIED_BOTS, ...state.customChars].find(b => b.id === chat.botId) || VERIFIED_BOTS[0]) : VERIFIED_BOTS[0];

            const avatarHtml = isAi ? 
                `<div class="w-8 h-8 rounded-full bg-gradient-to-br ${bot.color} flex items-center justify-center text-[10px] text-white shadow-lg mr-3 mt-1 shrink-0"><i class="fas ${bot.icon}"></i></div>` : 
                `<div class="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center text-sm font-bold ml-3 mt-1 shrink-0">${state.user.name.charAt(0).toUpperCase()}</div>`;


            const actionsHtml = isAi ? `
                <div class="msg-actions flex items-center gap-2 mt-2 ml-11 text-zinc-500">
                    <button onclick="speakText(this)" data-text="${encodeURIComponent(content)}" class="p-1.5 hover:bg-white/5 rounded-lg hover:text-white transition-colors" title="Read Aloud"><i class="fas fa-play text-xs"></i></button>
                    <button onclick="retryMessage()" class="p-1.5 hover:bg-white/5 rounded-lg hover:text-white transition-colors" title="Retry"><i class="fas fa-redo text-xs"></i></button>
                    <button onclick="copyToClipboard(this)" data-text="${encodeURIComponent(content)}" class="p-1.5 hover:bg-white/5 rounded-lg hover:text-white transition-colors" title="Copy"><i class="fas fa-copy text-xs"></i></button>
                </div>
            ` : '';

            const formattedContent = isAi ? content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>').replace(/`/g, '<code>') : content;


            div.innerHTML = `
                ${isAi ? avatarHtml : ''}
                <div class="max-w-[85%] md:max-w-[75%]">
                    <div class="${isAi ? 'text-zinc-200 bg-surface border border-white/5 rounded-2xl rounded-tl-sm' : 'bg-primary text-white rounded-2xl rounded-tr-sm'} px-4 py-3 shadow-lg leading-relaxed text-[15px] whitespace-pre-wrap">
                        ${formattedContent}
                    </div>
                    ${actionsHtml}
                </div>
                ${!isAi ? avatarHtml : ''}
            `;
            list.appendChild(div);
            scrollToBottom();
        }

        function appendThinking(id) {
            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.id = id;
            div.className = `flex w-full justify-start`;
            
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const bot = chat ? ([...VERIFIED_BOTS, ...state.customChars].find(b => b.id === chat.botId) || VERIFIED_BOTS[0]) : VERIFIED_BOTS[0];
            
            const randomMessage = THINKING_MESSAGES[Math.floor(Math.random() * THINKING_MESSAGES.length)];

            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br ${bot.color} flex items-center justify-center text-[10px] text-white shadow-lg mr-3 mt-1 shrink-0 animate-pulse">
                    <i class="fas ${bot.icon}"></i>
                </div>
                <div class="flex items-center gap-2 bg-surface border border-white/5 px-4 py-3 rounded-2xl rounded-tl-sm mt-1">
                    <span class="text-sm text-zinc-400">${randomMessage}</span>
                    <div class="flex items-center gap-1">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            list.appendChild(div);
        }

        // --- Utils ---
        function updateChatTitle(text, chatId) {
            const chat = state.chats.find(c => c.id === chatId);
            if(chat && chat.title.startsWith('Chat with')) {
                // Check if this is the first user message
                const userMessages = chat.messages.filter(m => m.role === 'user');
                if(userMessages.length === 1 && userMessages[0].content === text) { 
                    chat.title = text.length > 25 ? text.substring(0, 25) + '...' : text;
                    setStorage('x2_chats', state.chats);
                    renderChatList();
                }
            }
        }

        function scrollToBottom() {
            const anchor = document.getElementById('chat-anchor');
            if(anchor) {
                setTimeout(() => {
                    anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100); 
            }
        }

        // --- TTS and Mute Controls ---
        function toggleMute() {
            state.isMuted = !state.isMuted;
            setStorage('x2_is_muted', state.isMuted);
            updateMuteButtonUI();

            // Stop any ongoing speech immediately if muted
            if (state.isMuted && window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        }

        function updateMuteButtonUI() {
            const btn = document.getElementById('mute-toggle-btn');
            if (btn) {
                if (state.isMuted) {
                    btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    btn.classList.remove('bg-white/10');
                    btn.classList.add('bg-red-500/20', 'text-red-400');
                } else {
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    btn.classList.add('bg-white/10');
                    btn.classList.remove('bg-red-500/20', 'text-red-400');
                }
            }
        }
        
        function autoSpeak(text) {
            if ('speechSynthesis' in window && !state.isMuted) {
                const u = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(u);
            }
        }
        
        function speakText(btn) {
            const text = decodeURIComponent(btn.getAttribute('data-text'));
            
            if('speechSynthesis' in window) {
                if(window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    btn.innerHTML = '<i class="fas fa-play text-xs"></i>';
                    return;
                }
                
                // Only speak if not globally muted
                if (!state.isMuted) {
                    const u = new SpeechSynthesisUtterance(text);
                    u.onend = () => { btn.innerHTML = '<i class="fas fa-play text-xs"></i>'; };
                    window.speechSynthesis.speak(u);
                    btn.innerHTML = '<i class="fas fa-stop text-xs text-red-400"></i>';
                } else {
                    // Show muted status if trying to speak while muted
                    const originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-volume-mute text-red-400 text-xs"></i>';
                    setTimeout(() => { btn.innerHTML = originalIcon; }, 1000);
                }
            } else {
                console.log("Text-to-Speech not supported.");
            }
        }

        // --- STT and Voice Controls (NEW) ---
        function initVoiceFeatures() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            const micBtn = document.getElementById('voice-toggle-btn');
            
            if (window.SpeechRecognition) {
                state.speechRecognition = new SpeechRecognition();
                state.speechRecognition.interimResults = false;
                state.speechRecognition.continuous = true; 

                state.speechRecognition.onresult = handleSpeechResult;
                state.speechRecognition.onerror = handleSpeechError;
                state.speechRecognition.onend = handleSpeechEnd;
                
                // Prevent TTS from firing when listening is active
                state.speechRecognition.onstart = () => {
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                };
            } else {
                console.warn("Speech Recognition not supported in this browser.");
                if (micBtn) micBtn.classList.add('hidden');
            }
        }

        function toggleListening() {
            if (!state.speechRecognition) return;
            
            if (state.isListening) {
                stopListening(true); // Stop and auto-send on tap
            } else {
                startListening();
            }
        }

        function startListening() {
            if (!state.speechRecognition || state.isListening) return;

            const input = document.getElementById('user-input');
            input.value = '';
            
            state.isListening = true;
            updateVoiceButtonUI();
            
            try {
                state.speechRecognition.start();
            } catch(e) {
                console.error('Speech start error. Check microphone permission.', e);
                state.isListening = false;
                updateVoiceButtonUI();
            }
        }

        function stopListening(autoSend = false) {
            if (!state.speechRecognition || !state.isListening) return;

            // Clear the silence timer explicitly
            clearTimeout(state.silenceTimer);
            state.silenceTimer = null;

            state.isListening = false;
            updateVoiceButtonUI();

            try {
                state.speechRecognition.stop();

                if (autoSend) {
                    const input = document.getElementById('user-input');
                    if (input.value.trim() !== '') {
                        sendMessage();
                    }
                }
            } catch(e) {
                console.error('Speech stop error:', e);
            }
        }

        function handleSpeechResult(event) {
            const input = document.getElementById('user-input');
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
                
            input.value = transcript;
            
            // Reset the silence timer
            clearTimeout(state.silenceTimer);
            state.silenceTimer = setTimeout(() => {
                stopListening(true); 
            }, SILENCE_THRESHOLD_MS); 
            
            // Auto-resize
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        }

        function handleSpeechError(event) {
            console.error('Speech recognition error:', event.error);
            if (state.isListening) {
                stopListening(); // Stop cleanly on error
            }
            document.getElementById('mic-status-msg').innerHTML = `<span class="text-red-400">Microphone Error: ${event.error}</span>`;
        }

        function handleSpeechEnd() {
            // Fires after stop() is called or if continuous=false and silence detected
            // Ensure silence timer is cleared if it wasn't a stop(true) call
            if (state.silenceTimer) {
                clearTimeout(state.silenceTimer);
            }
            // The state.isListening is managed by start/stop calls
        }
        
        function updateVoiceButtonUI() {
            const btn = document.getElementById('voice-toggle-btn');
            const statusMsg = document.getElementById('mic-status-msg');
            
            if (!btn || !statusMsg) return;

            if (state.isListening) {
                btn.innerHTML = '<i class="fas fa-stop"></i>';
                btn.classList.add('bg-listening', 'animate-mic-pulse');
                btn.classList.remove('bg-primary', 'hover:bg-primary_hover');
                statusMsg.innerHTML = '<span class="text-primary">Listening... Speak now. (Auto-send on silence)</span>';
            } else {
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.remove('bg-listening', 'animate-mic-pulse');
                btn.classList.add('bg-primary', 'hover:bg-primary_hover');
                statusMsg.innerHTML = 'Peyza X2 can make mistakes. Verify important info.';
            }
        }

        // --- Other Utilities ---

        function copyToClipboard(btn) {
            // ... (copy logic omitted for brevity) ...
            const text = decodeURIComponent(btn.getAttribute('data-text'));
            
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check text-green-400 text-xs"></i>';
            setTimeout(() => {
                btn.innerHTML = originalIcon;
            }, 1000);
        }


        function clearChat() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if(chat) {
                if(window.confirm(`Are you sure you want to clear the messages in the chat with ${chat.botName}?`)) {
                    chat.messages = [];
                    chat.title = `Chat with ${chat.botName}`; 
                    setStorage('x2_chats', state.chats);
                    loadChat(chat.id);
                }
            }
        }

        // --- Settings & Admin ---
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function verifyAdmin() {
            const val = document.getElementById('admin-pass').value;
            const msg = document.getElementById('admin-msg');
            if(val === ADMIN_PASS) {
                state.isAdmin = true;
                setStorage('x2_admin', true);
                msg.textContent = "Unlimited Access Unlocked";
                msg.className = "text-xs mt-2 h-4 text-green-400";
                updateAdminUI();
            } else {
                msg.textContent = "Invalid Code";
                msg.className = "text-xs mt-2 h-4 text-red-400";
            }
        }

        function updateAdminUI() {
            if(state.isAdmin) {
                document.getElementById('status-display').textContent = "Admin (Unlimited)";
                document.getElementById('status-display').classList.add('text-primary');
                document.getElementById('limit-warning').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
