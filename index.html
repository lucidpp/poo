<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peyza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#000000',
                        darkSec: '#16181c',
                        darkText: '#e7e9ea',
                        darkBorder: '#2f3336'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #e11d48; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #be123c; 
        }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        
        .nav-item.active i {
            font-weight: 900;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .mobile-nav {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Interaction States */
        .liked {
            color: #e11d48 !important;
        }
        .reposted {
            color: #22c55e !important;
        }
        .bookmarked {
            color: #3b82f6 !important;
        }
        .bookmarked i {
            font-weight: 900 !important;
        }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-white text-[#0f1419] dark:bg-dark dark:text-darkText transition-colors duration-200">

    <!-- Left Sidebar (Desktop) -->
    <header class="hidden sm:flex flex-col w-[80px] xl:w-[275px] h-screen fixed left-0 top-0 border-r border-gray-100 dark:border-darkBorder px-2 xl:px-8 py-4 z-20 bg-white dark:bg-dark justify-between">
        <div class="space-y-4">
            <!-- Logo -->
            <div class="p-3 w-min hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-full cursor-pointer transition transform active:scale-90" onclick="app.navigate('home')">
                <i class="fa-solid fa-p text-3xl text-rose-600"></i>
            </div>

            <!-- Nav Items -->
            <nav class="space-y-2 text-xl">
                <a onclick="app.navigate('home')" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item active" id="nav-home">
                    <i class="fa-solid fa-house"></i>
                    <span class="hidden xl:block font-medium">Home</span>
                </a>
                <a onclick="app.showToast('Search coming soon!')" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span class="hidden xl:block font-medium">Explore</span>
                </a>
                <a onclick="app.showToast('No notifications yet')" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item">
                    <i class="fa-regular fa-bell"></i>
                    <span class="hidden xl:block font-medium">Notifications</span>
                </a>
                <a onclick="app.navigate('profile', app.user.handle)" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item" id="nav-profile">
                    <i class="fa-regular fa-user"></i>
                    <span class="hidden xl:block font-medium">Profile</span>
                </a>
                <a onclick="app.openSettings()" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item">
                    <i class="fa-solid fa-gear"></i>
                    <span class="hidden xl:block font-medium">Settings</span>
                </a>
            </nav>

            <!-- Post Button -->
            <button onclick="app.openComposeModal()" class="bg-rose-600 hover:bg-rose-700 text-white rounded-full p-4 xl:py-3 xl:px-8 w-full shadow-lg transition transform active:scale-95 mt-4">
                <i class="fa-solid fa-feather sm:hidden"></i>
                <span class="hidden xl:block font-bold text-lg">Post</span>
            </button>
        </div>

        <!-- User Mini Profile -->
        <div onclick="app.navigate('profile', app.user.handle)" class="flex items-center gap-3 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer mb-4 transition" id="sidebar-user">
            <!-- Injected by JS -->
        </div>
    </header>

    <!-- Main Content Feed -->
    <main class="w-full sm:ml-[80px] xl:ml-[275px] max-w-[600px] border-r border-gray-100 dark:border-darkBorder min-h-screen pb-20 sm:pb-0 relative">
        
        <!-- Sticky Header -->
        <div class="sticky top-0 bg-white/80 dark:bg-dark/80 backdrop-blur-md z-10 border-b border-gray-100 dark:border-darkBorder">
            <div id="header-content" class="px-4 h-[53px] flex items-center justify-between cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <h2 class="text-lg font-bold">Home</h2>
                <i class="fa-solid fa-wand-magic-sparkles text-rose-500 hover:rotate-12 transition"></i>
            </div>
            
            <!-- Feed Filters -->
            <div id="feed-filters" class="flex border-b border-gray-100 dark:border-darkBorder">
                <div onclick="app.setFeedFilter('foryou')" class="flex-1 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer transition text-center py-3 relative feed-filter group" data-filter="foryou">
                    <span class="font-medium text-sm text-gray-500 dark:text-gray-400 group-[.active]:text-gray-900 dark:group-[.active]:text-white group-[.active]:font-bold">For You</span>
                    <div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px]">
                        <div class="bg-rose-500 w-14 rounded-full indicator hidden transition-all duration-300"></div>
                    </div>
                </div>
                <div onclick="app.setFeedFilter('following')" class="flex-1 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer transition text-center py-3 relative feed-filter group" data-filter="following">
                    <span class="font-medium text-sm text-gray-500 dark:text-gray-400 group-[.active]:text-gray-900 dark:group-[.active]:text-white group-[.active]:font-bold">Following</span>
                    <div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px]">
                        <div class="bg-rose-500 w-14 rounded-full indicator hidden transition-all duration-300"></div>
                    </div>
                </div>
                <div onclick="app.setFeedFilter('media')" class="flex-1 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer transition text-center py-3 relative feed-filter group" data-filter="media">
                    <span class="font-medium text-sm text-gray-500 dark:text-gray-400 group-[.active]:text-gray-900 dark:group-[.active]:text-white group-[.active]:font-bold">Media</span>
                    <div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px]">
                        <div class="bg-rose-500 w-14 rounded-full indicator hidden transition-all duration-300"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="main-view" class="animate-fade-in">
            <!-- Content injected via JS -->
        </div>

    </main>

    <!-- Right Sidebar (Desktop) -->
    <aside class="hidden lg:block w-[350px] pl-8 py-4 h-screen sticky top-0">
        <!-- Search -->
        <div class="relative group mb-6">
            <div class="absolute left-4 top-3 text-gray-500 group-focus-within:text-rose-500">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <input type="text" placeholder="Search Peyza" class="w-full bg-gray-100 dark:bg-darkSec dark:text-white rounded-full py-3 pl-12 pr-4 outline-none focus:bg-white dark:focus:bg-black focus:ring-1 focus:ring-rose-500 transition border border-transparent dark:border-darkBorder">
        </div>

        <!-- Trends -->
        <div class="bg-gray-50 dark:bg-darkSec rounded-2xl p-4 mb-4">
            <h3 class="font-extrabold text-xl mb-4">Trends for you</h3>
            <div class="space-y-4">
                <div class="cursor-pointer hover:bg-gray-200/50 dark:hover:bg-gray-800 -mx-4 px-4 py-2 transition">
                    <p class="text-xs text-gray-500">Trending in Tech</p>
                    <p class="font-bold text-sm">#PeyzaGodMode</p>
                    <p class="text-xs text-gray-500">54.2K posts</p>
                </div>
                <div class="cursor-pointer hover:bg-gray-200/50 dark:hover:bg-gray-800 -mx-4 px-4 py-2 transition">
                    <p class="text-xs text-gray-500">Politics Â· Trending</p>
                    <p class="font-bold text-sm">Pin 568300</p>
                    <p class="text-xs text-gray-500">12.5K posts</p>
                </div>
                <div class="cursor-pointer hover:bg-gray-200/50 dark:hover:bg-gray-800 -mx-4 px-4 py-2 transition">
                    <p class="text-xs text-gray-500">Technology</p>
                    <p class="font-bold text-sm">AI Bots</p>
                    <p class="text-xs text-gray-500">88.1K posts</p>
                </div>
            </div>
        </div>

        <!-- Who to follow -->
        <div class="bg-gray-50 dark:bg-darkSec rounded-2xl p-4">
            <h3 class="font-extrabold text-xl mb-4">Who to follow</h3>
            <div id="who-to-follow" class="space-y-4">
                <!-- Injected via JS -->
            </div>
        </div>
    </aside>

    <!-- Mobile Navigation Bottom -->
    <div class="fixed bottom-0 w-full bg-white dark:bg-dark border-t border-gray-100 dark:border-darkBorder flex justify-around items-center py-3 sm:hidden mobile-nav z-30">
        <div onclick="app.navigate('home')" class="nav-icon cursor-pointer text-2xl text-gray-900 dark:text-white active:scale-90 transition"><i class="fa-solid fa-house"></i></div>
        <div onclick="app.showToast('Search coming soon')" class="nav-icon cursor-pointer text-2xl text-gray-400 active:scale-90 transition"><i class="fa-solid fa-magnifying-glass"></i></div>
        <div onclick="app.showToast('Notifications empty')" class="nav-icon cursor-pointer text-2xl text-gray-400 active:scale-90 transition"><i class="fa-regular fa-bell"></i></div>
        <div onclick="app.navigate('profile', app.user.handle)" class="nav-icon cursor-pointer text-2xl text-gray-400 active:scale-90 transition"><i class="fa-regular fa-user"></i></div>
    </div>

    <!-- Floating Action Button (Mobile) -->
    <button onclick="app.openComposeModal()" class="fixed bottom-20 right-4 bg-rose-500 text-white rounded-full p-4 shadow-lg sm:hidden z-20 hover:bg-rose-600 active:scale-90 transition animate-pop">
        <i class="fa-solid fa-feather text-xl"></i>
    </button>

    <!-- Compose Modal -->
    <div id="compose-modal" class="fixed inset-0 bg-black/40 dark:bg-white/10 z-50 hidden flex items-start justify-center pt-16 sm:pt-24 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark w-full max-w-[600px] rounded-2xl p-4 shadow-2xl relative animate-pop border dark:border-darkBorder">
            <div class="flex justify-between items-center mb-4">
                <button onclick="app.closeComposeModal()" class="text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-darkSec p-2 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="flex gap-4">
                     <span class="text-rose-500 font-bold text-sm self-center">Drafts</span>
                     <button onclick="app.publishPost()" class="bg-rose-500 text-white px-4 py-1.5 rounded-full font-bold text-sm hover:bg-rose-600 disabled:opacity-50 transition">Post</button>
                </div>
            </div>
            <div class="flex gap-3">
                <img id="compose-avatar" src="" class="w-10 h-10 rounded-full object-cover border border-gray-100 dark:border-darkBorder">
                <div class="w-full">
                    <!-- Author Selector for Bots -->
                    <div id="author-selector" class="hidden mb-2">
                        <select id="post-as-select" class="text-sm font-bold bg-transparent outline-none text-rose-500 cursor-pointer">
                            <!-- Options injected -->
                        </select>
                    </div>
                    
                    <div id="replying-to-indicator" class="hidden text-sm text-gray-500 mb-1">Replying to <span class="text-rose-500">@post</span></div>

                    <textarea id="compose-input" class="w-full h-32 resize-none outline-none text-xl placeholder-gray-500 bg-transparent dark:text-white mt-2" placeholder="What is happening?!"></textarea>
                    <div class="border-t border-gray-100 dark:border-darkBorder pt-3 flex justify-between items-center text-rose-500 text-lg">
                        <div class="flex gap-4">
                            <i class="fa-regular fa-image cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition"></i>
                            <i class="fa-solid fa-square-poll-horizontal cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition"></i>
                            <i class="fa-regular fa-face-smile cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition"></i>
                            <i class="fa-solid fa-calendar-days cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile / Settings Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black/40 dark:bg-white/10 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark w-full max-w-[500px] rounded-2xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto animate-pop border dark:border-darkBorder">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="app.closeEditProfile()" class="text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-darkSec p-2 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <h2 class="font-bold text-xl" id="edit-modal-title">Edit Profile</h2>
                </div>
                <button onclick="app.saveProfile()" class="bg-black dark:bg-white dark:text-black text-white px-5 py-1.5 rounded-full font-bold text-sm hover:bg-gray-800 transition">Save</button>
            </div>
            
            <!-- Hidden File Inputs -->
            <input type="file" id="banner-upload" hidden accept="image/*" onchange="app.handleImageUpload(event, 'banner')">
            <input type="file" id="avatar-upload" hidden accept="image/*" onchange="app.handleImageUpload(event, 'avatar')">

            <!-- Cover Photo Edit -->
            <div class="h-32 bg-gray-200 dark:bg-darkSec relative mb-12 rounded-md group cursor-pointer overflow-hidden border dark:border-darkBorder" onclick="document.getElementById('banner-upload').click()">
                <img id="edit-banner-preview" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                    <i class="fa-solid fa-camera text-white text-2xl drop-shadow-md"></i>
                </div>
                <!-- Avatar Overlap -->
                <div class="absolute -bottom-10 left-4 w-24 h-24 rounded-full border-4 border-white dark:border-dark bg-gray-300 dark:bg-darkSec overflow-hidden cursor-pointer group hover:opacity-90" onclick="event.stopPropagation(); document.getElementById('avatar-upload').click()">
                    <img id="edit-avatar-preview" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                        <i class="fa-solid fa-camera text-white drop-shadow-md"></i>
                    </div>
                </div>
            </div>

            <form class="space-y-4 mt-8">
                <!-- Theme Toggle -->
                <div class="flex items-center justify-between p-2 border border-gray-200 dark:border-darkBorder rounded-md">
                    <span class="font-bold text-sm">Dark Mode</span>
                    <button type="button" onclick="app.toggleTheme()" id="theme-btn" class="text-gray-500 hover:text-rose-500 font-bold text-sm transition">Switch</button>
                </div>

                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500 focus-within:border-transparent transition">
                    <label class="block text-xs text-gray-500">Name</label>
                    <input type="text" id="edit-name" class="w-full outline-none text-sm bg-transparent dark:text-white">
                </div>
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500 focus-within:border-transparent transition">
                    <label class="block text-xs text-gray-500">Bio</label>
                    <textarea id="edit-bio" class="w-full outline-none text-sm resize-none h-20 bg-transparent dark:text-white"></textarea>
                </div>
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500 focus-within:border-transparent transition">
                    <label class="block text-xs text-gray-500">Location</label>
                    <input type="text" id="edit-location" class="w-full outline-none text-sm bg-transparent dark:text-white">
                </div>
                
                <hr class="border-gray-100 dark:border-darkBorder my-4">
                
                <!-- Secret PIN Input -->
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500">
                    <label class="block text-xs text-gray-500">Secret PIN</label>
                    <input type="password" id="secret-pin" oninput="app.checkPin()" class="w-full outline-none text-sm font-mono text-rose-600 bg-transparent" placeholder="Enter code">
                </div>

                <!-- GOD MODE SECTION (Hidden by default) -->
                <div id="god-mode-panel" class="hidden space-y-4 bg-rose-50 dark:bg-rose-900/10 p-4 rounded-lg border border-rose-100 dark:border-rose-900/30">
                    <h3 class="font-bold text-rose-600 mb-2">âš¡ God Mode Active</h3>

                    <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 bg-white dark:bg-dark">
                        <label class="block text-xs text-gray-500">Follower Count (Cheat)</label>
                        <input type="number" id="edit-followers" class="w-full outline-none text-sm font-mono text-rose-600 bg-transparent">
                    </div>

                    <div class="flex items-center justify-between p-2 border border-gray-200 dark:border-darkBorder rounded-md bg-white dark:bg-dark">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm">Force Verify</span>
                            <span class="text-xs text-gray-500">Bypass requirements</span>
                        </div>
                        <button type="button" id="btn-verify" onclick="app.requestVerification(true)" class="bg-black text-white px-3 py-1.5 rounded-full text-sm font-bold transition">Get Badge</button>
                    </div>
                    
                    <button type="button" onclick="app.openCreateBotModal()" class="w-full bg-rose-500 text-white font-bold py-2 rounded-md hover:bg-rose-600 transition">
                        <i class="fa-solid fa-robot mr-2"></i> Create New Bot
                    </button>

                    <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-2 bg-white dark:bg-dark">
                        <label class="block text-xs text-gray-500 mb-2">Virality Speed</label>
                        <select id="edit-virality" class="w-full outline-none text-sm bg-transparent dark:text-white">
                            <option value="0.1">Slow (Realistic)</option>
                            <option value="1">Normal</option>
                            <option value="5">Fast</option>
                            <option value="20">Superfast (Viral)</option>
                            <option value="2000">Ultra Fast (Godspeed)</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Bot Modal -->
    <div id="create-bot-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark w-full max-w-[400px] rounded-2xl p-6 shadow-2xl relative animate-pop border dark:border-darkBorder">
             <div class="flex justify-between items-center mb-6">
                <h2 class="font-bold text-xl">Create Bot</h2>
                <button onclick="document.getElementById('create-bot-modal').classList.add('hidden')" class="text-gray-900 dark:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="bot-name" placeholder="Bot Name" class="w-full border p-2 rounded-md dark:bg-darkSec dark:border-darkBorder dark:text-white">
                <input type="text" id="bot-handle" placeholder="Bot Handle (no @)" class="w-full border p-2 rounded-md dark:bg-darkSec dark:border-darkBorder dark:text-white">
                <input type="text" id="bot-avatar" placeholder="Avatar URL (optional)" class="w-full border p-2 rounded-md dark:bg-darkSec dark:border-darkBorder dark:text-white">
                <button onclick="app.createBot()" class="w-full bg-rose-600 text-white font-bold py-2 rounded-full">Create</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-rose-500 text-white px-6 py-2 rounded-full shadow-lg z-[70] transition-opacity duration-300 opacity-0 pointer-events-none font-bold text-sm">
        Action Successful
    </div>

<script>
/**
 * Peyza App Logic v2.0
 */

// --- ICONS ---
// Updated to a rosette style badge
const VERIFIED_ICON = `<svg viewBox="0 0 24 24" aria-label="Verified Account" class="w-5 h-5 ml-1 inline-block text-rose-500 fill-current align-text-bottom"><g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.912-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.912 1.79-3.912 4 0 .495.084.965.238 1.4-1.272.65-2.147 2.02-2.147 3.6 0 1.417.705 2.674 1.774 3.426-.09.38-.138.775-.138 1.18 0 2.597 2.193 4.8 4.887 4.8.94 0 1.815-.28 2.546-.755.67.635 1.57.99 2.522.99.98 0 1.905-.373 2.585-1.036.65.385 1.393.595 2.164.595 2.553 0 4.708-2.02 4.908-4.502.04.017.08.03.123.03 1.252 0 2.373-.556 3.116-1.42.75-.873 1.096-2.03.96-3.18z"></path><path d="M9.707 15.293l-4-4 1.414-1.414L10 12.758l7.293-7.293 1.414 1.414-8 8a1 1 0 01-1.414 0z" fill="#fff"></path></g></svg>`;

const ANALYTICS_ICON = `<svg viewBox="0 0 24 24" aria-hidden="true" class="w-[18px] h-[18px] fill-current"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>`;

// Default Bots
const DEFAULT_BOTS = [
    { handle: 'tech_guru', name: 'Tech Insider', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix', bio: 'Latest tech news.', followers: 450200, following: 152, isVerified: true },
    { handle: 'meme_lord', name: 'Daily Memes', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Meme', bio: 'I post memes.', followers: 12000, following: 50, isVerified: false },
    { handle: 'crypto_king', name: 'Crypto Chad', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Chad', bio: 'HODL.', followers: 8900, following: 1200, isVerified: false },
    { handle: 'art_daily', name: 'Artistic Soul', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Art', bio: 'Digital artist.', followers: 230000, following: 890, isVerified: true },
    { handle: 'news_bot', name: 'Peyza News', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=News', bio: 'Breaking news.', followers: 1500000, following: 10, isVerified: true }
];

const MOCK_POSTS_CONTENT = [
    "Just deployed the new update! #coding #life", "Why is coffee so good? â˜•ï¸", "Peyza is looking slick with this red theme! â¤ï¸",
    "AI is taking over, and I for one welcome our robot overlords.", "Can't believe it's already Friday.", "Learning Rust is harder than I thought.",
    "Just bought more Bitcoin. Don't tell my wife. ðŸ¤«", "This new app design is fire ðŸ”¥", "Does anyone actually read these?",
    "Web3 is the future.", "React vs Vue vs Svelte vs Angular. Go!", "Just saw a Cybertruck in person. It looks... interesting."
];

// --- APP CLASS ---

class PeyzaApp {
    constructor() {
        this.user = this.loadUser();
        this.bots = this.loadBots();
        this.posts = this.loadPosts();
        this.currentView = 'home'; 
        this.viewParam = null;
        this.feedFilter = 'foryou';
        this.profileFilter = 'posts'; // Default profile filter
        this.settings = this.loadSettings();
        
        // Session state
        this.editingHandle = null; 
        this.replyingTo = null;

        this.init();
    }

    init() {
        this.applyTheme();
        this.renderSidebarUser();
        this.renderWhoToFollow();
        this.renderView();
        
        // Force UI update for filter bar on load
        setTimeout(() => this.setFeedFilter('foryou'), 100);

        // Real-time loop
        setInterval(() => this.simulateStats(), 1000);
        setInterval(() => this.generateRandomBotPost(), 15000);
    }

    // --- DATA MANAGEMENT ---

    loadUser() {
        const saved = localStorage.getItem('peyza_user_v4'); 
        if (saved) return JSON.parse(saved);
        return {
            handle: 'guest_user', name: 'Guest', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Guest',
            banner: 'https://images.unsplash.com/photo-1557683316-973673baf926?w=800&auto=format&fit=crop&q=60',
            bio: 'Just a guest exploring Peyza.', location: 'Internet',
            joined: new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            followers: 42, following: 15, isVerified: false,
            likedPosts: [], repostedPosts: [], bookmarks: [],
            isPremium: false, createdBots: [] // Handles of created bots
        };
    }

    loadBots() {
        const saved = localStorage.getItem('peyza_bots');
        if(saved) return JSON.parse(saved);
        return [...DEFAULT_BOTS];
    }

    saveUser() {
        localStorage.setItem('peyza_user_v4', JSON.stringify(this.user));
        this.renderSidebarUser();
        if (this.currentView === 'profile' && this.viewParam === this.user.handle) {
            this.renderProfile(this.user.handle);
        }
    }
    
    saveBots() {
        localStorage.setItem('peyza_bots', JSON.stringify(this.bots));
    }

    loadSettings() {
        const saved = localStorage.getItem('peyza_settings');
        if (saved) return JSON.parse(saved);
        return { viralitySpeed: 1.0, theme: 'light' };
    }

    saveSettings() {
        localStorage.setItem('peyza_settings', JSON.stringify(this.settings));
    }

    loadPosts() {
        const saved = localStorage.getItem('peyza_posts_v4');
        if (saved) {
            let posts = JSON.parse(saved);
            if(posts.length > 200) posts = posts.slice(0, 100);
            return posts;
        }
        const posts = [];
        for (let i = 0; i < 15; i++) {
            posts.push(this.createMockPost(i * 1000 * 60 * 30));
        }
        return posts;
    }

    savePosts() {
        localStorage.setItem('peyza_posts_v4', JSON.stringify(this.posts));
    }

    // --- LOGIC ---

    getProfile(handle) {
        if (handle === this.user.handle) return this.user;
        return this.bots.find(b => b.handle === handle);
    }

    createMockPost(timeOffset = 0) {
        const bot = this.bots[Math.floor(Math.random() * this.bots.length)];
        const content = MOCK_POSTS_CONTENT[Math.floor(Math.random() * MOCK_POSTS_CONTENT.length)];
        const hasImage = Math.random() > 0.7;
        
        return {
            id: 'post_' + Math.random().toString(36).substr(2, 9),
            authorHandle: bot.handle,
            authorName: bot.name,
            authorAvatar: bot.avatar,
            isVerified: bot.isVerified,
            content: content,
            image: hasImage ? `https://picsum.photos/seed/${Math.random()}/600/350` : null,
            createdAt: Date.now() - timeOffset,
            stats: {
                likes: Math.floor(Math.random() * 50), reposts: Math.floor(Math.random() * 10),
                replies: Math.floor(Math.random() * 5), views: Math.floor(Math.random() * 500)
            },
            baseVelocity: Math.random()
        };
    }

    createPost(content, asHandle = null) {
        let author = this.user;
        if (asHandle && asHandle !== this.user.handle) {
            author = this.bots.find(b => b.handle === asHandle) || this.user;
        }

        const newPost = {
            id: 'post_' + Math.random().toString(36).substr(2, 9),
            authorHandle: author.handle,
            authorName: author.name,
            authorAvatar: author.avatar,
            isVerified: author.isVerified,
            content: content,
            image: null,
            createdAt: Date.now(),
            stats: { likes: 0, reposts: 0, replies: 0, views: 0 },
            baseVelocity: Math.random()
        };
        this.posts.unshift(newPost);
        this.savePosts();
        
        // If it was a reply, increment original post reply count
        if (this.replyingTo) {
            const originalPost = this.posts.find(p => p.id === this.replyingTo);
            if(originalPost) {
                originalPost.stats.replies++;
                this.savePosts();
            }
            this.replyingTo = null;
        }

        this.renderView();
    }

    generateRandomBotPost() {
        // Enforce bot posting limit (max 20 active bot posts at a time to prevent flooding)
        const botPostCount = this.posts.filter(p => this.bots.some(b => b.handle === p.authorHandle)).length;
        if (botPostCount > 20) return;

        if (Math.random() > 0.5) {
            const post = this.createMockPost();
            this.posts.unshift(post);
            this.savePosts();
            if (this.currentView === 'home') this.renderFeed();
        }
    }

    simulateStats() {
        const now = Date.now();
        let changed = false;
        const fourHours = 4 * 60 * 60 * 1000;

        // Cleanup: Force removal of bot posts older than 4 hours
        const initialLength = this.posts.length;
        this.posts = this.posts.filter(p => {
            const isBot = this.bots.some(b => b.handle === p.authorHandle);
            // If it's a bot and older than 4 hours, remove it
            if (isBot && (now - p.createdAt > fourHours)) {
                return false; 
            }
            return true;
        });
        
        if (this.posts.length !== initialLength) changed = true;

        this.posts.forEach(post => {
            const ageInSeconds = (now - post.createdAt) / 1000;
            if (ageInSeconds < 86400) {
                // Determine Author followers for scale
                let followers = 100;
                if (post.authorHandle === this.user.handle) followers = this.user.followers;
                else {
                    const b = this.bots.find(x => x.handle === post.authorHandle);
                    if(b) followers = b.followers;
                }

                // Follower Scale Multiplier
                const followerScale = Math.max(1, Math.log10(followers));
                
                // Repost Multiplier: Reposts now strongly drive views
                const repostBoost = 1 + (post.stats.reposts * 0.1); // 10% boost per repost

                const growthFactor = this.settings.viralitySpeed * post.baseVelocity * followerScale * repostBoost;
                
                // Views Growth
                const newViews = Math.floor(post.stats.views + (growthFactor * 5 * Math.random()));
                if (newViews > post.stats.views) {
                    post.stats.views = newViews;
                    changed = true;
                }

                // Reply Growth: Correlated to views (Target: 1 reply per ~200 views)
                const targetReplies = Math.floor(post.stats.views / 200);
                // Catch up if lagging, with random noise
                if (post.stats.replies < targetReplies && Math.random() < 0.2) { 
                     post.stats.replies++;
                     changed = true;
                }

                // Likes Growth
                if (Math.random() < 0.3) {
                    post.stats.likes += Math.floor(growthFactor * Math.random() * 2);
                    changed = true;
                }
                
                // Repost Growth
                if (Math.random() < 0.05) {
                    post.stats.reposts += 1;
                    changed = true;
                }
            }
        });

        if (changed) {
            this.savePosts();
            this.updateVisibleStats();
        }
    }

    updateVisibleStats() {
        this.posts.forEach(post => {
            const el = document.getElementById(`stats-${post.id}`);
            if (el) {
                const viewsEl = el.querySelector('.stat-views');
                if (viewsEl) viewsEl.innerText = this.formatNumber(post.stats.views);
                const likesEl = el.querySelector('.stat-likes');
                if (likesEl) likesEl.innerText = this.formatNumber(post.stats.likes);
                const repostsEl = el.querySelector('.stat-reposts');
                if (repostsEl) repostsEl.innerText = this.formatNumber(post.stats.reposts);
            }
            const detailViews = document.getElementById(`detail-views-${post.id}`);
            if (detailViews) {
                detailViews.innerText = this.formatNumber(post.stats.views);
            }
        });
    }

    // --- NAVIGATION ---

    navigate(view, param = null) {
        this.currentView = view;
        this.viewParam = param;
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        if (view === 'home') {
            document.getElementById('nav-home').classList.add('active');
        } else if (view === 'profile' && param === this.user.handle) {
            document.getElementById('nav-profile').classList.add('active');
        }

        window.scrollTo(0,0);
        this.renderView();
    }

    setFeedFilter(filter) {
        this.feedFilter = filter;
        document.querySelectorAll('.feed-filter').forEach(el => {
            const isActive = el.dataset.filter === filter;
            if (isActive) el.classList.add('active'); else el.classList.remove('active');
            el.querySelector('.indicator').classList.toggle('hidden', !isActive);
        });
        this.renderView();
    }
    
    setProfileFilter(filter) {
        this.profileFilter = filter;
        this.renderProfile(this.viewParam);
    }

    // --- THEME ---

    toggleTheme() {
        this.settings.theme = this.settings.theme === 'light' ? 'dark' : 'light';
        this.applyTheme();
        this.saveSettings();
    }

    applyTheme() {
        const html = document.querySelector('html');
        if (this.settings.theme === 'dark') {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }
    }

    // --- RENDERING ---

    renderView() {
        const main = document.getElementById('main-view');
        const headerTitle = document.querySelector('#header-content h2');
        const feedFilters = document.getElementById('feed-filters');
        
        main.classList.remove('animate-fade-in');
        void main.offsetWidth; 
        main.classList.add('animate-fade-in');
        
        main.innerHTML = '';

        if (this.currentView === 'home') {
            headerTitle.innerText = 'Home';
            feedFilters.classList.remove('hidden');
            this.renderFeed();
        } else if (this.currentView === 'profile') {
            headerTitle.innerText = this.viewParam; 
            feedFilters.classList.add('hidden');
            this.renderProfile(this.viewParam);
        } else if (this.currentView === 'post') {
            headerTitle.innerText = 'Post';
            feedFilters.classList.add('hidden');
            this.renderPostDetail(this.viewParam);
        }
    }

    renderFeed() {
        const container = document.getElementById('main-view');
        let filteredPosts = [...this.posts];

        if (this.feedFilter === 'media') filteredPosts = filteredPosts.filter(p => p.image);
        else if (this.feedFilter === 'following') filteredPosts = filteredPosts.filter(p => p.authorHandle !== 'guest_user');

        filteredPosts.sort((a, b) => b.createdAt - a.createdAt);

        let html = '';
        filteredPosts.forEach(post => html += this.buildPostHTML(post));
        container.innerHTML = html;
    }

    renderProfile(handle) {
        const container = document.getElementById('main-view');
        
        const profileData = this.getProfile(handle) || { 
            name: 'Unknown', handle: handle, bio: 'User not found', followers: 0, following: 0, avatar: 'https://placehold.co/400', isVerified: false 
        };

        const isMe = handle === this.user.handle;
        const isMyBot = this.user.createdBots.includes(handle);
        const canEdit = isMe || (this.user.isPremium && isMyBot) || (this.user.isPremium && this.settings.godModeEnabled); 

        const banner = profileData.banner || `https://picsum.photos/seed/${handle}/800/300`;

        const html = `
            <div>
                <!-- Banner -->
                <div class="h-32 sm:h-48 bg-gray-200 dark:bg-darkSec overflow-hidden cursor-pointer">
                    <img src="${banner}" class="w-full h-full object-cover">
                </div>
                
                <!-- Info Section -->
                <div class="px-4 relative mb-4">
                    <div class="flex justify-between items-start">
                        <div class="-mt-[15%] sm:-mt-[10%] w-[25%] max-w-[130px] aspect-square rounded-full border-4 border-white dark:border-dark overflow-hidden bg-white dark:bg-darkSec">
                            <img src="${profileData.avatar}" class="w-full h-full object-cover">
                        </div>
                        <div class="mt-3">
                            ${canEdit ? 
                                `<button onclick="app.openEditProfile('${handle}')" class="border border-gray-300 dark:border-darkBorder font-bold rounded-full px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-darkSec transition text-sm text-gray-900 dark:text-white">Edit profile</button>` : 
                                `<button class="bg-black dark:bg-white dark:text-black text-white font-bold rounded-full px-5 py-1.5 hover:bg-gray-800 transition text-sm" onclick="app.toggleFollow('${handle}', this)">Follow</button>`
                            }
                        </div>
                    </div>

                    <div class="mt-3">
                        <h1 class="font-extrabold text-xl leading-tight flex items-center dark:text-white">
                            ${profileData.name}
                            ${profileData.isVerified ? VERIFIED_ICON : ''}
                        </h1>
                        <p class="text-gray-500 text-sm">@${profileData.handle}</p>
                    </div>

                    <p class="mt-3 text-[15px] text-gray-900 dark:text-white whitespace-pre-wrap">${profileData.bio}</p>

                    <div class="flex gap-4 mt-3 text-sm text-gray-500">
                        <span class="flex items-center gap-1"><i class="fa-solid fa-location-dot"></i> ${profileData.location || 'Internet'}</span>
                        <span class="flex items-center gap-1"><i class="fa-solid fa-calendar-days"></i> Joined ${profileData.joined || 'May 2023'}</span>
                    </div>

                    <div class="flex gap-5 mt-3 text-sm dark:text-gray-400">
                        <div class="hover:underline cursor-pointer"><span class="font-bold text-gray-900 dark:text-white">${this.formatNumber(profileData.following)}</span> Following</div>
                        <div class="hover:underline cursor-pointer"><span class="font-bold text-gray-900 dark:text-white" id="profile-followers-count">${this.formatNumber(profileData.followers)}</span> Followers</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-100 dark:border-darkBorder mt-2">
                    <div onclick="app.setProfileFilter('posts')" class="flex-1 text-center py-3 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer relative font-bold text-sm dark:text-white ${this.profileFilter === 'posts' ? 'text-black dark:text-white' : 'text-gray-500'}">
                        Posts
                        <div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${this.profileFilter === 'posts' ? '' : 'hidden'}"><div class="bg-rose-500 w-12 rounded-full"></div></div>
                    </div>
                    <div onclick="app.setProfileFilter('media')" class="flex-1 text-center py-3 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer relative font-bold text-sm dark:text-white ${this.profileFilter === 'media' ? 'text-black dark:text-white' : 'text-gray-500'}">
                        Media
                        <div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${this.profileFilter === 'media' ? '' : 'hidden'}"><div class="bg-rose-500 w-12 rounded-full"></div></div>
                    </div>
                    <div onclick="app.setProfileFilter('likes')" class="flex-1 text-center py-3 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer relative font-bold text-sm dark:text-white ${this.profileFilter === 'likes' ? 'text-black dark:text-white' : 'text-gray-500'}">
                        Likes
                        <div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${this.profileFilter === 'likes' ? '' : 'hidden'}"><div class="bg-rose-500 w-12 rounded-full"></div></div>
                    </div>
                </div>

                <!-- Profile Feed -->
                <div id="profile-feed">
                    ${this.getPostsByHandle(handle)}
                </div>
            </div>
        `;
        container.innerHTML = html;
    }

    renderPostDetail(postId) {
        const post = this.posts.find(p => p.id === postId);
        if (!post) return;

        // Dynamic Author Info
        let avatar = post.authorAvatar;
        let name = post.authorName;
        let isVerified = post.isVerified;

        if (post.authorHandle === this.user.handle) {
            avatar = this.user.avatar;
            name = this.user.name;
            isVerified = this.user.isVerified;
        } else {
             const bot = this.bots.find(b => b.handle === post.authorHandle);
             if (bot) {
                 avatar = bot.avatar;
                 name = bot.name;
                 isVerified = bot.isVerified;
             }
        }

        const isLiked = this.user.likedPosts.includes(postId);
        const isReposted = this.user.repostedPosts.includes(postId);
        const isBookmarked = this.user.bookmarks.includes(postId);
        const container = document.getElementById('main-view');
        
        let html = `
            <div class="px-4 py-3 border-b border-gray-100 dark:border-darkBorder animate-fade-in">
                <div class="flex gap-3 items-center mb-3">
                     <div class="w-10 h-10 rounded-full overflow-hidden cursor-pointer" onclick="app.navigate('profile', '${post.authorHandle}')">
                        <img src="${avatar}" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <div class="font-bold flex items-center cursor-pointer hover:underline dark:text-white" onclick="app.navigate('profile', '${post.authorHandle}')">
                            ${name} ${isVerified ? VERIFIED_ICON : ''}
                        </div>
                        <div class="text-gray-500 text-sm">@${post.authorHandle}</div>
                    </div>
                </div>
                
                <div class="text-xl mb-3 whitespace-pre-wrap leading-normal dark:text-white">${post.content}</div>
                
                ${post.image ? `<div class="rounded-2xl overflow-hidden border border-gray-100 dark:border-darkBorder mb-3"><img src="${post.image}" class="w-full"></div>` : ''}

                <div class="text-gray-500 text-sm py-4 border-b border-gray-100 dark:border-darkBorder">
                    ${new Date(post.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} Â· ${new Date(post.createdAt).toLocaleDateString()} Â· <span class="text-black dark:text-white font-bold font-mono" id="detail-views-${post.id}">${this.formatNumber(post.stats.views)}</span> <span class="font-medium">Views</span>
                </div>

                <div class="flex justify-between py-1 border-b border-gray-100 dark:border-darkBorder text-gray-500 px-2" id="stats-${post.id}">
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-500 flex items-center justify-center w-full py-3 transition group rounded-full" onclick="app.openReplyModal('${post.id}')">
                        <i class="fa-regular fa-comment text-xl"></i> 
                    </div>
                    <div class="cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 hover:text-green-500 flex items-center justify-center w-full py-3 transition group rounded-full ${isReposted ? 'reposted' : ''}" onclick="app.toggleRepost('${post.id}', this)">
                        <i class="fa-solid fa-retweet text-xl transition-transform active:scale-125"></i>
                    </div>
                    <div class="cursor-pointer hover:bg-rose-50 dark:hover:bg-rose-900/20 hover:text-rose-600 flex items-center justify-center w-full py-3 transition group rounded-full ${isLiked ? 'liked' : ''}" onclick="app.toggleLike('${post.id}', this)">
                        <i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart text-xl transition-transform active:scale-125"></i>
                    </div>
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-500 flex items-center justify-center w-full py-3 transition group rounded-full ${isBookmarked ? 'bookmarked' : ''}" onclick="app.toggleBookmark('${post.id}', this)">
                        <i class="${isBookmarked ? 'fa-solid' : 'fa-regular'} fa-bookmark text-xl transition-transform active:scale-125"></i>
                    </div>
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-500 flex items-center justify-center w-full py-3 transition group rounded-full" onclick="app.shareApp()">
                        <i class="fa-solid fa-arrow-up-from-bracket text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50/50 dark:bg-darkSec min-h-screen pb-10">
        `;

        for(let i=0; i<3; i++) {
            const bot = this.bots[Math.floor(Math.random() * this.bots.length)];
            html += `
                <div class="flex gap-3 px-4 py-3 border-b border-gray-100 dark:border-darkBorder bg-white dark:bg-dark hover:bg-gray-50 dark:hover:bg-darkSec cursor-pointer">
                    <div class="shrink-0 w-10 h-10 rounded-full overflow-hidden bg-gray-200">
                        <img src="${bot.avatar}" class="w-full h-full object-cover">
                    </div>
                    <div class="w-full">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-1 text-[15px]">
                                <span class="font-bold hover:underline truncate max-w-[150px] dark:text-white">${bot.name}</span>
                                ${bot.isVerified ? VERIFIED_ICON : ''}
                                <span class="text-gray-500 truncate">@${bot.handle}</span>
                                <span class="text-gray-500">Â·</span>
                                <span class="text-gray-500 hover:underline">1m</span>
                            </div>
                        </div>
                        <div class="text-[15px] text-gray-900 dark:text-white mt-0.5 whitespace-pre-wrap">This is a realistic automated reply. #botlife</div>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    buildPostHTML(post) {
        const isLiked = this.user.likedPosts && this.user.likedPosts.includes(post.id);
        const isReposted = this.user.repostedPosts && this.user.repostedPosts.includes(post.id);

        // Dynamic User Info in Feed
        let avatar = post.authorAvatar;
        let name = post.authorName;
        let isVerified = post.isVerified;

        if (post.authorHandle === this.user.handle) {
            avatar = this.user.avatar;
            name = this.user.name;
            isVerified = this.user.isVerified;
        } else {
             const bot = this.bots.find(b => b.handle === post.authorHandle);
             if (bot) {
                 avatar = bot.avatar;
                 name = bot.name;
                 isVerified = bot.isVerified;
             }
        }

        return `
            <div class="flex gap-3 px-4 py-3 border-b border-gray-100 dark:border-darkBorder hover:bg-gray-50 dark:hover:bg-darkSec/50 cursor-pointer transition duration-200" onclick="app.navigate('post', '${post.id}')">
                <div class="shrink-0 w-10 h-10 rounded-full overflow-hidden bg-gray-200" onclick="event.stopPropagation(); app.navigate('profile', '${post.authorHandle}')">
                    <img src="${avatar}" class="w-full h-full object-cover">
                </div>
                <div class="w-full">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-1 text-[15px]">
                            <span class="font-bold hover:underline truncate max-w-[150px] dark:text-white" onclick="event.stopPropagation(); app.navigate('profile', '${post.authorHandle}')">${name}</span>
                            ${isVerified ? VERIFIED_ICON : ''}
                            <span class="text-gray-500 truncate" onclick="event.stopPropagation(); app.navigate('profile', '${post.authorHandle}')">@${post.authorHandle}</span>
                            <span class="text-gray-500">Â·</span>
                            <span class="text-gray-500 hover:underline">${this.timeAgo(post.createdAt)}</span>
                        </div>
                        <div class="text-gray-400 hover:bg-rose-50 hover:text-rose-500 p-2 rounded-full -m-2 transition">
                            <i class="fa-solid fa-ellipsis"></i>
                        </div>
                    </div>
                    
                    <div class="text-[15px] text-gray-900 dark:text-gray-100 mt-0.5 whitespace-pre-wrap leading-normal">${post.content}</div>

                    ${post.image ? `
                        <div class="mt-3 rounded-2xl overflow-hidden border border-gray-200 dark:border-darkBorder max-h-[350px]">
                            <img src="${post.image}" class="w-full h-full object-cover">
                        </div>
                    ` : ''}

                    <div class="flex justify-between mt-3 text-gray-500 max-w-[425px]" id="stats-${post.id}">
                        <div class="flex items-center gap-2 group hover:text-blue-500 transition" onclick="event.stopPropagation(); app.openReplyModal('${post.id}')">
                            <div class="group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 p-2 rounded-full -m-2 transition"><i class="fa-regular fa-comment"></i></div>
                            <span class="text-xs">${post.stats.replies}</span>
                        </div>
                        <div class="flex items-center gap-2 group hover:text-green-500 transition ${isReposted ? 'reposted' : ''}" onclick="event.stopPropagation(); app.toggleRepost('${post.id}', this)">
                            <div class="group-hover:bg-green-50 dark:group-hover:bg-green-900/20 p-2 rounded-full -m-2 transition"><i class="fa-solid fa-retweet transition-transform active:rotate-180"></i></div>
                            <span class="text-xs stat-reposts">${this.formatNumber(post.stats.reposts)}</span>
                        </div>
                        <div class="flex items-center gap-2 group hover:text-rose-600 transition ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); app.toggleLike('${post.id}', this)">
                            <div class="group-hover:bg-rose-50 dark:group-hover:bg-rose-900/20 p-2 rounded-full -m-2 transition"><i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart transition-transform active:scale-125"></i></div>
                            <span class="text-xs stat-likes">${this.formatNumber(post.stats.likes)}</span>
                        </div>
                        <div class="flex items-center gap-2 group hover:text-blue-500 transition">
                             <div class="group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 p-2 rounded-full -m-2 transition">${ANALYTICS_ICON}</div>
                            <span class="text-xs stat-views">${this.formatNumber(post.stats.views)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    getPostsByHandle(handle) {
        let userPosts;
        
        if (this.profileFilter === 'likes') {
            // If viewing current user's profile and filter is likes
            if (handle === this.user.handle) {
                userPosts = this.posts.filter(p => this.user.likedPosts.includes(p.id));
            } else {
                return '<div class="p-8 text-center text-gray-500 dark:text-gray-400">Likes are private</div>';
            }
        } else {
            userPosts = this.posts.filter(p => p.authorHandle === handle);
            if (this.profileFilter === 'media') {
                userPosts = userPosts.filter(p => p.image);
            }
        }

        userPosts.sort((a,b) => b.createdAt - a.createdAt);
        
        if (userPosts.length === 0) return '<div class="p-8 text-center text-gray-500 dark:text-gray-400">No posts yet</div>';
        
        let html = '';
        userPosts.forEach(post => html += this.buildPostHTML(post));
        return html;
    }

    renderSidebarUser() {
        const el = document.getElementById('sidebar-user');
        if (el) {
            el.innerHTML = `
                <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-200"><img src="${this.user.avatar}" class="w-full h-full object-cover"></div>
                <div class="hidden xl:block">
                    <p class="font-bold text-sm truncate w-[140px] flex items-center dark:text-white">${this.user.name} ${this.user.isVerified ? VERIFIED_ICON : ''}</p>
                    <p class="text-gray-500 text-sm truncate w-[140px]">@${this.user.handle}</p>
                </div>
                <i class="hidden xl:block fa-solid fa-ellipsis ml-auto text-gray-900 dark:text-white"></i>
            `;
        }
    }

    renderWhoToFollow() {
        const container = document.getElementById('who-to-follow');
        if (container) {
            let html = '';
            // Only show 3 random bots
            this.bots.slice(0, 3).forEach(bot => {
                html += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="${bot.avatar}" class="w-10 h-10 rounded-full bg-gray-200">
                            <div>
                                <p class="font-bold text-sm hover:underline cursor-pointer flex items-center dark:text-white" onclick="app.navigate('profile', '${bot.handle}')">${bot.name} ${bot.isVerified ? VERIFIED_ICON : ''}</p>
                                <p class="text-gray-500 text-sm">@${bot.handle}</p>
                            </div>
                        </div>
                        <button class="bg-black dark:bg-white dark:text-black text-white text-sm font-bold px-4 py-1.5 rounded-full hover:bg-gray-800 transition transform active:scale-95" onclick="app.toggleFollow('${bot.handle}', this)">Follow</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
    }

    // --- ACTIONS ---

    openComposeModal() {
        document.getElementById('compose-modal').classList.remove('hidden');
        document.getElementById('compose-avatar').src = this.user.avatar;
        
        // Hide reply indicator if fresh post
        if(!this.replyingTo) document.getElementById('replying-to-indicator').classList.add('hidden');
        
        // Populate identity selector if user has bots
        const selector = document.getElementById('author-selector');
        const select = document.getElementById('post-as-select');
        
        if (this.user.createdBots && this.user.createdBots.length > 0) {
            selector.classList.remove('hidden');
            select.innerHTML = `<option value="${this.user.handle}">@${this.user.handle}</option>`;
            this.user.createdBots.forEach(botHandle => {
                const b = this.bots.find(x => x.handle === botHandle);
                if(b) select.innerHTML += `<option value="${b.handle}">@${b.handle}</option>`;
            });
            // Change avatar on selection
            select.onchange = (e) => {
                 const h = e.target.value;
                 if(h === this.user.handle) document.getElementById('compose-avatar').src = this.user.avatar;
                 else {
                     const b = this.bots.find(x => x.handle === h);
                     if(b) document.getElementById('compose-avatar').src = b.avatar;
                 }
            };
        } else {
            selector.classList.add('hidden');
        }
    }
    
    openReplyModal(postId) {
        this.replyingTo = postId;
        this.openComposeModal();
        const post = this.posts.find(p => p.id === postId);
        const indicator = document.getElementById('replying-to-indicator');
        indicator.classList.remove('hidden');
        indicator.innerHTML = `Replying to <span class="text-rose-500">@${post ? post.authorHandle : 'unknown'}</span>`;
    }

    closeComposeModal() {
        document.getElementById('compose-modal').classList.add('hidden');
        document.getElementById('compose-input').value = '';
        this.replyingTo = null;
    }

    publishPost() {
        const content = document.getElementById('compose-input').value;
        const author = document.getElementById('post-as-select').value;
        if (!content.trim()) return;
        
        this.createPost(content, author);
        this.closeComposeModal();
        this.showToast('Post sent');
        window.scrollTo(0,0);
    }

    openEditProfile(handleToEdit = null) {
        // Determine who we are editing
        this.editingHandle = handleToEdit || this.user.handle;
        const profile = this.getProfile(this.editingHandle);

        document.getElementById('edit-profile-modal').classList.remove('hidden');
        document.getElementById('edit-modal-title').innerText = `Edit ${profile.name}`;
        
        // Populate fields
        document.getElementById('edit-name').value = profile.name;
        document.getElementById('edit-bio').value = profile.bio;
        document.getElementById('edit-location').value = profile.location || '';
        document.getElementById('edit-followers').value = profile.followers;
        document.getElementById('edit-banner-preview').src = profile.banner || '';
        document.getElementById('edit-avatar-preview').src = profile.avatar || '';
        
        // Only show settings for Main User
        if (this.editingHandle === this.user.handle) {
            document.getElementById('edit-virality').value = this.settings.viralitySpeed;
            document.getElementById('secret-pin').parentElement.classList.remove('hidden');
            document.getElementById('theme-btn').parentElement.classList.remove('hidden');
        } else {
            // Hide global settings if editing a bot
            document.getElementById('secret-pin').parentElement.classList.add('hidden');
            document.getElementById('theme-btn').parentElement.classList.add('hidden');
        }

        // Show God Mode panel if user is premium
        if (this.user.isPremium && this.editingHandle === this.user.handle) {
            document.getElementById('god-mode-panel').classList.remove('hidden');
        } else {
            document.getElementById('god-mode-panel').classList.add('hidden');
        }

        // Verify Button Logic
        const btnVerify = document.getElementById('btn-verify');
        if (profile.isVerified) {
            btnVerify.innerText = "Verified";
            btnVerify.disabled = true;
            btnVerify.className = "bg-rose-500 text-white px-3 py-1.5 rounded-full text-sm font-bold";
        } else if (profile.followers >= 100000 || this.user.isPremium) {
            btnVerify.disabled = false;
            btnVerify.innerText = this.user.isPremium ? "Force Verify" : "Request";
            btnVerify.className = "bg-black dark:bg-white dark:text-black text-white px-3 py-1.5 rounded-full text-sm font-bold hover:bg-gray-800 transition";
        } else {
            btnVerify.disabled = true;
            btnVerify.className = "bg-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-sm font-bold cursor-not-allowed";
        }
    }

    closeEditProfile() {
        document.getElementById('edit-profile-modal').classList.add('hidden');
        this.editingHandle = null;
    }

    checkPin() {
        const val = document.getElementById('secret-pin').value;
        if (val === '568300') {
            this.user.isPremium = true;
            this.saveUser();
            document.getElementById('god-mode-panel').classList.remove('hidden');
            this.showToast("âš¡ God Mode Unlocked");
            
            // Unlock verify button immediately
            const btnVerify = document.getElementById('btn-verify');
            btnVerify.disabled = false;
            btnVerify.innerText = "Force Verify";
            btnVerify.className = "bg-black text-white px-3 py-1.5 rounded-full text-sm font-bold hover:bg-gray-800 transition";
        }
    }

    openCreateBotModal() {
        document.getElementById('edit-profile-modal').classList.add('hidden');
        document.getElementById('create-bot-modal').classList.remove('hidden');
    }

    createBot() {
        const name = document.getElementById('bot-name').value;
        const handle = document.getElementById('bot-handle').value;
        const avatar = document.getElementById('bot-avatar').value || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + handle;

        if(!name || !handle) return alert("Name and Handle required");

        const newBot = {
            name, handle, avatar, bio: 'A bot created by ' + this.user.name,
            followers: 0, following: 0, isVerified: false,
            banner: 'https://picsum.photos/seed/'+handle+'/800/300'
        };
        
        this.bots.push(newBot);
        this.user.createdBots.push(handle);
        
        this.saveBots();
        this.saveUser();
        
        document.getElementById('create-bot-modal').classList.add('hidden');
        this.showToast('Bot Created! You can now post as @' + handle);
        this.navigate('profile', handle);
    }

    handleImageUpload(event, type) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 500;
                let width = img.width, height = img.height;

                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }

                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById(`edit-${type}-preview`).src = dataUrl;
            };
        };
        reader.readAsDataURL(file);
    }

    saveProfile() {
        // Are we editing main user or a bot?
        const profile = this.editingHandle === this.user.handle ? this.user : this.bots.find(b => b.handle === this.editingHandle);

        profile.name = document.getElementById('edit-name').value;
        profile.bio = document.getElementById('edit-bio').value;
        profile.location = document.getElementById('edit-location').value;
        profile.followers = parseInt(document.getElementById('edit-followers').value);
        
        // Save images from preview src (if they were changed via file input)
        profile.banner = document.getElementById('edit-banner-preview').src;
        profile.avatar = document.getElementById('edit-avatar-preview').src;

        if (this.editingHandle === this.user.handle) {
            this.settings.viralitySpeed = parseFloat(document.getElementById('edit-virality').value);
            this.saveUser();
            this.saveSettings();
        } else {
            this.saveBots();
        }
        
        this.closeEditProfile();
        this.renderProfile(this.editingHandle);
        this.showToast('Profile saved');
    }

    requestVerification(force = false) {
        const profile = this.editingHandle === this.user.handle ? this.user : this.bots.find(b => b.handle === this.editingHandle);
        
        if (force || profile.followers >= 100000) {
            profile.isVerified = true;
            if(this.editingHandle === this.user.handle) this.saveUser(); else this.saveBots();
            
            const btn = document.getElementById('btn-verify');
            btn.innerText = "Verified!";
            btn.className = "bg-rose-500 text-white px-3 py-1.5 rounded-full text-sm font-bold";
            this.showToast('Badge Acquired!');
        }
    }
    
    openSettings() { this.openEditProfile(); }

    toggleLike(postId, btn) {
        const post = this.posts.find(p => p.id === postId);
        if (!post) return;
        if (!this.user.likedPosts) this.user.likedPosts = [];

        const index = this.user.likedPosts.indexOf(postId);
        const icon = btn.querySelector('i');
        const count = btn.querySelector('.stat-likes');

        if (index === -1) {
            this.user.likedPosts.push(postId);
            post.stats.likes++;
            btn.classList.add('liked');
            icon.classList.remove('fa-regular'); icon.classList.add('fa-solid', 'animate-pop');
        } else {
            this.user.likedPosts.splice(index, 1);
            post.stats.likes--;
            btn.classList.remove('liked');
            icon.classList.add('fa-regular'); icon.classList.remove('fa-solid', 'animate-pop');
        }

        if(count) count.innerText = this.formatNumber(post.stats.likes);
        this.saveUser(); this.savePosts();
    }

    toggleRepost(postId, btn) {
        const post = this.posts.find(p => p.id === postId);
        if (!post) return;
        if (!this.user.repostedPosts) this.user.repostedPosts = [];

        const index = this.user.repostedPosts.indexOf(postId);
        const count = btn.querySelector('.stat-reposts');

        if (index === -1) {
            this.user.repostedPosts.push(postId);
            post.stats.reposts++;
            btn.classList.add('reposted');
        } else {
            this.user.repostedPosts.splice(index, 1);
            post.stats.reposts--;
            btn.classList.remove('reposted');
        }
        if(count) count.innerText = this.formatNumber(post.stats.reposts);
        this.saveUser(); this.savePosts();
    }
    
    toggleBookmark(postId, btn) {
        if (!this.user.bookmarks) this.user.bookmarks = [];
        const index = this.user.bookmarks.indexOf(postId);
        const icon = btn.querySelector('i');
        
        if(index === -1) {
            this.user.bookmarks.push(postId);
            btn.classList.add('bookmarked');
            icon.classList.remove('fa-regular'); icon.classList.add('fa-solid', 'animate-pop');
            this.showToast('Post bookmarked');
        } else {
            this.user.bookmarks.splice(index, 1);
            btn.classList.remove('bookmarked');
            icon.classList.add('fa-regular'); icon.classList.remove('fa-solid', 'animate-pop');
            this.showToast('Removed from bookmarks');
        }
        this.saveUser();
    }
    
    shareApp() {
        const text = "Check out Peyza! The best Twitter-themed simulation app. #Peyza";
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Link copied to clipboard!');
        }).catch(() => {
            this.showToast('Failed to copy link');
        });
    }

    toggleFollow(handle, btn) {
        if (btn.innerText === 'Follow') {
            btn.innerText = 'Following';
            btn.classList.remove('bg-black', 'text-white');
            btn.classList.add('bg-white', 'text-black', 'border', 'border-gray-300');
            this.user.following++;
        } else {
            btn.innerText = 'Follow';
            btn.classList.add('bg-black', 'text-white');
            btn.classList.remove('bg-white', 'text-black', 'border', 'border-gray-300');
            this.user.following--;
        }
        this.saveUser();
    }

    showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.remove('opacity-0');
        setTimeout(() => t.classList.add('opacity-0'), 2000);
    }

    // --- UTILS ---

    formatNumber(num) {
        if (num === undefined || num === null) return '0';
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
        return num.toString();
    }

    timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m";
        return Math.floor(seconds) + "s";
    }
}

// Initialize
const app = new PeyzaApp();

</script>
</body>
</html>
