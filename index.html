<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peyza v1.3 | Worlds & Economy Update</title>
    <meta name="description" content="Peyza is a user-generated gaming platform. Play, create, and imagine.">
    <meta name="theme-color" content="#5865F2">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js for 3D Games -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'] },
                    colors: {
                        peyza: { blue: '#00A2FF', dark: '#1E1E24', card: '#2B2B36', hover: '#3A3A45', accent: '#00D86C', legendary: '#FFA500', epic: '#A335EE', rare: '#0070DD' }
                    },
                    animation: {
                        'bounce-slight': 'bounceSlight 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        bounceSlight: { '0%, 100%': { transform: 'translateY(-2%)' }, '50%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pop: { '0%': { transform: 'scale(0.8)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1E1E24; }
        ::-webkit-scrollbar-thumb { background: #3A3A45; border-radius: 4px; }
        .glass { background: rgba(43, 43, 54, 0.9); backdrop-filter: blur(10px); }
        canvas { image-rendering: pixelated; } /* Retro feel for 2D */
        .rarity-legendary { border-color: #FFA500; box-shadow: 0 0 10px rgba(255, 165, 0, 0.3); }
        .rarity-epic { border-color: #A335EE; }
        .rarity-common { border-color: #4B5563; }
        * { -webkit-tap-highlight-color: transparent; }
        
        /* Stamina Bar */
        .stamina-container { width: 200px; height: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; overflow: hidden; }
        .stamina-fill { height: 100%; background: #00D86C; width: 100%; transition: width 0.1s; }
    </style>
</head>
<body class="bg-peyza-dark text-white overflow-hidden h-screen w-screen select-none">

    <!-- TOASTS -->
    <div id="toast-container" class="fixed top-4 right-4 z-[999] flex flex-col gap-2 pointer-events-none"></div>

    <!-- DAILY REWARD MODAL -->
    <div id="daily-reward-modal" class="fixed inset-0 z-[80] bg-black/90 hidden flex items-center justify-center backdrop-blur">
        <div class="bg-gradient-to-b from-peyza-card to-gray-900 p-1 w-full max-w-sm rounded-3xl animate-pop">
            <div class="bg-peyza-dark rounded-[20px] p-6 text-center border border-gray-700 relative overflow-hidden">
                <div class="absolute inset-0 bg-yellow-500/10 animate-pulse"></div>
                <h2 class="text-3xl font-black text-yellow-400 mb-2 relative z-10">DAILY LOGIN</h2>
                <div class="text-6xl mb-4 animate-bounce-slight relative z-10">üéÅ</div>
                <p class="text-gray-300 mb-6 relative z-10">Streak: <span id="streak-count" class="text-peyza-blue font-bold">1</span> Days</p>
                <button onclick="app.claimDailyReward()" class="w-full bg-peyza-accent hover:bg-green-500 text-black font-bold py-3 rounded-xl shadow-lg transform transition active:scale-95 relative z-10">
                    Claim +100 PB
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) app.toggleSettings()">
        <div class="bg-peyza-card w-full max-w-md rounded-2xl border border-gray-700 shadow-2xl overflow-hidden animate-slide-up">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-xl">Settings</h3>
                <button onclick="app.toggleSettings()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <span>Performance Mode</span>
                    <button id="toggle-perf" onclick="app.toggleSetting('performance')" class="w-12 h-6 bg-gray-600 rounded-full relative transition-colors"><div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"></div></button>
                </div>
                <div class="flex justify-between items-center">
                    <span>Music</span>
                    <button id="toggle-music" onclick="app.toggleSetting('music')" class="w-12 h-6 bg-peyza-accent rounded-full relative transition-colors"><div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform translate-x-6"></div></button>
                </div>
                <div class="pt-4 border-t border-gray-700">
                    <p class="text-xs text-gray-500 mb-2">Account ID: <span id="settings-uid" class="font-mono text-gray-400">Loading...</span></p>
                    <button class="text-red-400 text-sm hover:underline" onclick="app.logout()">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LANDING PAGE -->
    <section id="landing-view" class="absolute inset-0 z-40 bg-peyza-dark flex flex-col items-center justify-center p-4">
        <div class="absolute inset-0 overflow-hidden opacity-20">
            <div class="absolute top-10 left-10 w-20 h-20 bg-peyza-blue rounded-lg animate-bounce-slight" style="animation-delay: 0s;"></div>
            <div class="absolute bottom-20 right-10 w-32 h-32 bg-peyza-accent rounded-xl animate-bounce-slight" style="animation-delay: 1s;"></div>
        </div>
        <div class="z-10 text-center max-w-md w-full animate-slide-up">
            <h1 class="text-6xl font-black mb-2 tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-peyza-blue to-purple-400 drop-shadow-lg">PEYZA</h1>
            <p class="text-gray-400 text-lg mb-8">v1.3 - 3D Worlds Update</p>
            <div class="bg-peyza-card p-8 rounded-3xl shadow-2xl border border-gray-700">
                <div id="login-form">
                    <input type="text" id="username-input" class="w-full bg-peyza-dark border border-gray-600 rounded-xl py-3 px-4 mb-4 focus:outline-none focus:border-peyza-blue transition-colors text-white" placeholder="Username">
                    <button onclick="app.login()" class="w-full bg-peyza-blue hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg flex justify-center items-center gap-2">Play Now <i class="fa-solid fa-gamepad"></i></button>
                    <button onclick="app.guestLogin()" class="mt-3 w-full text-gray-400 hover:text-white text-sm">Guest Login</button>
                </div>
                <div id="login-loader" class="hidden flex-col items-center py-4">
                    <div class="loader-spinner mb-3"></div>
                    <p class="text-sm text-gray-400">Loading Worlds...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- APP SHELL -->
    <div id="app-shell" class="hidden h-full flex flex-col md:flex-row relative">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="hidden md:flex flex-col w-64 bg-peyza-card border-r border-gray-800 z-30 h-full p-4">
            <div class="flex items-center gap-3 mb-8 px-2 cursor-pointer" onclick="app.navigate('home')">
                <div class="w-8 h-8 bg-gradient-to-br from-peyza-blue to-purple-500 rounded-lg flex items-center justify-center font-bold text-lg">P</div>
                <span class="text-2xl font-bold tracking-tight">Peyza</span>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="app.navigate('home')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-peyza-hover text-gray-300 hover:text-white transition flex items-center gap-3" data-page="home"><i class="fa-solid fa-house w-6 text-center"></i> Home</button>
                <button onclick="app.navigate('games')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-peyza-hover text-gray-300 hover:text-white transition flex items-center gap-3" data-page="games"><i class="fa-solid fa-gamepad w-6 text-center"></i> Games</button>
                <button onclick="app.navigate('avatar')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-peyza-hover text-gray-300 hover:text-white transition flex items-center gap-3" data-page="avatar"><i class="fa-solid fa-shirt w-6 text-center"></i> Shop</button>
                <button onclick="app.navigate('leaderboard')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-peyza-hover text-gray-300 hover:text-white transition flex items-center gap-3" data-page="leaderboard"><i class="fa-solid fa-trophy w-6 text-center"></i> Leaderboard</button>
                <button onclick="app.toggleSettings()" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-peyza-hover text-gray-300 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-gear w-6 text-center"></i> Settings</button>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-700">
                <div class="flex items-center gap-3 px-2">
                    <div class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden border-2 border-peyza-blue relative">
                         <canvas id="mini-avatar-canvas" width="40" height="40"></canvas>
                    </div>
                    <div class="overflow-hidden">
                        <p id="sidebar-username" class="font-bold truncate text-sm">Player</p>
                        <div class="flex items-center gap-1 text-xs text-peyza-blue">
                            <i class="fa-solid fa-star"></i> Lvl <span id="sidebar-level">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CONTENT -->
        <div class="flex-1 flex flex-col h-full relative overflow-hidden bg-peyza-dark">
            <!-- HEADER -->
            <header class="h-16 border-b border-gray-800 bg-peyza-dark/95 backdrop-blur z-20 flex items-center justify-between px-4 md:px-8">
                <button class="md:hidden text-gray-300" onclick="app.showToast('Use bottom nav', 'info')"><i class="fa-solid fa-bars text-xl"></i></button>
                <div class="hidden md:flex relative w-96 mx-4">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                    <input type="text" placeholder="Search games, items..." id="global-search" oninput="app.handleSearch(this.value)" class="w-full bg-peyza-card border border-gray-700 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-peyza-blue transition">
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-gray-800 rounded-full px-4 py-1.5 flex items-center gap-2 border border-gray-700 cursor-pointer hover:bg-gray-700 transition" onclick="app.addPeyBucks(100)">
                        <div class="w-5 h-5 rounded-full bg-yellow-400 flex items-center justify-center text-yellow-800 text-xs font-bold">P</div>
                        <span id="header-balance" class="font-bold text-sm">0</span>
                    </div>
                </div>
            </header>

            <!-- VIEWS -->
            <main id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                
                <!-- HOME VIEW -->
                <div id="page-home" class="page-view animate-fade-in space-y-8">
                    <div class="flex justify-between items-center mb-[-1rem]">
                        <h2 class="text-2xl font-bold">Featured Worlds</h2>
                        <span class="text-xs bg-peyza-blue px-2 py-1 rounded text-white font-bold">v1.3 LIVE</span>
                    </div>
                    
                    <!-- Pickle Farm 3D Hero -->
                    <div class="w-full h-64 md:h-80 rounded-3xl overflow-hidden relative group cursor-pointer border border-gray-700" onclick="app.launchGame('pickle_3d')">
                        <div class="absolute inset-0 bg-gradient-to-r from-green-900/90 to-transparent z-10 p-8 flex flex-col justify-end items-start">
                            <span class="bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded mb-2">3D EXPERIENCE</span>
                            <h2 class="text-4xl font-black mb-2 text-white">Pickle Farm 3D</h2>
                            <p class="text-gray-200 max-w-lg mb-4">Explore a fully 3D open world. Farm pickles, drive tractors (soon), and build your empire.</p>
                            <button class="bg-white text-black font-bold py-2 px-6 rounded-full hover:scale-105 transition flex items-center gap-2"><i class="fa-solid fa-play"></i> Play Now</button>
                        </div>
                        <div class="absolute inset-0 bg-[url('https://picsum.photos/seed/farm_bg/1200/600')] bg-cover bg-center transition duration-700 group-hover:scale-110 opacity-60"></div>
                    </div>

                    <!-- Games Grid -->
                    <div>
                        <h3 class="text-xl font-bold mb-4">Trending</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="home-games-grid"></div>
                    </div>
                </div>

                <!-- GAMES VIEW -->
                <div id="page-games" class="page-view hidden animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6">Discover Worlds</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="all-games-grid"></div>
                </div>

                <!-- LEADERBOARD VIEW -->
                <div id="page-leaderboard" class="page-view hidden animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6 flex items-center gap-2"><i class="fa-solid fa-trophy text-yellow-400"></i> Global Leaderboard</h2>
                    <div class="bg-peyza-card rounded-2xl border border-gray-700 overflow-hidden">
                        <div class="grid grid-cols-4 p-4 bg-gray-800 font-bold text-gray-400 border-b border-gray-700">
                            <div>Rank</div>
                            <div>Player</div>
                            <div>Level</div>
                            <div class="text-right">Net Worth</div>
                        </div>
                        <div id="leaderboard-list" class="divide-y divide-gray-700">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AVATAR/SHOP VIEW -->
                <div id="page-avatar" class="page-view hidden animate-fade-in h-full flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/2 bg-gradient-to-b from-gray-800 to-peyza-card rounded-3xl flex items-center justify-center relative overflow-hidden shadow-inner border border-gray-700 min-h-[300px]">
                        <canvas id="avatar-editor-canvas" width="400" height="400" class="relative z-10"></canvas>
                    </div>

                    <div class="w-full md:w-1/2 flex flex-col h-[500px]">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold">Catalog</h2>
                            <button onclick="app.toggleBundles()" class="text-xs bg-purple-600 px-2 py-1 rounded">View Bundles</button>
                        </div>
                        <div class="flex gap-2 overflow-x-auto pb-2 mb-2 border-b border-gray-700" id="avatar-tabs">
                            <button onclick="app.filterAvatar('all')" class="avatar-tab active px-3 py-1 text-sm font-bold rounded-full transition bg-white text-black" data-tab="all">All</button>
                            <button onclick="app.filterAvatar('clothing')" class="avatar-tab px-3 py-1 text-sm font-bold rounded-full transition text-gray-400 hover:text-white" data-tab="clothing">Clothes</button>
                            <button onclick="app.filterAvatar('accessories')" class="avatar-tab px-3 py-1 text-sm font-bold rounded-full transition text-gray-400 hover:text-white" data-tab="accessories">Hats</button>
                            <button onclick="app.filterAvatar('backbling')" class="avatar-tab px-3 py-1 text-sm font-bold rounded-full transition text-gray-400 hover:text-white" data-tab="backbling">Back</button>
                            <button onclick="app.filterAvatar('skin')" class="avatar-tab px-3 py-1 text-sm font-bold rounded-full transition text-gray-400 hover:text-white" data-tab="skin">Skin</button>
                        </div>

                        <div class="grid grid-cols-4 gap-3 overflow-y-auto p-2 bg-gray-900/50 rounded-xl flex-1" id="avatar-grid"></div>

                        <div class="mt-4 p-3 bg-gray-800 rounded-xl flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-400">Inventory</p>
                                <p class="font-bold text-lg" id="inventory-count">0</p>
                            </div>
                            <button class="bg-peyza-blue px-4 py-2 rounded-lg font-bold text-sm" onclick="app.saveAvatar()">Save Layout</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- MOBILE NAV -->
        <div class="md:hidden fixed bottom-0 w-full bg-peyza-card border-t border-gray-800 flex justify-around p-3 z-50">
            <button onclick="app.navigate('home')" class="text-gray-400 hover:text-white flex flex-col items-center gap-1 active-nav-mobile"><i class="fa-solid fa-house text-xl"></i></button>
            <button onclick="app.navigate('games')" class="text-gray-400 hover:text-white flex flex-col items-center gap-1"><i class="fa-solid fa-gamepad text-xl"></i></button>
            <button onclick="app.navigate('avatar')" class="text-gray-400 hover:text-white flex flex-col items-center gap-1"><i class="fa-solid fa-shirt text-xl"></i></button>
        </div>
    </div>

    <!-- GAME OVERLAY -->
    <div id="game-overlay" class="fixed inset-0 z-[100] bg-black hidden flex-col">
        <!-- Overlay Header -->
        <div id="game-ui-header" class="absolute top-0 w-full z-20 bg-gradient-to-b from-black/80 to-transparent px-4 py-2 flex items-center justify-between pointer-events-none">
            <div class="pointer-events-auto flex gap-2 items-center">
                 <button onclick="app.exitGame()" class="bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white px-3 py-1 rounded text-xs font-bold transition">EXIT</button>
                 <button onclick="app.toggleFullscreen()" class="text-white/50 hover:text-white"><i class="fa-solid fa-expand"></i></button>
            </div>
            <div class="flex flex-col items-end text-white pointer-events-none">
                <div class="flex items-center gap-2">
                    <span class="text-yellow-400 font-bold"><i class="fa-solid fa-coins"></i> <span id="ingame-money">0</span></span>
                </div>
                <!-- Stamina -->
                <div class="stamina-container mt-1">
                    <div id="stamina-bar" class="stamina-fill"></div>
                </div>
            </div>
        </div>

        <!-- 3D & 2D Canvas Container -->
        <div class="flex-1 relative bg-gray-900 flex items-center justify-center overflow-hidden">
            <canvas id="game-canvas" class="outline-none focus:outline-none"></canvas>
            
            <!-- In-Game Chat Overlay -->
            <div id="chat-overlay" class="absolute bottom-20 left-4 w-64 max-h-48 flex flex-col gap-1 pointer-events-none z-10">
                <div id="chat-messages" class="flex-col gap-1 overflow-y-auto max-h-40 bg-black/40 p-2 rounded-lg text-xs text-white shadow-lg pointer-events-auto hidden"></div>
                <input type="text" id="chat-input" placeholder="Press Enter to chat..." class="bg-black/60 border border-gray-600 rounded px-2 py-1 text-xs text-white pointer-events-auto focus:outline-none focus:border-peyza-blue" onkeydown="if(event.key === 'Enter') app.sendChat(this)">
            </div>

            <!-- Interaction Prompt -->
            <div id="interaction-prompt" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white text-black px-4 py-2 rounded-full font-bold shadow-lg animate-bounce hidden z-30">
                Press E to Interact
            </div>
            
            <!-- Mini Map (3D Games only) -->
            <div id="minimap" class="absolute bottom-4 right-4 w-32 h-32 bg-black/50 border-2 border-white/20 rounded-full overflow-hidden hidden z-10">
                <div class="absolute inset-0 flex items-center justify-center text-white/20 text-[10px]">RADAR</div>
                <div class="absolute top-1/2 left-1/2 w-2 h-2 bg-yellow-400 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>
            </div>

            <!-- Mobile Controls -->
            <div id="mobile-controls" class="absolute inset-0 pointer-events-none md:hidden hidden z-20">
                <div class="absolute bottom-8 left-8 w-32 h-32 bg-white/10 rounded-full backdrop-blur pointer-events-auto touch-manipulation relative">
                    <div id="dpad-up" class="absolute top-0 left-1/3 w-1/3 h-1/3 bg-white/20 rounded-t-lg"></div>
                    <div id="dpad-down" class="absolute bottom-0 left-1/3 w-1/3 h-1/3 bg-white/20 rounded-b-lg"></div>
                    <div id="dpad-left" class="absolute top-1/3 left-0 w-1/3 h-1/3 bg-white/20 rounded-l-lg"></div>
                    <div id="dpad-right" class="absolute top-1/3 right-0 w-1/3 h-1/3 bg-white/20 rounded-r-lg"></div>
                </div>
                <div id="action-btn" class="absolute bottom-10 right-8 w-20 h-20 bg-peyza-accent/80 rounded-full shadow-lg flex items-center justify-center pointer-events-auto active:scale-95 transition">
                    <i class="fa-solid fa-hand text-black text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- EXPANDED DATA CATALOG (50+ Items Simulated) ---
        const BASE_CATALOG = [
            { id: 'skin_yellow', type: 'skin', name: 'Classic Yellow', color: '#FFE135', rarity: 'common', price: 0 },
            { id: 'skin_blue', type: 'skin', name: 'Ice Blue', color: '#35A1FF', rarity: 'rare', price: 500 },
            { id: 'skin_red', type: 'skin', name: 'Magma Red', color: '#FF3535', rarity: 'epic', price: 1200 },
            { id: 'cloth_suit', type: 'clothing', name: 'Tuxedo', color: '#1a1a1a', rarity: 'rare', price: 800 },
            { id: 'back_wings', type: 'backbling', name: 'Angel Wings', color: '#fff', shape: 'wings', rarity: 'legendary', price: 5000 },
        ];
        
        // Procedural Generator for "50 New Items"
        const COLORS = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#000000'];
        const ADJ = ['Neon', 'Dark', 'Cyber', 'Retro', 'Golden', 'Mystic'];
        const TYPES = ['clothing', 'skin', 'accessories'];
        
        for(let i=0; i<45; i++) {
            const type = TYPES[i % 3];
            const color = COLORS[i % COLORS.length];
            const adj = ADJ[i % ADJ.length];
            const name = `${adj} ${type === 'clothing' ? 'Shirt' : type === 'skin' ? 'Skin' : 'Hat'}`;
            BASE_CATALOG.push({
                id: `gen_${i}`,
                type: type,
                name: name,
                color: color,
                rarity: i % 5 === 0 ? 'legendary' : (i % 3 === 0 ? 'rare' : 'common'),
                price: (i % 5 === 0 ? 2000 : 100) + (i*10),
                subType: type === 'accessories' ? 'hat' : null
            });
        }
        
        const CATALOG = BASE_CATALOG;

        class PeyzaApp {
            constructor() {
                const savedUser = localStorage.getItem('peyza_user');
                this.user = savedUser ? JSON.parse(savedUser) : null;
                this.state = {
                    peyBucks: parseInt(localStorage.getItem('peyza_balance')) || 50,
                    level: parseInt(localStorage.getItem('peyza_level')) || 1,
                    xp: parseInt(localStorage.getItem('peyza_xp')) || 0,
                    settings: { performance: false, music: true },
                    equipped: JSON.parse(localStorage.getItem('peyza_equipped')) || { skin: '#FFE135' },
                    inventory: JSON.parse(localStorage.getItem('peyza_inventory')) || [],
                    lastLogin: localStorage.getItem('peyza_last_login') || 0,
                    streak: parseInt(localStorage.getItem('peyza_streak')) || 0
                };
                this.gameEngine = null;
                this.init();
            }

            init() {
                this.renderGames();
                // Initialize Avatar Renderers regardless of login state
                this.avatarRenderer = new AvatarRenderer('avatar-editor-canvas', 400);
                this.miniAvatarRenderer = new AvatarRenderer('mini-avatar-canvas', 40);
                this.avatarLoop();
                this.filterAvatar('all');

                // Only perform user-specific actions if a user is logged in
                if (this.user) {
                    this.showApp();
                    this.checkDailyReward();
                    this.loadLeaderboard();
                    // updateStatsUI is now called within showApp()
                }
            }

            // Function to show the main application shell
            showApp() {
                if (!this.user) return; // Safety check
                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('sidebar-username').innerText = this.user.username;
                document.getElementById('settings-uid').innerText = this.user.username; // Use username as pseudo-ID
                this.updateStatsUI(); // Ensure stats load immediately after login/check
                this.navigate('home');
            }

            // --- CORE LOGIC ---
            login() {
                const username = document.getElementById('username-input').value || "Guest";
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('login-loader').classList.remove('hidden');
                document.getElementById('login-loader').classList.add('flex');
                setTimeout(() => {
                    this.user = { username };
                    localStorage.setItem('peyza_user', JSON.stringify(this.user));
                    this.showApp();
                    this.checkDailyReward();
                    this.loadLeaderboard(); // Call explicitly after user is set
                }, 1000);
            }
            guestLogin() {
                document.getElementById('username-input').value = `Guest_${Math.floor(Math.random()*1000)}`;
                this.login();
            }
            logout() { 
                localStorage.removeItem('peyza_user'); 
                location.reload(); 
            }
            
            toggleSetting(key) {
                this.state.settings[key] = !this.state.settings[key];
                const toggleBtn = document.getElementById(`toggle-${key}`);
                if (toggleBtn) {
                    const circle = toggleBtn.querySelector('div');
                    if (this.state.settings[key]) {
                        toggleBtn.classList.remove('bg-gray-600');
                        toggleBtn.classList.add('bg-peyza-accent');
                        circle.classList.add('translate-x-6');
                        circle.classList.remove('translate-x-0');
                    } else {
                        toggleBtn.classList.remove('bg-peyza-accent');
                        toggleBtn.classList.add('bg-gray-600');
                        circle.classList.remove('translate-x-6');
                        circle.classList.add('translate-x-0');
                    }
                }
                this.showToast(`${key} is now ${this.state.settings[key] ? 'ON' : 'OFF'}`, 'info');
            }

            // --- LEADERBOARD & ECONOMY ---
            loadLeaderboard() {
                if (!this.user) return; // Prevent crash if user is null on initial load

                // Generate fake data mixed with user data
                let data = [
                    { name: "NinjaPickle", lvl: 99, bal: 500000 },
                    { name: "PeyzaAdmin", lvl: 100, bal: 999999 },
                    { name: "NoobMaster69", lvl: 5, bal: 20 },
                    { name: "BuilderMan", lvl: 45, bal: 12000 },
                    { name: this.user.username, lvl: this.state.level, bal: this.state.peyBucks }
                ];
                // Sort
                data.sort((a,b) => b.bal - a.bal);
                // Render
                const html = data.map((p, i) => `
                    <div class="grid grid-cols-4 p-4 ${p.name === this.user.username ? 'bg-peyza-blue/20 border-l-4 border-peyza-blue' : ''}">
                        <div class="font-bold">#${i+1}</div>
                        <div class="flex items-center gap-2">
                             <div class="w-6 h-6 rounded-full bg-gray-600"></div> ${p.name}
                        </div>
                        <div>${p.lvl}</div>
                        <div class="text-right text-green-400 font-mono">$${p.bal.toLocaleString()}</div>
                    </div>
                `).join('');
                document.getElementById('leaderboard-list').innerHTML = html;
            }

            // --- SHOP & AVATAR ---
            filterAvatar(cat) {
                // UI Toggles omitted for brevity, functionality remains
                document.querySelectorAll('.avatar-tab').forEach(btn => {
                    btn.classList.remove('bg-white', 'text-black');
                    btn.classList.add('text-gray-400', 'hover:text-white');
                    if (btn.dataset.tab === cat) {
                        btn.classList.add('bg-white', 'text-black', 'active');
                        btn.classList.remove('text-gray-400', 'hover:text-white');
                    }
                });


                const grid = document.getElementById('avatar-grid');
                grid.innerHTML = '';
                const filtered = cat === 'all' ? CATALOG : CATALOG.filter(i => i.type === cat);
                
                filtered.forEach(item => {
                    // Check if owned
                    const owned = this.state.inventory.includes(item.id) || item.price === 0;
                    const isEquipped = this.state.equipped[item.type]?.id === item.id || (item.type === 'skin' && this.state.equipped.skin === item.color);
                    
                    const div = document.createElement('div');
                    div.className = `aspect-square bg-gray-800 rounded-xl border-2 cursor-pointer flex flex-col items-center justify-center relative group hover:scale-105 transition ${isEquipped ? 'border-peyza-accent' : `rarity-${item.rarity}`}`;
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full shadow-lg mb-1" style="background:${item.color}"></div>
                        <span class="text-[10px] text-gray-400 text-center leading-none">${item.name}</span>
                        ${!owned ? `<span class="absolute top-1 right-1 text-xs bg-black/80 px-1 rounded text-green-400">$${item.price}</span>` : ''}
                        ${isEquipped ? '<div class="absolute top-1 left-1 text-peyza-accent text-xs"><i class="fa-solid fa-check-circle"></i></div>' : ''}
                    `;
                    div.onclick = () => {
                        if (owned) this.equipItem(item);
                        else this.buyItem(item);
                    };
                    grid.appendChild(div);
                });
                document.getElementById('inventory-count').innerText = this.state.inventory.length;
            }

            buyItem(item) {
                if(this.state.peyBucks >= item.price) {
                    this.state.peyBucks -= item.price;
                    this.state.inventory.push(item.id);
                    localStorage.setItem('peyza_inventory', JSON.stringify(this.state.inventory));
                    this.addPeyBucks(0); // Sync UI
                    this.showToast(`Bought ${item.name}!`, 'success');
                    this.filterAvatar(document.querySelector('.avatar-tab.active')?.dataset.tab || 'all');
                } else {
                    this.showToast("Not enough PeyBucks!", "error");
                }
            }
            
            equipItem(item) {
                if (item.type === 'skin') this.state.equipped.skin = item.color;
                else this.state.equipped[item.type] = item;
                localStorage.setItem('peyza_equipped', JSON.stringify(this.state.equipped));
                this.filterAvatar(item.type);
            }
            
            saveAvatar() { this.showToast('Avatar saved!', 'info'); }
            toggleBundles() { this.showToast('Bundles feature coming soon!', 'info'); }

            // --- GAMES LAUNCHER (3D & 2D) ---
            renderGames() {
                const list = [
                    { id: 'pickle_3d', title: 'Pickle Farm 3D', players: '24K', img: 'https://picsum.photos/seed/pickle/300/200', tag: '3D' },
                    { id: 'mansion_3d', title: 'Halloween Mansion', players: '12K', img: 'https://picsum.photos/seed/mansion/300/200', tag: '3D' },
                    { id: 'iron_3d', title: 'Iron World', players: '5K', img: 'https://picsum.photos/seed/iron/300/200', tag: '3D' },
                    { id: 'tumble_2d', title: 'Tumble Town (Classic)', players: '2K', img: 'https://picsum.photos/seed/tumble/300/200', tag: '2D' },
                    { id: 'pizza_2d', title: 'Pizza Tycoon', players: '8K', img: 'https://picsum.photos/seed/pizza/300/200', tag: '2D' }
                ];
                const html = list.map(g => `
                    <div class="bg-peyza-card rounded-xl overflow-hidden hover:translate-y-[-5px] transition shadow-lg border border-gray-800 cursor-pointer group" onclick="app.launchGame('${g.id}')">
                        <div class="aspect-video bg-gray-700 relative overflow-hidden">
                            <img src="${g.img}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <div class="absolute bottom-2 left-2 bg-black/60 px-2 rounded text-[10px] font-bold backdrop-blur flex items-center gap-1">
                                <span class="bg-blue-600 px-1 rounded mr-1">${g.tag}</span> ${g.players}
                            </div>
                        </div>
                        <div class="p-3"><h4 class="font-bold text-sm truncate">${g.title}</h4></div>
                    </div>
                `).join('');
                document.getElementById('home-games-grid').innerHTML = html;
                document.getElementById('all-games-grid').innerHTML = html;
            }

            launchGame(id) {
                const overlay = document.getElementById('game-overlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                
                // Cleanup old engine
                if (this.gameEngine && this.gameEngine.dispose) this.gameEngine.dispose();
                
                // Route to Engine
                const canvasId = 'game-canvas';
                document.getElementById('chat-messages').classList.remove('hidden');
                document.getElementById('minimap').classList.remove('hidden');

                if (id === 'pickle_3d') this.gameEngine = new PickleFarmGame(canvasId);
                else if (id === 'mansion_3d') this.gameEngine = new MansionGame(canvasId);
                else if (id === 'iron_3d') this.gameEngine = new IronWorldGame(canvasId);
                else if (id === 'tumble_2d') this.gameEngine = new TumbleTownGame(canvasId);
                else if (id === 'pizza_2d') this.gameEngine = new PizzaTycoonGame(canvasId);
                
                if(this.gameEngine.start) this.gameEngine.start();
            }

            exitGame() {
                if (this.gameEngine && this.gameEngine.stop) this.gameEngine.stop();
                document.getElementById('game-overlay').classList.add('hidden');
                document.getElementById('game-overlay').classList.remove('flex');
                document.exitFullscreen().catch(()=>{});
            }

            // --- UTILS ---
            showToast(msg, type='info') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                const col = type === 'success' ? 'bg-peyza-accent text-black' : (type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white border border-gray-600');
                t.className = `${col} px-4 py-3 rounded-lg shadow-xl animate-slide-up font-bold text-sm flex items-center gap-2`;
                t.innerHTML = msg;
                c.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }
            
            // Stats helpers
            addPeyBucks(amount) {
                // Simple animation effect on counter
                const currentBalance = this.state.peyBucks;
                const newBalance = currentBalance + amount;
                
                if (amount > 0) {
                    this.state.peyBucks = newBalance;
                    document.getElementById('header-balance').classList.add('animate-pop', 'text-peyza-accent');
                    setTimeout(() => {
                         document.getElementById('header-balance').classList.remove('animate-pop', 'text-peyza-accent');
                    }, 300);
                } else {
                     this.state.peyBucks = newBalance;
                }

                localStorage.setItem('peyza_balance', this.state.peyBucks);
                this.updateStatsUI();
            }
            updateStatsUI() {
                if (!this.user) return; // Guard clause

                document.getElementById('header-balance').innerText = this.state.peyBucks.toLocaleString();
                document.getElementById('ingame-money').innerText = this.state.peyBucks.toLocaleString();
                document.getElementById('sidebar-level').innerText = this.state.level;
                this.loadLeaderboard(); // Keep leaderboard synced
            }
            navigate(page) {
                document.querySelectorAll('.page-view').forEach(e => e.classList.add('hidden'));
                document.getElementById('page-'+page).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-peyza-hover'));
                document.querySelector(`.nav-btn[data-page="${page}"]`)?.classList.add('bg-peyza-hover');
            }
            checkDailyReward() {
                const today = new Date().toDateString();
                if (this.state.lastLogin !== today) {
                    document.getElementById('daily-reward-modal').classList.remove('hidden');
                    document.getElementById('streak-count').innerText = this.state.streak + 1;
                }
            }
            claimDailyReward() {
                const today = new Date().toDateString();
                this.addPeyBucks(100);
                this.state.lastLogin = today;
                this.state.streak++;
                localStorage.setItem('peyza_last_login', today);
                localStorage.setItem('peyza_streak', this.state.streak);
                document.getElementById('daily-reward-modal').classList.add('hidden');
                this.showToast('+100 PB claimed!', 'success');
            }
            toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
            toggleFullscreen() {
                 if (!document.fullscreenElement) document.getElementById('game-overlay').requestFullscreen();
                 else document.exitFullscreen();
            }
            sendChat(input) {
                const msg = input.value;
                if(!msg) return;
                const container = document.getElementById('chat-messages');
                const line = document.createElement('div');
                line.innerHTML = `<span class="text-blue-400 font-bold">${this.user.username}:</span> ${msg}`;
                container.appendChild(line);
                input.value = '';
                container.scrollTop = container.scrollHeight;
            }
            avatarLoop() {
                requestAnimationFrame(() => this.avatarLoop());
                this.avatarRenderer.draw(this.state.equipped);
                this.miniAvatarRenderer.draw(this.state.equipped);
            }
        }

        /* --- 3D ENGINE BASE (THREE.JS) --- */
        class ThreeGameBase {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.running = false;
                this.keys = {};
                this.player = new THREE.Group();
                this.stamina = 100;
                
                // Basic Inputs
                window.addEventListener('keydown', e => this.keys[e.key.toLowerCase()] = true);
                window.addEventListener('keyup', e => this.keys[e.key.toLowerCase()] = false);
                window.addEventListener('resize', () => this.resize());
            }
            
            initPlayer() {
                // Simple Voxel Player
                const matBody = new THREE.MeshLambertMaterial({ color: app.state.equipped.skin });
                const matShirt = new THREE.MeshLambertMaterial({ color: app.state.equipped.clothing?.color || app.state.equipped.skin });
                
                const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.5), matShirt);
                body.position.y = 1.5;
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), matBody);
                head.position.y = 2.6;
                
                this.player.add(body);
                this.player.add(head);
                this.scene.add(this.player);
                this.camera.position.set(0, 4, 5);
            }

            resize() {
                if(!this.camera) return;
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            handleMovement(baseSpeed = 0.1) {
                let speed = baseSpeed;
                if(this.keys['shift'] && this.stamina > 0) { 
                    speed *= 2; 
                    this.stamina = Math.max(0, this.stamina - 1); 
                }
                else if(this.stamina < 100) {
                    this.stamina = Math.min(100, this.stamina + 0.5);
                }
                
                // Update UI Stamina
                document.getElementById('stamina-bar').style.width = this.stamina + '%';

                const dir = new THREE.Vector3();
                this.camera.getWorldDirection(dir);
                dir.y = 0; dir.normalize();

                if(this.keys['w'] && this.stamina > 0) this.player.position.add(dir.clone().multiplyScalar(speed));
                if(this.keys['s'] && this.stamina > 0) this.player.position.add(dir.clone().multiplyScalar(-speed));
                if(this.keys['a']) { this.player.rotation.y += 0.05; }
                if(this.keys['d']) { this.player.rotation.y -= 0.05; }

                // Camera follow
                const offset = new THREE.Vector3(0, 4, 6);
                offset.applyAxisAngle(new THREE.Vector3(0,1,0), this.player.rotation.y);
                this.camera.position.copy(this.player.position).add(offset);
                this.camera.lookAt(this.player.position.clone().add(new THREE.Vector3(0, 2, 0)));
            }

            start() { this.running = true; this.loop(); }
            stop() { this.running = false; }
            dispose() { this.renderer.dispose(); }
            loop() { if(this.running) { requestAnimationFrame(()=>this.loop()); this.update(); this.renderer.render(this.scene, this.camera); } }
            update() {} // Override
        }

        /* --- 3D GAME: PICKLE FARM --- */
        class PickleFarmGame extends ThreeGameBase {
            constructor(cid) {
                super(cid);
                this.pickles = [];
                this.carryCount = 0;
                this.setupWorld();
            }

            setupWorld() {
                // Sky
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.Fog(0x87CEEB, 10, 50);

                // Ground
                const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({ color: 0x4CAF50 }));
                ground.rotation.x = -Math.PI/2;
                this.scene.add(ground);

                // Lighting
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(10, 20, 10);
                this.scene.add(light);
                this.scene.add(new THREE.AmbientLight(0x404040));

                // Barn (Sell Zone)
                this.barn = new THREE.Mesh(new THREE.BoxGeometry(5, 5, 5), new THREE.MeshLambertMaterial({ color: 0x8B0000 }));
                this.barn.position.set(0, 2.5, -20);
                this.scene.add(this.barn);

                // Pickles
                const pickleGeo = new THREE.CylinderGeometry(0.2, 0.2, 1, 8);
                const pickleMat = new THREE.MeshLambertMaterial({ color: 0x006400 });
                for(let i=0; i<30; i++) {
                    const p = new THREE.Mesh(pickleGeo, pickleMat);
                    p.position.set((Math.random()-0.5)*80, 0.5, (Math.random()-0.5)*80);
                    p.rotation.z = Math.random();
                    this.scene.add(p);
                    this.pickles.push(p);
                }

                this.initPlayer();
            }

            update() {
                this.handleMovement();
                
                // Collection Logic
                const pPos = this.player.position;
                const prompt = document.getElementById('interaction-prompt');
                prompt.classList.add('hidden');

                // Check Pickles
                for(let i=this.pickles.length-1; i>=0; i--) {
                    if(pPos.distanceTo(this.pickles[i].position) < 2) {
                        this.scene.remove(this.pickles[i]);
                        this.pickles.splice(i, 1);
                        this.carryCount++;
                        app.showToast('Picked up pickle!', 'success');
                    }
                }

                // Check Barn
                if(pPos.distanceTo(this.barn.position) < 6) {
                    prompt.classList.remove('hidden');
                    prompt.innerText = `Press E to Sell (${this.carryCount})`;
                    if(this.keys['e'] && this.carryCount > 0) {
                        const earn = this.carryCount * 5;
                        app.addPeyBucks(earn);
                        this.carryCount = 0;
                        app.showToast(`Sold pickles for $${earn}!`, 'success');
                    }
                }
            }
        }

        /* --- 3D GAME: MANSION --- */
        class MansionGame extends ThreeGameBase {
            constructor(cid) {
                super(cid);
                this.setupWorld();
            }
            setupWorld() {
                this.scene.background = new THREE.Color(0x111111);
                this.scene.fog = new THREE.FogExp2(0x111111, 0.1); // Spooky fog

                // Floor
                const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshPhongMaterial({ color: 0x222222 }));
                floor.rotation.x = -Math.PI/2;
                this.scene.add(floor);

                // Walls (Random Maze)
                const wallGeo = new THREE.BoxGeometry(4, 4, 4);
                const wallMat = new THREE.MeshLambertMaterial({ color: 0x333333 });
                for(let i=0; i<40; i++) {
                    const w = new THREE.Mesh(wallGeo, wallMat);
                    w.position.set((Math.random()-0.5)*50, 2, (Math.random()-0.5)*50);
                    this.scene.add(w);
                }

                // Ghosts (Simple Floating Spheres)
                this.ghosts = [];
                const ghostGeo = new THREE.SphereGeometry(1, 16, 16);
                const ghostMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 });
                for(let i=0; i<5; i++) {
                    const g = new THREE.Mesh(ghostGeo, ghostMat);
                    g.position.set((Math.random()-0.5)*40, 2, (Math.random()-0.5)*40);
                    this.scene.add(g);
                    this.ghosts.push({ mesh: g, dir: new THREE.Vector3(Math.random()-0.5, 0, Math.random()-0.5).normalize() });
                }

                const light = new THREE.PointLight(0xffaa00, 1, 20); // Flashlight feel
                light.position.set(0, 5, 0);
                this.player.add(light);
                
                this.initPlayer();
            }
            update() {
                this.handleMovement(0.08);
                // Move Ghosts
                this.ghosts.forEach(g => {
                    g.mesh.position.add(g.dir.clone().multiplyScalar(0.05));
                    // Bounce bounds
                    if(g.mesh.position.x > 25 || g.mesh.position.x < -25) g.dir.x *= -1;
                    if(g.mesh.position.z > 25 || g.mesh.position.z < -25) g.dir.z *= -1;
                    
                    // Collision
                    if(this.player.position.distanceTo(g.mesh.position) < 2) {
                        this.player.position.set(0, 0, 0); // Respawn
                        app.addPeyBucks(-50); // Lose partial PBucks
                        app.showToast('Caught by a ghost! Lost 50 PB.', 'error');
                    }
                });
            }
        }

        /* --- 3D GAME: IRON WORLD --- */
        class IronWorldGame extends ThreeGameBase {
            constructor(cid) { super(cid); this.setupWorld(); }
            setupWorld() {
                this.scene.background = new THREE.Color(0xFF8C00); // Orange Sky
                this.scene.fog = new THREE.Fog(0xFF8C00, 20, 100);
                
                // Floating Platforms
                const platGeo = new THREE.BoxGeometry(10, 1, 10);
                const platMat = new THREE.MeshLambertMaterial({ color: 0x555555 });
                for(let i=0; i<20; i++) {
                    const p = new THREE.Mesh(platGeo, platMat);
                    p.position.set((Math.random()-0.5)*80, Math.random()*10, (Math.random()-0.5)*80);
                    this.scene.add(p);
                }
                
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
                const sun = new THREE.DirectionalLight(0xffffff, 0.8);
                sun.position.set(50, 50, 50);
                this.scene.add(sun);
                
                this.initPlayer();
                // Override player pos
                this.player.position.y = 5;
            }
            update() {
                this.handleMovement();
                // Simple Gravity (Visual only, no real collision physics in this simplified demo)
                if(this.player.position.y > 0) this.player.position.y -= 0.05; 
                if(this.player.position.y < 0) this.player.position.y = 0; // Ground plane reset
            }
        }

        /* --- LEGACY 2D GAMES (Maintained) --- */
        class TumbleTownGame {
            constructor(id) { this.canvas=document.getElementById(id); this.ctx=this.canvas.getContext('2d'); this.running=true; this.loop(); }
            start(){this.loop();} stop(){this.running=false;}
            loop() { if(!this.running) return; this.ctx.fillStyle='#333'; this.ctx.fillRect(0,0,1000,1000); this.ctx.fillStyle='white'; this.ctx.fillText("2D Tumble Town Legacy Mode", 50, 50); requestAnimationFrame(()=>this.loop()); }
        }
        class PizzaTycoonGame {
            constructor(id) { this.canvas=document.getElementById(id); this.ctx=this.canvas.getContext('2d'); this.running=true; this.loop(); }
            start(){this.loop();} stop(){this.running=false;}
            loop() { if(!this.running) return; this.ctx.fillStyle='#222'; this.ctx.fillRect(0,0,1000,1000); this.ctx.fillStyle='orange'; this.ctx.fillText("2D Pizza Tycoon Legacy Mode", 50, 50); requestAnimationFrame(()=>this.loop()); }
        }

        /* --- AVATAR RENDERER (2D Canvas) --- */
        class AvatarRenderer {
            constructor(id, size) {
                this.canvas = document.getElementById(id);
                this.ctx = this.canvas.getContext('2d');
                this.time = 0;
            }
            draw(equipped) {
                const ctx = this.ctx; const w = this.canvas.width; const h = this.canvas.height;
                this.time+=0.05; ctx.clearRect(0,0,w,h);
                const bounce = Math.sin(this.time)*5;
                ctx.save(); ctx.translate(w/2, h/2+bounce);
                
                // Back
                if(equipped.backbling) { ctx.fillStyle=equipped.backbling.color; ctx.fillRect(-45, -80, 90, 100); }
                // Body
                ctx.fillStyle = equipped.skin || '#FFE135'; ctx.beginPath(); ctx.roundRect(-40, -100, 80, 180, 40); ctx.fill(); 
                // Clothes
                if(equipped.clothing) { ctx.fillStyle=equipped.clothing.color; ctx.fillRect(-38, -60, 76, 100); }
                // Face
                ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(-15,-40,5,0,Math.PI*2); ctx.arc(15,-40,5,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(0,-30,15,0.2*Math.PI,0.8*Math.PI); ctx.stroke();
                ctx.restore();
            }
        }
        
        // Fix 2: Wrap app initialization in window.onload and assign to window.app
        window.onload = function() {
            window.app = new PeyzaApp();
        };
    </script>
</body>
</html>
