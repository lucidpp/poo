<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Site Metadata -->
    <title>Peyza - The Red Social Network</title>
    <meta name="description" content="Join Peyza, the hottest new social media platform. Experience real-time virality, bot interactions, and community building in a sleek red theme.">
    <meta name="keywords" content="social media, twitter alternative, simulation, bot social network, peyza">
    <meta name="author" content="Peyza Inc.">
    <meta name="theme-color" content="#e11d48">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peyza.app/">
    <meta property="og:title" content="Peyza - The Red Social Network">
    <meta property="og:description" content="Join Peyza, the hottest new social media platform. Experience real-time virality and community building.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://peyza.app/">
    <meta property="twitter:title" content="Peyza - The Red Social Network">
    <meta property="twitter:description" content="Join Peyza, the hottest new social media platform. Experience real-time virality and community building.">

    <!-- PWA / Mobile Web App Capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Peyza">

    <!-- Favicon (Data URI) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23e11d48'/%3E%3Ctext x='50' y='75' font-family='Arial, sans-serif' font-weight='900' font-size='70' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23e11d48'/%3E%3Ctext x='50' y='75' font-family='Arial, sans-serif' font-weight='900' font-size='70' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">

    <!-- PWA Manifest (Data URI) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUGV5emEiLCJzaG9ydF9uYW1lIjoiUGV5emEiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiI2UxMWQ0OCIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJyBmaWxsPSclMjNlMTFkNDgnLyUzRSUzQ3RleHQgeD0nNTAnIHk9Jzc1JyBmb250LWZhbWlseT0nQXJpYWwsIHNhbnMtc2VyaWYnIGZvbnQtd2VpZ2h0PSc5MDAnIGZvbnQtc2l6ZT0nNzAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9J3doaXRlJyUzRVAlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#000000',
                        darkSec: '#16181c',
                        darkText: '#e7e9ea',
                        darkBorder: '#2f3336'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e11d48; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #be123c; }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        
        .nav-item.active i { font-weight: 900; }
        
        /* Mobile Nav Animations */
        .nav-icon { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s; }
        .nav-icon.active { transform: scale(1.25); }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .mobile-nav { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Interaction States */
        .liked { color: #e11d48 !important; }
        .reposted { color: #22c55e !important; }
        .bookmarked { color: #3b82f6 !important; }
        .bookmarked i { font-weight: 900 !important; }
        
        /* Post Themes */
        .post-highlight {
            border: 2px solid #fbbf24 !important; 
            background-color: rgba(251, 191, 36, 0.05);
        }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-white text-[#0f1419] dark:bg-dark dark:text-darkText transition-colors duration-200">

    <!-- Left Sidebar (Desktop) -->
    <header class="hidden sm:flex flex-col w-[80px] xl:w-[275px] h-screen fixed left-0 top-0 border-r border-gray-100 dark:border-darkBorder px-2 xl:px-8 py-4 z-20 bg-white dark:bg-dark justify-between">
        <div class="space-y-4">
            <div class="p-3 w-min hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-full cursor-pointer transition transform active:scale-90" onclick="app.navigate('home')">
                <i class="fa-solid fa-p text-3xl text-rose-600"></i>
            </div>
            <nav class="space-y-2 text-xl">
                <a onclick="app.navigate('home')" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item active" id="nav-home">
                    <i class="fa-solid fa-house"></i>
                    <span class="hidden xl:block font-medium">Home</span>
                </a>
                <a onclick="app.navigate('explore')" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item" id="nav-explore">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span class="hidden xl:block font-medium">Explore</span>
                </a>
                <a onclick="app.navigate('notifications')" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item" id="nav-notifications">
                    <i class="fa-regular fa-bell"></i>
                    <span class="hidden xl:block font-medium">Notifications</span>
                </a>
                <a onclick="app.navigate('profile', app.user.handle)" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item" id="nav-profile">
                    <i class="fa-regular fa-user"></i>
                    <span class="hidden xl:block font-medium">Profile</span>
                </a>
                <a onclick="app.openSettings()" class="flex items-center gap-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer nav-item">
                    <i class="fa-solid fa-gear"></i>
                    <span class="hidden xl:block font-medium">Settings</span>
                </a>
            </nav>
            <button onclick="app.openComposeModal()" class="bg-rose-600 hover:bg-rose-700 text-white rounded-full p-4 xl:py-3 xl:px-8 w-full shadow-lg transition transform active:scale-95 mt-4">
                <i class="fa-solid fa-feather sm:hidden"></i>
                <span class="hidden xl:block font-bold text-lg">Post</span>
            </button>
        </div>
        <div onclick="app.navigate('profile', app.user.handle)" class="flex items-center gap-3 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer mb-4 transition" id="sidebar-user">
            <!-- Injected by JS -->
        </div>
    </header>

    <!-- Main Content Feed -->
    <main class="w-full sm:ml-[80px] xl:ml-[275px] max-w-[600px] border-r border-gray-100 dark:border-darkBorder min-h-screen pb-20 sm:pb-0 relative">
        <div id="sticky-header" class="sticky top-0 bg-white/80 dark:bg-dark/80 backdrop-blur-md z-10 border-b border-gray-100 dark:border-darkBorder"></div>
        <div id="main-view" class="animate-fade-in"></div>
    </main>

    <!-- Right Sidebar (Desktop) -->
    <aside class="hidden lg:block w-[350px] pl-8 py-4 h-screen sticky top-0">
        <div class="relative group mb-6">
            <div class="absolute left-4 top-3 text-gray-500 group-focus-within:text-rose-500"><i class="fa-solid fa-magnifying-glass"></i></div>
            <input type="text" placeholder="Search Peyza" onkeyup="if(event.key === 'Enter') { app.navigate('explore', this.value); }" class="w-full bg-gray-100 dark:bg-darkSec dark:text-white rounded-full py-3 pl-12 pr-4 outline-none focus:bg-white dark:focus:bg-black focus:ring-1 focus:ring-rose-500 transition border border-transparent dark:border-darkBorder">
        </div>
        <div class="bg-gray-50 dark:bg-darkSec rounded-2xl p-4 mb-4">
            <h3 class="font-extrabold text-xl mb-4">Trends for you</h3>
            <div class="space-y-4" id="sidebar-trends"></div>
        </div>
        <div class="bg-gray-50 dark:bg-darkSec rounded-2xl p-4">
            <h3 class="font-extrabold text-xl mb-4">Who to follow</h3>
            <div id="who-to-follow" class="space-y-4"></div>
        </div>
    </aside>

    <!-- Mobile Navigation Bottom -->
    <div class="fixed bottom-0 w-full bg-white dark:bg-dark border-t border-gray-100 dark:border-darkBorder flex justify-around items-center py-3 sm:hidden mobile-nav z-30" id="mobile-nav-bar"></div>

    <!-- Floating Action Button (Mobile) -->
    <button onclick="app.openComposeModal()" class="fixed bottom-20 right-4 bg-rose-500 text-white rounded-full p-4 shadow-lg sm:hidden z-20 hover:bg-rose-600 active:scale-90 transition animate-pop">
        <i class="fa-solid fa-feather text-xl"></i>
    </button>

    <!-- Compose Modal -->
    <div id="compose-modal" class="fixed inset-0 bg-black/40 dark:bg-white/10 z-50 hidden flex items-start justify-center pt-16 sm:pt-24 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark w-full max-w-[600px] rounded-2xl p-4 shadow-2xl relative animate-pop border dark:border-darkBorder">
            <div class="flex justify-between items-center mb-4">
                <button onclick="app.closeComposeModal()" class="text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-darkSec p-2 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="flex gap-4">
                     <span class="text-rose-500 font-bold text-sm self-center">Drafts</span>
                     <button onclick="app.publishPost()" class="bg-rose-500 text-white px-4 py-1.5 rounded-full font-bold text-sm hover:bg-rose-600 disabled:opacity-50 transition">Post</button>
                </div>
            </div>
            <div class="flex gap-3">
                <img id="compose-avatar" src="" class="w-10 h-10 rounded-full object-cover border border-gray-100 dark:border-darkBorder">
                <div class="w-full">
                    <div id="author-selector" class="hidden mb-2">
                        <select id="post-as-select" class="text-sm font-bold bg-transparent outline-none text-rose-500 cursor-pointer"></select>
                    </div>
                    <div id="replying-to-indicator" class="hidden text-sm text-gray-500 mb-1">Replying to <span class="text-rose-500">@post</span></div>
                    <div id="community-indicator" class="hidden text-sm text-gray-500 mb-1">Posting to <span class="text-rose-500 font-bold" id="community-name-target">Community</span></div>

                    <textarea id="compose-input" class="w-full h-24 resize-none outline-none text-xl placeholder-gray-500 bg-transparent dark:text-white mt-2" placeholder="What is happening?!"></textarea>
                    
                    <div id="media-preview" class="hidden relative mb-2">
                        <img id="media-preview-img" class="rounded-xl max-h-48 border border-gray-200 dark:border-darkBorder hidden">
                        <video id="media-preview-video" class="rounded-xl max-h-48 border border-gray-200 dark:border-darkBorder hidden" controls></video>
                        <button onclick="app.clearMedia()" class="absolute top-1 left-1 bg-black/50 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                    </div>

                    <div id="poll-creator" class="hidden border border-gray-200 dark:border-darkBorder rounded-xl p-3 mb-2">
                        <div class="space-y-2">
                            <input type="text" id="poll-opt-1" placeholder="Choice 1" class="w-full border dark:border-darkBorder p-2 rounded text-sm bg-transparent dark:text-white">
                            <input type="text" id="poll-opt-2" placeholder="Choice 2" class="w-full border dark:border-darkBorder p-2 rounded text-sm bg-transparent dark:text-white">
                        </div>
                        <div class="mt-2 text-rose-500 text-xs font-bold cursor-pointer" onclick="document.getElementById('poll-creator').classList.add('hidden')">Remove Poll</div>
                    </div>

                    <div class="border-t border-gray-100 dark:border-darkBorder pt-3 flex justify-between items-center text-rose-500 text-lg">
                        <div class="flex gap-4">
                            <i class="fa-regular fa-image cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition" onclick="document.getElementById('post-image-upload').click()"></i>
                            <i class="fa-solid fa-video cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition" onclick="document.getElementById('post-video-upload').click()"></i>
                            <i class="fa-solid fa-square-poll-horizontal cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition" onclick="document.getElementById('poll-creator').classList.remove('hidden')"></i>
                            <i class="fa-regular fa-face-smile cursor-pointer hover:bg-blue-50 dark:hover:bg-darkSec p-2 rounded-full transition"></i>
                        </div>
                    </div>
                    <input type="file" id="post-image-upload" hidden accept="image/*" onchange="app.handlePostMedia(event, 'image')">
                    <input type="file" id="post-video-upload" hidden accept="video/*" onchange="app.handlePostMedia(event, 'video')">
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile / Settings Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black/40 dark:bg-white/10 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark w-full max-w-[500px] rounded-2xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto animate-pop border dark:border-darkBorder">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="app.closeEditProfile()" class="text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-darkSec p-2 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <h2 class="font-bold text-xl" id="edit-modal-title">Edit Profile</h2>
                </div>
                <button onclick="app.saveProfile()" class="bg-black dark:bg-white dark:text-black text-white px-5 py-1.5 rounded-full font-bold text-sm hover:bg-gray-800 transition">Save</button>
            </div>
            
            <input type="file" id="banner-upload" hidden accept="image/*" onchange="app.handleImageUpload(event, 'banner')">
            <input type="file" id="avatar-upload" hidden accept="image/*" onchange="app.handleImageUpload(event, 'avatar')">

            <div class="h-32 bg-gray-200 dark:bg-darkSec relative mb-12 rounded-md group cursor-pointer overflow-hidden border dark:border-darkBorder" onclick="document.getElementById('banner-upload').click()">
                <img id="edit-banner-preview" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-white text-2xl drop-shadow-md"></i></div>
                <div class="absolute -bottom-10 left-4 w-24 h-24 rounded-full border-4 border-white dark:border-dark bg-gray-300 dark:bg-darkSec overflow-hidden cursor-pointer group hover:opacity-90" onclick="event.stopPropagation(); document.getElementById('avatar-upload').click()">
                    <img id="edit-avatar-preview" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-white drop-shadow-md"></i></div>
                </div>
            </div>

            <form class="space-y-4 mt-8">
                <div class="flex items-center justify-between p-2 border border-gray-200 dark:border-darkBorder rounded-md">
                    <span class="font-bold text-sm">Dark Mode</span>
                    <button type="button" onclick="app.toggleTheme()" id="theme-btn" class="text-gray-500 hover:text-rose-500 font-bold text-sm transition">Switch</button>
                </div>
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500 focus-within:border-transparent transition">
                    <label class="block text-xs text-gray-500">Name</label>
                    <input type="text" id="edit-name" class="w-full outline-none text-sm bg-transparent dark:text-white">
                </div>
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500 focus-within:border-transparent transition">
                    <label class="block text-xs text-gray-500">Bio</label>
                    <textarea id="edit-bio" class="w-full outline-none text-sm resize-none h-20 bg-transparent dark:text-white"></textarea>
                </div>
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500 focus-within:border-transparent transition">
                    <label class="block text-xs text-gray-500">Location</label>
                    <input type="text" id="edit-location" class="w-full outline-none text-sm bg-transparent dark:text-white">
                </div>
                
                <div id="bot-control-panel" class="hidden flex items-center justify-between p-2 border border-gray-200 dark:border-darkBorder rounded-md">
                    <span class="font-bold text-sm">Auto-Posting</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="bot-auto-post" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-rose-600"></div>
                    </label>
                </div>
                
                <hr class="border-gray-100 dark:border-darkBorder my-4">
                
                <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 focus-within:ring-2 focus-within:ring-rose-500">
                    <label class="block text-xs text-gray-500">Secret PIN</label>
                    <input type="password" id="secret-pin" oninput="app.checkPin()" class="w-full outline-none text-sm font-mono text-rose-600 bg-transparent" placeholder="Enter code">
                </div>

                <div id="god-mode-panel" class="hidden space-y-4 bg-rose-50 dark:bg-rose-900/10 p-4 rounded-lg border border-rose-100 dark:border-rose-900/30">
                    <h3 class="font-bold text-rose-600 mb-2">âš¡ God Mode Active</h3>
                    <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-1 bg-white dark:bg-dark">
                        <label class="block text-xs text-gray-500">Follower Count (Cheat)</label>
                        <input type="number" id="edit-followers" class="w-full outline-none text-sm font-mono text-rose-600 bg-transparent">
                    </div>
                    <div class="flex items-center justify-between p-2 border border-gray-200 dark:border-darkBorder rounded-md bg-white dark:bg-dark">
                        <div class="flex flex-col"><span class="font-bold text-sm">Force Verify</span><span class="text-xs text-gray-500">Bypass requirements</span></div>
                        <button type="button" id="btn-verify" onclick="app.requestVerification(true)" class="bg-black text-white px-3 py-1.5 rounded-full text-sm font-bold transition">Get Badge</button>
                    </div>
                    <button type="button" onclick="app.openCreateBotModal()" class="w-full bg-rose-500 text-white font-bold py-2 rounded-md hover:bg-rose-600 transition"><i class="fa-solid fa-robot mr-2"></i> Create New Bot</button>
                    <div class="border border-gray-300 dark:border-darkBorder rounded-md px-2 py-2 bg-white dark:bg-dark">
                        <label class="block text-xs text-gray-500 mb-2">Virality Speed</label>
                        <select id="edit-virality" class="w-full outline-none text-sm bg-transparent dark:text-white">
                            <option value="0.1">Slow (Realistic)</option>
                            <option value="1">Normal</option>
                            <option value="5">Fast</option>
                            <option value="20">Superfast (Viral)</option>
                            <option value="2000">Ultra Fast (Godspeed)</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Bot Modal -->
    <div id="create-bot-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark w-full max-w-[400px] rounded-2xl p-6 shadow-2xl relative animate-pop border dark:border-darkBorder">
             <div class="flex justify-between items-center mb-6">
                <h2 class="font-bold text-xl">Create Bot</h2>
                <button onclick="document.getElementById('create-bot-modal').classList.add('hidden')" class="text-gray-900 dark:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="bot-name" placeholder="Bot Name" class="w-full border p-2 rounded-md dark:bg-darkSec dark:border-darkBorder dark:text-white">
                <input type="text" id="bot-handle" placeholder="Bot Handle (no @)" class="w-full border p-2 rounded-md dark:bg-darkSec dark:border-darkBorder dark:text-white">
                <input type="text" id="bot-avatar" placeholder="Avatar URL (optional)" class="w-full border p-2 rounded-md dark:bg-darkSec dark:border-darkBorder dark:text-white">
                <button onclick="app.createBot()" class="w-full bg-rose-600 text-white font-bold py-2 rounded-full">Create</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-rose-500 text-white px-6 py-2 rounded-full shadow-lg z-[70] transition-opacity duration-300 opacity-0 pointer-events-none font-bold text-sm">Action Successful</div>

<script>
/**
 * Peyza App Logic v4.1
 * Fixed Navigation, Post Pages, and Stats
 */

const VERIFIED_ICON = `<svg viewBox="0 0 24 24" aria-label="Verified Account" class="w-5 h-5 ml-1 inline-block text-rose-500 fill-current align-text-bottom"><g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.912-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.912 1.79-3.912 4 0 .495.084.965.238 1.4-1.272.65-2.147 2.02-2.147 3.6 0 1.417.705 2.674 1.774 3.426-.09.38-.138.775-.138 1.18 0 2.597 2.193 4.8 4.887 4.8.94 0 1.815-.28 2.546-.755.67.635 1.57.99 2.522.99.98 0 1.905-.373 2.585-1.036.65.385 1.393.595 2.164.595 2.553 0 4.708-2.02 4.908-4.502.04.017.08.03.123.03 1.252 0 2.373-.556 3.116-1.42.75-.873 1.096-2.03.96-3.18z"></path><path d="M9.707 15.293l-4-4 1.414-1.414L10 12.758l7.293-7.293 1.414 1.414-8 8a1 1 0 01-1.414 0z" fill="#fff"></path></g></svg>`;
const ANALYTICS_ICON = `<svg viewBox="0 0 24 24" aria-hidden="true" class="w-[18px] h-[18px] fill-current"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>`;

const DEFAULT_BOTS = [
    { handle: 'tech_guru', name: 'Tech Insider', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix', bio: 'Latest tech news.', followers: 450200, following: 152, isVerified: true, autoPost: true },
    { handle: 'JuiceWorlddd', name: 'Juice WRLD', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Juice', bio: '999 Forever ðŸ•Šï¸', followers: 12500000, following: 1, isVerified: true, autoPost: true },
    { handle: 'elonmusk', name: 'Elon Musk', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Elon', bio: 'Mars & Cars.', followers: 150000000, following: 140, isVerified: true, autoPost: true },
    { handle: 'taylorswift13', name: 'Taylor Swift', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Taylor', bio: 'Iâ€™m the problem, itâ€™s me.', followers: 95000000, following: 0, isVerified: true, autoPost: true },
    { handle: 'meme_lord', name: 'Daily Memes', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Meme', bio: 'I post memes.', followers: 12000, following: 50, isVerified: false, autoPost: true },
    { handle: 'crypto_king', name: 'Crypto Chad', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Chad', bio: 'HODL.', followers: 8900, following: 1200, isVerified: false, autoPost: true },
    { handle: 'news_bot', name: 'Peyza News', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=News', bio: 'Breaking news.', followers: 1500000, following: 10, isVerified: true, autoPost: true }
];

const FAMOUS_CONTENT = {
    'JuiceWorlddd': ["Lucid Dreams still hits differently ðŸ’”", "999 till the world ends", "Making music in heaven ðŸ•Šï¸", "Legends never die."],
    'elonmusk': ["Sending a rocket to Mars next week.", "Peyza is actually pretty cool.", "Thinking about buying an island.", "AI is the future."],
    'taylorswift13': ["Tour dates coming soon! âœ¨", "In my era.", "Writing songs about rain.", "Cats are the best."]
};

const MOCK_POSTS_CONTENT = [
    "Just deployed the new update! #coding #life", "Why is coffee so good? â˜•ï¸", "Peyza is looking slick with this red theme! â¤ï¸",
    "AI is taking over, and I for one welcome our robot overlords.", "Can't believe it's already Friday.", "Learning Rust is harder than I thought.",
    "Just bought more Bitcoin. Don't tell my wife. ðŸ¤«", "This new app design is fire ðŸ”¥", "Does anyone actually read these?",
    "Web3 is the future.", "React vs Vue vs Svelte vs Angular. Go!", "Just saw a Cybertruck in person. It looks... interesting."
];

class PeyzaApp {
    constructor() {
        this.user = this.loadUser();
        this.bots = this.loadBots();
        this.posts = this.loadPosts();
        this.currentView = 'home'; 
        this.viewParam = null;
        this.feedFilter = 'foryou';
        this.profileFilter = 'posts';
        this.settings = this.loadSettings();
        this.editingHandle = null; 
        this.replyingTo = null;
        this.tempMedia = null;
        this.tempMediaType = 'image';
        this.postingToCommunity = null;
        this.init();
    }

    init() {
        this.applyTheme();
        this.renderSidebarUser();
        this.renderWhoToFollow();
        this.renderSidebarTrends();
        this.renderView();
        setTimeout(() => { if(this.currentView === 'home') this.setFeedFilter('foryou'); }, 100);
        setInterval(() => this.simulateStats(), 1000);
        setInterval(() => this.generateRandomBotPost(), 15000);
    }

    // --- DATA ---
    loadUser() {
        const saved = localStorage.getItem('peyza_user_v7'); 
        if (saved) return JSON.parse(saved);
        return {
            handle: 'guest_user', name: 'Guest', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Guest',
            banner: 'https://images.unsplash.com/photo-1557683316-973673baf926?w=800&auto=format&fit=crop&q=60',
            bio: 'Just a guest exploring Peyza.', location: 'Internet',
            joined: new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            followers: 42, following: 15, isVerified: false,
            likedPosts: [], repostedPosts: [], bookmarks: [],
            isPremium: false, createdBots: []
        };
    }
    loadBots() { const s=localStorage.getItem('peyza_bots_v7'); if(s)return JSON.parse(s); return [...DEFAULT_BOTS]; }
    loadPosts() { const s=localStorage.getItem('peyza_posts_v7'); if(s){let p=JSON.parse(s); if(p.length>200)p=p.slice(0,100); return p;} const p=[]; for(let i=0;i<20;i++)p.push(this.createMockPost(i*1000*60*20)); return p; }
    loadSettings() { const s=localStorage.getItem('peyza_settings'); if(s)return JSON.parse(s); return { viralitySpeed: 1.0, theme: 'light' }; }
    saveUser() { localStorage.setItem('peyza_user_v7', JSON.stringify(this.user)); this.renderSidebarUser(); }
    saveBots() { localStorage.setItem('peyza_bots_v7', JSON.stringify(this.bots)); }
    savePosts() { localStorage.setItem('peyza_posts_v7', JSON.stringify(this.posts)); }
    saveSettings() { localStorage.setItem('peyza_settings', JSON.stringify(this.settings)); }

    getProfile(handle) {
        if (handle === this.user.handle) return this.user;
        return this.bots.find(b => b.handle === handle);
    }

    createMockPost(timeOffset = 0) {
        const bot = this.bots[Math.floor(Math.random() * this.bots.length)];
        let content = MOCK_POSTS_CONTENT[Math.floor(Math.random() * MOCK_POSTS_CONTENT.length)];
        if (FAMOUS_CONTENT[bot.handle]) content = FAMOUS_CONTENT[bot.handle][Math.floor(Math.random() * FAMOUS_CONTENT[bot.handle].length)];
        const hasImage = Math.random() > 0.8;
        return {
            id: 'post_' + Math.random().toString(36).substr(2, 9),
            authorHandle: bot.handle, authorName: bot.name, authorAvatar: bot.avatar, isVerified: bot.isVerified,
            content: content, image: hasImage ? `https://picsum.photos/seed/${Math.random()}/600/350` : null, video: null, poll: null, communityHandle: null, theme: 'default',
            createdAt: Date.now() - timeOffset,
            stats: { likes: Math.floor(Math.random()*50), reposts: Math.floor(Math.random()*10), replies: Math.floor(Math.random()*5), views: Math.floor(Math.random()*500) },
            baseVelocity: Math.random()
        };
    }

    createPost(content, asHandle = null) {
        let author = this.user;
        if (asHandle && asHandle !== this.user.handle) author = this.bots.find(b => b.handle === asHandle) || this.user;
        let poll = null;
        const o1 = document.getElementById('poll-opt-1').value;
        const o2 = document.getElementById('poll-opt-2').value;
        if(o1 && o2 && !document.getElementById('poll-creator').classList.contains('hidden')) {
            poll = { options: [{ text: o1, votes: 0 }, { text: o2, votes: 0 }], totalVotes: 0 };
        }
        const newPost = {
            id: 'post_' + Math.random().toString(36).substr(2, 9),
            authorHandle: author.handle, authorName: author.name, authorAvatar: author.avatar, isVerified: author.isVerified,
            content: content, image: this.tempMediaType === 'image' ? this.tempMedia : null, video: this.tempMediaType === 'video' ? this.tempMedia : null, poll: poll,
            communityHandle: this.postingToCommunity, theme: 'default', createdAt: Date.now(),
            stats: { likes: 0, reposts: 0, replies: 0, views: 0 }, baseVelocity: Math.random()
        };
        this.posts.unshift(newPost);
        this.savePosts();
        if (this.replyingTo) { const op = this.posts.find(p => p.id === this.replyingTo); if(op) { op.stats.replies++; this.savePosts(); } this.replyingTo = null; }
        this.clearMedia(); this.postingToCommunity = null;
        
        // Fix: Go home after posting if not replying
        if (!this.replyingTo) this.navigate('home'); else this.renderView();
    }

    generateRandomBotPost() {
        const c = this.posts.filter(p => this.bots.some(b => b.handle === p.authorHandle)).length;
        if (c > 25) return;
        this.bots.forEach(bot => {
            if (bot.autoPost !== false && Math.random() < 0.0083) { 
                let content = MOCK_POSTS_CONTENT[Math.floor(Math.random() * MOCK_POSTS_CONTENT.length)];
                if (FAMOUS_CONTENT[bot.handle]) content = FAMOUS_CONTENT[bot.handle][Math.floor(Math.random() * FAMOUS_CONTENT[bot.handle].length)];
                let commHandle = null; if(Math.random() < 0.1) commHandle = this.user.handle;
                const np = {
                    id: 'post_' + Math.random().toString(36).substr(2, 9),
                    authorHandle: bot.handle, authorName: bot.name, authorAvatar: bot.avatar, isVerified: bot.isVerified,
                    content: content, image: Math.random() > 0.8 ? `https://picsum.photos/seed/${Math.random()}/600/350` : null, video: null, poll: null, theme: 'default', communityHandle: commHandle,
                    createdAt: Date.now(), stats: { likes: Math.floor(Math.random()*50), reposts: Math.floor(Math.random()*10), replies: Math.floor(Math.random()*5), views: Math.floor(Math.random()*500) }, baseVelocity: Math.random()
                };
                this.posts.unshift(np);
            }
        });
        this.savePosts();
        if (this.currentView === 'home') this.renderFeed();
        if (this.currentView === 'profile' && this.profileFilter === 'community') this.renderProfile(this.viewParam);
    }

    simulateStats() {
        const now = Date.now();
        let changed = false;
        const fourHours = 4 * 60 * 60 * 1000;
        const initLen = this.posts.length;
        this.posts = this.posts.filter(p => { const isBot = this.bots.some(b => b.handle === p.authorHandle); return !(isBot && (now - p.createdAt > fourHours)); });
        if (this.posts.length !== initLen) changed = true;

        this.posts.forEach(post => {
            const age = (now - post.createdAt) / 1000;
            if (age < 86400) {
                let f = 100;
                if (post.authorHandle === this.user.handle) f = this.user.followers;
                else { const b = this.bots.find(x => x.handle === post.authorHandle); if(b) f = b.followers; }
                const scale = Math.max(1, Math.log10(f));
                const boost = 1 + (post.stats.reposts * 0.1);
                const growth = this.settings.viralitySpeed * post.baseVelocity * scale * boost;
                const nv = Math.floor(post.stats.views + (growth * 5 * Math.random()));
                if (nv > post.stats.views) { post.stats.views = nv; changed = true; }
                if (Math.random() < 0.3) { post.stats.likes += Math.floor(growth * Math.random() * 2); changed = true; }
                if (Math.random() < 0.05) { post.stats.reposts += 1; changed = true; }
                if (post.poll && Math.random() < 0.2 * growth) { const r = Math.floor(Math.random() * post.poll.options.length); post.poll.options[r].votes++; post.poll.totalVotes++; changed = true; }
            }
        });
        if (changed) { this.savePosts(); this.updateVisibleStats(); }
    }

    updateVisibleStats() {
        this.posts.forEach(post => {
            const el = document.getElementById(`stats-${post.id}`);
            if (el) {
                const views = el.querySelector('.stat-views');
                if(views) views.innerText = this.formatNumber(post.stats.views);
                
                const likes = el.querySelector('.stat-likes');
                if(likes) likes.innerText = this.formatNumber(post.stats.likes);
                
                const reposts = el.querySelector('.stat-reposts');
                if(reposts) reposts.innerText = this.formatNumber(post.stats.reposts);
            }
            const dv = document.getElementById(`detail-views-${post.id}`);
            if(dv) dv.innerText = this.formatNumber(post.stats.views);
            if (post.poll) {
                post.poll.options.forEach((opt, idx) => {
                    const bar = document.getElementById(`poll-bar-${post.id}-${idx}`);
                    const text = document.getElementById(`poll-text-${post.id}-${idx}`);
                    if(bar && text) { const pct = post.poll.totalVotes === 0 ? 0 : Math.round((opt.votes / post.poll.totalVotes) * 100); bar.style.width = pct + '%'; text.innerText = `${pct}%`; }
                });
                const t = document.getElementById(`poll-total-${post.id}`); if(t) t.innerText = `${this.formatNumber(post.poll.totalVotes)} votes`;
            }
        });
    }

    navigate(view, param = null) {
        this.currentView = view;
        this.viewParam = param;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (view === 'home') document.getElementById('nav-home').classList.add('active');
        if (view === 'explore') document.getElementById('nav-explore').classList.add('active');
        if (view === 'notifications') document.getElementById('nav-notifications').classList.add('active');
        if (view === 'profile' && param === this.user.handle) document.getElementById('nav-profile').classList.add('active');
        window.scrollTo(0,0);
        this.renderView();
    }

    setFeedFilter(filter) { this.feedFilter = filter; this.renderView(); }
    setProfileFilter(filter) { this.profileFilter = filter; this.renderProfile(this.viewParam); }

    renderView() {
        const main = document.getElementById('main-view');
        const header = document.getElementById('sticky-header');
        main.innerHTML = '';
        const mNav = document.getElementById('mobile-nav-bar');
        if(mNav) {
            mNav.innerHTML = `
                <div onclick="app.navigate('home')" class="nav-icon cursor-pointer text-2xl ${this.currentView==='home'?'active text-black dark:text-white':'text-gray-400'}"><i class="fa-solid fa-house"></i></div>
                <div onclick="app.navigate('explore')" class="nav-icon cursor-pointer text-2xl ${this.currentView==='explore'?'active text-black dark:text-white':'text-gray-400'}"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div onclick="app.navigate('notifications')" class="nav-icon cursor-pointer text-2xl ${this.currentView==='notifications'?'active text-black dark:text-white':'text-gray-400'}"><i class="fa-regular fa-bell"></i></div>
                <div onclick="app.navigate('profile', app.user.handle)" class="nav-icon cursor-pointer text-2xl ${this.currentView==='profile'&&this.viewParam===this.user.handle?'active text-black dark:text-white':'text-gray-400'}"><i class="fa-regular fa-user"></i></div>`;
        }

        if (this.currentView === 'home') {
            const isForYou=this.feedFilter==='foryou', isFol=this.feedFilter==='following', isMed=this.feedFilter==='media';
            header.innerHTML = `
                <div id="header-content" class="px-4 h-[53px] flex items-center justify-between cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})"><h2 class="text-lg font-bold">Home</h2><i class="fa-solid fa-wand-magic-sparkles text-rose-500 hover:rotate-12 transition"></i></div>
                <div id="feed-filters" class="flex border-b border-gray-100 dark:border-darkBorder">
                    <div onclick="app.setFeedFilter('foryou')" class="flex-1 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer transition text-center py-3 relative feed-filter group ${isForYou?'active':''}" data-filter="foryou"><span class="font-medium text-sm ${isForYou?'font-bold text-gray-900 dark:text-white':'text-gray-500 dark:text-gray-400'}">For You</span><div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${isForYou?'':'hidden'}"><div class="bg-rose-500 w-14 rounded-full indicator"></div></div></div>
                    <div onclick="app.setFeedFilter('following')" class="flex-1 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer transition text-center py-3 relative feed-filter group ${isFol?'active':''}" data-filter="following"><span class="font-medium text-sm ${isFol?'font-bold text-gray-900 dark:text-white':'text-gray-500 dark:text-gray-400'}">Following</span><div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${isFol?'':'hidden'}"><div class="bg-rose-500 w-14 rounded-full indicator"></div></div></div>
                    <div onclick="app.setFeedFilter('media')" class="flex-1 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer transition text-center py-3 relative feed-filter group ${isMed?'active':''}" data-filter="media"><span class="font-medium text-sm ${isMed?'font-bold text-gray-900 dark:text-white':'text-gray-500 dark:text-gray-400'}">Media</span><div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${isMed?'':'hidden'}"><div class="bg-rose-500 w-14 rounded-full indicator"></div></div></div>
                </div>`;
            this.renderFeed();
        } else if (this.currentView === 'explore') {
            header.innerHTML = `<div class="px-4 py-2"><div class="relative group"><div class="absolute left-4 top-3 text-gray-500"><i class="fa-solid fa-magnifying-glass"></i></div><input type="text" id="explore-search" placeholder="Search Peyza" oninput="app.handleSearch(this.value)" value="${this.viewParam || ''}" class="w-full bg-gray-100 dark:bg-darkSec dark:text-white rounded-full py-3 pl-12 pr-4 outline-none focus:bg-white dark:focus:bg-black focus:ring-1 focus:ring-rose-500 transition border border-transparent dark:border-darkBorder"></div></div>`;
            this.renderExplore(this.viewParam);
        } else if (this.currentView === 'notifications') {
            header.innerHTML = `<div class="px-4 h-[53px] flex items-center font-bold text-lg dark:text-white">Notifications</div>`;
            this.renderNotifications();
        } else if (this.currentView === 'profile') {
            header.innerHTML = `<div class="px-4 h-[53px] flex items-center font-bold text-lg dark:text-white"><i class="fa-solid fa-arrow-left mr-6 cursor-pointer" onclick="app.navigate('home')"></i> ${this.viewParam}</div>`;
            this.renderProfile(this.viewParam);
        } else if (this.currentView === 'post') {
            header.innerHTML = `<div class="px-4 h-[53px] flex items-center font-bold text-lg dark:text-white"><i class="fa-solid fa-arrow-left mr-6 cursor-pointer" onclick="app.navigate('home')"></i> Post</div>`;
            this.renderPostDetail(this.viewParam);
        }
    }

    renderFeed() {
        const container = document.getElementById('main-view');
        let filteredPosts = [...this.posts];
        if (this.feedFilter === 'media') filteredPosts = filteredPosts.filter(p => p.image || p.video);
        else if (this.feedFilter === 'following') filteredPosts = filteredPosts.filter(p => p.authorHandle !== 'guest_user');
        if(this.feedFilter === 'foryou') filteredPosts = filteredPosts.filter(p => !p.communityHandle); 
        filteredPosts.sort((a, b) => b.createdAt - a.createdAt);
        let html = '';
        filteredPosts.forEach(post => html += this.buildPostHTML(post));
        container.innerHTML = html || '<div class="p-10 text-center text-gray-500">No posts found</div>';
    }

    renderExplore(query) {
        const container = document.getElementById('main-view');
        if (!query) {
            let html = `<div class="p-4"><h2 class="font-extrabold text-xl mb-4 dark:text-white">Trends for you</h2>`;
            ['#PeyzaGodMode', 'Juice WRLD', 'Artificial Intelligence', 'SpaceX', 'Taylor Swift'].forEach(topic => {
                html += `<div class="py-3 hover:bg-gray-50 dark:hover:bg-darkSec cursor-pointer -mx-4 px-4 transition"><div class="text-xs text-gray-500">Trending</div><div class="font-bold text-sm dark:text-white">${topic}</div><div class="text-xs text-gray-500">${Math.floor(Math.random()*500)+1}K posts</div></div>`;
            });
            html += `</div><div class="border-t border-gray-100 dark:border-darkBorder p-4"><h2 class="font-extrabold text-xl mb-4 dark:text-white">Who to follow</h2>`;
            this.bots.forEach(bot => { html += this.buildUserListHTML(bot); });
            html += `</div>`;
            container.innerHTML = html;
        } else {
            const q = query.toLowerCase();
            const matchedUsers = this.bots.filter(b => b.name.toLowerCase().includes(q) || b.handle.toLowerCase().includes(q));
            const matchedPosts = this.posts.filter(p => p.content.toLowerCase().includes(q));
            let html = `<div class="p-4 border-b border-gray-100 dark:border-darkBorder font-bold text-xl dark:text-white">People</div>`;
            if (matchedUsers.length === 0) html += `<div class="p-4 text-gray-500">No people found</div>`;
            matchedUsers.forEach(u => html += this.buildUserListHTML(u));
            html += `<div class="p-4 border-b border-gray-100 dark:border-darkBorder font-bold text-xl dark:text-white mt-2">Posts</div>`;
            if (matchedPosts.length === 0) html += `<div class="p-4 text-gray-500">No posts found</div>`;
            matchedPosts.forEach(p => html += this.buildPostHTML(p));
            container.innerHTML = html;
        }
    }

    renderNotifications() {
        const container = document.getElementById('main-view');
        const myPosts = this.posts.filter(p => p.authorHandle === this.user.handle);
        let html = '';
        myPosts.forEach(p => {
            if(p.stats.likes > 0) {
                html += `<div class="flex gap-3 px-4 py-3 border-b border-gray-100 dark:border-darkBorder hover:bg-gray-50 dark:hover:bg-darkSec cursor-pointer"><div class="text-3xl text-rose-500 w-10 text-right"><i class="fa-solid fa-heart"></i></div><div><div class="w-8 h-8 rounded-full bg-gray-200 mb-2"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}" class="w-full h-full object-cover"></div><p class="text-sm dark:text-white"><span class="font-bold">Someone</span> liked your post</p><p class="text-gray-500 text-sm mt-1 line-clamp-1">${p.content}</p></div></div>`;
            }
        });
        container.innerHTML = html || '<div class="p-10 text-center text-gray-500">No notifications yet</div>';
    }

    buildUserListHTML(user) {
        return `<div class="flex items-center justify-between py-3 hover:bg-gray-50 dark:hover:bg-darkSec px-4 -mx-4 transition cursor-pointer" onclick="app.navigate('profile', '${user.handle}')"><div class="flex items-center gap-3"><img src="${user.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover"><div><p class="font-bold text-sm dark:text-white">${user.name} ${user.isVerified ? VERIFIED_ICON : ''}</p><p class="text-gray-500 text-sm">@${user.handle}</p></div></div></div>`;
    }

    renderProfile(handle) {
        const container = document.getElementById('main-view');
        const pData = this.getProfile(handle) || { name: 'Unknown', handle: handle, followers:0, following:0, bio:'', avatar:'', isVerified:false };
        const isMe = handle === this.user.handle;
        const isMyBot = this.user.createdBots.includes(handle);
        const canEdit = isMe || (this.user.isPremium && isMyBot) || (this.user.isPremium && this.settings.godModeEnabled);
        const memberCount = Math.floor(pData.followers * 0.15) + (isMe?1:0);
        const banner = pData.banner || `https://picsum.photos/seed/${handle}/800/300`;

        const html = `
            <div>
                <div class="h-32 sm:h-48 bg-gray-200 dark:bg-darkSec overflow-hidden"><img src="${banner}" class="w-full h-full object-cover"></div>
                <div class="px-4 relative mb-4">
                    <div class="flex justify-between items-start">
                        <div class="-mt-[15%] sm:-mt-[10%] w-[25%] max-w-[130px] aspect-square rounded-full border-4 border-white dark:border-dark overflow-hidden bg-white dark:bg-darkSec"><img src="${pData.avatar}" class="w-full h-full object-cover"></div>
                        <div class="mt-3">${canEdit ? `<button onclick="app.openEditProfile('${handle}')" class="border border-gray-300 dark:border-darkBorder font-bold rounded-full px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-darkSec transition text-sm text-gray-900 dark:text-white">Edit profile</button>` : `<button class="bg-black dark:bg-white dark:text-black text-white font-bold rounded-full px-5 py-1.5 hover:bg-gray-800 transition text-sm" onclick="app.toggleFollow('${handle}', this)">Follow</button>`}</div>
                    </div>
                    <div class="mt-3"><h1 class="font-extrabold text-xl leading-tight flex items-center dark:text-white">${pData.name} ${pData.isVerified ? VERIFIED_ICON : ''}</h1><p class="text-gray-500 text-sm">@${pData.handle}</p></div>
                    <p class="mt-3 text-[15px] text-gray-900 dark:text-white whitespace-pre-wrap">${pData.bio}</p>
                    <div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="flex items-center gap-1"><i class="fa-solid fa-location-dot"></i> ${pData.location||'Internet'}</span><span class="flex items-center gap-1"><i class="fa-solid fa-calendar-days"></i> Joined ${pData.joined||'May 2023'}</span></div>
                    <div class="flex gap-5 mt-3 text-sm dark:text-gray-400"><div><span class="font-bold text-gray-900 dark:text-white">${this.formatNumber(pData.following)}</span> Following</div><div><span class="font-bold text-gray-900 dark:text-white">${this.formatNumber(pData.followers)}</span> Followers</div></div>
                </div>
                <div class="flex border-b border-gray-100 dark:border-darkBorder mt-2">
                    <div onclick="app.setProfileFilter('posts')" class="flex-1 text-center py-3 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer relative font-bold text-sm dark:text-white ${this.profileFilter==='posts'?'text-black dark:text-white':'text-gray-500'}">Posts<div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${this.profileFilter==='posts'?'':'hidden'}"><div class="bg-rose-500 w-12 rounded-full"></div></div></div>
                    <div onclick="app.setProfileFilter('community')" class="flex-1 text-center py-3 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer relative font-bold text-sm dark:text-white ${this.profileFilter==='community'?'text-black dark:text-white':'text-gray-500'}">Community<div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${this.profileFilter==='community'?'':'hidden'}"><div class="bg-rose-500 w-12 rounded-full"></div></div></div>
                    <div onclick="app.setProfileFilter('likes')" class="flex-1 text-center py-3 hover:bg-gray-100 dark:hover:bg-darkSec cursor-pointer relative font-bold text-sm dark:text-white ${this.profileFilter==='likes'?'text-black dark:text-white':'text-gray-500'}">Likes<div class="absolute bottom-0 left-0 w-full flex justify-center h-[4px] ${this.profileFilter==='likes'?'':'hidden'}"><div class="bg-rose-500 w-12 rounded-full"></div></div></div>
                </div>
                <div id="profile-feed">
                    ${this.profileFilter === 'community' ? `<div class="p-4 bg-gray-50 dark:bg-darkSec border-b border-gray-100 dark:border-darkBorder mb-2 flex justify-between items-center"><div><h3 class="font-bold text-lg dark:text-white">${pData.name}'s Community</h3><p class="text-sm text-gray-500">${this.formatNumber(memberCount)} Members</p></div><button onclick="app.openComposeModalForCommunity('${handle}')" class="bg-rose-500 text-white text-sm font-bold px-4 py-2 rounded-full">Post Here</button></div>` : ''}
                    ${this.getPostsByHandle(handle)}
                </div>
            </div>`;
        container.innerHTML = html;
    }

    getPostsByHandle(handle) {
        let userPosts;
        if(this.profileFilter === 'likes') {
            if(handle === this.user.handle) userPosts = this.posts.filter(p => this.user.likedPosts.includes(p.id));
            else return '<div class="p-8 text-center text-gray-500">Likes are private</div>';
        } else if (this.profileFilter === 'community') {
            userPosts = this.posts.filter(p => p.communityHandle === handle);
        } else {
            userPosts = this.posts.filter(p => p.authorHandle === handle && !p.communityHandle);
            if(this.profileFilter === 'media') userPosts = userPosts.filter(p => p.image || p.video);
        }
        userPosts.sort((a,b) => b.createdAt - a.createdAt);
        if(userPosts.length === 0) return '<div class="p-8 text-center text-gray-500">No posts yet</div>';
        let html = '';
        userPosts.forEach(post => html += this.buildPostHTML(post));
        return html;
    }

    renderPostDetail(postId) {
        const post = this.posts.find(p => p.id === postId);
        if (!post) return;
        let avatar = post.authorAvatar, name = post.authorName, isVerified = post.isVerified;
        if (post.authorHandle === this.user.handle) { avatar = this.user.avatar; name = this.user.name; isVerified = this.user.isVerified; }
        else { const bot = this.bots.find(b => b.handle === post.authorHandle); if(bot) { avatar = bot.avatar; name = bot.name; isVerified = bot.isVerified; } }
        
        const isLiked = this.user.likedPosts.includes(postId), isReposted = this.user.repostedPosts.includes(postId), isBookmarked = this.user.bookmarks.includes(postId);
        const container = document.getElementById('main-view');
        let html = `
            <div class="px-4 py-3 border-b border-gray-100 dark:border-darkBorder animate-fade-in">
                <div class="flex gap-3 items-center mb-3">
                     <div class="w-10 h-10 rounded-full overflow-hidden cursor-pointer" onclick="app.navigate('profile', '${post.authorHandle}')"><img src="${avatar}" class="w-full h-full object-cover"></div>
                    <div><div class="font-bold flex items-center cursor-pointer hover:underline dark:text-white" onclick="app.navigate('profile', '${post.authorHandle}')">${name} ${isVerified ? VERIFIED_ICON : ''}</div><div class="text-gray-500 text-sm">@${post.authorHandle}</div></div>
                </div>
                <div class="text-xl mb-3 whitespace-pre-wrap leading-normal dark:text-white">${post.content}</div>
                ${post.image ? `<div class="rounded-2xl overflow-hidden border border-gray-100 dark:border-darkBorder mb-3"><img src="${post.image}" class="w-full"></div>` : ''}
                ${post.video ? `<div class="mt-3 rounded-2xl overflow-hidden border border-gray-200 dark:border-darkBorder max-h-[350px]"><video src="${post.video}" class="w-full h-full object-cover" controls autoplay muted loop></video></div>` : ''}
                ${this.buildPollHTML(post, true)}
                <div class="text-gray-500 text-sm py-4 border-b border-gray-100 dark:border-darkBorder">${new Date(post.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} Â· ${new Date(post.createdAt).toLocaleDateString()} Â· <span class="text-black dark:text-white font-bold font-mono" id="detail-views-${post.id}">${this.formatNumber(post.stats.views)}</span> <span class="font-medium">Views</span></div>
                <div class="flex justify-between py-1 border-b border-gray-100 dark:border-darkBorder text-gray-500 px-2" id="stats-${post.id}">
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-500 flex items-center justify-center w-full py-3 transition group rounded-full" onclick="app.openReplyModal('${post.id}')"><i class="fa-regular fa-comment text-xl"></i></div>
                    <div class="cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 hover:text-green-500 flex items-center justify-center w-full py-3 transition group rounded-full ${isReposted ? 'reposted' : ''}" onclick="app.toggleRepost('${post.id}', this)"><i class="fa-solid fa-retweet text-xl transition-transform active:scale-125"></i></div>
                    <div class="cursor-pointer hover:bg-rose-50 dark:hover:bg-rose-900/20 hover:text-rose-600 flex items-center justify-center w-full py-3 transition group rounded-full ${isLiked ? 'liked' : ''}" onclick="app.toggleLike('${post.id}', this)"><i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart text-xl transition-transform active:scale-125"></i></div>
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-500 flex items-center justify-center w-full py-3 transition group rounded-full ${isBookmarked ? 'bookmarked' : ''}" onclick="app.toggleBookmark('${post.id}', this)"><i class="${isBookmarked ? 'fa-solid' : 'fa-regular'} fa-bookmark text-xl transition-transform active:scale-125"></i></div>
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-500 flex items-center justify-center w-full py-3 transition group rounded-full" onclick="app.shareApp()"><i class="fa-solid fa-arrow-up-from-bracket text-xl"></i></div>
                </div>
            </div>
            <div class="bg-gray-50/50 dark:bg-darkSec min-h-screen pb-10"></div>`;
        container.innerHTML = html;
    }

    buildPostHTML(post) {
        const isLiked = this.user.likedPosts.includes(post.id);
        const isReposted = this.user.repostedPosts.includes(post.id);
        
        let avatar = post.authorAvatar, name = post.authorName, isVerified = post.isVerified;
        if (post.authorHandle === this.user.handle) { avatar = this.user.avatar; name = this.user.name; isVerified = this.user.isVerified; }
        else { const bot = this.bots.find(b => b.handle === post.authorHandle); if(bot) { avatar = bot.avatar; name = bot.name; isVerified = bot.isVerified; } }

        const canManage = post.authorHandle === this.user.handle || this.user.createdBots.includes(post.authorHandle);
        const highlightClass = post.theme === 'highlight' ? 'post-highlight' : '';

        return `
            <div class="flex gap-3 px-4 py-3 border-b border-gray-100 dark:border-darkBorder hover:bg-gray-50 dark:hover:bg-darkSec/50 cursor-pointer transition duration-200 ${highlightClass}" onclick="app.navigate('post', '${post.id}')">
                <div class="shrink-0 w-10 h-10 rounded-full overflow-hidden bg-gray-200" onclick="event.stopPropagation(); app.navigate('profile', '${post.authorHandle}')"><img src="${avatar}" class="w-full h-full object-cover"></div>
                <div class="w-full">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-1 text-[15px]">
                            <span class="font-bold hover:underline truncate max-w-[150px] dark:text-white" onclick="event.stopPropagation(); app.navigate('profile', '${post.authorHandle}')">${name}</span>
                            ${isVerified ? VERIFIED_ICON : ''}
                            <span class="text-gray-500 truncate" onclick="event.stopPropagation(); app.navigate('profile', '${post.authorHandle}')">@${post.authorHandle}</span>
                            <span class="text-gray-500">Â·</span>
                            <span class="text-gray-500 hover:underline">${this.timeAgo(post.createdAt)}</span>
                            ${post.communityHandle ? `<span class="text-gray-500 ml-1"><i class="fa-solid fa-users text-xs"></i></span>` : ''}
                        </div>
                        <div class="relative group" onclick="event.stopPropagation()">
                            <div class="text-gray-400 hover:bg-rose-50 hover:text-rose-500 p-2 rounded-full -m-2 transition"><i class="fa-solid fa-ellipsis"></i></div>
                            ${canManage ? `
                            <div class="absolute right-0 top-6 bg-white dark:bg-black border dark:border-darkBorder shadow-lg rounded-md z-10 hidden group-hover:block w-32 overflow-hidden">
                                <button onclick="app.deletePost('${post.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-800">Delete</button>
                                <button onclick="app.togglePostTheme('${post.id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">Highlight</button>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="text-[15px] text-gray-900 dark:text-gray-100 mt-0.5 whitespace-pre-wrap leading-normal">${post.content}</div>
                    ${post.image ? `<div class="mt-3 rounded-2xl overflow-hidden border border-gray-200 dark:border-darkBorder max-h-[350px]"><img src="${post.image}" class="w-full h-full object-cover"></div>` : ''}
                    ${post.video ? `<div class="mt-3 rounded-2xl overflow-hidden border border-gray-200 dark:border-darkBorder max-h-[350px]"><video src="${post.video}" class="w-full h-full object-cover" controls autoplay muted loop></video></div>` : ''}
                    ${this.buildPollHTML(post)}
                    <div class="flex justify-between mt-3 text-gray-500 max-w-[425px]" id="stats-${post.id}">
                        <div class="flex items-center gap-2 group hover:text-blue-500 transition" onclick="event.stopPropagation(); app.openReplyModal('${post.id}')"><div class="group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 p-2 rounded-full -m-2 transition"><i class="fa-regular fa-comment"></i></div><span class="text-xs">${post.stats.replies}</span></div>
                        <div class="flex items-center gap-2 group hover:text-green-500 transition ${isReposted ? 'reposted' : ''}" onclick="event.stopPropagation(); app.toggleRepost('${post.id}', this)"><div class="group-hover:bg-green-50 dark:group-hover:bg-green-900/20 p-2 rounded-full -m-2 transition"><i class="fa-solid fa-retweet transition-transform active:rotate-180"></i></div><span class="text-xs stat-reposts">${this.formatNumber(post.stats.reposts)}</span></div>
                        <div class="flex items-center gap-2 group hover:text-rose-600 transition ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); app.toggleLike('${post.id}', this)"><div class="group-hover:bg-rose-50 dark:group-hover:bg-rose-900/20 p-2 rounded-full -m-2 transition"><i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart transition-transform active:scale-125"></i></div><span class="text-xs stat-likes">${this.formatNumber(post.stats.likes)}</span></div>
                        <div class="flex items-center gap-2 group hover:text-blue-500 transition"><div class="group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 p-2 rounded-full -m-2 transition">${ANALYTICS_ICON}</div><span class="text-xs stat-views">${this.formatNumber(post.stats.views)}</span></div>
                    </div>
                </div>
            </div>`;
    }

    buildPollHTML(post, isDetail = false) {
        if (!post.poll) return '';
        let html = `<div class="mt-3 space-y-2 max-w-[400px]" onclick="event.stopPropagation()">`;
        post.poll.options.forEach((opt, idx) => {
            const pct = post.poll.totalVotes === 0 ? 0 : Math.round((opt.votes / post.poll.totalVotes) * 100);
            html += `<div class="relative h-8 rounded-md overflow-hidden bg-gray-100 dark:bg-darkSec cursor-pointer hover:opacity-90 transition"><div id="poll-bar-${post.id}-${idx}" class="absolute top-0 left-0 h-full bg-rose-200 dark:bg-rose-900/40 transition-all duration-500" style="width: ${pct}%"></div><div class="absolute inset-0 flex items-center justify-between px-3 text-sm font-bold dark:text-white"><span>${opt.text}</span><span id="poll-text-${post.id}-${idx}">${pct}%</span></div></div>`;
        });
        html += `<div class="text-gray-500 text-xs mt-1"><span id="poll-total-${post.id}">${this.formatNumber(post.poll.totalVotes)} votes</span> Â· 1 day left</div></div>`;
        return html;
    }

    // --- ACTIONS ---
    handlePostMedia(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            this.tempMedia = e.target.result;
            this.tempMediaType = type;
            const preview = document.getElementById('media-preview');
            const img = document.getElementById('media-preview-img');
            const vid = document.getElementById('media-preview-video');
            
            preview.classList.remove('hidden');
            if(type === 'image') {
                img.src = this.tempMedia; img.classList.remove('hidden'); vid.classList.add('hidden');
            } else {
                vid.src = this.tempMedia; vid.classList.remove('hidden'); img.classList.add('hidden');
            }
        };
        reader.readAsDataURL(file);
    }

    openComposeModalForCommunity(handle) {
        this.postingToCommunity = handle;
        this.openComposeModal();
        document.getElementById('community-indicator').classList.remove('hidden');
        document.getElementById('community-name-target').innerText = '@' + handle;
    }

    closeComposeModal() {
        document.getElementById('compose-modal').classList.add('hidden');
        document.getElementById('compose-input').value = '';
        this.replyingTo = null;
        this.clearMedia();
        document.getElementById('poll-creator').classList.add('hidden');
        document.getElementById('community-indicator').classList.add('hidden');
        this.postingToCommunity = null;
    }

    deletePost(id) {
        if(confirm("Delete this post?")) {
            this.posts = this.posts.filter(p => p.id !== id);
            this.savePosts();
            this.renderView();
            this.showToast('Post deleted');
        }
    }

    togglePostTheme(id) {
        const post = this.posts.find(p => p.id === id);
        if(post) {
            post.theme = post.theme === 'default' ? 'highlight' : 'default';
            this.savePosts();
            this.renderView();
        }
    }

    // --- Standard Functions (Restored) ---
    openComposeModal() { document.getElementById('compose-modal').classList.remove('hidden'); document.getElementById('compose-avatar').src = this.user.avatar; if(!this.replyingTo) document.getElementById('replying-to-indicator').classList.add('hidden'); const sel=document.getElementById('author-selector'), s=document.getElementById('post-as-select'); if(this.user.createdBots.length>0){ sel.classList.remove('hidden'); s.innerHTML=`<option value="${this.user.handle}">@${this.user.handle}</option>`; this.user.createdBots.forEach(h=>{const b=this.bots.find(x=>x.handle===h);if(b)s.innerHTML+=`<option value="${b.handle}">@${b.handle}</option>`}); s.onchange=(e)=>{const h=e.target.value;if(h===this.user.handle)document.getElementById('compose-avatar').src=this.user.avatar;else{const b=this.bots.find(x=>x.handle===h);if(b)document.getElementById('compose-avatar').src=b.avatar}};}else{sel.classList.add('hidden');} }
    openReplyModal(id) { this.replyingTo=id; this.openComposeModal(); const p=this.posts.find(x=>x.id===id); document.getElementById('replying-to-indicator').classList.remove('hidden'); document.getElementById('replying-to-indicator').innerHTML=`Replying to <span class="text-rose-500">@${p?p.authorHandle:'user'}</span>`; }
    toggleTheme() { this.settings.theme = this.settings.theme === 'light' ? 'dark' : 'light'; this.applyTheme(); this.saveSettings(); }
    applyTheme() { const h=document.querySelector('html'); if(this.settings.theme==='dark')h.classList.add('dark');else h.classList.remove('dark'); }
    handleSearch(q) { if(this.currentView==='explore')this.renderExplore(q); }
    clearMedia() { this.tempMedia=null; document.getElementById('media-preview').classList.add('hidden'); document.getElementById('post-image-upload').value=''; document.getElementById('post-video-upload').value=''; }
    publishPost() { const c=document.getElementById('compose-input').value, a=document.getElementById('post-as-select').value; if(!c.trim()&&!this.tempMedia)return; this.createPost(c,a); this.closeComposeModal(); this.showToast('Post sent'); window.scrollTo(0,0); }
    openEditProfile(h) { this.editingHandle=h||this.user.handle; const p=this.getProfile(this.editingHandle); document.getElementById('edit-profile-modal').classList.remove('hidden'); document.getElementById('edit-modal-title').innerText=`Edit ${p.name}`; document.getElementById('edit-name').value=p.name; document.getElementById('edit-bio').value=p.bio; document.getElementById('edit-location').value=p.location||''; document.getElementById('edit-followers').value=p.followers; document.getElementById('edit-banner-preview').src=p.banner||''; document.getElementById('edit-avatar-preview').src=p.avatar||''; if(this.editingHandle===this.user.handle){ document.getElementById('edit-virality').value=this.settings.viralitySpeed; document.getElementById('secret-pin').parentNode.classList.remove('hidden'); document.getElementById('theme-btn').parentNode.classList.remove('hidden'); document.getElementById('bot-control-panel').classList.add('hidden'); } else { document.getElementById('secret-pin').parentNode.classList.add('hidden'); document.getElementById('theme-btn').parentNode.classList.add('hidden'); if(this.user.createdBots.includes(this.editingHandle)) { const bc = document.getElementById('bot-control-panel'); bc.classList.remove('hidden'); document.getElementById('bot-auto-post').checked = p.autoPost !== false; } } if(this.user.isPremium && this.editingHandle===this.user.handle) document.getElementById('god-mode-panel').classList.remove('hidden'); else document.getElementById('god-mode-panel').classList.add('hidden'); const btn=document.getElementById('btn-verify'); if(p.isVerified){btn.innerText="Verified";btn.disabled=true;btn.className="bg-rose-500 text-white px-3 py-1.5 rounded-full text-sm font-bold";}else if(p.followers>=100000||this.user.isPremium){btn.disabled=false;btn.innerText=this.user.isPremium?"Force Verify":"Request";btn.className="bg-black dark:bg-white dark:text-black text-white px-3 py-1.5 rounded-full text-sm font-bold transition";}else{btn.disabled=true;btn.className="bg-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-sm font-bold cursor-not-allowed";} }
    closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); this.editingHandle=null; }
    checkPin() { if(document.getElementById('secret-pin').value==='568300'){ this.user.isPremium=true; this.saveUser(); document.getElementById('god-mode-panel').classList.remove('hidden'); this.showToast("âš¡ God Mode Unlocked"); document.getElementById('btn-verify').disabled=false; document.getElementById('btn-verify').innerText="Force Verify"; document.getElementById('btn-verify').className="bg-black text-white px-3 py-1.5 rounded-full text-sm font-bold transition"; } }
    openCreateBotModal() { document.getElementById('edit-profile-modal').classList.add('hidden'); document.getElementById('create-bot-modal').classList.remove('hidden'); }
    createBot() { const n=document.getElementById('bot-name').value, h=document.getElementById('bot-handle').value, a=document.getElementById('bot-avatar').value||'https://api.dicebear.com/7.x/avataaars/svg?seed='+h; if(!n||!h)return alert("Req"); const nb={name:n,handle:h,avatar:a,bio:'Bot by '+this.user.name,followers:0,following:0,isVerified:false,autoPost:true,banner:'https://picsum.photos/seed/'+h+'/800/300'}; this.bots.push(nb); this.user.createdBots.push(h); this.saveBots(); this.saveUser(); document.getElementById('create-bot-modal').classList.add('hidden'); this.showToast('Bot Created!'); this.navigate('profile',h); }
    handleImageUpload(e,t) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{ const i=new Image(); i.src=ev.target.result; i.onload=()=>{ const c=document.createElement('canvas'), x=c.getContext('2d'), M=500; let w=i.width, h=i.height; if(w>h){if(w>M){h*=M/w;w=M}}else{if(h>M){w*=M/h;h=M}} c.width=w;c.height=h; x.drawImage(i,0,0,w,h); const d=c.toDataURL('image/jpeg',0.8); document.getElementById(`edit-${t}-preview`).src=d; }; }; r.readAsDataURL(f); }
    saveProfile() { const p=this.editingHandle===this.user.handle?this.user:this.bots.find(b=>b.handle===this.editingHandle); p.name=document.getElementById('edit-name').value; p.bio=document.getElementById('edit-bio').value; p.location=document.getElementById('edit-location').value; p.followers=parseInt(document.getElementById('edit-followers').value); p.banner=document.getElementById('edit-banner-preview').src; p.avatar=document.getElementById('edit-avatar-preview').src; if(this.editingHandle===this.user.handle){ this.settings.viralitySpeed=parseFloat(document.getElementById('edit-virality').value); this.saveUser(); this.saveSettings(); } else { if(this.user.createdBots.includes(this.editingHandle)) p.autoPost = document.getElementById('bot-auto-post').checked; this.saveBots(); } this.closeEditProfile(); this.renderProfile(this.editingHandle); this.showToast('Saved'); }
    requestVerification(f=false) { const p=this.editingHandle===this.user.handle?this.user:this.bots.find(b=>b.handle===this.editingHandle); if(f||p.followers>=100000){ p.isVerified=true; if(this.editingHandle===this.user.handle)this.saveUser(); else this.saveBots(); document.getElementById('btn-verify').innerText="Verified!"; this.showToast('Badge Acquired!'); } }
    toggleLike(id,b){const p=this.posts.find(x=>x.id===id);if(!p)return;if(!this.user.likedPosts)this.user.likedPosts=[];const i=this.user.likedPosts.indexOf(id);if(i===-1){this.user.likedPosts.push(id);p.stats.likes++;b.classList.add('liked');const z=b.querySelector('i');if(z){z.classList.remove('fa-regular');z.classList.add('fa-solid','animate-pop');}}else{this.user.likedPosts.splice(i,1);p.stats.likes--;b.classList.remove('liked');const z=b.querySelector('i');if(z){z.classList.add('fa-regular');z.classList.remove('fa-solid','animate-pop');}}if(b.parentElement.querySelector('.stat-likes'))b.parentElement.querySelector('.stat-likes').innerText=this.formatNumber(p.stats.likes);this.saveUser();this.savePosts();}
    toggleRepost(id,b){const p=this.posts.find(x=>x.id===id);if(!p)return;if(!this.user.repostedPosts)this.user.repostedPosts=[];const i=this.user.repostedPosts.indexOf(id);if(i===-1){this.user.repostedPosts.push(id);p.stats.reposts++;b.classList.add('reposted');}else{this.user.repostedPosts.splice(i,1);p.stats.reposts--;b.classList.remove('reposted');}if(b.parentElement.querySelector('.stat-reposts'))b.parentElement.querySelector('.stat-reposts').innerText=this.formatNumber(p.stats.reposts);this.saveUser();this.savePosts();}
    toggleBookmark(id,b){if(!this.user.bookmarks)this.user.bookmarks=[];const i=this.user.bookmarks.indexOf(id);if(i===-1){this.user.bookmarks.push(id);b.classList.add('bookmarked');b.querySelector('i').classList.replace('fa-regular','fa-solid');this.showToast('Saved');}else{this.user.bookmarks.splice(i,1);b.classList.remove('bookmarked');b.querySelector('i').classList.replace('fa-solid','fa-regular');this.showToast('Removed');}this.saveUser();}
    shareApp(){navigator.clipboard.writeText("Check out Peyza!").then(()=>this.showToast('Link Copied'));}
    toggleFollow(h,b){if(b.innerText==='Follow'){b.innerText='Following';b.classList.replace('bg-black','bg-white');b.classList.replace('text-white','text-black');b.classList.add('border','border-gray-300');this.user.following++;}else{b.innerText='Follow';b.classList.replace('bg-white','bg-black');b.classList.replace('text-black','text-white');b.classList.remove('border','border-gray-300');this.user.following--;}this.saveUser();}
    showToast(m){const t=document.getElementById('toast');t.innerText=m;t.classList.remove('opacity-0');setTimeout(()=>t.classList.add('opacity-0'),2000);}
    formatNumber(n){if(n==null)return'0';if(n>=1000000)return(n/1000000).toFixed(1).replace(/\.0$/,'')+'M';if(n>=1000)return(n/1000).toFixed(1).replace(/\.0$/,'')+'K';return n.toString();}
    timeAgo(d){const s=Math.floor((new Date()-d)/1000);if(s>31536000)return Math.floor(s/31536000)+'y';if(s>2592000)return Math.floor(s/2592000)+'mo';if(s>86400)return Math.floor(s/86400)+'d';if(s>3600)return Math.floor(s/3600)+'h';if(s>60)return Math.floor(s/60)+'m';return s+'s';}
    renderSidebarUser(){const e=document.getElementById('sidebar-user');if(e)e.innerHTML=`<div class="w-10 h-10 rounded-full overflow-hidden bg-gray-200"><img src="${this.user.avatar}" class="w-full h-full object-cover"></div><div class="hidden xl:block"><p class="font-bold text-sm truncate w-[140px] flex items-center dark:text-white">${this.user.name} ${this.user.isVerified?VERIFIED_ICON:''}</p><p class="text-gray-500 text-sm truncate w-[140px]">@${this.user.handle}</p></div><i class="hidden xl:block fa-solid fa-ellipsis ml-auto text-gray-900 dark:text-white"></i>`;}
    renderWhoToFollow(){const c=document.getElementById('who-to-follow');if(c){let h='';this.bots.slice(0,3).forEach(b=>{h+=`<div class="flex items-center justify-between"><div class="flex items-center gap-3"><img src="${b.avatar}" class="w-10 h-10 rounded-full bg-gray-200"><div><p class="font-bold text-sm hover:underline cursor-pointer flex items-center dark:text-white" onclick="app.navigate('profile','${b.handle}')">${b.name} ${b.isVerified?VERIFIED_ICON:''}</p><p class="text-gray-500 text-sm">@${b.handle}</p></div></div><button class="bg-black dark:bg-white dark:text-black text-white text-sm font-bold px-4 py-1.5 rounded-full hover:bg-gray-800 transition" onclick="app.toggleFollow('${b.handle}',this)">Follow</button></div>`});c.innerHTML=h;}}
    renderSidebarTrends(){const e=document.getElementById('sidebar-trends');if(!e)return;const t=[...this.bots].sort((a,b)=>b.followers-a.followers).slice(0,3);let h='';t.forEach(b=>{h+=`<div class="cursor-pointer hover:bg-gray-200/50 dark:hover:bg-gray-800 -mx-4 px-4 py-2 transition" onclick="app.navigate('profile','${b.handle}')"><div class="flex items-center justify-between"><div><p class="text-xs text-gray-500">Trending in Profiles</p><p class="font-bold text-sm dark:text-white">${b.name}</p><p class="text-xs text-gray-500">${this.formatNumber(b.followers)} followers</p></div><img src="${b.avatar}" class="w-8 h-8 rounded-full bg-gray-200"></div></div>`;});e.innerHTML=h;}
}

const app = new PeyzaApp();
</script>
</body>
</html>
